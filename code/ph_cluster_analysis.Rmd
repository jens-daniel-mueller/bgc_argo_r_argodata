---
title: "pH cluster analysis"
author: "David Stappard & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```

# Tasks

Load existing files from anomoly analysis and carry out cluster analysis

```{r loading_libraries, include=FALSE}

library(tidyverse)
library(argodata)
library(lubridate)
library(gridExtra)
library(gsw)
library(ggforce)

```

## Set directories

location of pre-prepared data

```{r set_updata_root_directory, include=FALSE}

path_argo <- '/nfs/kryo/work/datasets/ungridded/3d/ocean/floats/bgc_argo'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"

```

## Set options

Define options that are used to determine what analysis is done

```{r set_options}

# Options

# opt_analysis_type
# opt_analysis_type = 1 do analysis to determine number of clusters to use
# opt_analysis_type = 2 do cluster analysis and further analysis on the identified clusters clusters
opt_analysis_type <- 2

# opt_num_clusters
# How many clusters are used in the cluster analysis
opt_num_clusters <- 7

# opt_measure
# opt_measure = 1 analysis is done using pH
# opt_measure = 2 analysis is done using h_plus
# opt_measure_label, opt_xlim and opt_xbreaks are associated formatting
opt_measure <- 2
if (opt_measure == 1){
  opt_measure_label <- "pH anomaly"
  opt_xlim <- c(-0.08, 0.08)
  opt_xbreaks <- c(-0.08, -0.04, 0, 0.04, 0.08)
} else {
  opt_measure_label <- expression("[H]"^"+" ~ "anomaly")
  opt_xlim <- c(-2e-9, 2e-9)
  opt_xbreaks <- c(-2e-9, -1e-9, 0, 1e-9, 2e-9)
}
# Chl-a formatting
opt_chla_measure_label <- expression("chlorophyll a ( mg m"^"-3"~")")
opt_chla_xlim <- c(-0.5, 2.0)
opt_chla_xbreaks <- c(-0.5, 0, 0.5, 1.0, 1.5, 2.0)

# oxygen formatting
opt_doxy_measure_label <- expression("dissolved oxygen ( µmol kg"^"-1"~")")
opt_doxy_xlim <- c(50, 350)
opt_doxy_xbreaks <- c(50, 100, 150, 200, 250, 300, 350)

# options relating to cluster analysis
opt_n_start <- 25
opt_max_iterations <- 500

```


```{r set_global_theme, include=TRUE}

theme_set(theme_bw())

map <-
  read_rds(paste(path_emlr_utilities,
                 "map_landmask_WOA18.rds",
                 sep = ""))

```

## Cluster analysis

### Preperation

Prepare data for cluster analysis

```{r cluster_analysis_prep}

pH_anomaly_va <- read_rds(file = paste0(path_argo_preprocessed, "/pH_anomaly_va.rds"))


# select just 1500m profiles
pH_anomaly_va <- pH_anomaly_va %>% 
  filter(profile_range == 3)

# Simplified table ready to pivot
if (opt_measure == 1) {
  pH_anomaly_va_id <- pH_anomaly_va %>% 
    select(
      file_id,
      depth,
      anomaly = anomaly_pH
    )
} else {
  pH_anomaly_va_id <- pH_anomaly_va %>% 
    select(
      file_id,
      depth,
      anomaly = anomaly_h_plus
    )
}

# wide table with each depth becoming a column
pH_anomaly_va_wide <- pH_anomaly_va_id %>%
  pivot_wider(names_from = depth, values_from = anomaly)


# Drop any rows with missing values N/A caused by gaps in climatology data
pH_anomaly_va_wide <- drop_na(pH_anomaly_va_wide)
profile_id <- pH_anomaly_va_wide %>% select(file_id)

# Table for cluster analysis
x <- pH_anomaly_va_wide %>%
        select(-c(file_id))
```

### Number of clusters

```{r cluster_analysis_determine_k}

if (opt_analysis_type == 1) {

  # kmeansAIC = function(fit){
  # 
  #   m = ncol(fit$centers)
  #   n = length(fit$cluster)
  #   k = nrow(fit$centers)
  #   D = fit$tot.withinss
  #   return(data.frame(AIC = D + 2*m*k,
  #                     BIC = D + log(n)*m*k))
  # }

  # cluster analysis - What k
  n_clusters <- 14
  
  wss <- numeric(n_clusters)
  aic <- numeric(n_clusters)
  bic <- numeric(n_clusters)
  
  for (i in 1:n_clusters) {
    
    # Fit the model: km.out
    set.seed(1)
    (km_out <- kmeans(x, i, iter.max=opt_max_iterations, nstart=opt_n_start))

    # Save the within cluster sum of squares
    wss[i] <- km_out$tot.withinss
    
    # km <- kmeansAIC(km_out)
    # bic[i] <- km$BIC
    # aic[i] <- km$AIC
  }
  
  # Produce a scree plot
  wss_df <- tibble(clusters = 1:n_clusters, wss = wss)
   
  scree_plot <- ggplot(wss_df, aes(x = clusters, y = wss, group = 1)) +
      geom_point(size = 4)+
      geom_line() +
      scale_x_continuous(breaks = c(2, 4, 6, 8, 10, 12, 14)) +
      xlab('Number of clusters')
  scree_plot
  
  scree_plot +
      geom_hline(
          yintercept = wss, 
          linetype = 'dashed', 
          col = c(rep('#000000',5),rep('#FF0000', 3), rep('#000000', 6))
      )
  
  
  # Produce a scree plot using BIC
  # bic_df <- tibble(clusters = 1:n_clusters, bic = bic)
  # 
  # bic_scree_plot <- ggplot(bic_df, aes(x = clusters, y = bic, group = 1)) +
  #     geom_point(size = 4)+
  #     geom_line() +
  #     scale_x_continuous(breaks = c(2, 4, 6, 8, 10, 12, 14)) +
  #     xlab('Number of clusters')
  # bic_scree_plot
  # 
  # bic_scree_plot +
  #     geom_hline(
  #         yintercept = bic,
  #         linetype = 'dashed',
  #         col = c(rep('#000000',4),'#FF0000', rep('#000000', 9))
  #     )

  # # Produce a scree plot using AIC
  # 
  # aic_df <- tibble(clusters = 1:n_clusters, aic = aic)
  #  
  # aic_scree_plot <- ggplot(aic_df, aes(x = clusters, y = aic, group = 1)) +
  #     geom_point(size = 4)+
  #     geom_line() +
  #     scale_x_continuous(breaks = c(2, 4, 6, 8, 10, 12, 14)) +
  #     xlab('Number of clusters')
  # aic_scree_plot
  # 
  # aic_scree_plot +
  #     geom_hline(
  #         yintercept = aic, 
  #         linetype = 'dashed', 
  #         col = c(rep('#000000',4),'#FF0000', rep('#000000', 9))
  #     )
  # 
}

```

### Cluster analysis

```{r cluster_analysis_cluster_details}

if (opt_analysis_type == 2) {


  set.seed(1)
  (cl_out <- kmeans(x, opt_num_clusters, iter.max=opt_max_iterations, nstart=opt_n_start))
  
  cluster_profile <- t(cl_out$centers)
  cluster_ids <- cl_out$cluster
  
  profile_id <- profile_id %>%
    mutate(cluster = cluster_ids)
  
  # Add cluster to pH_anomaly_va
  pH_anomaly_cluster <- full_join(pH_anomaly_va, profile_id)
  
  # Plot cluster mean
  if (opt_measure == 1) {
    anomaly_cluster_mean <- pH_anomaly_cluster %>% 
      filter(cluster >= 1) %>%
      group_by(cluster, depth) %>% 
      summarise(count_cluster = n(),
                anomaly_mean = mean(anomaly_pH, na.rm = TRUE),
                anomaly_sd = sd(anomaly_pH, na.rm = TRUE)) %>%
      ungroup()

    anomaly_year_mean <- pH_anomaly_cluster %>% 
      filter(cluster >= 1) %>%
      group_by(cluster, year) %>% 
      summarise(count_cluster = n(),
                anomaly_mean = mean(anomaly_pH, na.rm = TRUE),
                anomaly_sd = sd(anomaly_pH, na.rm = TRUE)) %>%
      ungroup()
  } else {
    anomaly_cluster_mean <- pH_anomaly_cluster %>% 
      filter(cluster >= 1) %>%
      group_by(cluster, depth) %>% 
      summarise(count_cluster = n(),
                anomaly_mean = mean(anomaly_h_plus, na.rm = TRUE),
                anomaly_sd = sd(anomaly_h_plus, na.rm = TRUE)) %>%
      ungroup()
    
    anomaly_year_mean <- pH_anomaly_cluster %>% 
      filter(cluster >= 1) %>%
      group_by(cluster, year) %>% 
      summarise(count_cluster = n(),
                anomaly_mean = mean(anomaly_h_plus, na.rm = TRUE),
                anomaly_sd = sd(anomaly_h_plus, na.rm = TRUE)) %>%
      ungroup()
  }
  
  anomaly_year_mean <- anomaly_year_mean %>%
    group_by(year) %>%
    summarise(anomaly_mean = mean(anomaly_mean, na.rm = TRUE)) %>%
    ungroup ()
  
  # create figure
  anomaly_cluster_mean %>% 
    ggplot()+
    geom_path(aes(x = anomaly_mean,
                  y = depth))+
    geom_ribbon(aes(xmax = anomaly_mean + anomaly_sd,
                    xmin = anomaly_mean - anomaly_sd,
                    y = depth),
                alpha = 0.2)+
    geom_vline(xintercept = 0)+
    scale_y_reverse()+
    facet_wrap(~cluster)+
    coord_cartesian(xlim = opt_xlim)+
    scale_x_continuous(breaks = opt_xbreaks)+
    labs(title = paste0('Overall mean anomaly profiles by cluster'), x = opt_measure_label, y = 'depth (m)')

}

```

### Cluster climatology

```{r cluster_climatology_shift}

  bf_coefs <- summary(lm(anomaly_year_mean$anomaly_mean ~ anomaly_year_mean$year))$coefficients
  line_eq <- paste0("Y = ", formatC(bf_coefs[2, 1], format = "e", digits = 2), "X ", formatC(bf_coefs[1, 1], format = "e", digits = 2, flag = "+"))
  
  # annual difference from climatology
  anomaly_year_mean %>%
    ggplot(aes(x = year,
                  y = anomaly_mean))+
    geom_point(col='red', size=2)+
    geom_smooth(method=lm, se=FALSE, col='blue', linetype='dashed') +
    labs(title = paste0('Overall variation from climatology (', line_eq, ')'), x = 'year', y = opt_measure_label)
  
  # # annual difference from climatology - excluding 2014
  # anomaly_year_mean_ex14 <- anomaly_year_mean %>% filter(year >= 2015)
  # bf_coefs <- summary(lm(anomaly_year_mean_ex14$anomaly_mean ~ anomaly_year_mean_ex14$year))$coefficients
  # line_eq <- paste0("Y = ", formatC(bf_coefs[2, 1], format = "e", digits = 2), "X ", formatC(bf_coefs[1, 1], format = "e", digits = 2, flag = "+"))
  # 
  # anomaly_year_mean_ex14 %>%
  #   ggplot(aes(x = year,
  #                 y = anomaly_mean))+
  #   geom_point(col='red', size=2)+
  #   geom_smooth(method=lm, se=FALSE, col='blue', linetype='dashed') +
  #   labs(title = paste0('Overall variation from climatology - excluding 2014 (', line_eq, ')'), x = 'year', y = opt_measure_label)

```


### Cluster by year

count of each cluster by year

```{r cluster_by_year}

if (opt_analysis_type == 2) {

  # cluster_profile <- t(cl_out$centers)
  # cluster_ids <- cl_out$cluster
  # 
  # profile_id <- profile_id %>%
  #   mutate(cluster = cluster_ids)
  # 
  # Add cluster to pH_anomaly_va
  pH_anomaly_by_cluster <- unique(full_join(pH_anomaly_va, profile_id) %>%
                              select (file_id, year, cluster) %>%
                              filter (!is.na(cluster)))
  
  # Determine profile count by cluster and year
  cluster_by_year <- pH_anomaly_by_cluster %>% 
    filter(cluster >= 1) %>%
    group_by(cluster = as.character(cluster), year) %>% 
    summarise(count_cluster = n()) %>%
    ungroup()

  year_min <- min(cluster_by_year$year)
  year_max <- max(cluster_by_year$year)
  
  # create figure
  cluster_by_year %>% 
    ggplot(aes(x = year, y = count_cluster, col = cluster, group=cluster))+
    geom_point() +
    geom_line() +
    scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
    scale_color_brewer(palette = 'Dark2')+
    labs(x = 'year', 
         y = 'number of profiles', 
         col = 'cluster',
         title = 'Count of profiles by year and cluster')

}

```

### Cluster by month

count of each cluster by month of year

```{r cluster_by_month}

if (opt_analysis_type == 2) {

  # cluster_profile <- t(cl_out$centers)
  # cluster_ids <- cl_out$cluster
  # 
  # profile_id <- profile_id %>%
  #   mutate(cluster = cluster_ids)
  # 
  # Add cluster to pH_anomaly_va
  pH_anomaly_by_cluster <- unique(full_join(pH_anomaly_va, profile_id) %>%
                              select (file_id, month, cluster) %>%
                              filter (!is.na(cluster)))
  
  # Determine profile count by cluster and year
  cluster_by_year <- pH_anomaly_by_cluster %>% 
    filter(cluster >= 1) %>%
    group_by(cluster = as.character(cluster), month) %>% 
    summarise(count_cluster = n()) %>%
    ungroup()

  # create figure
  cluster_by_year %>% 
    ggplot(aes(x = month, y = count_cluster, col = cluster, group=cluster))+
    geom_point() +
    geom_line() +
    scale_x_continuous(breaks = seq(1, 12, 2)) +
    scale_color_brewer(palette = 'Dark2')+
    labs(x = 'month', 
         y = 'number of profiles', 
         col = 'cluster',
         title = 'Count of profiles by month and cluster')

}

```

### Cluster spatial

location of each cluster on map, spatial analysis

```{r spatial_cluster}

if (opt_analysis_type == 2) {

  # cluster_profile <- t(cl_out$centers)
  # cluster_ids <- cl_out$cluster
  # 
  # profile_id <- profile_id %>%
  #   mutate(cluster = cluster_ids)
  # 
  # Add cluster to pH_anomaly_va
  pH_anomaly_spatial <- unique(full_join(pH_anomaly_va, profile_id) %>%
                              select (file_id, lat, lon, cluster) %>%
                              filter (!is.na(cluster)))
  
  pH_anomaly_spatial <- pH_anomaly_spatial %>% 
                              mutate(cluster = as.character(cluster))
  
  # create figure
map +
  geom_tile(data = pH_anomaly_spatial, 
            aes(x = lon, 
                y = lat, 
                fill = cluster))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')+
  labs(title = 'cluster spatial distribution')

  # create figure
map +
  geom_tile(data = pH_anomaly_spatial, 
            aes(x = lon, 
                y = lat, 
                fill = cluster))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')+
  facet_wrap(~cluster, ncol = 2) +
  labs(title = 'cluster spatial distribution')

}

```

### Cluster spatial year

location of each cluster on map, spatial analysis by year

```{r spatial_cluster_year}

if (opt_analysis_type == 2) {

  # Add cluster to pH_anomaly_va
  pH_anomaly_spatial <- unique(full_join(pH_anomaly_va, profile_id) %>%
                              select (file_id, lat, lon, year, cluster) %>%
                              filter (!is.na(cluster)))
  
  pH_anomaly_spatial <- pH_anomaly_spatial %>% 
                              mutate(cluster = as.character(cluster))
  
  # create figure
  pH_anomaly_spatial %>%
    group_split(year) %>% 
map(
  ~map +
  geom_tile(data = .x, 
            aes(x = lon, 
                y = lat, 
                fill = cluster))+
  #lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')+
  facet_wrap(~cluster, ncol = 2) +
  labs(title = paste0('cluster spatial distribution ', unique(.x$year)))
)

}

```

### pH and Chl-a

for each cluster identified by pH cluster analysis show  alongside chl-a

```{r ph_with_chla}
if (opt_analysis_type == 2) {
  
  # Read chl-a data and link to cluster ID
  chla_bgc_va <- read_rds(file = paste0(path_argo_preprocessed, "/chla_bgc_va.rds"))
  chla_cluster <- full_join(chla_bgc_va, profile_id) %>%
                    filter(!is.na(cluster))

  # summarise by cluster
  chla_cluster_mean <- chla_cluster %>% 
      filter(cluster >= 1) %>%
      group_by(cluster, depth) %>% 
      summarise(chla_mean = mean(chla, na.rm = TRUE),
                chla_sd = sd(chla, na.rm = TRUE)) %>%
      ungroup()

  # join pH anomaly with chl-a
  cluster_ph_chla <- full_join(anomaly_cluster_mean, chla_cluster_mean)
  
  # create figures
  cluster_ph_chla %>% 
    ggplot()+
    geom_path(aes(x = anomaly_mean,
                  y = depth))+
    geom_ribbon(aes(xmax = anomaly_mean + anomaly_sd,
                    xmin = anomaly_mean - anomaly_sd,
                    y = depth),
                alpha = 0.2)+
    geom_vline(xintercept = 0)+
    scale_y_continuous(trans = trans_reverser("sqrt"),
                       breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
    facet_wrap(~cluster)+
    coord_cartesian(xlim = opt_xlim)+
    scale_x_continuous(breaks = opt_xbreaks)+
    labs(title = paste0('Overall mean anomaly profiles by cluster'), x = opt_measure_label, y = 'depth (m)')
    
  cluster_ph_chla %>% 
    ggplot()+
    geom_path(aes(x = chla_mean,
                  y = depth))+
    geom_ribbon(aes(xmax = chla_mean + chla_sd,
                    xmin = chla_mean - chla_sd,
                    y = depth),
                alpha = 0.2)+
    scale_y_continuous(trans = trans_reverser("sqrt"),
                       breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
    facet_wrap(~cluster)+
    coord_cartesian(xlim = opt_chla_xlim)+
    scale_x_continuous(breaks = opt_chla_xbreaks)+
    labs(title = paste0('Overall mean profiles by cluster'), x = opt_chla_measure_label, y = 'depth (m)')


  chla_to_ph_factor <- 1e9
  chla_to_ph_offset <- 1
  chla_color <- "#69b3a2"
  
  cluster_ph_chla %>% 
    ggplot()+
    geom_path(aes(x = anomaly_mean,
                  y = depth))+
    geom_ribbon(aes(xmax = anomaly_mean + anomaly_sd,
                    xmin = anomaly_mean - anomaly_sd,
                    y = depth),
                alpha = 0.2)+
    geom_path(aes(x = (chla_mean - chla_to_ph_offset) / chla_to_ph_factor,
                  y = depth), color = chla_color)+
    geom_ribbon(aes(xmax = (chla_mean + chla_sd - chla_to_ph_offset) / chla_to_ph_factor,
                    xmin = (chla_mean - chla_sd - chla_to_ph_offset) / chla_to_ph_factor,
                    y = depth),
                fill = chla_color,
                alpha = 0.2)+
    geom_vline(xintercept = 0)+
    scale_y_continuous(trans = trans_reverser("sqrt"),
                       breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
    facet_wrap(~cluster)+
    coord_cartesian(xlim = opt_xlim)+
    scale_x_continuous( # First axis
                        name = opt_measure_label, 
                        breaks = opt_xbreaks, 
                        # First axis
                        sec.axis = sec_axis(trans=~.*chla_to_ph_factor + chla_to_ph_offset, name=opt_chla_measure_label)
                       )+
    labs(title = paste0('Overall mean profiles by cluster'), x = opt_measure_label, y = 'depth (m)') +
    theme(
      axis.title.x.top = element_text(color = chla_color)
    )

}

```

### pH and oxygen

for each cluster identified by pH cluster analysis show  alongside oxygen

```{r ph_with_oxygen}
if (opt_analysis_type == 2) {
  
  # Read chl-a data and link to cluster ID
  doxy_bgc_va <- read_rds(file = paste0(path_argo_preprocessed, "/doxy_bgc_va.rds"))
  doxy_cluster <- full_join(doxy_bgc_va, profile_id) %>%
                    filter(!is.na(cluster))

  # summarise by cluster
  doxy_cluster_mean <- doxy_cluster %>% 
      filter(cluster >= 1) %>%
      group_by(cluster, depth) %>% 
      summarise(doxy_mean = mean(doxy, na.rm = TRUE),
                doxy_sd = sd(doxy, na.rm = TRUE)) %>%
      ungroup()

  # join pH anomaly with chl-a
  cluster_ph_doxy <- full_join(anomaly_cluster_mean, doxy_cluster_mean)
  
  # create figure
  cluster_ph_doxy %>% 
    ggplot()+
    geom_path(aes(x = anomaly_mean,
                  y = depth))+
    geom_ribbon(aes(xmax = anomaly_mean + anomaly_sd,
                    xmin = anomaly_mean - anomaly_sd,
                    y = depth),
                alpha = 0.2)+
    geom_vline(xintercept = 0)+
    scale_y_reverse()+
    facet_wrap(~cluster)+
    coord_cartesian(xlim = opt_xlim)+
    scale_x_continuous(breaks = opt_xbreaks)+
    labs(title = paste0('Overall mean anomaly profiles by cluster'), x = opt_measure_label, y = 'depth (m)')
    
  cluster_ph_doxy %>% 
    ggplot()+
    geom_path(aes(x = doxy_mean,
                  y = depth))+
    geom_ribbon(aes(xmax = doxy_mean + doxy_sd,
                    xmin = doxy_mean - doxy_sd,
                    y = depth),
                alpha = 0.2)+
    scale_y_reverse()+
    facet_wrap(~cluster)+
    coord_cartesian(xlim = opt_doxy_xlim)+
    scale_x_continuous(breaks = opt_doxy_xbreaks)+
    labs(title = paste0('Overall mean profiles by cluster'), x = opt_doxy_measure_label, y = 'depth (m)')


  doxy_to_ph_factor <- 75e9
  doxy_to_ph_offset <- 200
  doxy_color <- "#5B9BD5"
  
  cluster_ph_doxy %>% 
    ggplot()+
    geom_path(aes(x = anomaly_mean,
                  y = depth))+
    geom_ribbon(aes(xmax = anomaly_mean + anomaly_sd,
                    xmin = anomaly_mean - anomaly_sd,
                    y = depth),
                alpha = 0.2)+
    geom_path(aes(x = (doxy_mean - doxy_to_ph_offset)  / doxy_to_ph_factor,
                  y = depth), color = doxy_color)+
    geom_ribbon(aes(xmax = (doxy_mean + doxy_sd - doxy_to_ph_offset) / doxy_to_ph_factor,
                    xmin = (doxy_mean - doxy_sd - doxy_to_ph_offset) / doxy_to_ph_factor,
                    y = depth),
                fill = doxy_color,
                alpha = 0.2)+
    geom_vline(xintercept = 0)+
    scale_y_reverse()+
    facet_wrap(~cluster)+
    coord_cartesian(xlim = opt_xlim)+
    scale_x_continuous( # First axis
                        name = opt_measure_label, 
                        breaks = opt_xbreaks, 
                        # First axis
                        sec.axis = sec_axis(trans=~.*doxy_to_ph_factor + doxy_to_ph_offset, name=opt_doxy_measure_label)
                       )+
    labs(title = paste0('Overall mean profiles by cluster'), x = opt_measure_label, y = 'depth (m)') +
    theme(
      axis.title.x.top = element_text(color = doxy_color)
    )
  
}

```
