---
title: "Process each year core data into a consolidated file"
author: "David Stappard & Jens Daniel MÃ¼ller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```

# Task

Count the number of bgc-argo profiles, and plot their evolution over time.

```{r loading_libraries, include=FALSE}

library(tidyverse)
library(argodata)
library(lubridate)
library(argodata)
library(gsw)

```

```{r set_updata_root_directory, include=FALSE}

path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"

path_argo <- '/nfs/kryo/work/datasets/ungridded/3d/ocean/floats/bgc_argo'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

path_argo_core <- '/nfs/kryo/work/datasets/ungridded/3d/ocean/floats/core_argo_r_argodata'
path_argo_core_preprocessed <- paste0(path_argo_core, "/preprocessed_core_data")
```

# Task

Create a consolidated metadata file based on year that exists in the preprocessed_core_data folder.

```{r create_consolidated_metadata}

min_year = 2013
max_year = 2023
consolidated_created = 0

for (target_year in min_year:max_year) {
  metadata_path = paste0(path_argo_core_preprocessed, "/", target_year, "_core_metadata.rds")
  if (file.exists(metadata_path)){
    # read the yearly metadata file and append to consolidated metadata
    core_metadata_year <-
      read_rds(file = metadata_path)
    if (consolidated_created == 0) {
      core_metadata <- core_metadata_year %>%
        select(
          "file", 
          "n_prof", 
          "platform_number", 
          "project_name", 
          "pi_name", 
          "cycle_number", 
          "direction", 
          "data_centre", 
          "dc_reference", 
          "data_state_indicator", 
          "data_mode", 
          "platform_type", 
          "float_serial_no", 
          "firmware_version", 
          "wmo_inst_type", 
          "date", 
          "date_qc", 
          "date_location", 
          "lat", 
          "lon", 
          "position_qc", 
          "positioning_system", 
          "vertical_sampling_scheme", 
          "config_mission_number", 
          "profile_pres_qc", 
          "profile_temp_qc", 
          "profile_psal_qc"
        )
      consolidated_created = 1
    } else {
      core_metadata <- rbind(core_metadata, core_metadata_year %>% 
                                     select(
                                      "file", 
                                      "n_prof", 
                                      "platform_number", 
                                      "project_name", 
                                      "pi_name", 
                                      "cycle_number", 
                                      "direction", 
                                      "data_centre", 
                                      "dc_reference", 
                                      "data_state_indicator", 
                                      "data_mode", 
                                      "platform_type", 
                                      "float_serial_no", 
                                      "firmware_version", 
                                      "wmo_inst_type", 
                                      "date", 
                                      "date_qc", 
                                      "date_location", 
                                      "lat", 
                                      "lon", 
                                      "position_qc", 
                                      "positioning_system", 
                                      "vertical_sampling_scheme", 
                                      "config_mission_number", 
                                      "profile_pres_qc", 
                                      "profile_temp_qc", 
                                      "profile_psal_qc"
                                    ))
    }
  }
}

rm(core_metadata_year)

```

# Task

Write the consolidated metadata file to the preprocessed_core_data folder.

```{r write_consolidated_metadata}

core_metadata %>% 
  write_rds(file = paste0(path_argo_core_preprocessed, "/core_metadata.rds"))

```

## Set cache directory 

Directory where the core-Argo profile files are stored 

```{r set_core_cache_directory}

# set cache directory
argo_set_cache_dir(cache_dir = path_argo_core)

# check cache directory
argo_cache_dir()

# check argo mirror
argo_mirror()

argo_update_global(max_global_cache_age = Inf)  # age argument: age of the cached files to update in hours (Inf means always use the cached file, and -Inf means always download from the server) 
# ex: max_global_cache_age = 5 updates files that have been in the cache for more than 5 hours, max_global_cache_age = 0.5 updates files that have been in the cache for more than 30 minutes, etc.
argo_update_data(max_data_cache_age = Inf)
```

## Load index file 

Load in delayed-mode core-Argo (CTD) data index file. Load in batches and then append to master files for metadata, merge_temp and merge_psal

```{r load_core_by_year}

#------------------------------------------------------------------------------
# Imnportant - file are loaded for the given year processed and then appended to the all years files
#------------------------------------------------------------------------------
min_year = 2013
max_year = 2014
target_year = 2014
consolidated_created = 0

for (target_year in min_year:max_year) {


core_index <- argo_global_prof() %>% 
  argo_filter_data_mode(data_mode = 'delayed') %>% 
  argo_filter_date(date_min = paste0(target_year, "-01-01"),
                   date_max = paste0(target_year, "-12-31"))

# 1 month worth of data for test purposes 

# check dates 
# max(core_index$date, na.rm = TRUE)
# min(core_index$date, na.rm = TRUE)


core_data_yr <- argo_prof_levels(
  path = core_index,
  vars =
    c(
      'PRES_ADJUSTED',
      'PRES_ADJUSTED_QC',
      'PSAL_ADJUSTED',
      'PSAL_ADJUSTED_QC',
      'TEMP_ADJUSTED',
      'TEMP_ADJUSTED_QC'),
  quiet = TRUE
) 
# read in the profiles (takes a while)

# read associated metadata
core_metadata_yr <- argo_prof_prof(path = core_index)

# We only want the synthesised profiles i.e. n_prof == 1
core_data_yr <- core_data_yr %>%
filter(n_prof == 1)
core_metadata_yr <- core_metadata_yr %>%
filter(n_prof == 1)

# ------------------------------------------------------------------------------
# Process temperature file
# ------------------------------------------------------------------------------
core_data_temp_yr <- core_data_yr %>%
  filter(
    pres_adjusted_qc %in% c(1, 8) &
    temp_adjusted_qc %in% c(1, 8)
  ) %>%
  select (
    file,
    n_levels,
    pres_adjusted,
    temp_adjusted
  )

core_data_temp_yr <- left_join(core_data_temp_yr, core_index)

core_data_temp_yr <- core_data_temp_yr %>%
  select(    
    file,
    date,
    latitude,
    longitude,
    n_levels,
    pres_adjusted,
    temp_adjusted
)

core_merge_temp_yr <- core_data_temp_yr %>%
  rename(lon = longitude,
         lat = latitude) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon)) %>%
  mutate(
    lat = cut(lat, seq(-90, 90, 1), seq(-89.5, 89.5, 1)),
    lat = as.numeric(as.character(lat)),
    lon = cut(lon, seq(20, 380, 1), seq(20.5, 379.5, 1)),
    lon = as.numeric(as.character(lon))
  ) %>%
  mutate(depth = gsw_z_from_p(pres_adjusted, latitude =  lat)*-1.0,
         .before = pres_adjusted)

# ------------------------------------------------------------------------------
# Process salinity file
# ------------------------------------------------------------------------------
core_data_psal_yr <- core_data_yr %>%
  filter(
    pres_adjusted_qc %in% c(1, 8) &
    psal_adjusted_qc %in% c(1, 8)
  ) %>%
  select (
    file,
    n_levels,
    pres_adjusted,
    psal_adjusted
  )

core_data_psal_yr <- left_join(core_data_psal_yr, core_index)

core_data_psal_yr <- core_data_psal_yr %>%
  select(    
    file,
    date,
    latitude,
    longitude,
    n_levels,
    pres_adjusted,
    psal_adjusted
)

core_merge_psal_yr <- core_data_psal_yr %>%
  rename(lon = longitude,
         lat = latitude) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon)) %>%
  mutate(
    lat = cut(lat, seq(-90, 90, 1), seq(-89.5, 89.5, 1)),
    lat = as.numeric(as.character(lat)),
    lon = cut(lon, seq(20, 380, 1), seq(20.5, 379.5, 1)),
    lon = as.numeric(as.character(lon))
  ) %>%
  mutate(depth = gsw_z_from_p(pres_adjusted, latitude =  lat)*-1.0,
         .before = pres_adjusted)

# ------------------------------------------------------------------------------
# Process metadata file
# ------------------------------------------------------------------------------
core_metadata_yr <- core_metadata_yr %>%
  rename(lon = longitude,
         lat = latitude) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon)) %>%
  mutate( 
    lat = cut(lat, seq(-90, 90, 1), seq(-89.5, 89.5, 1)),
    lat = as.numeric(as.character(lat)),
    lon = cut(lon, seq(20, 380, 1), seq(20.5, 379.5, 1)),
    lon = as.numeric(as.character(lon))
  )

core_metadata_yr <- core_metadata_yr %>%
  select (
    file,
    date,
    date_qc,
    lat,
    lon,
    position_qc,
    profile_pres_qc,
    profile_temp_qc,
    profile_psal_qc
  )

  # Combine into a consolodated all years file
  if (consolidated_created == 0) {
    core_data_temp <- core_data_temp_yr
    core_data_psal <- core_data_psal_yr
    core_metadata <- core_metadata_yr
    consolidated_created = 1
  } else {
    core_data_temp <- rbind(core_data_temp, core_data_temp_yr)
    core_data_psal <- rbind(core_data_psal, core_data_psal_yr)
    core_metadata <- rbind(core_metadata, core_metadata_yr)
  }

}

```
