---
title: "Prepare temperature data and vertically align to climatology"
author: "David Stappard & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```

# Task

Load existing bgc_data.rds file and align profiles to a common vertical pattern.

```{r loading_libraries, include=FALSE}

library(tidyverse)
library(argodata)
library(lubridate)
library(gridExtra)
library(gsw)
library(ggforce)

```

## Set directories

location of pre-prepared data

```{r set_updata_root_directory, include=FALSE}

path_argo <- '/nfs/kryo/work/datasets/ungridded/3d/ocean/floats/bgc_argo'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

```

## Set options

Define options that are used to determine profiles that we will us in the ongoing analysis

```{r set_options}

# Options

# opt_profile_depth_range
# The profile must have at least one temperature reading at a depth <= opt_profile_depth_range[1, ]
# The profile must have at least one temperature reading at a depth >= opt_profile_depth_range[2, ].
# In addition if the profile depth does not exceed the min(opt_profile_depth_range[2, ]) (i.e. 600) it will be removed.
profile_range <- c(1, 2, 3)
min_depth <- c(7.5, 7.5, 7.5)
max_depth <- c(600, 1200, 1500)
opt_profile_depth_range <- data.frame(profile_range, min_depth, max_depth)

# opt_gap...
# The profile should not have a gap greater that opt_gap_limit within the range defined by opt_gap_min_depth and opt_gap_max_depth
opt_gap_limit <- c(28, 55, 110)
opt_gap_min_depth <- c(0, 400, 1000)
opt_gap_max_depth <- c(400, 1000, 1500)

```


## read climatology

read temperature climatology and prepare to a set range of depths

```{r read_climatology}

# climatology values (clim_temp (°C)) available for lat, lon, month and pressure
boa_temp_clim <- read_rds(file = paste0(path_argo_preprocessed, '/boa_temp_clim.rds'))

#What is the max depth we are interested in
opt_profile_max_depth <- max(opt_profile_depth_range$max_depth)

# existing pressure levels become the target depths that we align to
pressure_range <- unique(boa_temp_clim[c("pres")])
target_depth_range <- pressure_range %>% filter (pres <= opt_profile_max_depth) %>% mutate(target_depth = pres) %>% select(target_depth)

# select variable of interest and prepare target_depth field
boa_temp_clim_clean <- boa_temp_clim %>%
                          select(
                            lat,
                            lon,
                            month,
                            depth,
                            clim_temp
                          ) %>%
                          mutate(
                            target_depth = depth, .after = depth
                          )
  
# create all possible combinations of location and month climatologies and depth levels for interpolation
target_depth_grid <-
  expand_grid(target_depth_range,
              boa_temp_clim_clean %>% distinct(lat, lon, month))

# extend climatology depth vectors with target depths
boa_temp_clim_extended <-
  full_join(boa_temp_clim_clean, target_depth_grid) %>% 
  arrange(lat, lon, month, target_depth)


# filter where target depths outside range of climatology depths
# depth is slightly lower than pressure so 1.02 factor is used to ensure bottom value is not lost.
boa_temp_clim_extended <-
  boa_temp_clim_extended %>%
  group_by(lat, lon, month) %>%
  filter(
    target_depth <= max(depth, na.rm = TRUE)*1.02,
    target_depth >= min(depth, na.rm = TRUE)
  ) %>%
  ungroup()

# predict spline interpolation on adjusted depth grid for climatology loaction and month
boa_temp_clim_interpolated <-
  boa_temp_clim_extended %>%
  group_by(lat, lon, month) %>%
  mutate(clim_temp_spline = spline(target_depth, clim_temp,
                                       method = "natural",
                                       xout = target_depth)$y) %>%
  ungroup()

# subset interpolated values on traget depth grid
boa_temp_clim_interpolated_clean <- 
  inner_join(target_depth_range, boa_temp_clim_interpolated)

# select columns and rename to initial names
boa_temp_clim_interpolated_clean <-
  boa_temp_clim_interpolated_clean %>%
  select(lat, lon, month,
         depth = target_depth,
         clim_temp = clim_temp_spline)

# clean up working tables
rm(boa_temp_clim_clean, boa_temp_clim_extended, boa_temp_clim_interpolated)
```

## read temp data

read temperature profile and carry out basic checks, good data.

```{r read_profile_temperature_data}

# base data and associated metadata
bgc_data <- read_rds(file = paste0(path_argo_preprocessed, '/bgc_data.rds'))
bgc_metadata <- read_rds(file = paste0(path_argo_preprocessed, '/bgc_metadata.rds'))

# # Add a profile sequence field to metadata and default to 1
# bgc_metadata <- bgc_metadata %>%
#   mutate (profile_seq = 1)
# 
# # It is possible that a combination of platform_number and cycle_number do NOT result in a unique profile they will have differing file fields
# check_duplicates <- bgc_metadata %>%
# select (file, date, platform_number, cycle_number, profile_seq) %>%
#   arrange(file)
# 
# # These records will have the profile_seq field updated
# modify_profile_seq <- check_duplicates %>% 
#   group_by(platform_number, cycle_number) %>% 
#   summarise(file_update = last(file),
#             seq_update = n()) %>%
#   filter(seq_update > 1) %>%
#   ungroup()
# 
# # force join on file so that correct row has profile_seq updated
# bgc_metadata <- full_join(bgc_metadata, modify_profile_seq %>% select (file_update, seq_update), by = c("file" = "file_update"))
# bgc_metadata <- bgc_metadata %>%
#   mutate(profile_seq = ifelse(is.na(seq_update), profile_seq, seq_update))

# Select relevant field from metadata ready to join to bgc_data
bgc_metadata_select <- bgc_metadata %>%
                            filter (position_qc == 1) %>%
                            select(
                              file_id,
                              date,
                              lat,
                              lon
                              ) %>%
                            mutate(year = year(date), month = month(date), .after = date) 

# we only want pressure and temperature data
# conditions 
# n_prof == 1
# pres_adjusted_qc %in% c(1, 8) - pressure data marked as good
# temp_adjusted_qc %in% c(1, 8) - temperature data marked as good
# !is.na(pres_adjusted) - pressure value must be present
# !is.na(temp_adjusted) - temperature value must be present
bgc_data_temp <- bgc_data %>%
                  filter(pres_adjusted_qc %in% c(1, 8) & temp_adjusted_qc %in% c(1, 8) & n_prof == 1 & !is.na(pres_adjusted)& !is.na(temp_adjusted)) %>%
                  select(
                    file_id,
                    pres_adjusted,
                    temp_adjusted
                  )

# join with metadata information and calculate depth field
bgc_data_temp <- full_join(bgc_metadata_select, bgc_data_temp) %>%
                          select(
                            file_id,
                            lat, 
                            lon, 
                            date,
                            year, 
                            month,
                            pres_adjusted,
                            temp_adjusted
                          ) %>%
                          mutate(depth = gsw_z_from_p(pres_adjusted, latitude = lat) * -1.0,
                                 .before = pres_adjusted) %>%
                          filter(!is.na(file_id))

# clean up working tables
rm(bgc_data, bgc_metadata_select, check_duplicates, modify_profile_seq)

```

## Profile limits

Apply the rules that are determined by options set in set_options.
Profile must cover a set range and not contain gaps.

```{r profile_limits_temperature}

# Determine profile min and max depths
bgc_profile_limits <- bgc_data_temp %>%
  group_by(file_id) %>%
  summarise(
    min_depth = min(depth),
    max_depth = max(depth),
  ) %>%
  ungroup()

# The profile much match at least one of teh range criteria
force_min <- min(opt_profile_depth_range$min_depth)
force_max <- min(opt_profile_depth_range$max_depth)

# Apply profile min and max restrictions
bgc_apply_limits <- bgc_profile_limits %>%
  filter(
    min_depth <= force_min &
    max_depth >= force_max
    )

# Ensure working data set only contains profiles that have confrormed to the range test
bgc_data_temp <- full_join(bgc_data_temp, bgc_apply_limits) %>%
                        filter(!is.na(min_depth))

# Add profile type field and set all to 1.  
# All profile that meet the minimum requirements are profile_range = 1
bgc_data_temp <- bgc_data_temp %>%
  mutate(profile_range = 1)

for (i in 2:nrow(opt_profile_depth_range)) {

  #i = 3
  range_min <- opt_profile_depth_range[i,'min_depth']
  range_max <- opt_profile_depth_range[i,'max_depth']

  # Apply profile min and max restrictions
  bgc_apply_limits <- bgc_profile_limits %>%
    filter(
      min_depth <= range_min &
      max_depth >= range_max
      ) %>%
    select(
      file_id
      ) %>%
    mutate (
      profile_range = i 
    )

  # Update profile range to i for these profiles
  # bgc_data_temp <- full_join(bgc_data_temp, bgc_apply_limits) %>%
  #                         filter(!is.na(min_depth))
  bgc_data_temp <- bgc_data_temp %>% rows_update(bgc_apply_limits, by = "file_id")

}

# Find the gaps within the profiles
profile_gaps <- bgc_data_temp %>%
  select(
    file_id,
    depth
    ) %>%
  arrange(file_id, depth) %>%
  group_by(file_id) %>%
  mutate(gap = depth - lag(depth, default = 0)) %>%
  ungroup()

# Ensure we do not have gaps in the profile that invalidate it 
for (i_gap in opt_gap_limit) {

  # The limits to be applied in that pass of for loop
  # i_gap <- opt_gap_limit[3]
  i_gap_min = opt_gap_min_depth[which(opt_gap_limit == i_gap)]
  i_gap_max = opt_gap_max_depth[which(opt_gap_limit == i_gap)]
  
  # Which gaps are greater than i_gap
  profile_gaps_remove <- profile_gaps %>%
    filter(gap > i_gap) %>%
    filter(depth >= i_gap_min & depth <= i_gap_max) %>%
    select(file_id, gap)
  
  # Remonve these profiles from working data set
  bgc_data_temp <- full_join(bgc_data_temp, profile_gaps_remove) %>%
                                  filter(is.na(gap)) %>%
                                  select(-c(gap))
}

# Ensure primary fields are all present
bgc_data_temp <- bgc_data_temp %>%
  filter(!is.na(lat) & !is.na(lon) & !is.na(date) & !is.na(depth)) 

# clean up working tables
rm(bgc_profile_limits, profile_gaps, profile_gaps_remove, bgc_apply_limits)

```

## Vertical align temp

We have a set of temperature profiles that match our criteria we now need to align that data set to match the 
depth that are in target_depth_range, this will match the range of climatology values in boa_temp_clim_interpolated_clean

```{r vertical_align_temperature}

# select variable of interest and prepare target_depth field
bgc_data_temp_clean <- bgc_data_temp %>%
                              select(
                                file_id, 
                                lat,
                                lon,
                                date,
                                depth,
                                profile_range,
                                temp = temp_adjusted
                              ) %>%
                              mutate(
                                target_depth = depth, .after = depth
                              )

# create all possible combinations of location, month and depth levels for interpolation
target_depth_grid <-
  expand_grid(target_depth_range,
              bgc_data_temp_clean %>% distinct(file_id, lat, lon, date, profile_range))

# Take account of the profile_range field to determine the profile_range of target_depth_grid
target_depth_grid <- left_join(target_depth_grid, opt_profile_depth_range) %>%
        filter(target_depth <= max_depth)

target_depth_grid <- target_depth_grid %>% 
                        select(
                          target_depth, 
                          file_id, 
                          lat, 
                          lon,
                          date,
                          profile_range
                          )

# extend temperature depth vectors with target depths
bgc_data_temp_extended <- full_join(bgc_data_temp_clean, target_depth_grid) %>% 
  arrange(file_id, lat, lon, date, target_depth)

# predict spline interpolation on adjusted depth grid for temperature location and month
bgc_data_temp_interpolated <-
  bgc_data_temp_extended %>%
  group_by(file_id, lat, lon, date) %>%
  mutate(temp_spline = spline(target_depth, temp,
                                method = "natural",
                                xout = target_depth)$y) %>%
  ungroup()

# subset interpolated values on target depth range
bgc_data_temp_interpolated_clean <- 
  inner_join(target_depth_grid, bgc_data_temp_interpolated)

# select columns and rename to initial names
bgc_data_temp_interpolated_clean <-
  bgc_data_temp_interpolated_clean %>%
  select(
    file_id, 
    lat, 
    lon, 
    date,
    profile_range,
    depth = target_depth,
    temp = temp_spline)

# Create year and month fields
bgc_data_temp_interpolated_clean <- bgc_data_temp_interpolated_clean %>%
  mutate(year = year(date),
         month = month(date),
         .after = date)

# clean up working tables
rm(bgc_data_temp_extended, bgc_data_temp_interpolated)
```

## Create anomaly profiles

Create anomaly profiles as observed - climatology
```{r anomaly_temperature}

# Create bgc_temp_anomaly, but only where we have an climatology temperature
bgc_temp_anomaly <- left_join(bgc_data_temp_interpolated_clean, boa_temp_clim_interpolated_clean) %>%
                        filter(!is.na(clim_temp) &  lat <= -30)

# Calculate the anomaly temperature
bgc_temp_anomaly <- bgc_temp_anomaly %>%
                      mutate(
                        anomaly = temp - clim_temp
                      )

# -----------------------------------------------------------------------------
# Climatology check
# -----------------------------------------------------------------------------
# It is possible even though we have observational measures to full depth the climatology may not matach all depth.
# These profiles will be removed from both temp_bgc_va and temp_anomaly_va

# Anomaly max depth
bgc_temp_anomaly_depth_check <- bgc_temp_anomaly %>%
                                group_by(
                                  file_id,
                                  profile_range
                                  ) %>%
                                summarise(
                                  min_pdepth = min(depth),
                                  max_pdepth = max(depth)
                                  ) %>%
                                ungroup()

# Add the required min depth and max depth
bgc_temp_anomaly_depth_check <- left_join(bgc_temp_anomaly_depth_check, opt_profile_depth_range)

# This profiles do not match the depth required by the profile_range
min_depth_check <- min(target_depth_grid$target_depth)
remove_profiles <- bgc_temp_anomaly_depth_check %>%
  filter((max_pdepth < max_depth) | min_pdepth != min_depth_check) %>%
  select(file_id, max_depth)

# remove from both bgc_temp_anomaly and bgc_data_temp_interpolated_clean
bgc_temp_anomaly <- full_join(bgc_temp_anomaly, remove_profiles) %>%
            filter(is.na(max_depth)) %>%
            select(-c(max_depth))

bgc_data_temp_interpolated_clean <- full_join(bgc_data_temp_interpolated_clean, remove_profiles) %>%
            filter(is.na(max_depth)) %>%
            select(-c(max_depth))

# clean up working tables
rm(bgc_temp_anomaly_depth_check, remove_profiles)

```

## Write files

Write the climatology that maps onto depth levels, interpolated temperature profiles that map onto depth levels and resulting anomaly files.
```{r write_temperature_va}

# Write files
bgc_data_temp_interpolated_clean %>%
  write_rds(file = paste0(path_argo_preprocessed, "/temp_bgc_va.rds"))

boa_temp_clim_interpolated_clean %>%
  write_rds(file = paste0(path_argo_preprocessed, "/temp_clim_va.rds"))

bgc_temp_anomaly %>%
  write_rds(file = paste0(path_argo_preprocessed, "/temp_anomaly_va.rds"))

# Rename so that names match if just reading existing files
temp_bgc_va <- bgc_data_temp_interpolated_clean
temp_clim_va <- boa_temp_clim_interpolated_clean
temp_anomaly_va <- bgc_temp_anomaly

#rm(bgc_data_temp_interpolated_clean, boa_temp_clim_interpolated_clean, bgc_temp_anomaly)

```

## read files

Read files that were previously created ready for analysis
```{r read_temperature_va}

# read files
temp_bgc_va <- read_rds(file = paste0(path_argo_preprocessed, "/temp_bgc_va.rds"))

temp_clim_va <- read_rds(file = paste0(path_argo_preprocessed, "/temp_clim_va.rds"))

temp_anomaly_va <- read_rds(file = paste0(path_argo_preprocessed, "/temp_anomaly_va.rds"))

```


## Temperature anomaly

Details of mean anomaly over analysis period
```{r plot_overall_mean_anomaly_profiles, fig.asp=1}

max_depth_1 <- opt_profile_depth_range[1, "max_depth"]
max_depth_2 <- opt_profile_depth_range[2, "max_depth"]
max_depth_3 <- opt_profile_depth_range[3, "max_depth"]

# Profiles to 600m
anomaly_overall_mean_1 <- temp_anomaly_va %>% 
  filter(profile_range %in% c(1, 2, 3) & depth <= max_depth_1) %>%
  group_by(depth) %>% 
  summarise(temp_count = n(),
            temp_anomaly_mean = mean(anomaly, na.rm = TRUE),
            temp_anomaly_sd = sd(anomaly, na.rm = TRUE))

anomaly_year_mean_1 <- temp_anomaly_va %>% 
  filter(profile_range %in% c(1, 2, 3) & depth <= max_depth_1) %>%
  group_by(year, depth) %>% 
  summarise(temp_count = n(),
            temp_anomaly_mean = mean(anomaly, na.rm = TRUE),
            temp_anomaly_sd = sd(anomaly, na.rm = TRUE))

# Profiles to 1200m
anomaly_overall_mean_2 <- temp_anomaly_va %>% 
  filter(profile_range %in% c(2, 3) & depth <= max_depth_2) %>%
  group_by(depth) %>% 
  summarise(temp_count = n(),
            temp_anomaly_mean = mean(anomaly, na.rm = TRUE),
            temp_anomaly_sd = sd(anomaly, na.rm = TRUE))

anomaly_year_mean_2 <- temp_anomaly_va %>% 
  filter(profile_range %in% c(2, 3) & depth <= max_depth_2) %>%
  group_by(year, depth) %>% 
  summarise(temp_count = n(),
            temp_anomaly_mean = mean(anomaly, na.rm = TRUE),
            temp_anomaly_sd = sd(anomaly, na.rm = TRUE))

# Profiles to 1500m
anomaly_overall_mean_3 <- temp_anomaly_va %>% 
  filter(profile_range %in% c(3) & depth <= max_depth_3) %>%
  group_by(depth) %>% 
  summarise(temp_count = n(),
            temp_anomaly_mean = mean(anomaly, na.rm = TRUE),
            temp_anomaly_sd = sd(anomaly, na.rm = TRUE))

anomaly_year_mean_3 <- temp_anomaly_va %>% 
  filter(profile_range %in% c(3) & depth <= max_depth_3) %>%
  group_by(year, depth) %>% 
  summarise(temp_count = n(),
            temp_anomaly_mean = mean(anomaly, na.rm = TRUE),
            temp_anomaly_sd = sd(anomaly, na.rm = TRUE))

# All years anomaly
anomaly_overall_mean_1 %>% 
  ggplot()+
  geom_path(aes(x = temp_anomaly_mean,
                y = depth))+
  geom_ribbon(aes(xmax = temp_anomaly_mean + temp_anomaly_sd,
                  xmin = temp_anomaly_mean - temp_anomaly_sd,
                  y = depth),
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  # scale_color_manual(values = HNL_colors)+
  # scale_fill_manual(values = HNL_colors)+
  coord_cartesian(xlim = c(-4.5, 4.5))+
  scale_x_continuous(breaks = c(-4, -2, 0, 2, 4))+
  labs(title = paste0('Overall mean anomaly profiles to ', max_depth_1, 'm'), x='temperature anomaly (°C)', y='depth (m)')

anomaly_overall_mean_2 %>% 
  ggplot()+
  geom_path(aes(x = temp_anomaly_mean,
                y = depth))+
  geom_ribbon(aes(xmax = temp_anomaly_mean + temp_anomaly_sd,
                  xmin = temp_anomaly_mean - temp_anomaly_sd,
                  y = depth),
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  # scale_color_manual(values = HNL_colors)+
  # scale_fill_manual(values = HNL_colors)+
  coord_cartesian(xlim = c(-4.5, 4.5))+
  scale_x_continuous(breaks = c(-4, -2, 0, 2, 4))+
  labs(title = paste0('Overall mean anomaly profiles to ', max_depth_2, 'm'), x='temperature anomaly (°C)', y='depth (m)')

anomaly_overall_mean_3 %>% 
  ggplot()+
  geom_path(aes(x = temp_anomaly_mean,
                y = depth))+
  geom_ribbon(aes(xmax = temp_anomaly_mean + temp_anomaly_sd,
                  xmin = temp_anomaly_mean - temp_anomaly_sd,
                  y = depth),
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  # scale_color_manual(values = HNL_colors)+
  # scale_fill_manual(values = HNL_colors)+
  coord_cartesian(xlim = c(-4.5, 4.5))+
  scale_x_continuous(breaks = c(-4, -2, 0, 2, 4))+
  labs(title = paste0('Overall mean anomaly profiles to ', max_depth_3, 'm'), x='temperature anomaly (°C)', y='depth (m)')

# yearly anomaly
anomaly_year_mean_1 %>% 
  ggplot()+
  geom_path(aes(x = temp_anomaly_mean,
                y = depth))+
  geom_ribbon(aes(xmax = temp_anomaly_mean + temp_anomaly_sd,
                  xmin = temp_anomaly_mean - temp_anomaly_sd,
                  y = depth),
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  # scale_color_manual(values = HNL_colors)+
  # scale_fill_manual(values = HNL_colors)+
  facet_wrap(~year)+
  coord_cartesian(xlim = c(-4.5, 4.5))+
  scale_x_continuous(breaks = c(-4, -2, 0, 2, 4))+
  labs(title = paste0('Yearly mean anomaly profiles to ', max_depth_1, 'm'), x='temperature anomaly (°C)', y='depth (m)')

anomaly_year_mean_2 %>% 
  ggplot()+
  geom_path(aes(x = temp_anomaly_mean,
                y = depth))+
  geom_ribbon(aes(xmax = temp_anomaly_mean + temp_anomaly_sd,
                  xmin = temp_anomaly_mean - temp_anomaly_sd,
                  y = depth),
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  # scale_color_manual(values = HNL_colors)+
  # scale_fill_manual(values = HNL_colors)+
  facet_wrap(~year)+
  coord_cartesian(xlim = c(-4.5, 4.5))+
  scale_x_continuous(breaks = c(-4, -2, 0, 2, 4))+
  labs(title = paste0('Yearly mean anomaly profiles to ', max_depth_2, 'm'), x='temperature anomaly (°C)', y='depth (m)')

anomaly_year_mean_3 %>% 
  ggplot()+
  geom_path(aes(x = temp_anomaly_mean,
                y = depth))+
  geom_ribbon(aes(xmax = temp_anomaly_mean + temp_anomaly_sd,
                  xmin = temp_anomaly_mean - temp_anomaly_sd,
                  y = depth),
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  # scale_color_manual(values = HNL_colors)+
  # scale_fill_manual(values = HNL_colors)+
  facet_wrap(~year)+
  coord_cartesian(xlim = c(-4.5, 4.5))+
  scale_x_continuous(breaks = c(-4, -2, 0, 2, 4))+
  labs(title = paste0('Yearly mean anomaly profiles to ', max_depth_3, 'm'), x='temperature anomaly (°C)', y='depth (m)')



#rm(anomaly_overall_mean)
```

## Profile counts

Details of the number of profiles and to which depths over the analysis period
```{r temp_histogram, fig.asp=1}

temp_histogram <- temp_bgc_va %>%
  group_by(year, profile_range = as.character(profile_range)) %>%
  summarise(num_profiles = n_distinct(file_id)) %>%
  ungroup()


temp_histogram %>% 
  ggplot()+
  geom_bar(aes(x = year, y = num_profiles, fill = profile_range, group = profile_range), position = "stack", stat="identity")+
  scale_fill_viridis_d()+
  labs(title = "profiles per year and profile range", x = "year", y = "profile count", fill = "profile range")


```


## Cluster analysis

```{r cluster_analysis_prep}

#temp_bgc_va <- read_rds(file = paste0(path_argo_preprocessed, "/temp_bgc_va.rds"))
#temp_clim_va <- read_rds(file = paste0(path_argo_preprocessed, "/temp_clim_va.rds"))
temp_anomaly_va <- read_rds(file = paste0(path_argo_preprocessed, "/temp_anomaly_va.rds"))


# prof_id %>% filter(num_id == 8035)
# base <- temp_bgc_va %>% filter(id == "5905442_139")
# clim <- temp_clim_va %>% filter(lat == -39.5 & lon == 148.5 & month == 4)

# cselect just 1500m profiles
temp_anomaly_va <- temp_anomaly_va %>% 
  filter(profile_range == 3)

# Create table with a numeric id and current id
prof_id <- unique(temp_anomaly_va$id)
prof_id <- tibble(prof_id)
prof_id <- tibble::rowid_to_column(prof_id, "num_id")

temp_anomaly_va_id <- full_join(temp_anomaly_va, prof_id, by = c("id" = "prof_id"))

temp_anomaly_va_id <- temp_anomaly_va_id %>% 
  select(
    id = num_id,
    depth,
    anomaly
  )

temp_anomaly_va_wide <- temp_anomaly_va_id %>%
  pivot_wider(names_from = depth, values_from = anomaly)



# review profiles
# temp_anomaly_va_review = temp_anomaly_va_id %>% filter(id == 8035)
# temp_anomaly_va_wide_review = temp_anomaly_va_wide %>% filter(id == 8035)
# temp_anomaly_va_wide[6437, ]
# which(is.na(temp_anomaly_va_wide), arr.ind=TRUE)

x <- temp_anomaly_va_wide %>%
        select(-c(id))
```

```{r cluster_analysis_determine_k}

# cluster analysis - What k??
n_clusters <- 14
wss <- numeric(n_clusters)

for (i in 1:n_clusters) {
  # Fit the model: km.out
  km_out <- kmeans(x, i)
  # Save the within cluster sum of squares
  wss[i] <- km_out$tot.withinss
}

# Produce a scree plot
wss_df <- tibble(clusters = 1:n_clusters, wss = wss)
 
scree_plot <- ggplot(wss_df, aes(x = clusters, y = wss, group = 1)) +
    geom_point(size = 4)+
    geom_line() +
    scale_x_continuous(breaks = c(2, 4, 6, 8, 10, 12, 14)) +
    xlab('Number of clusters')
scree_plot

scree_plot +
    geom_hline(
        yintercept = wss, 
        linetype = 'dashed', 
        col = c(rep('#000000',5),'#FF0000', rep('#000000', 8))
    )
```

```{r cluster_analysis_determine_analysis}

# k = 6
(cl_out <- kmeans(x, 6))

cluster_profile <- t(cl_out$centers)
cluster_ids <- cl_out$cluster

prof_id <- prof_id %>%
  mutate(cluster = cluster_ids)

# Add cluster to temp_anomaly_va
temp_anomaly_va <- full_join(temp_anomaly_va, prof_id, by = c("id" = "prof_id"))

anomaly_cluster_mean <- temp_anomaly_va %>% 
  filter(cluster >= 1) %>%
  group_by(cluster, depth) %>% 
  summarise(count_anom = n(),
            anomaly_mean = mean(anomaly, na.rm = TRUE),
            anomaly_sd = sd(anomaly, na.rm = TRUE)) %>%
  ungroup()

anomaly_cluster_mean %>% 
  ggplot()+
  geom_path(aes(x = anomaly_mean,
                y = depth))+
  geom_ribbon(aes(xmax = anomaly_mean + anomaly_sd,
                  xmin = anomaly_mean - anomaly_sd,
                  y = depth),
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_reverse() +
  # scale_y_continuous(trans = trans_reverser("sqrt"),
  #                    breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  facet_wrap(~cluster)+
  # scale_color_manual(values = HNL_colors)+
  # scale_fill_manual(values = HNL_colors)+
  coord_cartesian(xlim = c(-4.5, 4.5))+
  scale_x_continuous(breaks = c(-4, -2, 0, 2, 4))+
  labs(title = paste0('Overall mean anomaly profiles by cluster'))


```


