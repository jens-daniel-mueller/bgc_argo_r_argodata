---
title: "Combined cluster analysis"
author: "David Stappard & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```

# Tasks

Carried out cluster analysis having first set options and determined the data sets on which that cluster analysis should be based on.

```{r loading_libraries, include=FALSE}

library(tidyverse)
library(argodata)
library(lubridate)
library(gridExtra)
library(gsw)
library(ggforce)
library(ggpmisc)
library(tidymodels)

```

## Set directories

location of pre-prepared data

```{r set_updata_root_directory, include=FALSE}

path_argo <- '/nfs/kryo/work/datasets/ungridded/3d/ocean/floats/bgc_argo'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

path_core_argo <- '/nfs/kryo/work/datasets/ungridded/3d/ocean/floats/core_argo_r_argodata'
path_core_preprocessed <- paste0(path_core_argo, "/preprocessed_core_data")

path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"

```

## Category options

What category of data is the cluster analysis related to

```{r set_category_options}

# opt_category
# bgc_temp_withph based on bgc_temp dataset but must also have ph profile.
# bgc_ph_hplus based on bgc_ph dataset with analysis carried out on h plus anomalies
#opt_category <- "bgc_temp"
#opt_category <- "bgc_temp_withph"
#opt_category <- "bgc_ph_h_plus"
#opt_category <- "bgc_ph_ph"
#opt_category <- "bgc_doxy"
opt_category <- "bgc_ph_h_plus"

# # Global
# opt_lat_min <- -90
# opt_lat_max <- 90
# opt_lon_min <- 20
# opt_lon_max <- 380
# 
# # spatial restrictions
# # Southern ocean
# opt_lat_min <- -90
# opt_lat_max <- -30
# opt_lon_min <- 20
# opt_lon_max <- 380
# 
# # Mapping latitude limits
# opt_map_lat_limit <- c(-85, 85) # global
# opt_map_lat_limit <- c(-85,-30) # SO

```

## Analysis options

Define options that are used to determine the nature of the cluster analysis that is carried out.

```{r set_cluster_options}

# Options

# opt_num_clusters
# How many clusters are used in the cluster analysis for each depth 1 (600 m), 2 (1000 m) and 3 (1500 m)
opt_num_clusters_min <- c(8, 8, 4)
opt_num_clusters_max <- c(8, 8, 5)
# Which profile range is used
opt_profile_range <- 3

# options relating to cluster analysis
opt_n_start <- 15
opt_max_iterations <- 500
opt_n_clusters <- 14 # Max number of clusters to try when determining optimal number of clusters

# opt_extreme_determination
# 1 - based on the trend of de-seasonal data - we believe this results in more summer extremes where variation tend to be greater.
# 2 - based on the trend of de-seasonal data by month. grouping is by lat, lon and month.
opt_extreme_determination <- 2

# Options associated with profiles under surface extreme conditions
extreme_type <- c('L', 'N', 'H')
opt_num_clusters_ext_min <- c(4, 4, 4)
opt_num_clusters_ext_max <- c(5, 5, 5)

# Option related to normalising the anomaly profiles.
# TRUE - anomaly profiles are normalised by the surface anomaly. Every depth anomaly is divided by the surface anomaly.
#      - The is only carried out for profiles where the abs(surface temp) > 1.
#      - This analysis is carried out in addition to the analysis on base anomaly profiles.  
# FALSE - The normalisation process is not carried out. 
opt_norm_anomaly <- TRUE

```


```{r set_global_theme, include=TRUE}

theme_set(theme_bw())

map <-
  read_rds(paste(path_emlr_utilities,
                 "map_landmask_WOA18.rds",
                 sep = ""))

```


## Preparation

Prepare data for cluster analysis

```{r prep_bgc_temp}

if (opt_category == "bgc_temp") {

  # ---------------------------------------------------------------------------------------------
  # spatial restrictions
  # ---------------------------------------------------------------------------------------------
  # Southern ocean
  opt_lat_min <- -90
  opt_lat_max <- -30
  opt_lon_min <- 20
  opt_lon_max <- 380
  
  # Mapping latitude limits
  opt_map_lat_limit <- c(-85,-30) # SO
    
  # ---------------------------------------------------------------------------------------------
  # read data - bgc temperature must have a ph profile
  # ---------------------------------------------------------------------------------------------
  # read data, applying geographical limits and standardize field names.
  anomaly_va <-
    read_rds(file = paste0(path_argo_preprocessed, "/temp_anomaly_va.rds")) %>%
    filter (lat >= opt_lat_min &
            lat <= opt_lat_max &
            lon >= opt_lon_min &
            lon <= opt_lon_max) %>%
    select(file_id,
           date,
           year,
           month,
           lat,
           lon,
           profile_range,
           depth, 
           prof_measure = temp,
           clim_measure = clim_temp,
           anomaly
           )
  
  # ---------------------------------------------------------------------------------------------
  # read data extreme data for later use
  # ---------------------------------------------------------------------------------------------
  # load previously created OceanSODA extreme data. date, position and nature of extreme
  if (opt_extreme_determination == 1){
    extreme_data <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_SST_anomaly_field_01.rds")) %>%
      select(lon, lat, date, extreme_flag = temp_extreme)
  } else if (opt_extreme_determination == 2){
    extreme_data <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_SST_anomaly_field_02.rds")) %>%
      select(lon, lat, date, extreme_flag = temp_extreme)
  }

  # ---------------------------------------------------------------------------------------------
  # Associated data restrictions and formatting
  # ---------------------------------------------------------------------------------------------
  # What is the max depth of each profile_range
  opt_max_depth <- c(600, 1000, 1500)
  
  # opt_measure_label, opt_xlim and opt_xbreaks are associated with formatting
  opt_measure_label <- "temperature anomaly (°C)"
  opt_xlim <- c(-4.5, 4.5)
  opt_xbreaks <- c(-4, -2, 0, 2, 4)
  
  # adjusted to be in scale -1 to 1
  opt_measure_label_adjusted <- "adjusted temperature anomaly"
  opt_xlim_adjusted <- c(-1, 1)
  opt_xbreaks_adjusted <- c(-1.0, -0.5, 0, 0.5, 1.0)

  # Under extreme analysis
  opt_extreme_analysis <- TRUE
  
}

```

```{r prep_bgc_temp_withph}

if (opt_category == "bgc_temp_withph") {

  # ---------------------------------------------------------------------------------------------
  # spatial restrictions
  # ---------------------------------------------------------------------------------------------
  # Southern ocean
  opt_lat_min <- -90
  opt_lat_max <- -30
  opt_lon_min <- 20
  opt_lon_max <- 380
  
  # Mapping latitude limits
  opt_map_lat_limit <- c(-85,-30) # SO
    
  # ---------------------------------------------------------------------------------------------
  # read data - bgc temperature must have a ph profile
  # ---------------------------------------------------------------------------------------------
  # read data, applying geographical limits and standardize field names.
  anomaly_va <-
    read_rds(file = paste0(path_argo_preprocessed, "/temp_anomaly_va.rds")) %>%
    filter (lat >= opt_lat_min &
            lat <= opt_lat_max &
            lon >= opt_lon_min &
            lon <= opt_lon_max) %>%
    select(file_id,
           date,
           year,
           month,
           lat,
           lon,
           profile_range,
           depth, 
           prof_measure = temp,
           clim_measure = clim_temp,
           anomaly
           )
  
  # Additional ph requirement restriction
  bgc_ph <- read_rds(file = paste0(path_argo_preprocessed, "/pH_bgc_va.rds"))
  anomaly_va <- inner_join(anomaly_va, bgc_ph %>% distinct(file_id)) 
  
  # ---------------------------------------------------------------------------------------------
  # read data extreme data for later use
  # ---------------------------------------------------------------------------------------------
  # load previously created OceanSODA extreme data. date, position and nature of extreme
  if (opt_extreme_determination == 1){
    extreme_data <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_SST_anomaly_field_01.rds")) %>%
      select(lon, lat, date, extreme_flag = temp_extreme)
  } else if (opt_extreme_determination == 2){
    extreme_data <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_SST_anomaly_field_02.rds")) %>%
      select(lon, lat, date, extreme_flag = temp_extreme)
  }

  # ---------------------------------------------------------------------------------------------
  # Associated data restrictions and formatting
  # ---------------------------------------------------------------------------------------------
  # What is the max depth of each profile_range
  opt_max_depth <- c(600, 1000, 1500)
  
  # opt_measure_label, opt_xlim and opt_xbreaks are associated with formatting
  opt_measure_label <- "temperature anomaly (°C)"
  opt_xlim <- c(-4.5, 4.5)
  opt_xbreaks <- c(-4, -2, 0, 2, 4)
  
  # adjusted to be in scale -1 to 1
  opt_measure_label_adjusted <- "adjusted temperature anomaly"
  opt_xlim_adjusted <- c(-1, 1)
  opt_xbreaks_adjusted <- c(-1.0, -0.5, 0, 0.5, 1.0)

  # Under extreme analysis
  opt_extreme_analysis <- TRUE
  
}

```

```{r prep_bgc_ph_h_plus}

if (opt_category == "bgc_ph_h_plus") {

  # ---------------------------------------------------------------------------------------------
  # spatial restrictions
  # ---------------------------------------------------------------------------------------------
  # Southern ocean
  opt_lat_min <- -90
  opt_lat_max <- -30
  opt_lon_min <- 20
  opt_lon_max <- 380
  
  # Mapping latitude limits
  opt_map_lat_limit <- c(-85,-30) # SO
  
  # ---------------------------------------------------------------------------------------------
  # read data - ph with analysis based on hplus
  # ---------------------------------------------------------------------------------------------
  # read data, applying geographical limits and standardize field names.
  anomaly_va <-
    read_rds(file = paste0(path_argo_preprocessed, "/pH_anomaly_va.rds")) %>%
    filter (lat >= opt_lat_min &
            lat <= opt_lat_max &
            lon >= opt_lon_min &
            lon <= opt_lon_max) %>%
    select(file_id,
           date,
           year,
           month,
           lat,
           lon,
           profile_range,
           depth, 
           prof_measure = h_plus,
           clim_measure = clim_h_plus,
           anomaly = anomaly_h_plus
           )

  # ---------------------------------------------------------------------------------------------
  # read data extreme data for later use
  # ---------------------------------------------------------------------------------------------
  # load previously created OceanSODA extreme data. date, position and nature of extreme
  if (opt_extreme_determination == 1){
  extreme_data <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_pH_anomaly_field_01.rds")) %>%
    select(lon, lat, date, extreme_flag = ph_extreme)
  } else if (opt_extreme_determination == 2){
  extreme_data <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_pH_anomaly_field_02.rds")) %>%
    select(lon, lat, date, extreme_flag = ph_extreme)
  }

  # ---------------------------------------------------------------------------------------------
  # Associated data restrictions and formatting
  # ---------------------------------------------------------------------------------------------
  # What is the max depth of each profile_range
  opt_max_depth <- c(614, 1225, 1600)
    
  # opt_measure_label, opt_xlim and opt_xbreaks are associated with formatting
  opt_measure_label <- expression("[H]"^"+" ~ "anomaly")
  opt_xlim <- c(-2e-9, 2e-9)
  opt_xbreaks <- c(-2e-9, -1e-9, 0, 1e-9, 2e-9)
  
  # adjusted to be in scale -1 to 1
  opt_measure_label_adjusted <- expression("adjusted [H]"^"+" ~ "anomaly")
  opt_xlim_adjusted <- c(-1, 1)
  opt_xbreaks_adjusted <- c(-1.0, -0.5, 0, 0.5, 1.0)

  # Chl-a formatting
  opt_chla_measure_label <- expression("chlorophyll a ( mg m"^"-3"~")")
  opt_chla_xlim <- c(-0.5, 2.0)
  opt_chla_xbreaks <- c(-0.5, 0, 0.5, 1.0, 1.5, 2.0)
  
  # oxygen formatting
  opt_doxy_measure_label <- expression("dissolved oxygen ( µmol kg"^"-1"~")")

  # nitrate formatting
  opt_nitrate_measure_label <- expression("nitrate ( µmol kg"^"-1"~")")

  # Under extreme analysis
  opt_extreme_analysis <- TRUE
  
}

```

```{r prep_bgc_ph_ph}

if (opt_category == "bgc_ph_ph") {
  
  # ---------------------------------------------------------------------------------------------
  # spatial restrictions
  # ---------------------------------------------------------------------------------------------
  # Southern ocean
  opt_lat_min <- -90
  opt_lat_max <- -30
  opt_lon_min <- 20
  opt_lon_max <- 380
  
  # Mapping latitude limits
  opt_map_lat_limit <- c(-85,-30) # SO

  # ---------------------------------------------------------------------------------------------
  # read data - ph with analysis based on ph
  # ---------------------------------------------------------------------------------------------
  # read data, applying geographical limits and standardize field names.
  anomaly_va <-
    read_rds(file = paste0(path_argo_preprocessed, "/pH_anomaly_va.rds")) %>%
    filter (lat >= opt_lat_min &
            lat <= opt_lat_max &
            lon >= opt_lon_min &
            lon <= opt_lon_max) %>%
    select(file_id,
           date,
           year,
           month,
           lat,
           lon,
           profile_range,
           depth, 
           prof_measure = pH,
           clim_measure = clim_pH,
           anomaly = anomaly_pH
           )

  # ---------------------------------------------------------------------------------------------
  # read data extreme data for later use
  # ---------------------------------------------------------------------------------------------
  # load previously created OceanSODA extreme data. date, position and nature of extreme
  if (opt_extreme_determination == 1){
  extreme_data <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_pH_anomaly_field_01.rds")) %>%
    select(lon, lat, date, extreme_flag = ph_extreme)
  } else if (opt_extreme_determination == 2){
  extreme_data <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_pH_anomaly_field_02.rds")) %>%
    select(lon, lat, date, extreme_flag = ph_extreme)
  }

  # ---------------------------------------------------------------------------------------------
  # Associated data restrictions and formatting
  # ---------------------------------------------------------------------------------------------
  # What is the max depth of each profile_range
  opt_max_depth <- c(614, 1225, 1600)
    
  # opt_measure_label, opt_xlim and opt_xbreaks are associated with formatting
  opt_measure_label <- "pH anomaly"
  opt_xlim <- c(-0.08, 0.08)
  opt_xbreaks <- c(-0.08, -0.04, 0, 0.04, 0.08)
  
  # adjusted to be in scale -1 to 1
  opt_measure_label_adjusted <- "adjusted pH anomaly"
  opt_xlim_adjusted <- c(-1, 1)
  opt_xbreaks_adjusted <- c(-1.0, -0.5, 0, 0.5, 1.0)

  # Chl-a formatting
  opt_chla_measure_label <- expression("chlorophyll a ( mg m"^"-3"~")")
  opt_chla_xlim <- c(-0.5, 2.0)
  opt_chla_xbreaks <- c(-0.5, 0, 0.5, 1.0, 1.5, 2.0)
  
  # oxygen formatting
  opt_doxy_measure_label <- expression("dissolved oxygen ( µmol kg"^"-1"~")")

  # nitrate formatting
  opt_nitrate_measure_label <- expression("nitrate ( µmol kg"^"-1"~")")
    
  # Under extreme analysis
  opt_extreme_analysis <- TRUE
  
}

```

```{r prep_bgc_doxy}

if (opt_category == "bgc_doxy") {
  
  # ---------------------------------------------------------------------------------------------
  # spatial restrictions
  # ---------------------------------------------------------------------------------------------
  # global
  opt_lat_min <- -90
  opt_lat_max <- 90
  opt_lon_min <- 20
  opt_lon_max <- 380
  
  # Mapping latitude limits
  opt_map_lat_limit <- c(-85, 85) # global
  
  # ---------------------------------------------------------------------------------------------
  # read data - bgc oxygen must have a ph profile
  # ---------------------------------------------------------------------------------------------
  # read data, applying geographical limits and standardize field names.
  anomaly_va <-
    read_rds(file = paste0(path_argo_preprocessed, "/doxy_anomaly_va.rds")) %>%
    filter (lat >= opt_lat_min &
            lat <= opt_lat_max &
            lon >= opt_lon_min &
            lon <= opt_lon_max) %>%
    select(file_id,
           date,
           year,
           month,
           lat,
           lon,
           profile_range,
           depth, 
           prof_measure = doxy,
           clim_measure = clim_doxy,
           anomaly
           )
  
  # ---------------------------------------------------------------------------------------------
  # Associated data restrictions and formatting
  # ---------------------------------------------------------------------------------------------
  # What is the max depth of each profile_range
  opt_max_depth <- c(600, 1000, 1500)
  
  # opt_measure_label, opt_xlim and opt_xbreaks are associated with formatting
  opt_measure_label <- expression("dissolved oxygen anomaly ( µmol kg"^"-1"~")")
  opt_xlim <- c(-20, 20)
  opt_xbreaks <- c(-20, -10, 0, 10, 20)

  # adjusted to be in scale -1 to 1
  opt_measure_label_adjusted <- "adjusted oxygen anomaly"
  opt_xlim_adjusted <- c(-1, 1)
  opt_xbreaks_adjusted <- c(-1.0, -0.5, 0, 0.5, 1.0)

  # Under extreme analysis
  opt_extreme_analysis <- FALSE
  
}

```

## Data preparation

```{r prep_cluster_data}

# select profile based on profile_range and the appropriate max depth
anomaly_va <- anomaly_va %>% 
  filter(profile_range == opt_profile_range & depth <= opt_max_depth[opt_profile_range])

# Simplified table ready to pivot
anomaly_va_id <- anomaly_va %>%
  select(file_id,
         depth,
         anomaly,
         year, 
         month, 
         lat, 
         lon)

# wide table with each depth becoming a column
anomaly_va_wide <- anomaly_va_id %>%
  select(file_id, depth, anomaly) %>%
  pivot_wider(names_from = depth, values_from = anomaly)

# Drop any rows with missing values N/A caused by gaps in climatology data
anomaly_va_wide <- anomaly_va_wide %>% 
  drop_na()

# Table for cluster analysis
points <- anomaly_va_wide %>%
  column_to_rownames(var = "file_id")

# normalisation?
if (opt_norm_anomaly) {
  
  # Get the maximum anomaly for each profile - the normalisation will then fit -1 to 1
  anomaly_va_id_normalised <- anomaly_va_id %>%
    group_by(file_id) %>%
    mutate(abs_ma = max(abs(anomaly))) %>%
    ungroup()
  
  # divide each anomaly by the maximum anomaly
  anomaly_va_id_normalised <- anomaly_va_id_normalised %>%
    mutate(anomaly = anomaly/abs_ma)
    
  # wide table with each depth becoming a column
  anomaly_va_wide <- anomaly_va_id_normalised %>%
    select(file_id, depth, anomaly) %>%
    pivot_wider(names_from = depth, values_from = anomaly)
  
  # Drop any rows with missing values N/A caused by gaps in climatology data
  anomaly_va_wide <- anomaly_va_wide %>% 
    drop_na()
  
  # Table for cluster analysis
  points_normalised <- anomaly_va_wide %>%
    column_to_rownames(var = "file_id")

}

```

## Cluster analysis

### Cluster means

Based on all floats regardless of surface condition.

```{r cluster_analysis_cluster_details}

for (iType in 1:2) {
  for (inum_clusters in opt_num_clusters_min[opt_profile_range]:opt_num_clusters_max[opt_profile_range]) {
    if (iType == 1) {

      set.seed(1)
      kclusts <-
        tibble(k = inum_clusters) %>%
        mutate(kclust = map(k, ~ kmeans(points, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
          tidied = map(kclust, tidy),
          glanced = map(kclust, glance),
          augmented = map(kclust, augment, points)
        )
      
      profile_id <-
        kclusts %>%
        unnest(cols = c(augmented)) %>%
        select(file_id = .rownames,
               cluster = .cluster) %>%
        mutate(file_id = as.numeric(file_id),
               cluster = as.character(cluster))
      
      # Add cluster to anomaly_va_id
      anomaly_cluster <-
        full_join(anomaly_va_id, profile_id)
      
      # Add profile_type field
      anomaly_cluster <- anomaly_cluster %>%
        mutate(profile_type = 'base')
      
      # Check null clusters
      anomaly_cluster <- anomaly_cluster %>%
        filter(!is.na(cluster))
      
      # Create table to be used for later analysis and Set the number of clusters field
      if (!exists('anomaly_cluster_all')) {
        anomaly_cluster_all <- anomaly_cluster %>%
          mutate(num_clusters = inum_clusters)
      } else {
        anomaly_cluster_all <-
          rbind(
            anomaly_cluster_all,
            anomaly_cluster %>%
              mutate(num_clusters = inum_clusters)
          )
      }
      
    } else if (iType == 2 & opt_norm_anomaly) {

      set.seed(1)
      kclusts <-
        tibble(k = inum_clusters) %>%
        mutate(kclust = map(k, ~ kmeans(points_normalised, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
          tidied = map(kclust, tidy),
          glanced = map(kclust, glance),
          augmented = map(kclust, augment, points)
        )
      
      profile_id <-
        kclusts %>%
        unnest(cols = c(augmented)) %>%
        select(file_id = .rownames,
               cluster = .cluster) %>%
        mutate(file_id = as.numeric(file_id),
               cluster = as.character(cluster))
      
      # Add cluster to anomaly_va
      anomaly_cluster_norm <-
        full_join(anomaly_va_id_normalised %>% select(-c(abs_ma)) ,
                  profile_id)
      
      # Add profile_type field
      anomaly_cluster_norm <- anomaly_cluster_norm %>%
        mutate(profile_type = 'adjusted')
      
      # Check null clusters
      anomaly_cluster_norm <- anomaly_cluster_norm %>%
        filter(!is.na(cluster))
      
      # Create table to be used for later analysis and Set the number of clusters field
      if (!exists('anomaly_cluster_all')) {
        anomaly_cluster_all <- anomaly_cluster_norm %>%
          mutate(num_clusters = inum_clusters)
      } else {
        anomaly_cluster_all <-
          rbind(
            anomaly_cluster_all,
            anomaly_cluster_norm %>%
              mutate(num_clusters = inum_clusters)
          )
      }
      
    }
    
  }
}

# Prepare to plot cluster mean
anomaly_cluster_mean <- anomaly_cluster_all %>%
  group_by(profile_type, num_clusters, cluster, depth) %>%
  summarise(
    count_cluster = n(),
    anomaly_mean = mean(anomaly, na.rm = TRUE),
    anomaly_sd = sd(anomaly, na.rm = TRUE)
  ) %>%
  ungroup()

anomaly_cluster_mean_year <- anomaly_cluster_all %>%
  group_by(profile_type, num_clusters, cluster, depth, year) %>%
  summarise(
    count_cluster = n(),
    anomaly_mean = mean(anomaly, na.rm = TRUE),
    anomaly_sd = sd(anomaly, na.rm = TRUE)
  ) %>%
  ungroup()

anomaly_year_mean <- anomaly_cluster_all %>%
  group_by(profile_type, num_clusters, cluster, year) %>%
  summarise(
    count_cluster = n(),
    anomaly_mean = mean(anomaly, na.rm = TRUE),
    anomaly_sd = sd(anomaly, na.rm = TRUE)
  ) %>%
  ungroup()

anomaly_year_mean <- anomaly_year_mean %>%
  group_by(profile_type, num_clusters, year) %>%
  summarise(anomaly_mean = mean(anomaly_mean, na.rm = TRUE)) %>%
  ungroup ()

# Determine profile count by cluster and year
# Count the measurements
cluster_by_year <- anomaly_cluster_all %>% 
  count(profile_type, num_clusters, file_id, cluster, year,
        name = "count_cluster")

# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(profile_type, num_clusters, cluster, year,
        name = "count_cluster")

# total of each type of cluster
cluster_count <- cluster_by_year %>%
  group_by(profile_type, num_clusters, cluster) %>% 
  summarise(count_profiles = sum(count_cluster)) %>%
  ungroup()

anomaly_cluster_mean <- left_join(anomaly_cluster_mean, cluster_count)

```

Base profiles

```{r cluster_analysis_means}

# create figure of cluster mean profiles
anomaly_cluster_mean %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters) %>%
  map(
    ~ ggplot(data = .x,) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(
        aes(
          xmax = anomaly_mean + anomaly_sd,
          xmin = anomaly_mean - anomaly_sd,
          y = depth
        ),
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(breaks = opt_xbreaks) +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      )
  )

```

Adjusted profiles

```{r cluster_analysis_means_adj}

if (opt_norm_anomaly) {

  # repeat for adjusted profiles profiles
  anomaly_cluster_mean %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x,) +
        geom_path(aes(x = anomaly_mean,
                      y = depth)) +
        geom_ribbon(
          aes(
            xmax = anomaly_mean + anomaly_sd,
            xmin = anomaly_mean - anomaly_sd,
            y = depth
          ),
          alpha = 0.2
        ) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )
}

```

### Cluster mean by year

```{r cluster_mean_year}

# cluster means by year
anomaly_cluster_mean_year %>%
  filter (profile_type == "base") %>%
  mutate(year = as.factor(year)) %>%
  group_split(profile_type, num_clusters) %>%
  map(
    ~ ggplot(data = .x, ) +
      geom_path(aes(
        x = anomaly_mean,
        y = depth,
        col = year
      )) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap(~ cluster) +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(breaks = opt_xbreaks) +
      scale_color_viridis_d() +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      )
  )

```

Adjusted profiles

```{r cluster_mean_year_adj}

if (opt_norm_anomaly) {
  
  # Repeat for adjusted profiles
  anomaly_cluster_mean_year %>%
    filter (profile_type == "adjusted") %>%
    mutate(year = as.factor(year)) %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x, ) +
        geom_path(aes(
          x = anomaly_mean,
          y = depth,
          col = year
        )) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ cluster) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        scale_color_viridis_d() +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )
  
}
    
```

### Cluster by year

count of each cluster by year

```{r cluster_by_year}

year_min <- min(cluster_by_year$year)
year_max <- max(cluster_by_year$year)

# create figure
cluster_by_year %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters) %>%
  map(
    ~ ggplot(data = .x, aes(
        x = year,
        y = count_cluster,
        col = cluster,
        group = cluster
      )) +
      geom_point() +
      geom_line() +
      scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
      scale_color_brewer(palette = 'Dark2') +
      labs(
        title = paste0(
          'Count of profiles by year and cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = 'year',
        y = 'number of profiles',
        col = 'cluster'
      )
  )

```

Adjusted profiles

```{r cluster_by_year_adj}

if (opt_norm_anomaly) {

  year_min <- min(cluster_by_year$year)
  year_max <- max(cluster_by_year$year)
  
  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x, aes(
          x = year,
          y = count_cluster,
          col = cluster,
          group = cluster
        )) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'Count of profiles by year and cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = 'year',
          y = 'number of profiles',
          col = 'cluster'
        )
    )
  
}

```

### Cluster by month

count of each cluster by month of year

```{r cluster_by_month}

# Determine profile count by cluster and year
# Count the measurements
cluster_by_year <- anomaly_cluster_all %>% 
  count(profile_type, num_clusters, file_id, cluster, month,
        name = "count_cluster")

# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(profile_type, num_clusters, cluster, month,
        name = "count_cluster")

# create figure
cluster_by_year %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = month,
        y = count_cluster,
        col = cluster,
        group = cluster
      )
    ) +
      geom_point() +
      geom_line() +
      scale_x_continuous(breaks = seq(1, 12, 2)) +
      scale_color_brewer(palette = 'Dark2') +
      labs(
        title = paste0(
          'Count of profiles by month and cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = 'month',
        y = 'number of profiles',
        col = 'cluster'
      )
  )

```

Adjusted profiles

```{r cluster_by_month_adj}

if (opt_norm_anomaly) {

  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(
        data = .x,
        aes(
          x = month,
          y = count_cluster,
          col = cluster,
          group = cluster
        )
      ) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(1, 12, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'Count of profiles by month and cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = 'month',
          y = 'number of profiles',
          col = 'cluster'
        )
    )
  
}

```

### Cluster spatial

location of each cluster on map, spatial analysis

```{r spatial_cluster_01}

# create figure
anomaly_cluster_all %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(
                  x = lon,
                  y = lat,
                  fill = cluster
                )) +
      lims(y = opt_map_lat_limit) +
      scale_fill_brewer(palette = 'Dark2') +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
      )
  )

```

Adjusted profiles

```{r spatial_cluster_01_adj}

if (opt_norm_anomaly) {

  # create figure
  anomaly_cluster_all %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ map +
        geom_tile(data = .x,
                  aes(
                    x = lon,
                    y = lat,
                    fill = cluster
                  )) +
        lims(y = opt_map_lat_limit) +
        scale_fill_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
        )
    )
  
}

```

### Cluster spatial counts

count of measurements for each cluster on separate maps, spatial analysis

```{r spatial_cluster_03}

# Count profiles    
cluster_by_location <- anomaly_cluster_all %>%
  count(profile_type, num_clusters, file_id, lat, lon, cluster,
        name = "count_cluster")

# # Add cluster counts to 
cluster_by_location <- left_join(cluster_by_location, cluster_count)
    
# create figure
cluster_by_location %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters) %>%
  map(
    ~ map +
      geom_tile(data = .x %>%
                  count(lat, lon, cluster, count_profiles),
                aes(
                  x = lon,
                  y = lat,
                  fill = n
                )) +
      lims(y = opt_map_lat_limit) +
      scale_fill_gradient(low = "blue",
                          high = "red",
                          trans = "log10") +
      facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")"), ncol = 2) +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        )
      )
  )

```

Adjusted profiles

```{r spatial_cluster_03_adj}

if (opt_norm_anomaly) {

  # create figure
  cluster_by_location %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ map +
        geom_tile(data = .x %>%
                    count(lat, lon, cluster, count_profiles),
                  aes(
                    x = lon,
                    y = lat,
                    fill = n
                  )) +
        lims(y = opt_map_lat_limit) +
        scale_fill_gradient(low = "blue",
                            high = "red",
                            trans = "log10") +
        facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")"), ncol = 2) +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          )
        )
    )
  
}
```

### pH and Chl-a

for each cluster identified by pH cluster analysis show  alongside chl-a

```{r ph_with_chla}
if (opt_category == "bgc_ph_ph" | opt_category == "bgc_ph_h_plus") {

  # Read chl-a data and link to cluster ID
  chla_bgc_va <- read_rds(file = paste0(path_argo_preprocessed, "/chla_bgc_va.rds"))
  chla_cluster <-
    full_join(
      chla_bgc_va,
      anomaly_cluster_all %>% distinct (file_id, cluster, profile_type, num_clusters)
    ) %>% filter(!is.na(cluster))

  # summarise by cluster
  chla_cluster_mean <- chla_cluster %>%
    group_by(cluster, profile_type, num_clusters, depth) %>%
    summarise(
      chla_mean = mean(chla, na.rm = TRUE),
      chla_sd = sd(chla, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    select(
      cluster,
      profile_type,
      num_clusters,
      chla_depth = depth,
      chla_mean,
      chla_sd
    )

  # join pH anomaly with chl-a
  cluster_ph_chla <- full_join(anomaly_cluster_mean, chla_cluster_mean)
  chla_color <- "#69b3a2"

  if (opt_category == "bgc_ph_ph"){
    chla_to_ph_factor <- 25
    chla_to_ph_offset <- 1
  } else {
    chla_to_ph_factor <- 1e9
    chla_to_ph_offset <- 1
  }

  # Add the cluster count information
  cluster_ph_chla <- left_join(cluster_ph_chla, cluster_count)

  cluster_ph_chla %>% 
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(aes(
        xmax = anomaly_mean + anomaly_sd,
        xmin = anomaly_mean - anomaly_sd,
        y = depth
      ),
      alpha = 0.2) +
      geom_path(aes(
        x = (chla_mean - chla_to_ph_offset) / chla_to_ph_factor,
        y = chla_depth
      ), color = chla_color) +
      geom_ribbon(
        aes(
          xmax = (chla_mean + chla_sd - chla_to_ph_offset) / chla_to_ph_factor,
          xmin = (chla_mean - chla_sd - chla_to_ph_offset) / chla_to_ph_factor,
          y = chla_depth
        ),
        fill = chla_color,
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
      facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")"),
                  strip.position = "right") +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(
        # First axis
        name = opt_measure_label,
        breaks = opt_xbreaks,
        # Second axis
        sec.axis = sec_axis(
          trans =  ~ . * chla_to_ph_factor + chla_to_ph_offset,
          name = opt_chla_measure_label
        )
      ) +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      ) +
      theme(axis.title.x.top = element_text(color = chla_color),
            axis.text.x.top = element_text(color = chla_color))
    )

}

```

Adjusted profiles

```{r ph_with_chla_adj}
if (opt_category == "bgc_ph_ph" | opt_category == "bgc_ph_h_plus") {
  
  if (opt_category == "bgc_ph_ph"){
    chla_to_ph_factor <- 1
    chla_to_ph_offset <- 0.5
  } else {
    chla_to_ph_factor <- 1
    chla_to_ph_offset <- 0.5
  }
  
  cluster_ph_chla %>% 
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(aes(
        xmax = anomaly_mean + anomaly_sd,
        xmin = anomaly_mean - anomaly_sd,
        y = depth
      ),
      alpha = 0.2) +
      geom_path(aes(
        x = (chla_mean - chla_to_ph_offset) / chla_to_ph_factor,
        y = chla_depth
      ), color = chla_color) +
      geom_ribbon(
        aes(
          xmax = (chla_mean + chla_sd - chla_to_ph_offset) / chla_to_ph_factor,
          xmin = (chla_mean - chla_sd - chla_to_ph_offset) / chla_to_ph_factor,
          y = chla_depth
        ),
        fill = chla_color,
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
      facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")"),
                  strip.position = "right") +
      coord_cartesian(xlim = opt_xlim_adjusted) +
      scale_x_continuous(
        # First axis
        name = opt_measure_label_adjusted,
        breaks = opt_xbreaks_adjusted,
        # Second axis
        sec.axis = sec_axis(
          trans =  ~ . * chla_to_ph_factor + chla_to_ph_offset,
          name = opt_chla_measure_label
        )
      ) +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label_adjusted,
        y = 'depth (m)'
      ) +
      theme(axis.title.x.top = element_text(color = chla_color),
            axis.text.x.top = element_text(color = chla_color))
    )

}

```

### pH and oxygen anomaly

for each cluster identified by pH cluster analysis show alongside oxygen anomaly

```{r ph_with_oxygen}
if (opt_category == "bgc_ph_ph" | opt_category == "bgc_ph_h_plus") {
  
  # Read oxygen anomaly data and link to cluster information
  doxy_bgc_va <- read_rds(file = paste0(path_argo_preprocessed, "/doxy_anomaly_va.rds"))
  doxy_cluster <-
    full_join(
      doxy_bgc_va,
      anomaly_cluster_all %>% distinct (file_id, cluster, profile_type, num_clusters)
    ) %>% filter(!is.na(cluster))
  
  # summarise by cluster, , profile_type, num_clusters
  doxy_cluster_mean <- doxy_cluster %>%
    group_by(cluster, profile_type, num_clusters, depth) %>%
    summarise(
      doxy_anomaly_mean = mean(anomaly, na.rm = TRUE),
      doxy_anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    select(
      cluster,
      profile_type,
      num_clusters,
      doxy_depth = depth,
      doxy_anomaly_mean,
      doxy_anomaly_sd
    )
  

  # join pH anomaly with oxygen
  #anomaly_cluster_mean
  cluster_ph_doxy <- full_join(anomaly_cluster_mean, doxy_cluster_mean)
  doxy_color <- "#5B9BD5"

  if (opt_category == "bgc_ph_ph"){
    doxy_to_ph_factor <- 250
    doxy_to_ph_offset <- 0
  } else {
    doxy_to_ph_factor <- 1e10
    doxy_to_ph_offset <- 0
  }

  # Add the cluster count information
  cluster_ph_doxy <- left_join(cluster_ph_doxy, cluster_count)
    
  cluster_ph_doxy %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(aes(
        xmax = anomaly_mean + anomaly_sd,
        xmin = anomaly_mean - anomaly_sd,
        y = depth
      ),
      alpha = 0.2) +
      geom_path(aes(
        x = (doxy_anomaly_mean - doxy_to_ph_offset)  / doxy_to_ph_factor,
        y = doxy_depth
      ), color = doxy_color) +
      geom_ribbon(
        aes(
          xmax = (doxy_anomaly_mean + doxy_anomaly_sd - doxy_to_ph_offset) / doxy_to_ph_factor,
          xmin = (doxy_anomaly_mean - doxy_anomaly_sd - doxy_to_ph_offset) / doxy_to_ph_factor,
          y = doxy_depth
        ),
        fill = doxy_color,
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")"),
                  strip.position = "right") +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(
        # First axis
        name = opt_measure_label,
        breaks = opt_xbreaks,
        # First axis
        sec.axis = sec_axis(
          trans =  ~ . * doxy_to_ph_factor + doxy_to_ph_offset,
          name = opt_doxy_measure_label
        )
      ) +
      labs(        
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label, 
        y = 'depth (m)'
        ) +
      theme(axis.title.x.top = element_text(color = doxy_color),
            axis.text.x.top = element_text(color = doxy_color))
    )
  
}

```

Adjusted profiles

```{r ph_with_oxygen_adj}

if (opt_category == "bgc_ph_ph" | opt_category == "bgc_ph_h_plus") {

  if (opt_category == "bgc_ph_ph"){
    doxy_to_ph_factor <- 20
    doxy_to_ph_offset <- 0
  } else {
    doxy_to_ph_factor <- 20
    doxy_to_ph_offset <- 0
  }
  
  cluster_ph_doxy %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(aes(
        xmax = anomaly_mean + anomaly_sd,
        xmin = anomaly_mean - anomaly_sd,
        y = depth
      ),
      alpha = 0.2) +
      geom_path(aes(
        x = (doxy_anomaly_mean - doxy_to_ph_offset)  / doxy_to_ph_factor,
        y = doxy_depth
      ), color = doxy_color) +
      geom_ribbon(
        aes(
          xmax = (doxy_anomaly_mean + doxy_anomaly_sd - doxy_to_ph_offset) / doxy_to_ph_factor,
          xmin = (doxy_anomaly_mean - doxy_anomaly_sd - doxy_to_ph_offset) / doxy_to_ph_factor,
          y = doxy_depth
        ),
        fill = doxy_color,
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")"),
                  strip.position = "right") +
      coord_cartesian(xlim = opt_xlim_adjusted) +
      scale_x_continuous(
        # First axis
        name = opt_measure_label_adjusted,
        breaks = opt_xbreaks_adjusted,
        # First axis
        sec.axis = sec_axis(
          trans =  ~ . * doxy_to_ph_factor + doxy_to_ph_offset,
          name = opt_doxy_measure_label
        )
      ) +
      labs(        
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label_adjusted, 
        y = 'depth (m)'
        ) +
      theme(axis.title.x.top = element_text(color = doxy_color),
            axis.text.x.top = element_text(color = doxy_color))
    )
  
}

```

### pH and nitrate anomaly

for each cluster identified by pH cluster analysis show alongside nitrate anomaly

```{r ph_with_nitrate}
if (opt_category == "bgc_ph_ph" | opt_category == "bgc_ph_h_plus") {
  
  # Read oxygen anomaly data and link to cluster information
  nitrate_bgc_va <- read_rds(file = paste0(path_argo_preprocessed, "/nitrate_anomaly_va.rds"))
  nitrate_cluster <-
    full_join(
      nitrate_bgc_va,
      anomaly_cluster_all %>% distinct (file_id, cluster, profile_type, num_clusters)
    ) %>% filter(!is.na(cluster))
  
  # summarise by cluster, , profile_type, num_clusters
  nitrate_cluster_mean <- nitrate_cluster %>%
    group_by(cluster, profile_type, num_clusters, depth) %>%
    summarise(
      nitrate_anomaly_mean = mean(anomaly, na.rm = TRUE),
      nitrate_anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    select(
      cluster,
      profile_type,
      num_clusters,
      nitrate_depth = depth,
      nitrate_anomaly_mean,
      nitrate_anomaly_sd
    )
  

  # join pH anomaly with nitrate
  #anomaly_cluster_mean
  cluster_ph_nitrate <- full_join(anomaly_cluster_mean, nitrate_cluster_mean)
  nitrate_color <- "#ED7D31"

  if (opt_category == "bgc_ph_ph"){
    nitrate_to_ph_factor <- 75
    nitrate_to_ph_offset <- 0
  } else {
    nitrate_to_ph_factor <- 3e9
    nitrate_to_ph_offset <- 0
  }
  
  # Add the cluster count information
  cluster_ph_nitrate <- left_join(cluster_ph_nitrate, cluster_count)
    
  cluster_ph_nitrate %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(aes(
        xmax = anomaly_mean + anomaly_sd,
        xmin = anomaly_mean - anomaly_sd,
        y = depth
      ),
      alpha = 0.2) +
      geom_path(aes(
        x = (nitrate_anomaly_mean - nitrate_to_ph_offset)  / nitrate_to_ph_factor,
        y = nitrate_depth
      ), color = nitrate_color) +
      geom_ribbon(
        aes(
          xmax = (nitrate_anomaly_mean + nitrate_anomaly_sd - nitrate_to_ph_offset) / nitrate_to_ph_factor,
          xmin = (nitrate_anomaly_mean - nitrate_anomaly_sd - nitrate_to_ph_offset) / nitrate_to_ph_factor,
          y = nitrate_depth
        ),
        fill = nitrate_color,
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")"),
                  strip.position = "right") +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(
        # First axis
        name = opt_measure_label,
        breaks = opt_xbreaks,
        # First axis
        sec.axis = sec_axis(
          trans =  ~ . * nitrate_to_ph_factor + nitrate_to_ph_offset,
          name = opt_nitrate_measure_label
        )
      ) +
      labs(        
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label, 
        y = 'depth (m)'
        ) +
      theme(axis.title.x.top = element_text(color = nitrate_color),
            axis.text.x.top = element_text(color = nitrate_color))
    )
  
}

```

Adjusted profiles

```{r ph_with_nitrate_adj}

if (opt_category == "bgc_ph_ph" | opt_category == "bgc_ph_h_plus") {

  if (opt_category == "bgc_ph_ph"){
    nitrate_to_ph_factor <- 6
    nitrate_to_ph_offset <- 0
  } else {
    nitrate_to_ph_factor <- 6
    nitrate_to_ph_offset <- 0
  }
  
  cluster_ph_nitrate %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(aes(
        xmax = anomaly_mean + anomaly_sd,
        xmin = anomaly_mean - anomaly_sd,
        y = depth
      ),
      alpha = 0.2) +
      geom_path(aes(
        x = (nitrate_anomaly_mean - nitrate_to_ph_offset)  / nitrate_to_ph_factor,
        y = nitrate_depth
      ), color = nitrate_color) +
      geom_ribbon(
        aes(
          xmax = (nitrate_anomaly_mean + nitrate_anomaly_sd - nitrate_to_ph_offset) / nitrate_to_ph_factor,
          xmin = (nitrate_anomaly_mean - nitrate_anomaly_sd - nitrate_to_ph_offset) / nitrate_to_ph_factor,
          y = nitrate_depth
        ),
        fill = nitrate_color,
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")"),
                  strip.position = "right") +
      coord_cartesian(xlim = opt_xlim_adjusted) +
      scale_x_continuous(
        # First axis
        name = opt_measure_label_adjusted,
        breaks = opt_xbreaks_adjusted,
        # First axis
        sec.axis = sec_axis(
          trans =  ~ . * nitrate_to_ph_factor + nitrate_to_ph_offset,
          name = opt_nitrate_measure_label
        )
      ) +
      labs(        
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label_adjusted, 
        y = 'depth (m)'
        ) +
      theme(axis.title.x.top = element_text(color = nitrate_color),
            axis.text.x.top = element_text(color = nitrate_color))
    )
  
}

```
  
## Cluster by surface Extreme

```{r cluster_analysis_prep_ext}

if (opt_extreme_analysis){
  
# date to match to ocean SODA
anomaly_va <- anomaly_va %>% 
  mutate(date = ymd(format(date, "%Y-%m-15")))

# Add the OceanSODA extreme condition
anomaly_va <- left_join(anomaly_va, extreme_data)

# If extreme is NA set it to N
anomaly_va <- anomaly_va %>% replace_na(list(extreme_flag = 'N'))
anomaly_va <- anomaly_va %>% mutate (profile_type = 'base')

# Create a replica data set with profile_type = adjusted 
if (opt_norm_anomaly){
  
  # mark as adjusted
  anomaly_va_norm <- anomaly_va %>% mutate (profile_type = 'adjusted')

  # Get the maximum anomaly for each profile - the normalisation will then fit -1 to 1
  anomaly_va_norm <- anomaly_va_norm %>%
    group_by(file_id) %>%
    mutate(abs_ma = max(abs(anomaly))) %>%
    ungroup()

  # Carry out the adjustment
  anomaly_va_norm <- anomaly_va_norm %>%
    mutate(anomaly = anomaly/abs_ma)
  
  #remove the surface anomaly field
  anomaly_va_norm <- anomaly_va_norm %>% select(-c(abs_ma))
  
  # Append to base profiles
  anomaly_va <- rbind(anomaly_va, anomaly_va_norm)
  
}

profile_types <- c('adjusted', 'base')

# loop through profile_type
for (iprofile_type in 1:2) {
  
  sel_profile_type = profile_types[iprofile_type]
    
  # loop through surface condition
  for (i in 1:3) {

    # ---------------------------------------------------------------------------------------------
    # Preparation
    # ---------------------------------------------------------------------------------------------
    # select profile based on profile_range and he appropriate max depth
    anomaly_va_id <- anomaly_va %>%
      filter(profile_range == opt_profile_range & depth <= opt_max_depth[opt_profile_range] & extreme_flag == extreme_type[i] & profile_type == sel_profile_type)

    # Simplified table ready to pivot
    anomaly_va_id <- anomaly_va_id %>%
      select(file_id,
             depth,
             anomaly,
             year, 
             month, 
             lat, 
             lon)
    
    # wide table with each depth becoming a column
    anomaly_va_wide <- anomaly_va_id %>%
      select(file_id, depth, anomaly) %>%
      pivot_wider(names_from = depth, values_from = anomaly)
    
    # Drop any rows with missing values N/A caused by gaps in climatology data
    anomaly_va_wide <- anomaly_va_wide %>% 
      drop_na()
    
    # Table for cluster analysis
    points <- anomaly_va_wide %>%
      column_to_rownames(var = "file_id")
    
    # ---------------------------------------------------------------------------------------------
    # cluster analysis
    # ---------------------------------------------------------------------------------------------
    # loop through number of clusters
    for (inum_clusters in opt_num_clusters_ext_min[i]:opt_num_clusters_ext_max[i]) {    

      set.seed(1)
      kclusts <-
        tibble(k = inum_clusters) %>%
        mutate(
          kclust = map(k, ~ kmeans(points, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
          tidied = map(kclust, tidy),
          glanced = map(kclust, glance),
          augmented = map(kclust, augment, points)
        )
      
      profile_id <-
        kclusts %>%
        unnest(cols = c(augmented)) %>%
        select(file_id = .rownames,
               cluster = .cluster) %>% 
        mutate(file_id = as.numeric(file_id),
               cluster = as.character(cluster))
      
      # Add cluster to anomaly_va
      anomaly_cluster <- full_join(anomaly_va_id, profile_id)
      
      # Plot cluster mean
      anomaly_cluster <- anomaly_cluster %>% 
        filter(!is.na(cluster))
      
      # cluster mean
      anomaly_cluster_mean <- anomaly_cluster %>%
        group_by(cluster, depth) %>%
        summarise(
          count_cluster = n(),
          anomaly_mean = mean(anomaly, na.rm = TRUE),
          anomaly_sd = sd(anomaly, na.rm = TRUE)
        ) %>%
        ungroup()
      
      anomaly_cluster_mean_year <- anomaly_cluster %>%
        group_by(cluster, depth, year) %>%
        summarise(
          count_cluster = n(),
          anomaly_mean = mean(anomaly, na.rm = TRUE),
          anomaly_sd = sd(anomaly, na.rm = TRUE)
        ) %>%
        ungroup()
      
      anomaly_year_mean <- anomaly_cluster %>%
        group_by(cluster, year) %>%
        summarise(
          count_cluster = n(),
          anomaly_mean = mean(anomaly, na.rm = TRUE),
          anomaly_sd = sd(anomaly, na.rm = TRUE)
        ) %>%
        ungroup()
      
      anomaly_year_mean <- anomaly_year_mean %>%
        group_by(year) %>%
        summarise(anomaly_mean = mean(anomaly_mean, na.rm = TRUE)) %>%
        ungroup ()
      
      if (!exists('anomaly_cluster_mean_ext')) {
        anomaly_cluster_mean_ext <-
          anomaly_cluster_mean %>% mutate(
            extreme_order = i,
            extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
        anomaly_cluster_mean_year_ext <-
          anomaly_cluster_mean_year %>% mutate(
            extreme_order = i,
            extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
        anomaly_year_mean_ext <-
          anomaly_year_mean %>% mutate(
            extreme_order = i,
            extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
        anomaly_cluster_ext <-
          anomaly_cluster %>% mutate(
            extreme_order = i,
            extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
      } else {
        anomaly_cluster_mean_ext <-
          rbind(
            anomaly_cluster_mean_ext,
            anomaly_cluster_mean %>% mutate(
              extreme_order = i,
              extreme = extreme_type[i],
              num_clusters = inum_clusters,
              profile_type = sel_profile_type
            )
          )
        anomaly_cluster_mean_year_ext <-
          rbind(
            anomaly_cluster_mean_year_ext,
            anomaly_cluster_mean_year %>% mutate(
              extreme_order = i,
              extreme = extreme_type[i],
              num_clusters = inum_clusters,
              profile_type = sel_profile_type
            )
          )
        anomaly_year_mean_ext <-
          rbind(
            anomaly_year_mean_ext,
            anomaly_year_mean %>% mutate(
              extreme_order = i,
              extreme = extreme_type[i],
              num_clusters = inum_clusters,
              profile_type = sel_profile_type
            )
          )
        anomaly_cluster_ext <-
          rbind(
            anomaly_cluster_ext,
            anomaly_cluster_ext <-
              anomaly_cluster %>% mutate(
                extreme_order = i,
                extreme = extreme_type[i],
                num_clusters = inum_clusters,
                profile_type = sel_profile_type
              )
          )
      }
  
    }
    
  }
  
}
}

```

### Cluster means

```{r cluster_mean_ext}

if (opt_extreme_analysis){

# Determine profile count by cluster and year
# Count the measurements
cluster_by_year <- anomaly_cluster_ext %>% 
  count(profile_type, num_clusters, extreme, extreme_order, file_id, cluster, year,
        name = "count_cluster")

# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(profile_type, num_clusters, extreme, extreme_order, cluster, year,
        name = "count_cluster")

# total of each type of cluster
cluster_count <- cluster_by_year %>%
  group_by(profile_type, num_clusters, extreme, extreme_order, cluster) %>% 
  summarise(count_profiles = sum(count_cluster)) %>%
  ungroup()

anomaly_cluster_mean_ext <- left_join(anomaly_cluster_mean_ext, cluster_count)
  
# create figure of cluster mean profiles
anomaly_cluster_mean_ext %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, extreme_order) %>%
  map(
    ~  ggplot(data = .x, ) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(
        aes(
          xmax = anomaly_mean + anomaly_sd,
          xmin = anomaly_mean - anomaly_sd,
          y = depth
        ),
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      #facet_wrap(~ cluster) +
      facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(breaks = opt_xbreaks) +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      )
  )
}

```

Adjusted profiles

```{r cluster_mean_ext_adj}

if (opt_extreme_analysis){

if (opt_norm_anomaly) {

  # create figure of cluster mean profiles
  anomaly_cluster_mean_ext %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, extreme_order) %>%
    map(
      ~  ggplot(data = .x, ) +
        geom_path(aes(x = anomaly_mean,
                      y = depth)) +
        geom_ribbon(
          aes(
            xmax = anomaly_mean + anomaly_sd,
            xmin = anomaly_mean - anomaly_sd,
            y = depth
          ),
          alpha = 0.2
        ) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        #facet_wrap(~ cluster) +
        facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )

}
}

```

### Clusters mean by year

```{r cluster_mean_year_ext}

if (opt_extreme_analysis){

# cluster means by year
anomaly_cluster_mean_year_ext %>%
  filter (profile_type == "base") %>%
  mutate(year = as.factor(year)) %>%
  group_split(profile_type, num_clusters, extreme_order) %>%
  map(
    ~  ggplot(data = .x,) +
      geom_path(aes(
        x = anomaly_mean,
        y = depth,
        col = year
      )) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap(~ cluster) +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(breaks = opt_xbreaks) +
      scale_color_viridis_d() +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster by year \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      )
  )
}

```

Adjusted profiles

```{r cluster_mean_year_ext_adj}

if (opt_extreme_analysis){

if (opt_norm_anomaly) {

  # cluster means by year
  anomaly_cluster_mean_year_ext %>%
    filter (profile_type == "adjusted") %>%
    mutate(year = as.factor(year)) %>%
    group_split(profile_type, num_clusters, extreme_order) %>%
    map(
      ~  ggplot(data = .x,) +
        geom_path(aes(
          x = anomaly_mean,
          y = depth,
          col = year
        )) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ cluster) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        scale_color_viridis_d() +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster by year \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )

}
}

```

### Cluster by year

count of each cluster by year

```{r cluster_by_year_ext}

if (opt_extreme_analysis){

# Determine profile count by extreme and cluster and year
# Count the measurements
cluster_by_year <- anomaly_cluster_ext %>% 
  count(file_id, profile_type, num_clusters, extreme_order, extreme, cluster, year,
        name = "count_cluster")
# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(profile_type, num_clusters, extreme_order, extreme, cluster, year,
        name = "count_cluster")

year_min <- min(cluster_by_year$year)
year_max <- max(cluster_by_year$year)

# create figure
cluster_by_year %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, extreme_order) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = year,
        y = count_cluster,
        col = cluster,
        group = cluster
      )
    ) +
      geom_point() +
      geom_line() +
      scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
      scale_color_brewer(palette = 'Dark2') +
      labs(
        x = 'year',
        y = 'number of profiles',
        col = 'cluster',
        title = paste0(
          'Count of profiles by year and cluster \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )
}

```

Adjusted profiles

```{r cluster_by_year_ext_adj}

if (opt_extreme_analysis){

if (opt_norm_anomaly) {

  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, extreme_order) %>%
    map(
      ~ ggplot(
        data = .x,
        aes(
          x = year,
          y = count_cluster,
          col = cluster,
          group = cluster
        )
      ) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          x = 'year',
          y = 'number of profiles',
          col = 'cluster',
          title = paste0(
            'Count of profiles by year and cluster \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )
    
}
}

```

### Cluster by month

count of each cluster by month of year

```{r cluster_by_month_ext}

if (opt_extreme_analysis){

# Determine profile count by cluster and year
# Count the measurements
cluster_by_year <- anomaly_cluster_ext %>% 
  count(file_id, profile_type, num_clusters, extreme_order, extreme, cluster, month,
        name = "count_cluster")
# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(profile_type, num_clusters, extreme_order, extreme, cluster, month,
        name = "count_cluster")

# create figure
cluster_by_year %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, extreme_order) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = month,
        y = count_cluster,
        col = cluster,
        group = cluster
      )
    ) +
      geom_point() +
      geom_line() +
      scale_x_continuous(breaks = seq(1, 12, 2)) +
      scale_color_brewer(palette = 'Dark2') +
      labs(
        x = 'month',
        y = 'number of profiles',
        col = 'cluster',
        title = paste0(
          'Count of profiles by month and cluster \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )
}

```

Adjusted profiles

```{r cluster_by_month_ext_adj}

if (opt_extreme_analysis){

if (opt_norm_anomaly) {

  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, extreme_order) %>%
    map(
      ~ ggplot(
        data = .x,
        aes(
          x = month,
          y = count_cluster,
          col = cluster,
          group = cluster
        )
      ) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(1, 12, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          x = 'month',
          y = 'number of profiles',
          col = 'cluster',
          title = paste0(
            'Count of profiles by month and cluster \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )
  
}
}

```

### Cluster spatial

location of each cluster on map, spatial analysis

```{r spatial_cluster_combined_ext}

if (opt_extreme_analysis){

# create figure combined
anomaly_cluster_ext %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, extreme_order) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(
                  x = lon,
                  y = lat,
                  fill = cluster
                )) +
      lims(y = opt_map_lat_limit) +
      scale_fill_brewer(palette = 'Dark2') +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )
}

```

Adjusted profiles

```{r spatial_cluster_combined_ext_adj}

if (opt_extreme_analysis){

if (opt_norm_anomaly) {

  # create figure combined
  anomaly_cluster_ext %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, extreme_order) %>%
    map(
      ~ map +
        geom_tile(data = .x,
                  aes(
                    x = lon,
                    y = lat,
                    fill = cluster
                  )) +
        lims(y = opt_map_lat_limit) +
        scale_fill_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )

}
}

```

### Cluster spatial counts

location of each cluster on map, spatial analysis

```{r spatial_cluster_count_ext}

if (opt_extreme_analysis){

# Count profiles    
cluster_by_location <- anomaly_cluster_ext %>%
  count(profile_type, num_clusters, extreme_order, extreme, file_id, lat, lon, cluster,
        name = "count_cluster")

# # Add cluster counts to 
cluster_by_location <- left_join(cluster_by_location, cluster_count)
    
# create figure
cluster_by_location %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, extreme_order) %>%
  map(
    ~ map +
      geom_tile(data = .x %>%
                  count(lat, lon, cluster, count_profiles),
                aes(
                  x = lon,
                  y = lat,
                  fill = n
                )) +
      lims(y = opt_map_lat_limit) +
      scale_fill_gradient(low = "blue",
                          high = "red",
                          trans = "log10") +
    facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")"), ncol = 2) +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )
}
```

Adjusted profiles

```{r spatial_cluster_count_ext_adj}

if (opt_extreme_analysis){

if (opt_norm_anomaly) {

  cluster_by_location %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, extreme_order) %>%
    map(
      ~ map +
        geom_tile(data = .x %>%
                    count(lat, lon, cluster, count_profiles),
                  aes(
                    x = lon,
                    y = lat,
                    fill = n
                  )) +
        lims(y = opt_map_lat_limit) +
        scale_fill_gradient(low = "blue",
                            high = "red",
                            trans = "log10") +
        facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")"), ncol = 2) +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )
    
}    
}

```

