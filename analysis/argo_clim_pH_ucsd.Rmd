---
title: "UCSD Argo pH Climatology"
author: "Pasqualina Vonlanthen & Jens Daniel MÃ¼ller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Task 

Explore the January climatology of Argo pH of Matt Mazloff, UCSD 

```{r load_libraries}
library(tidyverse)
library(ggOceanMaps)
library(oce)
library(ncdf4)
```

# Load data 

```{r set_paths}
path_updata <- "/nfs/kryo/work/updata"
path_argo_clim_ph <- paste0(path_updata, "/argo_climatology/pH")
path_argo_clim_temp <- paste0(path_updata, "/argo_climatology/temperature")
path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"

theme_set(theme_bw())
```


```{r load_argo_ph_climatology}

# load in the ucsd climatology for january

# 581 880 obs of 5 variables, with columns:
# pH (range from )
# nx (range from 1 to 360)
# ny (range from 1 to 46)
# nz (range from 1 to 42)
# t (value 1, corresponds to month 1 -> january)

#range(clim_argo_ph_jan$nx)
# 1 - 360 
#range(clim_argo_ph_jan$ny)
# 1 - 46
#table(clim_argo_ph_jan$ny)
#range(clim_argo_ph_jan$nz)
# 1 - 42 
#range(clim_argo_ph_jan$t)
# 1 (january only)
#table(is.na(clim_argo_ph_jan$pH))
# no NA pH values
#table(round(clim_argo_ph_jan$pH, digits = 0))
# 6516 occurrences of pH = 0

# clim_argo_ph_jan <- nc_open(paste0(path_argo_clim_ph,
#                                             "/PHclim_15March2022_Prelim.nc"))
# print(clim_argo_ph_jan)
# lon <- ncvar_get(clim_argo_ph_jan, 'nx')
# nlon <- dim(clim_argo_ph_jan$nx)
# lat <- ncvar_get(clim_argo_ph_jan, 'ny')
# nlat <- dim(clim_argo_ph_jan$ny)


clim_argo_ph_jan <- tidync::hyper_tibble(paste0(path_argo_clim_ph,
                                            "/PHclim_15March2022_Prelim.nc"))

clim_argo_ph_jan <- clim_argo_ph_jan %>% 
  mutate(nx = as.double(nx),
         ny = as.double(ny),
         nz = as.double(nz)) %>% 
  mutate(lon = case_when(nx < 20 ~ nx +360,
                         TRUE ~ nx))

# range(clim_argo_ph_jan$lon)
# 20 to 279 


map <-
  read_rds(paste(path_emlr_utilities,
                 "map_landmask_WOA18.rds",
                 sep = ""))
```

Plot the climatological pH profiles for January 

```{r plot_jan_pH_profiles}

clim_argo_ph_jan %>% 
  filter(pH != 0) %>% 
  ggplot(aes(x = pH,
             y = nz))+
  geom_point(aes(x = pH,
                 y = nz),
             size = 0.3)+
  scale_y_reverse()

```

Location of observations: 

```{r plot_map_of_observations}

map+
  geom_point(data = clim_argo_ph_jan %>% filter(nz == 1),
             aes(x = lon, 
                 y = ny),
             size = 0.2, 
             alpha = 0.2)+
  geom_point(data = clim_argo_ph_jan %>% filter(nz == 1,
                                                ny == 1),
            aes(x = lon,
                y = ny),
            size = 0.3,
            col = 'blue')+
  geom_point(data = clim_argo_ph_jan %>% filter(nz == 1,
                                                ny == 46),
             aes(x = lon, 
                 y = ny),
             size = 0.3, 
             col = 'red')

# the 46th latitude level is the northernmost latitude (ny = 46, lat = -30?)
# the 1st latitude level is the southernmost latitude (ny = 1, lat = -75?)

# clim_argo_ph_jan %>% 
#   mutate(lat = case_when(ny == 1 ~ -75,
#                          ny == 46 ~ -30,
#                          TRUE ~ 0))

# clim_argo_ph_jan %>% 
#   mutate(lat = case_when(ny == seq(1, 46, 1) ~ seq(-75, -30, 1)))
# 
# clim_argo_ph_jan %>% 
#   mutate(lat = replace(ny, c(1:581880), seq(-75, -30, 1)))



```
