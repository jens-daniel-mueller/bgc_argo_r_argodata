---
title: "BGC temperature cluster analysis"
author: "David Stappard & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```

# Tasks

This markdown file carries out cluster analysis on previously created bgc temperature anomaly profiles.

The cluster_analysis_determine_k chunk is used to give an indication of an appropriate number of clusers and this can then set the option opt_num_clusters. Chunk cluster_analysis_cluster_details carried out the cluster analysis and the results are used in subsequent figures.

```{r loading_libraries, include=FALSE}

library(tidyverse)
library(argodata)
library(lubridate)
library(gridExtra)
library(gsw)
library(ggforce)
library(ggpmisc)
library(tidymodels)

```

## Set directories

location of pre-prepared data

```{r set_updata_root_directory, include=FALSE}

path_argo <- '/nfs/kryo/work/datasets/ungridded/3d/ocean/floats/bgc_argo'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"

```

## Set options

Define options that are used to determine what analysis is done

```{r set_options}

# Options

# opt_analysis_type
# opt_analysis_type = 1 do analysis to determine number of clusters to use
# opt_analysis_type = 2 do cluster analysis and further analysis on the identified clusters clusters
opt_analysis_type <- 2

# opt_num_clusters
# How many clusters are used in the cluster analysis for each depth 1 (600 m), 2 (1000 m) and 3 (1500 m)
opt_num_clusters_min <- c(8, 8, 1)
opt_num_clusters_max <- c(8, 8, 8)
# What is the max depth of each profile_range
opt_max_depth <- c(600, 1000, 1500)
# Which profile range is used
opt_profile_range <- 3

# opt_measure_label, opt_xlim and opt_xbreaks are associated with formatting
opt_measure_label <- "temperature anomaly (°C)"
opt_xlim <- c(-4.5, 4.5)
opt_xbreaks <- c(-4, -2, 0, 2, 4)

# adjusted to be in scale -1 to 1
opt_measure_label_adjusted <- "adjusted temperature anomaly"
opt_xlim_adjusted <- c(-1, 1)
opt_xbreaks_adjusted <- c(-1.0, -0.5, 0, 0.5, 1.0)

# options relating to cluster analysis
opt_n_start <- 15
opt_max_iterations <- 500
opt_n_clusters <- 14 # Max number of clusters to try when determining optimal number of clusters

# opt_extreme_determination
# 1 - based on the trend of de-seasonal data - we believe this results in more summer extremes where variation tend to be greater.
# 2 - based on the trend of de-seasonal data by month. grouping is by lat, lon and month.
opt_extreme_determination <- 2

# Options associated with profiles under surface extreme conditions
# Carried out for 1500m profiles
opt_profile_range = 3
extreme_type <- c('L', 'N', 'H')
opt_num_clusters_ext_min <- c(1, 1, 1)
opt_num_clusters_ext_max <- c(6, 6, 6)

# Option related to normalising the anomaly profiles.
# TRUE - anomaly profiles are normalised by the surface anomaly. Every depth anomaly is divided by the surface anomaly.
#      - The is only carried out for profiles where the abs(surface temp) > 1.
#      - This analysis is carried out in addition to the analysis on base anomaly profiles.  
# FALSE - The normalisation process is not carried out. 
opt_norm_anomaly <- TRUE

```


```{r set_global_theme, include=TRUE}

theme_set(theme_bw())

map <-
  read_rds(paste(path_emlr_utilities,
                 "map_landmask_WOA18.rds",
                 sep = ""))

```
## Cluster analysis

### Preparation

Prepare data for cluster analysis

```{r cluster_analysis_prep}

# read data
temp_anomaly_va <- read_rds(file = paste0(path_argo_preprocessed, "/temp_anomaly_va.rds"))

# select profile based on profile_range and he appropriate max depth
temp_anomaly_va <- temp_anomaly_va %>% 
  filter(profile_range == opt_profile_range & depth <= opt_max_depth[opt_profile_range])

# Simplified table ready to pivot
temp_anomaly_va_id <- temp_anomaly_va %>%
  select(file_id,
         depth,
         anomaly,
         year, 
         month, 
         lat, 
         lon)

# wide table with each depth becoming a column
temp_anomaly_va_wide <- temp_anomaly_va_id %>%
  select(file_id, depth, anomaly) %>%
  pivot_wider(names_from = depth, values_from = anomaly)

# Drop any rows with missing values N/A caused by gaps in climatology data
temp_anomaly_va_wide <- temp_anomaly_va_wide %>% 
  drop_na()

# Table for cluster analysis
points <- temp_anomaly_va_wide %>%
  column_to_rownames(var = "file_id")

# normalisation?
if (opt_norm_anomaly) {
  
  surf_anomaly <- abs(temp_anomaly_va_id %>% 
    filter (depth == 5) %>%
    select (file_id, abs_sa = anomaly))
  
  # Get the maximum anomaly for each profile - the normalisation will then fit max to 1
  surf_anomaly <- temp_anomaly_va_id %>%
    group_by(file_id) %>%
    summarise(abs_sa = max(abs(anomaly))) %>%
    ungroup() %>%
    select (file_id, abs_sa)

  temp_anomaly_va_id_normalised <- left_join(temp_anomaly_va_id, surf_anomaly)
  
  #temp_anomaly_va_id_normalised <- temp_anomaly_va_id_normalised %>%
  #  mutate(anomaly = if_else(abs_sa > 1.0, anomaly/abs_sa, anomaly))
  temp_anomaly_va_id_normalised <- temp_anomaly_va_id_normalised %>%
    mutate(anomaly = anomaly/abs_sa)
    
  # wide table with each depth becoming a column
  temp_anomaly_va_wide <- temp_anomaly_va_id_normalised %>%
    select(file_id, depth, anomaly) %>%
    pivot_wider(names_from = depth, values_from = anomaly)
  
  # Drop any rows with missing values N/A caused by gaps in climatology data
  temp_anomaly_va_wide <- temp_anomaly_va_wide %>% 
    drop_na()
  
  # Table for cluster analysis
  points_normalised <- temp_anomaly_va_wide %>%
    column_to_rownames(var = "file_id")

}

```

### Number of clusters

```{r cluster_analysis_determine_k}

if (opt_analysis_type == 1) {


  # cluster analysis - What k? try between 1 and opt_n_clusters clusters
  kclusts <- 
  tibble(k = 1:opt_n_clusters) %>%
  mutate(
    kclust = map(k, ~kmeans(points, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
    tidied = map(kclust, tidy),
    glanced = map(kclust, glance),
    augmented = map(kclust, augment, points)
  )
  

  # cluster analysis data
  # clusters <-
  #   kclusts %>%
  #   unnest(cols = c(tidied))
  # 
  # assignments <-
  #   kclusts %>%
  #   unnest(cols = c(augmented))
  
  clusterings <-
    kclusts %>%
    unnest(cols = c(glanced))
  
  # What cluster works best?
  clusterings %>%
  ggplot(aes(k, tot.withinss)) +
    geom_line() +
    geom_point() +
    scale_x_continuous(breaks = c(2, 4, 6, 8, 10, 12, 14)) +
    labs(
      title = paste0('within ss by number of clusters: ', opt_max_depth[i_range], ' m profiles'),
      x = 'number of clusters',
      y = 'within ss'
    )

}

```

### Cluster analysis

Based on all floats regardless of surface condition.

```{r cluster_analysis_cluster_details}

if (opt_analysis_type == 2) {
  
  for (iType in 1:2) {
    for (inum_clusters in opt_num_clusters_min[opt_profile_range]:opt_num_clusters_max[opt_profile_range]) {
      if (iType == 1) {

        set.seed(1)
        kclusts <-
          tibble(k = inum_clusters) %>%
          mutate(kclust = map(k, ~ kmeans(points, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
            tidied = map(kclust, tidy),
            glanced = map(kclust, glance),
            augmented = map(kclust, augment, points)
          )
        
        profile_id <-
          kclusts %>%
          unnest(cols = c(augmented)) %>%
          select(file_id = .rownames,
                 cluster = .cluster) %>%
          mutate(file_id = as.numeric(file_id),
                 cluster = as.character(cluster))
        
        # Add cluster to temp_anomaly_va
        temp_anomaly_cluster <-
          full_join(temp_anomaly_va_id, profile_id)
        
        # Add profile_type field
        temp_anomaly_cluster <- temp_anomaly_cluster %>%
          mutate(profile_type = 'base')
        
        # Check null clusters
        temp_anomaly_cluster <- temp_anomaly_cluster %>%
          filter(!is.na(cluster))
        
        # Create table to be used for later analysis and Set the number of clusters field
        if (!exists('temp_anomaly_cluster_all')) {
          temp_anomaly_cluster_all <- temp_anomaly_cluster %>%
            mutate(num_clusters = inum_clusters)
        } else {
          temp_anomaly_cluster_all <-
            rbind(
              temp_anomaly_cluster_all,
              temp_anomaly_cluster %>%
                mutate(num_clusters = inum_clusters)
            )
        }
        
      } else if (iType == 2 & opt_norm_anomaly) {

        set.seed(1)
        kclusts <-
          tibble(k = inum_clusters) %>%
          mutate(kclust = map(k, ~ kmeans(points_normalised, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
            tidied = map(kclust, tidy),
            glanced = map(kclust, glance),
            augmented = map(kclust, augment, points)
          )
        
        profile_id <-
          kclusts %>%
          unnest(cols = c(augmented)) %>%
          select(file_id = .rownames,
                 cluster = .cluster) %>%
          mutate(file_id = as.numeric(file_id),
                 cluster = as.character(cluster))
        
        # Add cluster to temp_anomaly_va
        temp_anomaly_cluster_norm <-
          full_join(temp_anomaly_va_id_normalised %>% select(-c(abs_sa)) ,
                    profile_id)
        
        # Add profile_type field
        temp_anomaly_cluster_norm <- temp_anomaly_cluster_norm %>%
          mutate(profile_type = 'adjusted')
        
        # Check null clusters
        temp_anomaly_cluster_norm <- temp_anomaly_cluster_norm %>%
          filter(!is.na(cluster))
        
        # Create table to be used for later analysis and Set the number of clusters field
        if (!exists('temp_anomaly_cluster_all')) {
          temp_anomaly_cluster_all <- temp_anomaly_cluster_norm %>%
            mutate(num_clusters = inum_clusters)
        } else {
          temp_anomaly_cluster_all <-
            rbind(
              temp_anomaly_cluster_all,
              temp_anomaly_cluster_norm %>%
                mutate(num_clusters = inum_clusters)
            )
        }
        
      }
      
    }
  }
  
  # Plot cluster mean
  anomaly_cluster_mean <- temp_anomaly_cluster_all %>%
    group_by(profile_type, num_clusters, cluster, depth) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_cluster_mean_year <- temp_anomaly_cluster_all %>%
    group_by(profile_type, num_clusters, cluster, depth, year) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_year_mean <- temp_anomaly_cluster_all %>%
    group_by(profile_type, num_clusters, cluster, year) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_year_mean <- anomaly_year_mean %>%
    group_by(profile_type, num_clusters, year) %>%
    summarise(anomaly_mean = mean(anomaly_mean, na.rm = TRUE)) %>%
    ungroup ()

  # Determine profile count by cluster and year
  # Count the measurements
  cluster_by_year <- temp_anomaly_cluster_all %>% 
    count(profile_type, num_clusters, file_id, cluster, year,
          name = "count_cluster")

  # Convert to profiles
  cluster_by_year <- cluster_by_year %>% 
    count(profile_type, num_clusters, cluster, year,
          name = "count_cluster")
  
  # total of each type of cluster
  cluster_count <- cluster_by_year %>%
    group_by(profile_type, num_clusters, cluster) %>% 
    summarise(count_profiles = sum(count_cluster)) %>%
    ungroup()
  
  anomaly_cluster_mean <- left_join(anomaly_cluster_mean, cluster_count)
  
  # create figure of cluster mean profiles
  anomaly_cluster_mean %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x,) +
        geom_path(aes(x = anomaly_mean,
                      y = depth)) +
        geom_ribbon(
          aes(
            xmax = anomaly_mean + anomaly_sd,
            xmin = anomaly_mean - anomaly_sd,
            y = depth
          ),
          alpha = 0.2
        ) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
        coord_cartesian(xlim = opt_xlim) +
        scale_x_continuous(breaks = opt_xbreaks) +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = opt_measure_label,
          y = 'depth (m)'
        )
    )
}

```

Adjusted profiles

```{r cluster_analysis_cluster_details_adj}

if (opt_norm_anomaly) {

  # repeat for adjusted profiles profiles
  anomaly_cluster_mean %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x,) +
        geom_path(aes(x = anomaly_mean,
                      y = depth)) +
        geom_ribbon(
          aes(
            xmax = anomaly_mean + anomaly_sd,
            xmin = anomaly_mean - anomaly_sd,
            y = depth
          ),
          alpha = 0.2
        ) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )
}

```
### Cluster mean by year

```{r cluster_mean_year}

if (opt_analysis_type == 2) {

  # cluster means by year
  anomaly_cluster_mean_year %>%
    filter (profile_type == "base") %>%
    mutate(year = as.factor(year)) %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x, ) +
        geom_path(aes(
          x = anomaly_mean,
          y = depth,
          col = year
        )) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ cluster) +
        coord_cartesian(xlim = opt_xlim) +
        scale_x_continuous(breaks = opt_xbreaks) +
        scale_color_viridis_d() +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = opt_measure_label,
          y = 'depth (m)'
        )
    )
}

```

Adjusted profiles

```{r cluster_mean_year_adj}

if (opt_norm_anomaly) {
  
  # Repeat for adjusted profiles
  anomaly_cluster_mean_year %>%
    filter (profile_type == "adjusted") %>%
    mutate(year = as.factor(year)) %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x, ) +
        geom_path(aes(
          x = anomaly_mean,
          y = depth,
          col = year
        )) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ cluster) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        scale_color_viridis_d() +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )
  
}
    
```

### Cluster climatology

```{r cluster_climatology_shift, eval=FALSE}

# A nice short alternative, uses the package ggpmisc
anomaly_year_mean %>%
  ggplot(aes(x = year,
             y = anomaly_mean)) +
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2","P", "n"))) +
  geom_point()
  
```

### Cluster by year

count of each cluster by year

```{r cluster_by_year}

if (opt_analysis_type == 2) {

  year_min <- min(cluster_by_year$year)
  year_max <- max(cluster_by_year$year)
  
  # create figure
  cluster_by_year %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x, aes(
          x = year,
          y = count_cluster,
          col = cluster,
          group = cluster
        )) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'Count of profiles by year and cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = 'year',
          y = 'number of profiles',
          col = 'cluster'
        )
    )
  
}

```

Adjusted profiles

```{r cluster_by_year_adj}

if (opt_norm_anomaly) {

  year_min <- min(cluster_by_year$year)
  year_max <- max(cluster_by_year$year)
  
  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x, aes(
          x = year,
          y = count_cluster,
          col = cluster,
          group = cluster
        )) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'Count of profiles by year and cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = 'year',
          y = 'number of profiles',
          col = 'cluster'
        )
    )
  
}

```

### Cluster by month

count of each cluster by month of year

```{r cluster_by_month}

if (opt_analysis_type == 2) {

  # Determine profile count by cluster and year
  # Count the measurements
  cluster_by_year <- temp_anomaly_cluster_all %>% 
    count(profile_type, num_clusters, file_id, cluster, month,
          name = "count_cluster")

  # Convert to profiles
  cluster_by_year <- cluster_by_year %>% 
    count(profile_type, num_clusters, cluster, month,
          name = "count_cluster")

  # create figure
  cluster_by_year %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(
        data = .x,
        aes(
          x = month,
          y = count_cluster,
          col = cluster,
          group = cluster
        )
      ) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(1, 12, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'Count of profiles by month and cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = 'month',
          y = 'number of profiles',
          col = 'cluster'
        )
    )
  
}

```

Adjusted profiles

```{r cluster_by_month_adj}

if (opt_norm_anomaly) {

  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(
        data = .x,
        aes(
          x = month,
          y = count_cluster,
          col = cluster,
          group = cluster
        )
      ) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(1, 12, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'Count of profiles by month and cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = 'month',
          y = 'number of profiles',
          col = 'cluster'
        )
    )
  
}

```

### Cluster spatial

location of each cluster on map, spatial analysis

```{r spatial_cluster_01}

if (opt_analysis_type == 2) {

  # create figure
  temp_anomaly_cluster_all %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ map +
        geom_tile(data = .x,
                  aes(
                    x = lon,
                    y = lat,
                    fill = cluster
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
        )
    )
  
}

```

Adjusted profiles

```{r spatial_cluster_01_adj}

if (opt_norm_anomaly) {

  # create figure
  temp_anomaly_cluster_all %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ map +
        geom_tile(data = .x,
                  aes(
                    x = lon,
                    y = lat,
                    fill = cluster
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
        )
    )
  
}

```

location of each cluster on separate maps, spatial analysis

```{r spatial_cluster_02, eval=FALSE}

if (opt_analysis_type == 2) {

  # create figure
map +
  geom_tile(data = temp_anomaly_cluster,
            aes(x = lon,
                y = lat,
                fill = cluster)) +
  lims(y = c(-85, -30)) +
  scale_fill_brewer(palette = 'Dark2') +
  facet_wrap( ~ cluster, ncol = 2) +
  labs(title = 'cluster spatial distribution')

}
```

count of measurements for each cluster on separate maps, spatial analysis

```{r spatial_cluster_03}

if (opt_analysis_type == 2) {

  # Count profiles    
  cluster_by_location <- temp_anomaly_cluster_all %>%
    count(profile_type, num_clusters, file_id, lat, lon, cluster,
          name = "count_cluster")
  
  # create figure
  cluster_by_location %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ map +
        geom_tile(data = .x %>%
                    count(lat, lon, cluster),
                  aes(
                    x = lon,
                    y = lat,
                    fill = n
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_viridis_c(
          option = "cividis",
          direction = -1,
          trans = "log10"
        ) +
        facet_wrap(~ cluster, ncol = 2) +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          )
        )
    )

}

```

Adjusted profiles

```{r spatial_cluster_03_adj}

if (opt_norm_anomaly) {

  # create figure
  cluster_by_location %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ map +
        geom_tile(data = .x %>%
                    count(lat, lon, cluster),
                  aes(
                    x = lon,
                    y = lat,
                    fill = n
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_viridis_c(
          option = "cividis",
          direction = -1,
          trans = "log10"
        ) +
        facet_wrap(~ cluster, ncol = 2) +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          )
        )
    )
  
}
```

### Cluster spatial year

location of each cluster on map, spatial analysis by year

```{r spatial_cluster_year, eval=FALSE}

if (opt_analysis_type == 2) {

  # create figure
  temp_anomaly_cluster_all %>%
    group_split(profile_type, num_clusters, year) %>%
    map(
      ~ map +
        geom_tile(data = .x,
                  aes(
                    x = lon,
                    y = lat,
                    fill = cluster
                  )) +
        #lims(y = c(-85, -30))+
        scale_fill_brewer(palette = 'Dark2') +
        facet_wrap(~ cluster, ncol = 2) +
        labs(
          title = paste0(
            'cluster spatial distribution ', unique(.x$year), '\n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          )
        )
    )
      
}

```

## Cluster by surface Extreme

```{r cluster_analysis_prep_ext}

# ---------------------------------------------------------------------------------------------
# read data
# ---------------------------------------------------------------------------------------------
# load previously created OceanSODA extreme data. date, position and nature of extreme
if (opt_extreme_determination == 1){
  temp_extreme <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_SST_anomaly_field_01.rds")) %>%
    select(lon, lat, date, temp_extreme)
} else if (opt_extreme_determination == 2){
  temp_extreme <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_SST_anomaly_field_02.rds")) %>%
    select(lon, lat, date, temp_extreme)
}

# -------------------------------------------------------------------------------------------------------------
# Temp - review incidences of extremes based on method.
# -------------------------------------------------------------------------------------------------------------
# 
#   temp_extreme_info_01 <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_SST_anomaly_field_01.rds")) %>%
#     select(lon, lat, date, temp_extreme)
# 
# temp_extreme_info_01 <- temp_extreme_info_01 %>%
#   group_by(temp_extreme, date) %>%
#   summarise(n = n()) %>%
#   ungroup()
# 
# temp_extreme_info_01 %>%
#   filter (temp_extreme %in% c('H', 'L') & date >= '2013-01-01') %>%
#   ggplot(aes(
#            x = date,
#            y = n,
#            col = temp_extreme
#          )) +
#   geom_point() +
#   geom_line() +
#   lims(y = c(0,3200)) +
#   labs(
#     x = 'date',
#     y = 'number of extreme pixels',
#     col = 'extreme type',
#     title = paste0(
#       'Count of extreme pixels - single trend'
#     )
#   )
# 
# 
# temp_extreme_info_02 <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_SST_anomaly_field_02.rds")) %>%
#     select(lon, lat, date, temp_extreme)
# 
# temp_extreme_info_02 <- temp_extreme_info_02 %>%
#   group_by(temp_extreme, date) %>%
#   summarise(n = n()) %>%
#   ungroup()
# 
# temp_extreme_info_02 %>%
#   filter (temp_extreme %in% c('H', 'L') & date >= '2013-01-01') %>%
#   ggplot(aes(
#            x = date,
#            y = n,
#            col = temp_extreme
#          )) +
#   geom_point() +
#   geom_line() +
#   lims(y = c(0,3200)) +
#   labs(
#     x = 'date',
#     y = 'number of extreme pixels',
#     col = 'extreme type',
#     title = paste0(
#       'Count of extreme pixels - monthly trends'
#     )
#   )
#   
# -------------------------------------------------------------------------------------------------------------
  
# read data
temp_anomaly_va <- read_rds(file = paste0(path_argo_preprocessed, "/temp_anomaly_va.rds")) %>%
  mutate(date = ymd(format(date, "%Y-%m-15")))

# Add the OceanSODA extreme condition
temp_anomaly_va <- left_join(temp_anomaly_va, temp_extreme)

# If temp_extreme is NA set it to N
temp_anomaly_va <- temp_anomaly_va %>% replace_na(list(temp_extreme = 'N'))
temp_anomaly_va <- temp_anomaly_va %>% mutate (profile_type = 'base')

# Create a replica data set with profile_type = adjusted 
if (opt_norm_anomaly){
  # mark as adjusted
  temp_anomaly_va_norm <- temp_anomaly_va %>% mutate (profile_type = 'adjusted')

  # Determine surface anomaly for each profile
  # surf_anomaly <- abs(temp_anomaly_va_norm %>% 
  #   filter (depth == 5) %>%
  #   select (file_id, abs_sa = anomaly))

  # Get the maximum anomaly for each profile - the normalisation will then fit max to 1
  surf_anomaly <- temp_anomaly_va_id %>%
    group_by(file_id) %>%
    summarise(abs_sa = max(abs(anomaly))) %>%
    ungroup() %>%
    select (file_id, abs_sa)
  
  temp_anomaly_va_norm <- left_join(temp_anomaly_va_norm, surf_anomaly)
    
  # Carry out the adjustment
  #temp_anomaly_va_norm <- temp_anomaly_va_norm %>%
  #  mutate(anomaly = if_else(abs_sa > 1.0, anomaly/abs_sa, anomaly))
  temp_anomaly_va_norm <- temp_anomaly_va_norm %>%
    mutate(anomaly = anomaly/abs_sa)
  
  #remove the surface anomaly field
  temp_anomaly_va_norm <- temp_anomaly_va_norm %>% select(-c(abs_sa))
  
  # Append to base profiles
  temp_anomaly_va <- rbind(temp_anomaly_va, temp_anomaly_va_norm)
  
}

profile_types <- c('adjusted', 'base')

# loop through profile_type
for (iprofile_type in 1:2) {

  sel_profile_type = profile_types[iprofile_type]
    
  # loop through surface condition
  for (i in 1:3) {
  
    # ---------------------------------------------------------------------------------------------
    # Preparation
    # ---------------------------------------------------------------------------------------------
    # select profile based on profile_range and he appropriate max depth
    temp_anomaly_va_id <- temp_anomaly_va %>% 
      filter(profile_range == opt_profile_range & depth <= opt_max_depth[opt_profile_range] & temp_extreme == extreme_type[i] & profile_type == sel_profile_type)
    
    # Simplified table ready to pivot
    temp_anomaly_va_id <- temp_anomaly_va_id %>%
      select(file_id,
             depth,
             anomaly,
             year, 
             month, 
             lat, 
             lon)
    
    # wide table with each depth becoming a column
    temp_anomaly_va_wide <- temp_anomaly_va_id %>%
      select(file_id, depth, anomaly) %>%
      pivot_wider(names_from = depth, values_from = anomaly)
    
    # Drop any rows with missing values N/A caused by gaps in climatology data
    temp_anomaly_va_wide <- temp_anomaly_va_wide %>% 
      drop_na()
    
    # Table for cluster analysis
    points <- temp_anomaly_va_wide %>%
      column_to_rownames(var = "file_id")
    
    # ---------------------------------------------------------------------------------------------
    # cluster analysis
    # ---------------------------------------------------------------------------------------------
    # loop through number of clusters
    for (inum_clusters in opt_num_clusters_ext_min[i]:opt_num_clusters_ext_max[i]) {    
  
      set.seed(1)
      kclusts <-
        tibble(k = inum_clusters) %>%
        mutate(
          kclust = map(k, ~ kmeans(points, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
          tidied = map(kclust, tidy),
          glanced = map(kclust, glance),
          augmented = map(kclust, augment, points)
        )
      
      profile_id <-
        kclusts %>%
        unnest(cols = c(augmented)) %>%
        select(file_id = .rownames,
               cluster = .cluster) %>% 
        mutate(file_id = as.numeric(file_id),
               cluster = as.character(cluster))
      
      # Add cluster to temp_anomaly_va
      temp_anomaly_cluster <- full_join(temp_anomaly_va_id, profile_id)
      
      # Plot cluster mean
      temp_anomaly_cluster <- temp_anomaly_cluster %>% 
        filter(!is.na(cluster))
      
      # cluster mean
      anomaly_cluster_mean <- temp_anomaly_cluster %>%
        group_by(cluster, depth) %>%
        summarise(
          count_cluster = n(),
          anomaly_mean = mean(anomaly, na.rm = TRUE),
          anomaly_sd = sd(anomaly, na.rm = TRUE)
        ) %>%
        ungroup()
      
      anomaly_cluster_mean_year <- temp_anomaly_cluster %>%
        group_by(cluster, depth, year) %>%
        summarise(
          count_cluster = n(),
          anomaly_mean = mean(anomaly, na.rm = TRUE),
          anomaly_sd = sd(anomaly, na.rm = TRUE)
        ) %>%
        ungroup()
      
      anomaly_year_mean <- temp_anomaly_cluster %>%
        group_by(cluster, year) %>%
        summarise(
          count_cluster = n(),
          anomaly_mean = mean(anomaly, na.rm = TRUE),
          anomaly_sd = sd(anomaly, na.rm = TRUE)
        ) %>%
        ungroup()
      
      anomaly_year_mean <- anomaly_year_mean %>%
        group_by(year) %>%
        summarise(anomaly_mean = mean(anomaly_mean, na.rm = TRUE)) %>%
        ungroup ()
      
      if (!exists('anomaly_cluster_mean_ext')) {
        anomaly_cluster_mean_ext <-
          anomaly_cluster_mean %>% mutate(
            temp_extreme_order = i,
            temp_extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
        anomaly_cluster_mean_year_ext <-
          anomaly_cluster_mean_year %>% mutate(
            temp_extreme_order = i,
            temp_extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
        anomaly_year_mean_ext <-
          anomaly_year_mean %>% mutate(
            temp_extreme_order = i,
            temp_extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
        temp_anomaly_cluster_ext <-
          temp_anomaly_cluster %>% mutate(
            temp_extreme_order = i,
            temp_extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
      } else {
        anomaly_cluster_mean_ext <-
          rbind(
            anomaly_cluster_mean_ext,
            anomaly_cluster_mean %>% mutate(
              temp_extreme_order = i,
              temp_extreme = extreme_type[i],
              num_clusters = inum_clusters,
              profile_type = sel_profile_type
            )
          )
        anomaly_cluster_mean_year_ext <-
          rbind(
            anomaly_cluster_mean_year_ext,
            anomaly_cluster_mean_year %>% mutate(
              temp_extreme_order = i,
              temp_extreme = extreme_type[i],
              num_clusters = inum_clusters,
              profile_type = sel_profile_type
            )
          )
        anomaly_year_mean_ext <-
          rbind(
            anomaly_year_mean_ext,
            anomaly_year_mean %>% mutate(
              temp_extreme_order = i,
              temp_extreme = extreme_type[i],
              num_clusters = inum_clusters,
              profile_type = sel_profile_type
            )
          )
        temp_anomaly_cluster_ext <-
          rbind(
            temp_anomaly_cluster_ext,
            temp_anomaly_cluster_ext <-
              temp_anomaly_cluster %>% mutate(
                temp_extreme_order = i,
                temp_extreme = extreme_type[i],
                num_clusters = inum_clusters,
                profile_type = sel_profile_type
              )
          )
      }
  
    }
    
  }
  
}
```

### Cluster mean

```{r cluster_mean_ext}

# Determine profile count by cluster and year
# Count the measurements
cluster_by_year <- temp_anomaly_cluster_ext %>% 
  count(profile_type, num_clusters, temp_extreme, temp_extreme_order, file_id, cluster, year,
        name = "count_cluster")

#cluster_by_year %>% filter (num_clusters == 5 & temp_extreme == 'N')

# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(profile_type, num_clusters, temp_extreme, temp_extreme_order, cluster, year,
        name = "count_cluster")

# total of each type of cluster
cluster_count <- cluster_by_year %>%
  group_by(profile_type, num_clusters, temp_extreme, temp_extreme_order, cluster) %>% 
  summarise(count_profiles = sum(count_cluster)) %>%
  ungroup()

anomaly_cluster_mean_ext <- left_join(anomaly_cluster_mean_ext, cluster_count)
  
# create figure of cluster mean profiles
anomaly_cluster_mean_ext %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, temp_extreme_order) %>%
  map(
    ~  ggplot(data = .x, ) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(
        aes(
          xmax = anomaly_mean + anomaly_sd,
          xmin = anomaly_mean - anomaly_sd,
          y = depth
        ),
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      #facet_wrap(~ cluster) +
      facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(breaks = opt_xbreaks) +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$temp_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      )
  )

```

Adjusted profiles

```{r cluster_mean_ext_adj}

if (opt_norm_anomaly) {

  # create figure of cluster mean profiles
  anomaly_cluster_mean_ext %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, temp_extreme_order) %>%
    map(
      ~  ggplot(data = .x, ) +
        geom_path(aes(x = anomaly_mean,
                      y = depth)) +
        geom_ribbon(
          aes(
            xmax = anomaly_mean + anomaly_sd,
            xmin = anomaly_mean - anomaly_sd,
            y = depth
          ),
          alpha = 0.2
        ) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        #facet_wrap(~ cluster) +
        facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$temp_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )

}

```

### Clusters mean by year

```{r cluster_mean_year_ext}

# cluster means by year
anomaly_cluster_mean_year_ext %>%
  filter (profile_type == "base") %>%
  mutate(year = as.factor(year)) %>%
  group_split(profile_type, num_clusters, temp_extreme_order) %>%
  map(
    ~  ggplot(data = .x,) +
      geom_path(aes(
        x = anomaly_mean,
        y = depth,
        col = year
      )) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap(~ cluster) +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(breaks = opt_xbreaks) +
      scale_color_viridis_d() +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster by year \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$temp_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      )
  )

```

Adjusted profiles

```{r cluster_mean_year_ext_adj}

if (opt_norm_anomaly) {

  # cluster means by year
  anomaly_cluster_mean_year_ext %>%
    filter (profile_type == "adjusted") %>%
    mutate(year = as.factor(year)) %>%
    group_split(profile_type, num_clusters, temp_extreme_order) %>%
    map(
      ~  ggplot(data = .x,) +
        geom_path(aes(
          x = anomaly_mean,
          y = depth,
          col = year
        )) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ cluster) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        scale_color_viridis_d() +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster by year \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$temp_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )

}
```

### Cluster by year

count of each cluster by year

```{r cluster_by_year_ext}

# Determine profile count by extreme and cluster and year
# Count the measurements
cluster_by_year <- temp_anomaly_cluster_ext %>% 
  count(file_id, profile_type, num_clusters, temp_extreme_order, temp_extreme, cluster, year,
        name = "count_cluster")
# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(profile_type, num_clusters, temp_extreme_order, temp_extreme, cluster, year,
        name = "count_cluster")

year_min <- min(cluster_by_year$year)
year_max <- max(cluster_by_year$year)

# create figure
cluster_by_year %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, temp_extreme_order) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = year,
        y = count_cluster,
        col = cluster,
        group = cluster
      )
    ) +
      geom_point() +
      geom_line() +
      scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
      scale_color_brewer(palette = 'Dark2') +
      labs(
        x = 'year',
        y = 'number of profiles',
        col = 'cluster',
        title = paste0(
          'Count of profiles by year and cluster \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$temp_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )

```

Adjusted profiles

```{r cluster_by_year_ext_adj}

if (opt_norm_anomaly) {

  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, temp_extreme_order) %>%
    map(
      ~ ggplot(
        data = .x,
        aes(
          x = year,
          y = count_cluster,
          col = cluster,
          group = cluster
        )
      ) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          x = 'year',
          y = 'number of profiles',
          col = 'cluster',
          title = paste0(
            'Count of profiles by year and cluster \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$temp_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )
    
}

```

### Cluster by month

count of each cluster by month of year

```{r cluster_by_month_ext}

# Determine profile count by cluster and year
# Count the measurements
cluster_by_year <- temp_anomaly_cluster_ext %>% 
  count(file_id, profile_type, num_clusters, temp_extreme_order, temp_extreme, cluster, month,
        name = "count_cluster")
# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(profile_type, num_clusters, temp_extreme_order, temp_extreme, cluster, month,
        name = "count_cluster")

# create figure
cluster_by_year %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, temp_extreme_order) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = month,
        y = count_cluster,
        col = cluster,
        group = cluster
      )
    ) +
      geom_point() +
      geom_line() +
      scale_x_continuous(breaks = seq(1, 12, 2)) +
      scale_color_brewer(palette = 'Dark2') +
      labs(
        x = 'month',
        y = 'number of profiles',
        col = 'cluster',
        title = paste0(
          'Count of profiles by month and cluster \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$temp_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )

```

Adjusted profiles

```{r cluster_by_month_ext_adj}

if (opt_norm_anomaly) {

  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, temp_extreme_order) %>%
    map(
      ~ ggplot(
        data = .x,
        aes(
          x = month,
          y = count_cluster,
          col = cluster,
          group = cluster
        )
      ) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(1, 12, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          x = 'month',
          y = 'number of profiles',
          col = 'cluster',
          title = paste0(
            'Count of profiles by month and cluster \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$temp_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )
  
}

```

### Cluster spatial

location of each cluster on map, spatial analysis

```{r spatial_cluster_combined_ext}

# create figure combined
temp_anomaly_cluster_ext %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, temp_extreme_order) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(
                  x = lon,
                  y = lat,
                  fill = cluster
                )) +
      lims(y = c(-85,-30)) +
      scale_fill_brewer(palette = 'Dark2') +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$temp_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )

```

Adjusted profiles

```{r spatial_cluster_combined_ext_adj}

if (opt_norm_anomaly) {

  # create figure combined
  temp_anomaly_cluster_ext %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, temp_extreme_order) %>%
    map(
      ~ map +
        geom_tile(data = .x,
                  aes(
                    x = lon,
                    y = lat,
                    fill = cluster
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$temp_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )

}

```

### Spatial by cluster

location of each cluster on map, spatial analysis

```{r spatial_cluster_ext, eval=FALSE}

# create figure by cluster
temp_anomaly_cluster_ext %>%
  group_split(profile_type, num_clusters, temp_extreme_order) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(
                  x = lon,
                  y = lat,
                  fill = cluster
                )) +
      lims(y = c(-85,-30)) +
      scale_fill_brewer(palette = 'Dark2') +
      facet_wrap( ~ cluster, ncol = 2) +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$temp_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )

```

### Spatial count

location of each cluster on map, spatial analysis

```{r spatial_cluster_count_ext}

# Count profiles    
cluster_by_location <- temp_anomaly_cluster_ext %>%
  count(profile_type, num_clusters, temp_extreme_order, temp_extreme, file_id, lat, lon, cluster,
        name = "count_cluster")


# create figure
cluster_by_location %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, temp_extreme_order) %>%
  map(
    ~ map +
      geom_tile(data = .x %>%
                  count(lat, lon, cluster),
                aes(
                  x = lon,
                  y = lat,
                  fill = n
                )) +
      lims(y = c(-85,-30)) +
      scale_fill_viridis_c(
        option = "cividis",
        direction = -1,
        trans = "log10"
      ) +
      facet_wrap(~ cluster, ncol = 2) +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$temp_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )

```

Adjusted profiles

```{r spatial_cluster_count_ext_adj}

if (opt_norm_anomaly) {

  cluster_by_location %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, temp_extreme_order) %>%
    map(
      ~ map +
        geom_tile(data = .x %>%
                    count(lat, lon, cluster),
                  aes(
                    x = lon,
                    y = lat,
                    fill = n
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_viridis_c(
          option = "cividis",
          direction = -1,
          trans = "log10"
        ) +
        facet_wrap(~ cluster, ncol = 2) +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$temp_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )
    
}    
    
```

