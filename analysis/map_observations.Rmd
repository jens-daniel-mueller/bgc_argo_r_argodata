---
title: "Map BGC Argo observations"
author: "Pasqualina Vonlanthen & Jens Daniel MÃ¼ller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Task

Map the location of oxygen, pH, and nitrate observations recorded by BGC-Argo floats


```{r loading_packages}

library(tidyverse, quiet = TRUE)
library(argodata, quiet = TRUE)
library(ggplot2, quiet = TRUE)
library(lubridate, quiet = TRUE)
library(sf, quiet = TRUE)
library(rnaturalearth, quiet = TRUE)
library(rnaturalearthdata, quiet = TRUE)
# load in coastline data (uses sf and rnaturalearthdata packages)
world = ne_coastline(scale = 'medium', returnclass = 'sf')

```


```{r set_updata_root_directory, include=FALSE}

path_argo <- '/nfs/kryo/work/updata/bgc_argo_r_argodata'

```


# Load data

Read the files created in loading_data.html: 


```{r load_preprpocessed_data}

path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

bgc_subset <-
  read_rds(file = paste0(path_argo_preprocessed, "/bgc_subset.rds"))

bgc_metadata <-
  read_rds(file = paste0(path_argo_preprocessed, "/bgc_metadata.rds"))

bgc_data <-
  read_rds(file = paste0(path_argo_preprocessed, "/bgc_data.rds"))

bgc_merge <-
  read_rds(file = paste0(path_argo_preprocessed, "/bgc_merge.rds"))

```


```{r loading_data, eval=FALSE}
# Set the cache directory using argo_set_cache_dir():
argo_set_cache_dir('/nfs/kryo/work/updata/bgc_argo_r_argodata')
argo_update_global(max_global_cache_age = Inf)
argo_update_data(max_data_cache_age = Inf)

bgc_subset = argo_global_synthetic_prof() %>%
  argo_filter_data_mode(data_mode = 'delayed') %>%
  argo_filter_date(date_min = '2013-01-01',
                   date_max = '2015-12-31') # download the indexes of synthetic files of delayed-mode data (BGC and core argo data)

# check the dates 
# max(bgc_subset$date, na.rm = TRUE)
# min(bgc_subset$date, na.rm = TRUE)


bgc_data = argo_prof_levels(bgc_subset, vars = c('PRES_ADJUSTED','PRES_ADJUSTED_QC',
                                                 'PSAL_ADJUSTED', 'PSAL_ADJUSTED_QC',
                                                 'TEMP_ADJUSTED','TEMP_ADJUSTED_QC',
                                                 'DOXY_ADJUSTED', 'DOXY_ADJUSTED_QC',
                                                 'NITRATE_ADJUSTED', 'NITRATE_ADJUSTED_QC',
                                                 'PH_IN_SITU_TOTAL_ADJUSTED', 'PH_IN_SITU_TOTAL_ADJUSTED_QC'), quiet = TRUE)
# read in the profiles (takes a while)

bgc_metadata = argo_prof_prof(bgc_subset)  # load in the corresponding metadata

bgc_merge = left_join(bgc_data, bgc_metadata, by = c('file', 'n_prof'))
# joins the metadata to the data and creates one data frame
```

# MAP OF OBSERVATIONS  

Create separate dataframes for each variable, with longitude, latitude, date, value, cycle number, and float ID 

## Oxygen 

```{r create_oxygen_dataframe}

oxy = data.frame(bgc_merge$longitude, bgc_merge$latitude, bgc_merge$date,
                 bgc_merge$doxy_adjusted) # add longitude, latitude, date and oxygen to the dataframe 
colnames(oxy) = c('longitude','latitude','date', 'doxy_adjusted') # rename columns 

oxy = oxy %>%
  mutate(date.simple = as.Date(date),    # create one date and one time column
         time = format(date, '%H:%M:%S'),
         cycle = bgc_merge$cycle_number, # add cycle number and float ID 
         float_ID = bgc_merge$float_serial_no)

oxy.no.na = oxy %>%
  filter(!is.na(doxy_adjusted)) # remove the NA values

location_obs_oxy = oxy.no.na %>%
  group_by(round(longitude, digits = 0), round(latitude, digits = 0)) %>% 
  summarise(Count = n()) # count the number of data points per longitude/latitude pair, rounded to the nearest integer 

colnames(location_obs_oxy) = c('longitude', 'latitude', 'Count') # rename columns
```

Map the location of the oxygen observations 

```{r map_oxygen_observations}

ggplot() +
  geom_tile(data = location_obs_oxy, aes(x = longitude, y = latitude, fill = Count))+
  geom_sf(data = world, fill = 'grey')+
  scale_fill_gradientn(colors = rev(rainbow(10)))+
  theme_bw()+
  labs(x = 'longitude', y = 'latitude', fill = 'number of obs',
       title = 'location of delayed-mode adjusted oxygen observations')

```

## pH 

```{r create_pH_dataframe}

ph = data.frame(bgc_merge$longitude, bgc_merge$latitude, bgc_merge$date,
                bgc_merge$ph_in_situ_total_adjusted) # add longitude, latitude, date, and pH to a dataframe 

colnames(ph) = c('longitude','latitude','date', 'ph_in_situ_total') #rename columns

ph = ph %>%
  mutate(date.simple = as.Date(date),  # create one date and one time columns
         time = format(date, '%H:%M:%S'),
         cycle = bgc_merge$cycle_number,  # add cycle number and float ID
         float_ID = bgc_merge$float_serial_no)

ph.no.na = ph %>%
  filter(!is.na(ph_in_situ_total)) # remove NA values 

location_obs_ph = ph.no.na %>%
  group_by(round(longitude, digits = 0), round(latitude, digits = 0)) %>%
  summarise(Count = n()) # count the number of pH observations for each longitude/latitude pair rounded to the nearest integer 

colnames(location_obs_ph) = c('longitude', 'latitude', 'Count') # rename columns 
```

Map the location of pH observations 

```{r map_pH_observations}

ggplot() +
  geom_sf(data = world, fill = 'grey')+
  geom_tile(data = location_obs_ph, aes(x = longitude, y = latitude, fill = Count))+
  scale_fill_gradientn(colors = rev(rainbow(10)))+
  theme_bw()+
  labs(x = 'longitude', y = 'latitude', fill = 'number of obs',
       title = 'location of delayed-mode adjusted pH observations')

```

## Nitrate 

```{r create_nitrate_dataframe}

nitrate = data.frame(bgc_merge$longitude, bgc_merge$latitude, bgc_merge$date,
                     bgc_merge$nitrate_adjusted) # create a dataframe with longitude, latitude, date, and nitrate values 

colnames(nitrate) = c('longitude','latitude', 'date', 'nitrate_adjusted') # rename columns

nitrate = nitrate %>%
  mutate(date.simple = as.Date(date),  # separate date and time into two columns 
         time = format(date, '%H:%M:%S'),
         cycle = bgc_merge$cycle_number,  # add cycle number and float ID 
         float_ID = bgc_merge$float_serial_no)

nitrate.no.na = nitrate %>%
  filter(!is.na(nitrate_adjusted)) # remove NA values 

location_obs_nitrate = nitrate.no.na %>%
  group_by(round(longitude, digits = 0), round(latitude, digits = 0)) %>%
  summarise(Count = n()) # count the number of nitrate observations for each longitude/latitude pair rounded to the nearest integer 

colnames(location_obs_nitrate) = c('longitude', 'latitude', 'Count') # rename columns 

```

Map the location of nitrate observations 

```{r map_nitrate_observations}

ggplot() +
  geom_tile(data = location_obs_nitrate, aes(x = longitude, y = latitude, fill = Count))+
  geom_sf(data = world, fill = 'grey')+
  scale_fill_gradientn(colors = rev(rainbow(10)))+
  theme_bw()+
  labs(x = 'longitude', y = 'latitude', fill = 'number of obs',
       title = 'location of delayed-mode adjusted nitrate observations')

```

## All BGC variables 

Map the location of observations for which a measurement of all three variables exists 

```{r create_all_bgc_dataframe}
# create a dataframe which contains longitude, latitude, date, cycle number, float ID, and all three bgc variables 
bgc_co_located = data.frame(bgc_merge$longitude, bgc_merge$latitude,
                            bgc_merge$date,
                            bgc_merge$cycle_number,
                            bgc_merge$float_serial_no,
                            bgc_merge$doxy_adjusted,
                            bgc_merge$ph_in_situ_total_adjusted,
                            bgc_merge$nitrate_adjusted)

# rename columns:
colnames(bgc_co_located) = c('longitude', 'latitude',
                             'date',
                             'cycle',
                             'float_ID',
                             'doxy_adjusted',
                             'ph_in_situ_total_adjusted',
                             'nitrate_adjusted')

bgc_co_located = bgc_co_located %>%    # change the date and time format
  mutate(date.simple = as.Date(date),
         time = format(date, '%H:%M:%S'))

bgc_co_located.no.na = bgc_co_located %>%  # remove NA values for each variable
  filter(!is.na(doxy_adjusted)) %>%
  filter(!is.na(ph_in_situ_total_adjusted)) %>%
  filter(!is.na(nitrate_adjusted))

location_obs_bgc = bgc_co_located.no.na %>% 
  group_by(round(longitude, digits = 0), round(latitude, digits = 0)) %>%
  summarise(Count = n()) # count the number of observations for each longitude/latitude pair, rounded to the nearest integer

colnames(location_obs_bgc) = c('longitude', 'latitude', 'Count') # rename columns 
```

Map the locations of BGC observations 

```{r map_bgc_observations}

ggplot() +
  geom_tile(data = location_obs_bgc, aes(x = longitude, y = latitude, fill = Count))+
  geom_sf(data = world, fill = 'grey')+
  scale_fill_gradientn(colors = rev(rainbow(10)))+
  theme_bw()+
  labs(x = 'longitude', y = 'latitude', fill = 'number of obs',
       title = 'location of delayed-mode adjusted BGC observations (oxygen, pH, and nitrate)')

```

# MAP OF PROFILE LOCATIONS

## Oxygen 

```{r count_oxygen_profiles}

# count the number of oxygen profiles
prof_oxy = oxy.no.na %>%
  group_by(float_ID, cycle, round(longitude, digits = 0), round(latitude, digits = 0)) %>%    
  summarise(num_obs = n())  # count the number of oxygen observations by float and cycle

colnames(prof_oxy) = c('float_ID', 'cycle', 'longitude', 'latitude', 'num_obs') # rename columns

prof_oxy = prof_oxy %>%
  mutate(prof = rep(1, length(cycle))) # repeat a vector of 1s for each individual cycle 

location_prof_oxy = prof_oxy %>%
  group_by(round(longitude, digits = 0), round(latitude, digits = 0)) %>%
  summarise(count_prof = n())       # count the number of 1s (profiles) for each longitude/latitude pair, rounded to the nearest integer 

colnames(location_prof_oxy) = c('longitude', 'latitude', 'Count')

```

Map the location of oxygen profiles 

```{r map_oxygen_profiles}

ggplot() +
  geom_tile(data = location_prof_oxy, aes(x = longitude, y = latitude, fill = Count))+
  geom_sf(data = world, fill = 'grey')+
  scale_fill_gradientn(colors = rev(rainbow(10)))+
  theme_bw()+
  labs(x = 'longitude', y = 'latitude', fill = 'number of profiles',
       title = 'location of delayed-mode adjusted oxygen profiles')

```

## pH 

```{r count_pH_profiles}

# count the number of pH profiles
prof_ph = ph.no.na %>%
  group_by(float_ID, cycle, round(longitude, digits = 0), round(latitude, digits = 0)) %>%    
  summarise(num_obs = n())  # count the number of ph observations by float and cycle

colnames(prof_ph) = c('float_ID', 'cycle', 'longitude', 'latitude', 'num_obs') # rename columns

prof_ph = prof_ph %>%
  mutate(prof = rep(1, length(cycle))) # repeat a vector of 1s for each individual cycle 

location_prof_ph = prof_ph %>%
  group_by(round(longitude, digits = 0), round(latitude, digits = 0)) %>%
  summarise(count_prof = n())       # count the number of 1s (profiles) for each longitude/latitude pair, rounded to the nearest integer 

colnames(location_prof_ph) = c('longitude', 'latitude', 'Count') # rename columns 

```

Map the location of pH profiles 

```{r map_pH_profiles}

ggplot() +
  geom_tile(data = location_prof_ph, aes(x = longitude, y = latitude, fill = Count))+
  geom_sf(data = world, fill = 'grey')+
  scale_fill_gradientn(colors = rev(rainbow(10)))+
  theme_bw()+
  labs(x = 'longitude', y = 'latitude', fill = 'number of profiles',
       title = 'location of delayed-mode adjusted pH profiles')

```


## Nitrate 

```{r count_nitrate_profiles}

# count the number of nitrate profiles
prof_nitrate = nitrate.no.na %>%
  group_by(float_ID, cycle, round(longitude, digits = 0), round(latitude, digits = 0)) %>%    
  summarise(num_obs = n())  # count the number of nitrate observations by float and cycle

colnames(prof_nitrate) = c('float_ID', 'cycle', 'longitude', 'latitude', 'num_obs') # rename columns

prof_nitrate = prof_nitrate %>%
  mutate(prof = rep(1, length(cycle))) # repeat a vector of 1s for each individual cycle 

location_prof_nitrate = prof_nitrate %>%
  group_by(round(longitude, digits = 0), round(latitude, digits = 0)) %>%
  summarise(count_prof = n())       # count the number of 1s (profiles) for each longitude/latitude pair, rounded to the nearest integer 

colnames(location_prof_nitrate) = c('longitude', 'latitude', 'Count') # rename columns

```

Map the location of nitrate profiles 

```{r map_nitrate_profiles}

ggplot() +
  geom_tile(data = location_prof_nitrate, aes(x = longitude, y = latitude, fill = Count))+
  geom_sf(data = world, fill = 'grey')+
  scale_fill_gradientn(colors = rev(rainbow(10)))+
  theme_bw()+
  labs(x = 'longitude', y = 'latitude', fill = 'number of profiles',
       title = 'location of delayed-mode adjusted nitrate profiles')

```

## All  BGC variables 

```{r count_bgc_profiles}
# count the number of bgc profiles
prof_bgc = bgc_co_located.no.na %>%
  group_by(float_ID, cycle, round(longitude, digits = 0), round(latitude, digits = 0)) %>%    
  summarise(num_obs = n())  # count the number of nitrate observations by float and cycle

colnames(prof_bgc) = c('float_ID', 'cycle', 'longitude', 'latitude', 'num_obs') # rename columns

prof_bgc = prof_bgc %>%
  mutate(prof = rep(1, length(cycle))) # repeat a vector of 1s for each individual cycle 

location_prof_bgc = prof_bgc %>%
  group_by(round(longitude, digits = 0), round(latitude, digits = 0)) %>%
  summarise(count_prof = n())       # count the number of 1s (profiles) for each longitude/latitude pair, rounded to the nearest integer 

colnames(location_prof_bgc) = c('longitude', 'latitude', 'Count') # rename columns
```

Map the location of profiles containing all three BGC variables 

```{r map_bgc_profiles}

ggplot() +
  geom_tile(data = location_prof_bgc, aes(x = longitude, y = latitude, fill = Count))+
  geom_sf(data = world, fill = 'grey')+
  scale_fill_gradientn(colors = rev(rainbow(10)))+
  theme_bw()+
  labs(x = 'longitude', y = 'latitude', fill = 'number of profiles',
       title = 'location of delayed-mode adjusted BGC profiles')

```


# Map of profiles revised
 
```{r number_profiles_revised}

bgc_profile_counts_year <- bgc_metadata %>% 
  select(platform_number, cycle_number, date, longitude, latitude,
         profile_doxy_qc, profile_ph_in_situ_total_qc, profile_nitrate_qc) %>% 
  pivot_longer(profile_doxy_qc:profile_nitrate_qc,
               names_to = "profile_qc",
               values_to = "flag",
               names_prefix = "profile_") %>% 
  mutate(year = year(date),
         latitude = round(latitude, digits = 0),
         longitude = round(longitude, digits = 0)) %>% 
  filter(!is.na(flag),
         flag != "") %>% 
  count(latitude, longitude, year, profile_qc)

bgc_profile_counts_flag <- bgc_metadata %>% 
  select(platform_number, cycle_number, date, longitude, latitude,
         profile_doxy_qc, profile_ph_in_situ_total_qc, profile_nitrate_qc) %>% 
  pivot_longer(profile_doxy_qc:profile_nitrate_qc,
               names_to = "profile_qc",
               values_to = "flag",
               names_prefix = "profile_") %>% 
  mutate(year = year(date),
         latitude = round(latitude, digits = 0),
         longitude = round(longitude, digits = 0)) %>% 
  filter(!is.na(flag),
         flag != "") %>% 
  count(latitude, longitude, profile_qc, flag)

```

Plot the evolution of the number of profiles over time

```{r profiles_maps_year}

bgc_profile_counts_year %>%
  ggplot() +
  geom_sf(data = ne_countries(returnclass = "sf"),
          fill = "gray90",
          color = NA) +
  geom_sf(data = ne_coastline(returnclass = "sf")) +
  geom_tile(aes(x = longitude, y = latitude, fill = n)) +
  scale_fill_gradient(low="blue", high="red",
                      trans = "log10") +
  theme_bw() +
  facet_grid(year ~ profile_qc)

```

```{r profiles_maps_flag, fig.asp=1.2}

bgc_profile_counts_flag %>%
  ggplot() +
  geom_sf(data = ne_countries(returnclass = "sf"),
          fill = "gray90",
          color = NA) +
  geom_sf(data = ne_coastline(returnclass = "sf")) +
  geom_tile(aes(x = longitude, y = latitude, fill = n)) +
  scale_fill_gradient(low="blue", high="red",
                      trans = "log10") +
  theme_bw() +
  facet_grid(flag ~ profile_qc)

```
