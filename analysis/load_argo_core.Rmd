---
title: "Load Core-Argo Data"
author: "Pasqualina Vonlanthen & Jens Daniel MÃ¼ller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---


```{r set_options_global, include=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```

# Task
Load core-Argo temperature data for comparison with BGC-Argo temperature data  


```{r loading_libraries, include=FALSE}

library(tidyverse)
# remotes::install_github('ArgoCanada/argodata')
library(argodata)
library(ggplot2)
library(lubridate)
# install.packages('sf')
# install.packages("oce")
library(sf)
library(oce)
# install.packages('ggspatial')
# devtools::install_github("MikkoVihtakari/ggOceanMapsData")
# devtools::install_github("MikkoVihtakari/ggOceanMaps")
# library(ggspatial)
# library(ggOceanMaps)
```


```{r set_updata_root_directory, include=FALSE}

# dir.create('/nfs/kryo/work/updata/core_argo_r_argodata')

path_argo_core <- '/nfs/kryo/work/updata/core_argo_r_argodata'
path_updata <- '/nfs/kryo/work/updata'
# dir.create(paste0(path_argo_core, "/preprocessed_core_data"))
path_argo_core_preprocessed <- paste0(path_argo_core, "/preprocessed_core_data")
# path_basin_mask <- "/nfs/kryo/work/updata/reccap2/"
# path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"
```

## Set cache directory 

Directory where the core-Argo profile files are stored 

```{r set_core_cache_directory}

# set cache directory
argo_set_cache_dir(cache_dir = path_argo_core)

# check cache directory
argo_cache_dir()

# check argo mirror
argo_mirror()

argo_update_global(max_global_cache_age = Inf)  # age argument: age of the cached files to update in hours (Inf means always use the cached file, and -Inf means always download from the server) 
# ex: max_global_cache_age = 5 updates files that have been in the cache for more than 5 hours, max_global_cache_age = 0.5 updates files that have been in the cache for more than 30 minutes, etc.
argo_update_data(max_data_cache_age = Inf)
```

## Load index file 

Load in delayed-mode core-Argo (CTD) data index file  

```{r load_core_index}

# core_index <- argo_global_prof() %>%
#   argo_filter_data_mode(data_mode = 'delayed') %>%  # load in delayed-mode data
#   argo_filter_date(date_min = '2013-01-01',
#                    date_max = Sys.time())  

core_index <- argo_global_prof() %>% 
  argo_filter_data_mode(data_mode = 'delayed') %>% 
  argo_filter_date(date_min = '2013-01-01',
                   date_max = '2013-02-01')
# 1 month worth of data for test purposes 

# check dates 
# max(core_index$date, na.rm = TRUE)
# min(core_index$date, na.rm = TRUE)


```

## Read data 

Read in the core CTD variables corresponding to the index defined above 

```{r load_core_argo_data}

core_data <- argo_prof_levels(
  path = core_index,
  vars =
    c(
      'PRES_ADJUSTED',
      'PRES_ADJUSTED_QC',
      'PSAL_ADJUSTED',
      'PSAL_ADJUSTED_QC',
      'TEMP_ADJUSTED',
      'TEMP_ADJUSTED_QC'),
  quiet = TRUE
) 
# read in the profiles (takes a while)


```

## Read metadata 

Read in the corresponding metadata:

```{r}

core_metadata <- argo_prof_prof(path = core_index)

```

## Join data 

```{r join_core_data}

core_merge <- full_join(core_data, core_metadata)

core_merge <- core_merge %>%
  rename(lon = longitude,
         lat = latitude) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon)) %>%
  mutate(
    lat = cut(lat, seq(-90, 90, 1), seq(-89.5, 89.5, 1)),
    lat = as.numeric(as.character(lat)),
    lon = cut(lon, seq(20, 380, 1), seq(20.5, 379.5, 1)),
    lon = as.numeric(as.character(lon))
  ) %>%
  mutate(depth = swDepth(pres_adjusted, latitude =  lat),
         .before = pres_adjusted)

```

## Harmonise metadata

```{r harmonise_core_metadata}

core_metadata <- core_metadata %>%
  rename(lon = longitude,
         lat = latitude) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon)) %>%
  mutate(
    lat = cut(lat, seq(-90, 90, 1), seq(-89.5, 89.5, 1)),
    lat = as.numeric(as.character(lat)),
    lon = cut(lon, seq(20, 380, 1), seq(20.5, 379.5, 1)),
    lon = as.numeric(as.character(lon))
  )
```


## Write data 

```{r write_core_data}

core_data %>% 
  write_rds(file = paste0(path_argo_core_preprocessed, "/core_data.rds"))

core_metadata %>% 
  write_rds(file = paste0(path_argo_core_preprocessed, "/core_metadata.rds"))

core_merge %>% 
  write_rds(file = paste0(path_argo_core_preprocessed, "/core_merge.rds"))

```

## Core-Temperature Flag A profiles 

```{r flag_A_core_temp_profiles}

core_merge_flag_A <- core_merge %>% 
  filter(profile_temp_qc == 'A') %>% 
  select(lat, lon, date, 
         depth, temp_adjusted, temp_adjusted_qc,
         platform_number, cycle_number,
         profile_temp_qc)

core_merge_flag_A %>% 
  write_rds(file = paste0(path_argo_core_preprocessed, "/core_merge_flag_A.rds"))
```

## Core-Temperature Flag A and B 

```{r flag_AB_core_temp_profiles}

core_merge_flag_AB <- core_merge %>% 
  filter(profile_temp_qc == 'A' | profile_temp_qc == 'B') %>% 
  filter(temp_adjusted_qc == '1' | temp_adjusted_qc == '8') %>% 
  select(lat, lon, date,
         depth, temp_adjusted, temp_adjusted_qc,
         platform_number, cycle_number,
         profile_temp_qc)

core_merge_flag_AB %>% 
  write_rds(file = paste0(path_argo_core_preprocessed, "/core_merge_flag_AB.rds"))

```

