---
title: "Temporal data coverage"
author: "Pasqualina Vonlanthen & Jens Daniel MÃ¼ller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Task

Count the number of bgc-argo profiles, and plot their evolution over time.

```{r loading_libraries, include=FALSE}

library(tidyverse)
library(argodata)
library(ggplot2)
library(lubridate)

```

```{r set_updata_root_directory, include=FALSE}

path_argo <- '/nfs/kryo/work/updata/bgc_argo_r_argodata'

```

# Load data

Read the files created in loading_data.html:

```{r load_preprpocessed_data}

path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

bgc_subset <-
  read_rds(file = paste0(path_argo_preprocessed, "/bgc_subset.rds"))

bgc_metadata <-
  read_rds(file = paste0(path_argo_preprocessed, "/bgc_metadata.rds"))

bgc_data <-
  read_rds(file = paste0(path_argo_preprocessed, "/bgc_data.rds"))

bgc_merge <-
  read_rds(file = paste0(path_argo_preprocessed, "/bgc_merge.rds"))

```

# QC flags

**QC flags** for values ('`flag`' column) are between 1 and 8, where:

-   1 is 'good' data
-   2 is 'probably good' data,
-   3 is 'probably bad' data,
-   4 is 'bad' data,
-   5 is 'value changed',
-   8 is 'estimated value',
-   9 is 'missing value'.
-   (6 and 7 are not used)

**Profile QC flags** ('`profile_flag`' column) are QC codes attributed to the entire profile, and indicate the number of depth levels (in %) where the value is considered to be good data (QC flags of 1, 2, 5, and 8):

-   'A' means 100% of profile levels contain good data,
-   'B' means 75-\<100% of profile levels contain good data,
-   'C' means 50-75% of profile levels contain good data,
-   'D' means 25-50% of profile levels contain good data,
-   'E' means \>0-50% of profile levels contain good data,
-   'F' means 0% of profile levels contain good data.

# Number of profiles

```{r number_profiles_per_parameter}
# count the number of profiles per parameter 

bgc_profile_counts <- bgc_metadata %>% 
  select(platform_number, cycle_number, date,
         profile_doxy_qc, profile_ph_in_situ_total_qc, profile_nitrate_qc) %>% 
  pivot_longer(cols = profile_doxy_qc:profile_nitrate_qc,
               names_to = "parameter",
               values_to = "profile_flag",
               names_prefix = "profile_") %>% 
  mutate(year = year(date),
         month = month(date)) %>% 
  count(year, month, parameter, profile_flag) %>%   # count the number of occurrences of unique flags for each parameter, in each month of each year 
  filter(!is.na(profile_flag),
         profile_flag != "")

# the 'parameter' column contains character strings of either 'doxy_qc', 'ph_in_situ_total_qc', or 'nitrate_qc', with the corresponding profile QC flag in the 'profile_flag' column

```

Plot the evolution of the number of profiles over time

```{r profiles_timeseries, eval = FALSE}

bgc_profile_counts %>% 
  ggplot(aes(x = month, y = n, col = profile_flag)) +
  geom_line() +
  geom_point() +
  facet_grid(parameter ~ year,
             scales = "free_y") +
  scale_x_continuous(breaks = seq(1,12,2))+
  labs(x = 'month', y = 'number of profiles', title = 'number of profiles per year')+
  theme_bw()

```

```{r profiles_timeseries_per_parameter}
# draw separate plots for the separate parameters

bgc_profile_counts %>%
  group_split(parameter) %>%   # creates a separate flag count for each parameter 
  map(
    ~ ggplot(data = .x,       # repeats the ggplot for each separate parameter 
             aes(
               x = month, y = n, col = profile_flag
             )) +
      geom_line() +
      geom_point() +
      facet_grid(. ~ year,
                 scales = "free_y") +
      labs(title = paste("Parameter: ", unique(.x$parameter)), 
           x = 'month', y = 'number of profiles') +
      scale_x_continuous(breaks = seq(1,12,2))+
      theme_bw()
  )


```

```{r number_profiles_total_A}

# count the number of profiles with a QC flag of A for at least one BGC parameter 
# (not plotted)

bgc_profile_counts_A <- bgc_metadata %>% 
  select(platform_number, cycle_number, date,
         profile_doxy_qc, profile_ph_in_situ_total_qc, profile_nitrate_qc) %>% 
  pivot_longer(cols = profile_doxy_qc:profile_nitrate_qc,
               names_to = "parameter",
               values_to = "profile_flag",
               names_prefix = "profile_") %>% 
  mutate(year = year(date),
         month = month(date)) %>% 
  filter(profile_flag == "A") %>% 
  distinct(platform_number, cycle_number, year, month) %>% 
  count(year, month)
  
  
```

```{r test_chunk_filtering_A_flag}

# count the number of profiles which have a QC flag of A for all three BGC parameters 
# (plotted below)

bgc_profile_counts_total_A <- bgc_metadata %>% 
  select(platform_number, cycle_number, date,
         profile_doxy_qc, profile_ph_in_situ_total_qc, profile_nitrate_qc) %>% 
  filter(!is.na(profile_doxy_qc),
         !is.na(profile_ph_in_situ_total_qc),
         !is.na(profile_nitrate_qc)) %>% 
  pivot_longer(cols = profile_doxy_qc:profile_nitrate_qc,
               names_to = "parameter",
               values_to = "profile_flag",
               names_prefix = "profile_") %>% 
  mutate(year = year(date),
         month = month(date)) %>% 
  filter(profile_flag == "A") %>% 
  distinct(platform_number, cycle_number, year, month) %>% 
  count(year, month)


```

```{r profiles_timeseries_total_A}

bgc_profile_counts_total_A %>% 
  ggplot(aes(x = month, y = n)) +
  geom_line() +
  geom_point() +
  facet_grid(. ~ year,
             scales = "free_y") +
  scale_x_continuous(breaks = seq(1,12,2)) +
  labs(x = 'month', y = 'number of profiles', title = 'number of profiles with all three BGC parameters (QC flag A)')+
  theme_bw()

```
