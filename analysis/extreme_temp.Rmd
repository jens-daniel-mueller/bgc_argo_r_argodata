---
title: "Extreme Temperature Profiles"
author: "Pasqualina Vonlanthen & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Task

Compare depth profiles of normal temperature and of extreme temperature, as identified in the surface OceanSODA data product

```{r load_libraries, include=FALSE}
library(tidyverse)
library(lubridate)
library(broom)
library(ggOceanMaps)
library(scico)
library(metR)
library(ggforce)
```

```{r set_global_theme}

theme_set(theme_bw())
HNL_colors <- c("H" = "#b2182b",
                "N" = "#636363",
                "L" = "#2166ac")

HNL_colors_map <- c('H' = 'red3',
                    'N' = 'gray90',
                    'L' = 'blue3')
```

# Load data

```{r set_root_directories}
path_argo <- '/nfs/kryo/work/updata/bgc_argo_r_argodata'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")
path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"
path_updata <- '/nfs/kryo/work/updata'
```

```{r load_data}

# RECCAP2-ocean region mask

region_masks_all_2x2 <- read_rds(file = paste0(path_argo_preprocessed,
                                               "/region_masks_all_2x2.rds"))

region_masks_all_2x2 <- region_masks_all_2x2 %>%
  rename(biome = value) %>% 
  mutate(coast = as.character(coast))

# WOA 18 basin mask

basinmask <-
  read_csv(
    paste(path_emlr_utilities,
          "basin_mask_WOA18.csv",
          sep = ""),
    col_types = cols("MLR_basins" = col_character())
  )

basinmask <- basinmask %>%
  filter(MLR_basins == unique(basinmask$MLR_basins)[1]) %>% 
  select(-c(MLR_basins, basin))

# OceanSODA temperature

OceanSODA_temp <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_temp.rds"))

OceanSODA_temp <- OceanSODA_temp %>%
  mutate(year = year(date),
         month = month(date))

# full argo data
full_argo <- read_rds(file = paste0(path_argo_preprocessed, "/bgc_merge_temp_qc_1.rds"))

# change the date format for compatibility with OceanSODA data
full_argo <- full_argo %>%
  mutate(year = year(date),
         month = month(date)) %>%
  mutate(date = ymd(format(date, "%Y-%m-15")))

map <-
  read_rds(paste(path_emlr_utilities,
                 "map_landmask_WOA18.rds",
                 sep = ""))
```

# Regions

## Biomes

```{r filter_southern_ocean_biomes}

region_masks_all_2x2 <- region_masks_all_2x2 %>%
  filter(region == 'southern',
         biome != 0) %>% 
  select(-region)
```

## Remove coastal data

```{r coast_map, eval=FALSE}

basemap(limits = -32) +
  geom_spatial_tile(
    data = region_masks_all_2x2,
    aes(x = lon,
        y = lat,
        fill = coast),
    col = 'transparent'
  ) +
  scale_fill_brewer(palette = "Dark2")
```

```{r coast_flat_map, fig.asp=1}
map + 
  geom_tile(data = region_masks_all_2x2, 
            aes(x = lon, 
                y = lat, 
                fill = coast))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')
```

```{r remove_coastal_data}
# remove coastal data 

region_masks_all_2x2 <- region_masks_all_2x2 %>% 
  filter(coast == "0")
```

## Grid reduction

```{r biomes_map_pre_grid_reduction, eval=FALSE}

basemap(limits = -32) +
  geom_spatial_tile(
    data = region_masks_all_2x2,
    aes(x = lon,
        y = lat,
        fill = biome),
    col = 'transparent'
  ) +
  scale_fill_brewer(palette = "Dark2")
```

```{r biomes_flat_map_pre_grid_reduction, fig.asp=1}

map +
  geom_tile(data = region_masks_all_2x2, 
            aes(x = lon, 
                y = lat, 
                fill = biome))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')
```

```{r grid_reduction_to_true_2x2_region_mask}

region_masks_all_2x2 <- region_masks_all_2x2 %>%
  count(lon, lat, biome) %>%
  group_by(lon, lat) %>%
  slice_max(n, with_ties = FALSE) %>%
  ungroup()
```

```{r biomes_map_post_grid_reduction, eval=FALSE}

basemap(limits = -32) +
  geom_spatial_tile(
    data = region_masks_all_2x2,
    aes(x = lon,
        y = lat,
        fill = biome),
    col = 'transparent'
  ) +
  scale_fill_brewer(palette = "Dark2")
```

```{r biomes_flat_map_post_grid_reduction, fig.asp=1}

map+
  geom_tile(data = region_masks_all_2x2,
            aes(x = lon,
                y = lat, 
                fill = biome))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')
```

## Basins

```{r filter_southern_ocean_basins}

basinmask <- basinmask %>%
  filter(lat < -30)
```

## Grid reduction

```{r basin_map_pre_grid_reduction, eval=FALSE}

basemap(limits = -32) +
  geom_spatial_tile(
    data = basinmask,
    aes(x = lon,
        y = lat,
        fill = basin_AIP),
    col = 'transparent'
  ) +
  scale_fill_brewer(palette = "Dark2")
```

```{r basin_flat_map_pre_grid_reduction, fig.asp=1}
map +
  geom_tile(data = basinmask, 
            aes(x = lon, 
                y = lat, 
                fill = basin_AIP))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')
```

```{r grid_reduction_to_true_2x2_basinmask}

basinmask_2x2 <- basinmask %>%
  mutate(
    lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)), 
    lat = as.numeric(as.character(lat)),
    lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)), 
    lon = as.numeric(as.character(lon))
   ) # regrid into 2x2º grid

# assign basins from each pixel to to each 2 Lon x Lat pixel, based on the majority of basins in each 2x2 grid  

basinmask_2x2 <- basinmask_2x2 %>%
  count(lon, lat, basin_AIP) %>%
  group_by(lon, lat) %>%
  slice_max(n, with_ties = FALSE) %>%
  ungroup() %>% 
  select(-n)

rm(basinmask)
```

```{r basin_map_post_grid_reduction, eval=FALSE}

basemap(limits = -32) +
  geom_spatial_tile(
    data = basinmask_2x2 %>% filter(lat < -30),
    aes(x = lon,
        y = lat,
        fill = basin_AIP),
    col = 'transparent'
  ) +
  scale_fill_brewer(palette = "Dark2")
```

```{r basin_flat_map_post_grid_reduction, fig.asp=1}

map+
  geom_tile(data = basinmask_2x2 %>% filter(lat < -30),
            aes(x = lon,
                y = lat, 
                fill = basin_AIP))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')
```

# OceanSODA

## Grid reduction

```{r grid_reduction_to_2x2_OceanSODA_temp}

# Note: While reducing lon x lat grid,
# we keep the original number of observations

OceanSODA_temp_2x2 <- OceanSODA_temp %>% 
  mutate(
    lat_raw = lat,
    lon_raw = lon,
    lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)), 
    lat = as.numeric(as.character(lat)),
    lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)), 
    lon = as.numeric(as.character(lon))) # regrid into 2x2º grid 
```

## Apply region masks

```{r apply_region_masks_OceanSODA_temp}

# keep only Southern Ocean data
OceanSODA_temp_2x2_SO <- inner_join(OceanSODA_temp_2x2, region_masks_all_2x2)

# add in basin separations
OceanSODA_temp_2x2_SO <- inner_join(OceanSODA_temp_2x2_SO, basinmask_2x2)
# expected number of rows from -30 to -70º latitude, 360º longitude, for 12 months, 8 years:
# 40 lat x 360 lon x 12 months x 8 years = 1 382 400 rows 
# actual number of rows: 1 134 177 (in line with expectations)

OceanSODA_temp_2x2_SO <- OceanSODA_temp_2x2_SO %>% 
  filter(!is.na(temperature))
# resulting number of rows: 925 056 
# (removes 209 121 observations)
```

# OceanSODA temperature anomalies

## Grid level

### Fit lm models

```{r fit_temp_linear_regression}

# fit a linear regression of OceanSODA pH against time (temporal trend)
# in each lat/lon/month grid
OceanSODA_temp_2x2_SO <- OceanSODA_temp_2x2_SO %>% 
  mutate(row_number = row_number())


OceanSODA_temp_regression <- OceanSODA_temp_2x2_SO %>% 
  # filter(basin_AIP == "Indian",
  #        biome == "2",
  #        lon < 40) %>%
  nest(data = -c(lon, lat, month)) %>%
  mutate(fit = map(.x = data,
                   .f = ~ lm(temperature ~ year, data = .x)),
         tidied = map(.x = fit, .f = tidy),
         glanced = map(.x = fit, .f = glance),
         augmented = map(.x = fit, .f = augment)) 


OceanSODA_temp_regression_tidied <- OceanSODA_temp_regression %>%
  select(-c(data, fit, augmented, glanced)) %>%
  unnest(tidied) 

OceanSODA_temp_regression_tidied <- OceanSODA_temp_regression_tidied %>% 
  select(lon:estimate) %>% 
  pivot_wider(names_from = term,
              values_from = estimate) %>% 
  rename(intercept = `(Intercept)`,
         slope = year)

OceanSODA_temp_regression_augmented <- OceanSODA_temp_regression %>%
  select(-c(fit, tidied, glanced, data)) %>%
  unnest(augmented) %>% 
  select(lon:year, .resid) 

OceanSODA_temp_regression_data <- OceanSODA_temp_regression %>% 
  select(-c(fit, tidied, glanced, augmented)) %>% 
  unnest(data) 

# OceanSODA_temp_regression_augmented <- bind_cols(
#   OceanSODA_temp_regression_augmented,
#   OceanSODA_temp_2x2_SO %>% 
#     select(
#     date, lon_raw, lat_raw, lon, lat, basin_AIP, biome)
# )

OceanSODA_temp_regression_augmented <- bind_cols(
  OceanSODA_temp_regression_augmented,
  OceanSODA_temp_regression_data %>% 
    select(lon_raw, lat_raw, date, row_number, biome, basin_AIP))

OceanSODA_temp_regression_glanced <- OceanSODA_temp_regression %>%
  select(-c(data, fit, tidied, augmented)) %>%
  unnest(glanced) 
```

### Slope maps

```{r map_temp_regression_slopes, fig.asp=2, eval=FALSE}

basemap(limits = -32) +
  geom_spatial_tile(data = OceanSODA_temp_regression_tidied,
                    aes(x = lon,
                        y = lat,
                        fill = slope),
                    col = 'transparent') +
  scale_fill_scico(palette = "vik", midpoint = 0) +
  facet_wrap( ~ month, ncol = 2)
```

```{r map_temp_regression_slopes_flat, fig.asp=1}

map+
  geom_tile(data = OceanSODA_temp_regression_tidied,
            aes(x = lon,
                y = lat, 
                fill = slope))+
  scale_fill_scico(palette = 'vik', midpoint = 0)+
  lims(y = c(-85, -30))+
  facet_wrap(~month, ncol = 2)
```

### Residual st. dev. maps

```{r temp_map_sigma, fig.asp=2, eval=FALSE}

basemap(limits = -32)+
  geom_spatial_tile(data = OceanSODA_temp_regression_glanced,
                    aes(x = lon, 
                        y = lat, 
                        fill = sigma),
                    col = 'transparent')+
  scale_fill_viridis_c()+
  facet_wrap(~month, ncol = 2)+
  labs(fill = '1 residual \nst. dev.')
```

```{r temp_flat_map_sigma, fig.asp=1}

map+
  geom_tile(data = OceanSODA_temp_regression_glanced,
            aes(x = lon,
                y = lat, 
                fill = sigma))+
  scale_fill_viridis_c()+
  lims(y = c(-85, -30))+
  facet_wrap(~month, ncol = 2)+
  labs(fill = '1 residual \nst. dev.')
```

### Anomaly identification

Calculate OceanSODA surface temperature anomalies; L for abnormally low, H for abnormally high, and N for normal

```{r calculate_extreme_OceanSODA_temp_grid}

# when the in-situ OceanSODA temperature is lower than the 5th percentile (predicted - 2*residual.st.dev), assign 'L' for low extreme
# when the in-situ OceanSODA temperature exceeds the 95th percentile (predicted + 2*residual.st.dev), assign 'H' for high extreme
# when the in-situ OceanSODA temperature is within 95% of the range, then assign 'N' for normal pH

# combine observations and regression statistics

OceanSODA_temp_2x2_SO_extreme_grid <-
  full_join(
    OceanSODA_temp_regression_augmented,
    OceanSODA_temp_regression_glanced %>%
      select(lon:month, sigma)
  )
# results in 925 056 rows 

# identify observations in anomaly classes

OceanSODA_temp_2x2_SO_extreme_grid <- OceanSODA_temp_2x2_SO_extreme_grid %>%
  mutate(
    temp_extreme = case_when(
      .resid < -sigma*2 ~ 'L',
      .resid > sigma*2 ~ 'H',
      TRUE ~ 'N'
    )
  ) 

OceanSODA_temp_2x2_SO_extreme_grid <- OceanSODA_temp_2x2_SO_extreme_grid %>%
  mutate(temp_extreme = fct_relevel(temp_extreme, "H", "N", "L"))


# combine with regression coefficients

OceanSODA_temp_2x2_SO_extreme_grid <-
  full_join(OceanSODA_temp_2x2_SO_extreme_grid,
            OceanSODA_temp_regression_tidied) 
# 925 056 rows, in line with expectations for 40 lat x 360 lon x 12 months x 8 years (1 382 400 obs minus NA values)
```

```{r temp_anomaly_test_plot_grid, fig.asp=0.5}

OceanSODA_temp_2x2_SO_extreme_grid %>%
  group_split(lon, lat, month) %>%
  head(6) %>%
  map(~ ggplot(data = .x) +
        geom_point(aes(x = year,
                       y = temperature,
                       col = temp_extreme)) +
        geom_abline(data = .x, aes(slope = slope,
                    intercept = intercept)) +
        geom_abline(data = .x, aes(slope = slope,
                    intercept = intercept + 2*sigma),
                    linetype = 2) +
        geom_abline(data = .x, aes(slope = slope,
                    intercept = intercept - 2*sigma),
                    linetype = 2) +
        labs(title = paste(fititle = paste(
          "lon:", unique(.x$lon),
          "| lat:", unique(.x$lat),
          "| month:", unique(.x$month)
          ))) +
        scale_color_manual(values = HNL_colors))
```

### Anomaly maps

##### Anomalies on a 2x2 grid

Location of OceanSODA temperature extremes

```{r map_OceanSODA_temp_extremes_grid, fig.asp=2, eval=FALSE}

OceanSODA_temp_2x2_SO_extreme_grid %>% 
  group_split(year) %>% 
  # head(2) %>%
  map(
    ~ basemap(limits = -32, data = .x)+
      geom_spatial_tile(data = .x,
                        aes(x = lon,
                            y = lat,
                            fill = temp_extreme),
                        linejoin = 'mitre',
                        col = 'transparent',
                        detail = 60
                        ) +
      scale_fill_manual(values = HNL_colors) +
      facet_wrap(~month, ncol = 2)+
      labs(title = paste("Year:", unique(.x$year)),
           fill = 'temperature')
  )
```

```{r flat_map_OceanSODA_temp_extremes_grid, fig.asp=2}

OceanSODA_temp_2x2_SO_extreme_grid %>% 
  group_split(year) %>% 
  map(
    ~map +
      geom_tile(data = .x,
                aes(x = lon,
                    y = lat, 
                    fill = temp_extreme))+
      scale_fill_manual(values = HNL_colors_map)+
      facet_wrap(~month, ncol = 2)+
      lims(y = c(-85, -30))+
      labs(title = paste('Year:', unique(.x$year)),
           fill = 'temperature (ºC)')
  )
```

##### Anomalies on a 1x1 grid 

```{r flat_map_temp_extremes_1x1_plot}

OceanSODA_temp_2x2_SO_extreme_grid %>% 
  group_split(year) %>% 
  head(3) %>% 
  map(
    ~map +
      geom_tile(data = .x,
                aes(x = lon_raw,
                    y = lat_raw, 
                    fill = temp_extreme))+
      scale_fill_manual(values = HNL_colors_map)+
      facet_wrap(~month, ncol = 2)+
      lims(y = c(-85, -30))+
      labs(title = paste('Year:', unique(.x$year)),
           fill = 'pH')
  )

```

### Anomaly timeseries

```{r extreme_temp_timeseries_grid}
# calculate a regional mean temperature for each biome, basin, and ph extreme (H/L/N) and plot a timeseries 

OceanSODA_temp_2x2_SO_extreme_grid %>% 
  group_by(year, biome, basin_AIP, temp_extreme) %>% 
  summarise(temp_regional = mean(temperature, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = temp_regional, col = temp_extreme))+
  geom_point(size = 0.3)+
  geom_line()+
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP~biome)+
  theme(legend.position = 'bottom')
```

### Anomaly histogram

```{r extreme_temp_histogram_grid}

OceanSODA_temp_2x2_SO_extreme_grid %>%
  ggplot(aes(temperature, col = temp_extreme)) +
  geom_density() +
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP ~ biome) +
  coord_cartesian(xlim = c(-2, 28)) +
  labs(x = 'value',
       y = 'density',
       col = 'temp anomaly') +
  theme(legend.position = 'bottom')
```

# Argo

## Grid reduction

```{r grid_reduction_to_2x2_argo, eval=FALSE}

# Note: While reducing lon x lat grid,
# we keep the original number of observations

full_argo_2x2 <- full_argo %>%
  mutate(
    lat_raw = lat,
    lon_raw = lon,
    lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
    lat = as.numeric(as.character(lat)),
    lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
    lon = as.numeric(as.character(lon)))  # re-grid to 2x2
```

## Apply region masks

```{r apply_region_masks_argo, eval=FALSE}

# keep only Southern Ocean argo data
full_argo_2x2_SO <- inner_join(full_argo_2x2, region_masks_all_2x2)
# expected number of rows: 
# number of points in a profile, for sampling every 2 m from 0 to 1000 m and every 50 m from 1000 to 2500 m: 530 obs (rows)
# for 12 months x 9 years x 360 lon x 30 lat: 
# 618 000 000 rows 
# actual number of rows: 15 770 055 
# (not all Argo profiles go down to 2500 m and spatial coverage isn't as large as OceanSODA)

# With 50% of Argo profiles to 2500 m and half of longitude coverage: 
# sampling every 2 m from 0 to 1000 m (500 obs) + 50% every 50 m from 1000 to 2500 m (15 obs): 515 obs 
# for 12 months x 9 years x 180 lon x 30 lat:
# 299 181 600 rows 
# actual number of obs: 15 770 055 

# add in basin separations
full_argo_2x2_SO <- inner_join(full_argo_2x2_SO, basinmask_2x2)
```

# Join OceanSODA

```{r combine_extreme_temp_OceanSODA_to_Argo}

# rename OceanSODA columns
OceanSODA_temp_2x2_SO_extreme_grid <- OceanSODA_temp_2x2_SO_extreme_grid %>%
  select(-c(lon, lat)) %>%
  rename(OceanSODA_temp = temperature,
         lon = lon_raw,
         lat = lat_raw)
# 925 056 obs 

# OceanSODA_temp_2x2_SO_extreme_grid <- OceanSODA_temp_2x2_SO_extreme_grid %>% 
#   rename(OceanSODA_temp = temperature)

# full_argo_2x2_SO <- full_argo_2x2_SO %>% 
#   rename(argo_temp = temp_adjusted)

# check lat/lon distributions for argo and OceanSODA 
# OceanSODA_temp_2x2_SO_extreme_grid %>% 
#   ggplot(aes(x = lon))+
#   geom_density()
# 
# OceanSODA_temp_2x2_SO_extreme_grid %>% 
#   ggplot(aes(x = lat))+
#   geom_density()
# 
# OceanSODA_temp_2x2_SO_extreme_grid %>% 
#   ggplot(aes(x = OceanSODA_temp))+
#   geom_density()

# OceanSODA_temp_2x2_SO_extreme_grid %>% 
#   ggplot(aes(x = lon, y = lat))+
#   geom_bin2d(aes(x = lon, y = lat), size = 0.3, bins = 60)

# 
# full_argo_2x2_SO %>% 
#   ggplot(aes(x = lon))+
#   geom_density()
# 
# full_argo_2x2_SO %>% 
#   ggplot(aes(y = lat))+
#   geom_density(aes(y = lat))
#   
# full_argo_2x2_SO %>% 
#   ggplot(aes(x = argo_temp))+
#   geom_density()

# full_argo_2x2_SO %>% 
#   ggplot(aes(x = lon, y = lat))+
#   geom_bin2d(aes(x = lon, y = lat))

# combine the argo profile data to the surface extreme data
profile_temp_extreme <- inner_join(
  full_argo %>% 
    select(c(year, month, date, lon, lat, depth,
           temp_adjusted,
           platform_number,
           cycle_number)),                 # 15 770 055 obs 
  OceanSODA_temp_2x2_SO_extreme_grid %>% 
    select(c(year, month, date, lon, lat,
           OceanSODA_temp, temp_extreme,
           biome, basin_AIP))) %>% 
  unite('platform_cycle', platform_number:cycle_number, sep = '_', remove = FALSE)
  
  # 925 056 obs 
  
# results in 14 816 885 rows 

# profile_temp_extreme %>% 
#   ggplot(aes(x = lon))+
#   geom_density()
# 
# profile_temp_extreme %>% 
#   ggplot(aes(y = lat))+
#   geom_density()
```

# Plot profiles

Argo profiles plotted according to the surface OceanSODA temperature

L profiles correspond to a low surface temperature event, as recorded in OceanSODA

H profiles correspond to an event of high surface temperature, as recorded in OceanSODA

N profiles correspond to normal surface OceanSODA temperature

## Raw

```{r temp_profiles_raw}

profile_temp_extreme %>%
  group_split(biome, basin_AIP, year) %>% 
  # head(5) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = temp_adjusted,
        y = depth,
        group = platform_cycle,
        col = temp_extreme
      )
    ) +
      geom_path(data = .x %>% filter(temp_extreme == 'N'),
                aes(x = temp_adjusted, 
                    y = depth,
                    group = platform_cycle,
                    col = temp_extreme),
                size = 0.3) +
      geom_path(data = .x %>% filter(temp_extreme == 'H' | temp_extreme == 'L'),
                aes(x = temp_adjusted,
                    y = depth,
                    group = platform_cycle,
                    col = temp_extreme),
                size = 0.5)+
      scale_y_reverse() +
      scale_color_manual(values = HNL_colors) +
      facet_wrap(~ month, ncol = 6) +
      labs(
        x = 'Argo temperature (ºC)',
        y = 'depth (m)',
        title = paste(
          unique(.x$basin_AIP),
          "|",
          unique(.x$year),
          "| biome:",
          unique(.x$biome)
        ),
        col = 'OceanSODA temp \nanomaly'
      )
  )

```

### Atlantic, biome 1, March - April 2018

```{r select_specific_temp_profiles_2018}

# Temperature extreme: 
# Atlantic biome 1, 2018, months 2 and 3 

OceanSODA_temp_2x2_SO_extreme_grid_2018 <- OceanSODA_temp_2x2_SO_extreme_grid %>% 
  filter(date == '2018-03-15' | date == '2018-04-15')  

map+
  geom_tile(data = OceanSODA_temp_2x2_SO_extreme_grid_2018,
            aes(x = lon,
                y = lat,
                fill = temp_extreme))+
  facet_wrap(~month, ncol = 1)+
  scale_fill_manual(values = HNL_colors_map)+
  lims(y = c(-85, -30))+
  labs(title = 'March - April 2018',
       fill = 'OceanSODA SST \nextreme')
  
profile_temp_Atl_2018 <- profile_temp_extreme %>% 
  filter(date == '2018-03-15' | date == '2018-04-15',
         basin_AIP == 'Atlantic',
         biome == '1') 

profile_temp_Atl_2018 %>% 
  ggplot(aes(x = temp_adjusted,
             y = depth,
             group = platform_cycle,
             col = temp_extreme))+
  geom_path(size = 0.3)+
  scale_y_reverse()+
  scale_color_manual(values = HNL_colors)+
  facet_wrap(~month, ncol = 2)+
  labs(title = 'Atlantic, biome 1, March - April 2018',
       col = 'OceanSODA SST\nextreme',
       x = 'Argo temperature (ºC)')


```

### Atlantic, biome 3, July - August 2015

```{r select_specific_temp_profiles_2015}

# Atlantic biome 3, 2015 months 7 and 8 

OceanSODA_temp_2x2_SO_extreme_grid_2015 <- OceanSODA_temp_2x2_SO_extreme_grid %>% 
  filter(date == '2015-07-15' | date == '2015-08-15')  

map+
  geom_tile(data = OceanSODA_temp_2x2_SO_extreme_grid_2015,
            aes(x = lon,
                y = lat,
                fill = temp_extreme))+
  facet_wrap(~month, ncol = 1)+
  scale_fill_manual(values = HNL_colors_map)+
  lims(y = c(-85, -30))+
  labs(title = 'July - August 2015',
       fill = 'OceanSODA SST \nextreme')

profile_temp_Atl_2015 <- profile_temp_extreme %>% 
  filter(date == '2015-07-15' | date == '2015-08-15',
         basin_AIP == 'Atlantic',
         biome == '3') 

profile_temp_Atl_2015 %>% 
  ggplot(aes(x = temp_adjusted,
             y = depth,
             group = platform_cycle,
             col = temp_extreme))+
  geom_path(size = 0.3)+
  scale_y_reverse()+
  scale_color_manual(values = HNL_colors)+
  facet_wrap(~month, ncol = 2)+
  labs(title = 'Atlantic, biome 3, July - August 2015',
       col = 'OceanSODA SST\nextreme',
       x = 'Argo temperature (ºC)')

```

### Pacific, biome 2, July - August 2016

```{r select_specific_temp_profile_2016}

# Pacific biome 2, 2016, months 7 and 8 

OceanSODA_temp_2x2_SO_extreme_grid_2016 <- OceanSODA_temp_2x2_SO_extreme_grid %>% 
  filter(date == '2016-07-15' | date == '2016-08-15')  

map+
  geom_tile(data = OceanSODA_temp_2x2_SO_extreme_grid_2016,
            aes(x = lon,
                y = lat,
                fill = temp_extreme))+
  facet_wrap(~month, ncol = 1)+
  scale_fill_manual(values = HNL_colors_map)+
  lims(y = c(-85, -30))+
  labs(title = 'July - August 2016',
       fill = 'OceanSODA SST \nextreme')

profile_temp_Pac_2016 <- profile_temp_extreme %>% 
  filter(date == '2016-07-15' | date == '2016-08-15',
         basin_AIP == 'Pacific',
         biome == '2') 

profile_temp_Pac_2016 %>% 
  ggplot(aes(x = temp_adjusted,
             y = depth,
             group = platform_cycle,
             col = temp_extreme))+
  geom_path(size = 0.3)+
  scale_y_reverse()+
  scale_color_manual(values = HNL_colors)+
  facet_wrap(~month, ncol = 2)+
  labs(title = 'Pacific, biome 2, July - August 2016',
       col = 'OceanSODA SST\nextreme',
       x = 'Argo temperature (ºC)')

```

## Averaged profiles

```{r calculate_mean_temp_profiles}
 
# cut depth levels at 10, 20, .... etc m
# add seasons 
# Dec, Jan, Feb <- summer 
# Mar, Apr, May <- autumn 
# Jun, Jul, Aug <- winter 
# Sep, Oct, Nov <- spring 

profile_temp_extreme <- profile_temp_extreme %>%
  mutate(
    depth = Hmisc::cut2(
      depth,
      cuts = c(10, 20, 30, 50, 70, 100, 300, 500, 800, 1000, 1500, 2000, 2500),
      m = 5,
      levels.mean = TRUE
    ),
    depth = as.numeric(as.character(depth))
  ) %>%
  mutate(
    season = case_when(
      between(month, 3, 5) ~ 'autumn',
      between(month, 6, 8) ~ 'winter',
      between(month, 9, 11) ~ 'spring',
      month == 12 | 1 | 2 ~ 'summer'
    ),
    .after = date
  ) 
```

### Overall mean

```{r mean_temp_profiles, fig.asp=1}

profile_temp_extreme_mean <- profile_temp_extreme %>%
  group_by(temp_extreme, depth) %>%
  summarise(temp_mean = mean(temp_adjusted, na.rm = TRUE),
            temp_std = sd(temp_adjusted, na.rm = TRUE)) %>%
  ungroup()

profile_temp_extreme_mean %>%
  arrange(depth) %>%
  ggplot(aes(x = temp_mean, 
             y = depth, 
             group = temp_extreme, 
             col = temp_extreme)) +
  geom_ribbon(aes(xmin = temp_mean - temp_std,
                  xmax = temp_mean + temp_std,
                  col = NA,
                  fill = temp_extreme), 
              col = NA,
              alpha = 0.2)+
  geom_path()+
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = "Overall mean",
       col = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       y = 'sqrt(depth)',
       x = 'mean Argo temperature (ºC)') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))
```

Number of profiles

```{r mean_temp_profile_count, fig.asp=1}

profile_temp_count_mean <- profile_temp_extreme %>% 
  distinct(temp_extreme, platform_number, cycle_number) %>% 
  count(temp_extreme)

profile_temp_count_mean %>% 
  ggplot(aes(x = temp_extreme, y = n, fill = temp_extreme))+
  geom_col(width = 0.5)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles')
```

Surface Argo temperature vs surface OceanSODA temperature (20 m)

```{r argo_vs_OceanSODA_temp_mean, fig.asp=1}
# calculate surface-mean argo pH, for each profile 
surface_temp_mean <- profile_temp_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(temp_extreme, platform_number, cycle_number) %>% 
  summarise(argo_surf_temp = mean(temp_adjusted, na.rm = TRUE),
            OceanSODA_surf_temp = mean(OceanSODA_temp, na.rm = TRUE))

# test by averaging surface temp over lat/lon instead of profile 
# surface_temp_mean <- profile_temp_extreme %>% 
#   filter(depth <= 20) %>% 
#   group_by(temp_extreme, lon, lat) %>% 
#   summarise(argo_surf_temp = mean(temp_adjusted, na.rm = TRUE),
#             OceanSODA_surf_temp = mean(OceanSODA_temp, na.rm = TRUE))

# test 2, without averaging surface temperature 
# surface_temp_mean <- profile_temp_extreme %>% 
#   filter(depth <= 20)

# test plot without averaging surface temperature 
# surface_temp_mean %>% 
#   ggplot(aes(x = OceanSODA_temp, y = temp_adjusted)) +
#   geom_bin2d(aes(x = OceanSODA_temp, y = temp_adjusted)) +
#   geom_abline(slope = 1, intercept = 0) +
#   coord_fixed(ratio = 1,
#               xlim = c(-3, 28),
#               ylim = c(-3, 28)) +
#   facet_wrap(~temp_extreme) +
#   labs(x = 'OceanSODA temp',
#        y = 'Argo temp')


surface_temp_mean %>% 
  group_by(temp_extreme) %>% 
  group_split(temp_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = OceanSODA_surf_temp, 
             y = argo_surf_temp))+
  geom_bin2d(data = .x, aes(x = OceanSODA_surf_temp, 
                 y = argo_surf_temp), size = 0.3, bins = 60) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1,
              xlim = c(-3, 28),
              ylim = c(-3, 28))+
    labs(title = paste('temp extreme:', unique(.x$temp_extreme)),
         x = 'OceanSODA temp',
         y = 'Argo temp')
  )
```

### Season x biome

```{r mean_temp_profiles_season_biome, fig.asp=1}

profile_temp_extreme_biome <- profile_temp_extreme %>% 
  group_by(season, biome, temp_extreme, depth) %>% 
  summarise(temp_biome = mean(temp_adjusted, na.rm = TRUE),
            temp_std_biome = sd(temp_adjusted, na.rm = TRUE)) %>% 
  ungroup()
  

profile_temp_extreme_biome %>%
  ggplot(aes(
    x = temp_biome,
    y = depth,
    group = temp_extreme,
    col = temp_extreme
  )) +
  geom_ribbon(aes(xmax = temp_biome + temp_std_biome,
                  xmin = temp_biome - temp_std_biome,
                  group = temp_extreme,
                  fill = temp_extreme),
              col = NA, 
              alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(col = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       y = 'sqrt(depth)',
       x = 'biome mean Argo temperature (ºC)') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
  lims(x = c(-3, 18))+
  facet_grid(season ~ biome)
```

Number of profiles season x biome

```{r count_temp_profiles_season_biome, fig.asp=1}

profile_temp_count_biome <- profile_temp_extreme %>% 
  distinct(season, biome, temp_extreme, platform_number, cycle_number) %>% 
  group_by(season, biome, temp_extreme) %>% 
  count(temp_extreme)

profile_temp_count_biome %>% 
  ggplot(aes(x = temp_extreme, y = n, fill = temp_extreme))+
  geom_col(width = 0.5)+
  facet_grid(season ~ biome)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles season x biome')
```

Surface Argo temp vs surface OceanSODA temp season x biome (20 m)

```{r argo_vs_OceanSODA_temp_biome, fig.asp=1}

surface_temp_biome <- profile_temp_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season, biome, temp_extreme, platform_number, cycle_number) %>% 
  summarise(argo_surf_temp = mean(temp_adjusted, na.rm=TRUE),
            OceanSODA_surf_temp = mean(OceanSODA_temp, na.rm = TRUE))

surface_temp_biome %>% 
  group_by(temp_extreme) %>% 
  group_split(temp_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = OceanSODA_surf_temp, 
             y = argo_surf_temp))+
  geom_bin2d(data = .x, aes(x = OceanSODA_surf_temp, 
                 y = argo_surf_temp)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(-3, 25),
              ylim = c(-3, 25))+
  facet_grid(season~biome) +
    labs(title = paste( 'Temp extreme:', unique(.x$temp_extreme)),
         x = 'OceanSODA temp',
         y = 'Argo temp')
  )
```

### Season x basin

```{r mean_basin_temp_profiles, fig.asp=1}

profile_temp_extreme_basin <- profile_temp_extreme %>% 
  group_by(season, basin_AIP, temp_extreme, depth) %>% 
  summarise(temp_basin = mean(temp_adjusted, na.rm = TRUE),
            temp_basin_std = sd(temp_adjusted, na.rm = TRUE)) %>% 
  ungroup()

profile_temp_extreme_basin %>% 
  ggplot(aes(x = temp_basin, 
             y = depth, 
             group = temp_extreme, 
             col = temp_extreme))+
  geom_ribbon(aes(xmin = temp_basin - temp_basin_std,
                  xmax = temp_basin + temp_basin_std,
                  group = temp_extreme, 
                  fill = temp_extreme),
              col = NA, 
              alpha = 0.2)+
  geom_path()+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  labs(col = 'OceanSODA\ntemp anomaly\n(mean ± st dev)',
       fill = 'OceanSODA\ntemp anomaly\n(mean ± st dev)',
       y = 'sqrt(depth)',
       x = 'basin-mean Argo temperature (ªC)')+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
  facet_grid(season~basin_AIP)
```

Number of profiles season x basin

```{r count_basin_temp_profiles, fig.asp=1}

profile_temp_count_basin <- profile_temp_extreme %>% 
  distinct(season, basin_AIP, temp_extreme, platform_number, cycle_number) %>% 
  group_by(season, basin_AIP, temp_extreme) %>% 
  count(temp_extreme)

profile_temp_count_basin %>% 
  ggplot(aes(x = temp_extreme, y = n, fill = temp_extreme))+
  geom_col(width = 0.5)+
  facet_grid(season~basin_AIP)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles season x basin')
```

Surface Argo temperature vs surface OceanSODA temperature (20 m) season x basin

```{r argo_vs_OceanSODA_temp_basin, fig.asp=1}
# calculate surface-mean argo pH to compare against OceanSODA surface pH (one value)
surface_temp_basin <- profile_temp_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season, basin_AIP, temp_extreme, platform_number, cycle_number) %>% 
  summarise(surf_argo_temp = mean(temp_adjusted, na.rm=TRUE),
            surf_OceanSODA_temp = mean(OceanSODA_temp, na.rm = TRUE)) 

surface_temp_basin %>% 
  group_by(temp_extreme) %>% 
  group_split(temp_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = surf_OceanSODA_temp, 
             y = surf_argo_temp))+
  geom_bin2d(data = .x, aes(x = surf_OceanSODA_temp, 
                 y = surf_argo_temp)) +
    scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(-3, 25),
              ylim = c(-3, 25))+
  facet_grid(season~basin_AIP) +
    labs(title = paste('Temp extreme:', unique(.x$temp_extreme)),
         x = 'OceanSODA temp',
         y = 'Argo temp')
  )
```

### Season x biome x basin

```{r mean_temp_profiles_season_biome_basin, fig.asp=1}

profile_temp_extreme_season <- profile_temp_extreme %>%
  group_by(season, biome, basin_AIP, temp_extreme, depth) %>%
  summarise(temp_mean = mean(temp_adjusted, na.rm = TRUE),
            temp_std = sd(temp_adjusted, na.rm = TRUE)) %>%
  ungroup()

profile_temp_extreme_season %>%
  arrange(depth) %>%
  group_split(season) %>%
  # head(1) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(x = temp_mean,
          y = depth,
          group = temp_extreme,
          col = temp_extreme)) +
      geom_ribbon(aes(xmax = temp_mean + temp_std,
                      xmin = temp_mean - temp_std,
                      group = temp_extreme,
                      fill = temp_extreme),
                  col = NA,
                  alpha = 0.2)+
      geom_path() +
      scale_color_manual(values = HNL_colors) +
      scale_fill_manual(values = HNL_colors) +
      labs(title = paste("season:", unique(.x$season)),
           col = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
           fill = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
           y = 'sqrt(depth)',
           x = 'mean Argo temperature (ºC)') +
      scale_y_continuous(
        trans = trans_reverser("sqrt"),
        breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))
      ) +
      facet_grid(basin_AIP ~ biome)
  )
```

Number of profiles season x biome x basin

```{r number_season_biome_basin_temp_profiles, fig.asp=1}

profile_temp_count_season <- profile_temp_extreme %>% 
  distinct(season, biome, basin_AIP,
           temp_extreme, platform_number, cycle_number) %>% 
  group_by(season, biome, basin_AIP, temp_extreme) %>% 
  count(temp_extreme)


profile_temp_count_season %>% 
  group_by(season) %>% 
  group_split(season) %>% 
  map(
    ~ggplot()+
      geom_col(data =.x, 
               aes(x = temp_extreme,
                   y = n,
                   fill = temp_extreme),
               width = 0.5)+
      facet_grid(basin_AIP ~ biome)+
      scale_y_continuous(trans = 'log10')+
      labs(y = 'log(number of profiles)',
           title = paste('season:', unique(.x$season)))
  )
```

Surface Argo temperature vs surface OceanSODA temperature (20 m) season x biome x basin

```{r surface_OceanSODA_vs_argo_temp_season, fig.asp=1}

# calculate surface-mean argo pH, for each season x biome x basin x ph extreme 
surface_temp_season <- profile_temp_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season, 
           basin_AIP, 
           biome, 
           temp_extreme,  
           platform_number, 
           cycle_number) %>%  
  summarise(surf_argo_temp = mean(temp_adjusted, na.rm=TRUE),
            surf_OceanSODA_temp = mean(OceanSODA_temp, na.rm = TRUE)) 

surface_temp_season %>% 
  group_by(season, temp_extreme) %>% 
  group_split(season, temp_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = surf_OceanSODA_temp, 
             y = surf_argo_temp))+
  geom_bin2d(data = .x, aes(x = surf_OceanSODA_temp, 
                 y = surf_argo_temp)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(-3, 25),
              ylim = c(-3, 25))+
  facet_grid(basin_AIP ~ biome) +
    labs(title = paste('season:', unique(.x$season), 
                        '| temp extreme:', unique(.x$temp_extreme)),
         x = 'OceanSODA temp',
         y = 'Argo temp')
  )
```

##### Season x biome x Atlantic basin 

```{r temp_profile_season_biome_Atlantic, fig.asp=1}

profile_temp_extreme_season %>%
  filter(basin_AIP == 'Atlantic') %>% 
  arrange(depth) %>%
  group_split(season) %>%
  # head(1) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(x = temp_mean,
          y = depth,
          group = temp_extreme,
          col = temp_extreme)) +
      geom_ribbon(aes(xmax = temp_mean + temp_std,
                      xmin = temp_mean - temp_std,
                      group = temp_extreme,
                      fill = temp_extreme),
                  col = NA,
                  alpha = 0.2)+
      geom_path() +
      scale_color_manual(values = HNL_colors) +
      scale_fill_manual(values = HNL_colors) +
      labs(title = paste("Atlantic basin, season:", unique(.x$season)),
           col = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
           fill = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
           y = 'sqrt(depth)',
           x = 'mean Argo temperature (ºC)') +
      scale_y_continuous(
        trans = trans_reverser("sqrt"),
        breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))
      ) +
      facet_wrap(~ biome)
  )
```
