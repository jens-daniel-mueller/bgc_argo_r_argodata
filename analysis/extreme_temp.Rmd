---
title: "Extreme BGC-Temperature Profiles"
author: "Pasqualina Vonlanthen, David Stappard & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Task

Compare depth profiles of normal temperature and of extreme temperature, as identified in the surface OceanSODA data product

```{r load_libraries, include=FALSE}
library(tidyverse)
library(lubridate)
library(broom)
library(ggOceanMaps)
library(scico)
library(metR)
library(ggforce)
library(oce)
library(ggrepel)
library(ggnewscale)
```

```{r set_global_theme}

theme_set(theme_bw())
HNL_colors <- c("H" = "#b2182b",
                "N" = "#636363",
                "L" = "#2166ac")

HNL_colors_map <- c('H' = 'red3',
                    'N' = 'transparent',
                    'L' = 'blue3')

# opt_min_profile_range
# profiles with profile_range >= opt_min_profile_range will be selected 1 = profiles of at least 600m, 2 = profiles of at least 1200m, 3 = profiles of at least 1500m
opt_min_profile_range = 3

# opt_extreme_determination
# 1 - based on the trend of de-seasonal data - we believe this results in more summer extremes where variation tend to be greater.
# 2 - based on the trend of de-seasonal data by month. grouping is by lat, lon and month.
opt_extreme_determination <- 2

```

# Load data

```{r set_root_directories}
path_argo <- '/nfs/kryo/work/updata/bgc_argo_r_argodata'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")
path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"
path_updata <- '/nfs/kryo/work/updata'
path_argo_clim_temp <- paste0(path_updata, "/argo_climatology/temperature")

path_argo <- '/nfs/kryo/work/datasets/ungridded/3d/ocean/floats/bgc_argo'
# /nfs/kryo/work/datasets/ungridded/3d/ocean/floats/bgc_argo/preprocessed_bgc_data
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

```

```{r load_data}

# RECCAP2-ocean region mask

#  region_masks_all_2x2 <- read_rds(file = paste0(path_argo_preprocessed,
#                                                 "/region_masks_all_2x2.rds"))
# #   
# region_masks_all_2x2 <- region_masks_all_2x2 %>%
#   rename(biome = value) %>%
#   mutate(coast = as.character(coast))

# updated biomes of Nicolas Mayot 

nm_biomes <- read_rds(file = paste0(path_argo_preprocessed, "/nm_biomes.rds"))

# WOA 18 basin mask

basinmask <-
  read_csv(
    paste(path_emlr_utilities,
          "basin_mask_WOA18.csv",
          sep = ""),
    col_types = cols("MLR_basins" = col_character())
  )

basinmask <- basinmask %>%
  filter(MLR_basins == unique(basinmask$MLR_basins)[1]) %>% 
  select(-c(MLR_basins, basin))

# OceanSODA temperature (from 1995 to 2020)

OceanSODA_temp <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_temp.rds"))

OceanSODA_temp <- OceanSODA_temp %>%
  mutate(month = month(date))

# load validated and vertically aligned temp profiles, 
full_argo <-
  read_rds(file = paste0(path_argo_preprocessed, "/temp_bgc_va.rds")) %>%
  filter(profile_range >= opt_min_profile_range) %>%
  mutate(date = ymd(format(date, "%Y-%m-15")))


# base map for plotting
map <-
  read_rds(paste(path_emlr_utilities,
                 "map_landmask_WOA18.rds",
                 sep = ""))

```

# Regions

## Biome grid reduction

```{r new_mayot_biomes_pre_grid_reduction, fig.asp=0.4}

map+
  geom_tile(data = nm_biomes,
            aes(x = lon,
                y = lat,
                fill = biome_name))+
  scale_fill_brewer(palette = 'Dark2')+
  labs(title = 'Mayot biomes (pre-grid reduction)')

```

```{r polar_projection_Mayot_biomes_pre_grid_reduction, eval=FALSE}

basemap(limits = -30)+
  geom_spatial_tile(data = nm_biomes,
                    aes(x = lon,
                        y = lat,
                        fill = biome_name),
                    col = NA)+
  scale_fill_brewer(palette = 'Dark2')+
  labs(title = 'Mayot biomes (pre-grid reduction)')

```


```{r grid_reduction_to_true_2x2_region_mask}

# Commented
# nm_biomes_2x2 <- nm_biomes %>% 
#   mutate(lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
#          lon = as.numeric(as.character(lon)),
#          lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
#          lat = as.numeric(as.character(lat)))
# 
# nm_biomes_2x2 <- nm_biomes_2x2 %>% 
#   count(lon, lat, biome_name) %>% 
#   group_by(lon, lat) %>% 
#   slice_max(n, with_ties = FALSE) %>% 
#   ungroup()

# New
nm_biomes <- nm_biomes %>% 
  count(lon, lat, biome_name) %>% 
  group_by(lon, lat) %>% 
  slice_max(n, with_ties = FALSE) %>% 
  ungroup()

# Commented
#rm(nm_biomes)

```


```{r new_mayot_biomes_map, fig.asp=0.4}

# map+
#   geom_tile(data = nm_biomes_2x2,
#             aes(x = lon,
#                 y = lat,
#                 fill = biome_name))+
#   scale_fill_brewer(palette = 'Dark2')+
#   labs('Mayot biomes post-grid reduction')

```

```{r polar_projection_mayot_biomes, eval=FALSE}

# basemap(limits = -30)+
#   geom_spatial_tile(data = nm_biomes_2x2,
#                     aes(x = lon, 
#                         y = lat,
#                         fill = biome_name),
#                     col = NA)+
#   scale_fill_brewer(palette = 'Dark2')+
#   labs(title = 'Mayot biomes (post-grid reduction)')

```

```{r basin_map_pre_grid_reduction, fig.asp=0.4}

map +
  geom_tile(data = basinmask, 
            aes(x = lon, 
                y = lat, 
                fill = basin_AIP))+
  scale_fill_brewer(palette = 'Dark2')

```

```{r grid_reduction_to_true_2x2_basinmask}

# Commented
# basinmask_2x2 <- basinmask %>%
#   mutate(
#     lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
#     lat = as.numeric(as.character(lat)),
#     lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
#     lon = as.numeric(as.character(lon))
#    )
# 
# # assign basins from each pixel to to each 2 Lon x Lat pixel, based on the majority of basins in each 2x2 grid
# 
# basinmask_2x2 <- basinmask_2x2 %>%
#   count(lon, lat, basin_AIP) %>%
#   group_by(lon, lat) %>%
#   slice_max(n, with_ties = FALSE) %>%
#   ungroup() %>%
#   select(-n)

# Added
basinmask <- basinmask %>%
  count(lon, lat, basin_AIP) %>%
  group_by(lon, lat) %>%
  slice_max(n, with_ties = FALSE) %>%
  ungroup() %>%
  select(-n)

# commented
#rm(basinmask)

```

```{r basin_map_post_grid_reduction, fig.asp=0.4}

# map+
#   geom_tile(data = basinmask_2x2 %>% filter(lat < -30),
#             aes(x = lon,
#                 y = lat,
#                 fill = basin_AIP))+
#   scale_fill_brewer(palette = 'Dark2')

```

```{r polar_projection_basin_map, eval=FALSE}

# basemap(limits = -32)+
#   geom_spatial_tile(data = basinmask_2x2 %>% filter(lat < -32),
#                     aes(x = lon,
#                         y = lat,
#                         fill = basin_AIP),
#                     col = NA)+
#   scale_fill_brewer(palette = 'Dark2')

```

# OceanSODA

## Monthly clim

```{r calculate_climatological_temperature}

OceanSODA_temp <- OceanSODA_temp %>% 
  group_by(lon, lat, month) %>% 
  mutate(clim_temp = mean(temperature, na.rm = TRUE),
         clim_diff = temperature - clim_temp,
         .after = temperature) %>% 
  ungroup()

```

## Grid reduction

```{r grid_reduction_to_2x2_OceanSODA_temp}

# Note: While reducing lon x lat grid,
# we keep the original number of observations

# Commented
# OceanSODA_temp_2x2 <- OceanSODA_temp %>%
#   mutate(
#     lat_raw = lat,
#     lon_raw = lon,
#     lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
#     lat = as.numeric(as.character(lat)),
#     lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
#     lon = as.numeric(as.character(lon))) # regrid into 2x2º grid

# Added
OceanSODA_temp <- OceanSODA_temp %>%
  mutate(
    lat_raw = lat,
    lon_raw = lon)

# commented
#rm(OceanSODA_temp)

```

## Apply region masks

Propose not to add biomes as these restrict to SO

```{r apply_region_masks_OceanSODA_temp, fig.asp=0.4}

# keep only Southern Ocean data
# OceanSODA_temp_2x2_SO <- inner_join(OceanSODA_temp_2x2, nm_biomes_2x2 %>% 
                                       # select(-n)) 
# 
# rm(OceanSODA_temp_2x2)

# # add in basin separations
# OceanSODA_temp_2x2_SO <- inner_join(OceanSODA_temp_2x2_SO, basinmask_2x2)
# # expected number of rows from -30 to -70º latitude, 360º longitude, for 12 months, 8 years:
# # 40 lat x 360 lon x 12 months x 8 years = 1 382 400 rows 
# # actual number of rows: 925 260 (in line with expectations)
# 
# OceanSODA_temp_2x2_SO <- OceanSODA_temp_2x2_SO %>% 
#    filter(!is.na(temperature))
# # no NA clim_diff values 


# OceanSODA_temp_SO <- inner_join(OceanSODA_temp, nm_biomes %>% 
#                                        select(-n)) 

# add in basin separations
OceanSODA_temp <- inner_join(OceanSODA_temp, basinmask)

OceanSODA_temp <- OceanSODA_temp %>% 
   filter(!is.na(temperature))

```

## Maps

```{r map_OceanSODA_temp_clim_diff, fig.asp=1.5}

OceanSODA_temp %>% 
  filter(year == 2020) %>% 
  ggplot(aes(lon_raw, lat_raw, fill = clim_temp)) +
  geom_tile() +
  scale_fill_viridis_c() +
  facet_wrap(~ month, ncol = 2) +
  coord_quickmap(expand = 0)


```

```{r monthly_clim_OceanSODA_temp_map, fig.asp=0.4}

OceanSODA_temp %>% 
  group_split(month) %>% 
  #head(1) %>% 
  map(
    ~map +
      geom_tile(data = .x,
                aes(x = lon_raw,
                    y = lat_raw,
                    fill = clim_temp))+
      scale_fill_viridis_c()+
      labs(title = paste0('month:', unique(.x$month)))+
      theme(legend.position = 'right')
  )
  
```

```{r OceanSODA_temp_anomaly_map, fig.asp=1}
  
OceanSODA_temp %>% 
  group_split(month) %>% 
  #head(1) %>% 
  map(
    ~map +
      geom_tile(data = .x,
                aes(x = lon_raw,
                    y = lat_raw,
                    fill = clim_diff))+
      scale_fill_divergent(mid = 'grey80')+
      facet_wrap(~year, ncol = 3)+
      labs(title = paste0('month:', unique(.x$month)))+
      theme(legend.position = 'right')
  )

```

# SST anomalies

Through setting only one of the following two code chunks to "eval=FALSE" you can choose between a lr- and a mean-based anomaly detection.

## Fit lr models

```{r fit_temp_linear_regression}

# create a decimal_year column to use are the parameter to the regression function
OceanSODA_temp <- OceanSODA_temp %>%
  mutate(decimal_year = decimal_date(date), .after = year)

# fit a linear regression of OceanSODA temp against time (temporal trend)
# in each lat/lon/month grid, month is used depending on opt_extreme_determination
if (opt_extreme_determination == 1){
  OceanSODA_temp_regression <- OceanSODA_temp %>% 
    nest(data = -c(lon, lat)) %>%
    mutate(fit = map(.x = data,
                     .f = ~ lm(clim_diff ~ decimal_year, data = .x)),
           tidied = map(.x = fit, .f = tidy),
           glanced = map(.x = fit, .f = glance),
           augmented = map(.x = fit, .f = augment)) 
} else if (opt_extreme_determination == 2){
  OceanSODA_temp_regression <- OceanSODA_temp %>% 
    nest(data = -c(lon, lat, month)) %>%
    mutate(fit = map(.x = data,
                     .f = ~ lm(clim_diff ~ decimal_year, data = .x)),
           tidied = map(.x = fit, .f = tidy),
           glanced = map(.x = fit, .f = glance),
           augmented = map(.x = fit, .f = augment)) 
}

OceanSODA_temp_regression_tidied <- OceanSODA_temp_regression %>%
  select(-c(data, fit, augmented, glanced)) %>%
  unnest(tidied) 

OceanSODA_temp_regression_tidied <- OceanSODA_temp_regression_tidied %>% 
  select(lon:estimate) %>% 
  pivot_wider(names_from = term,
              values_from = estimate) %>% 
  rename(intercept = `(Intercept)`,
         slope = decimal_year)

OceanSODA_temp_regression_augmented <- OceanSODA_temp_regression %>%
  select(-c(fit, tidied, glanced, data)) %>%
  unnest(augmented) %>% 
  select(lon:decimal_year, .resid) 

OceanSODA_temp_regression_data <- OceanSODA_temp_regression %>% 
  select(-c(fit, tidied, glanced, augmented)) %>% 
  unnest(data) 

OceanSODA_temp_regression_augmented <- bind_cols(
  OceanSODA_temp_regression_augmented,
  OceanSODA_temp_regression_data %>% 
    select(date,
           basin_AIP, 
           temperature, 
           clim_temp, 
           lat_raw, 
           lon_raw))

OceanSODA_temp_regression_glanced <- OceanSODA_temp_regression %>%
  select(-c(data, fit, tidied, augmented)) %>%
  unnest(glanced) 
```

## Fit mean

```{r fit_temp_mean, eval=FALSE}

# identify the mean value
# in each lat/lon/month grid
OceanSODA_temp_regression_tidied <- OceanSODA_temp_2x2_SO %>% 
  group_by(lon, lat, month) %>%
  summarise(slope = 0,
            intercept = mean(clim_diff, na.rm = TRUE)) %>% 
  ungroup()

OceanSODA_temp_regression_glanced <- OceanSODA_temp_2x2_SO %>% 
  group_by(lon, lat, month) %>%
  summarise(sigma = sd(clim_diff, na.rm = TRUE)) %>% 
  ungroup()

OceanSODA_temp_regression_augmented <- OceanSODA_temp_2x2_SO %>% 
  mutate(.resid = clim_diff)

```

## Slope maps

```{r map_temp_regression_slopes_flat, fig.asp=1}

if (opt_extreme_determination == 1){
  map +
    geom_tile(data = OceanSODA_temp_regression_tidied,
              aes(x = lon,
                  y = lat,
                  fill = slope)) +
    scale_fill_scico(palette = 'vik', midpoint = 0)
} else if (opt_extreme_determination == 2){
  map +
    geom_tile(data = OceanSODA_temp_regression_tidied,
              aes(x = lon,
                  y = lat,
                  fill = slope)) +
    scale_fill_scico(palette = 'vik', midpoint = 0) +
    facet_wrap( ~ month, ncol = 2)
}

```

## Sigma maps

```{r temp_map_sigma, fig.asp=1}

if (opt_extreme_determination == 1){
  map +
    geom_tile(data = OceanSODA_temp_regression_glanced,
              aes(x = lon,
                  y = lat,
                  fill = sigma)) +
    scale_fill_viridis_c() +
    labs(fill = '1 residual \nst. dev.')
} else if (opt_extreme_determination == 2){
  map +
    geom_tile(data = OceanSODA_temp_regression_glanced,
              aes(x = lon,
                  y = lat,
                  fill = sigma)) +
    scale_fill_viridis_c() +
    labs(fill = '1 residual \nst. dev.') +
    facet_wrap(~month, ncol = 2)
}  

```

## Anomaly identification

Calculate OceanSODA surface temperature anomalies; L for abnormally low, H for abnormally high, and N for normal

```{r calculate_extreme_OceanSODA_temp_grid}

# when the in-situ OceanSODA temperature is lower than the 5th percentile (predicted - 2*residual.st.dev), assign 'L' for low extreme
# when the in-situ OceanSODA temperature exceeds the 95th percentile (predicted + 2*residual.st.dev), assign 'H' for high extreme
# when the in-situ OceanSODA temperature is within 95% of the range, then assign 'N' for normal pH

# combine observations and regression statistics
if (opt_extreme_determination == 1){
  OceanSODA_temp_extreme_grid <-
    full_join(
      OceanSODA_temp_regression_augmented,
      OceanSODA_temp_regression_glanced %>%
        select(lon:lat, sigma)
    )
} else if (opt_extreme_determination == 2){
  OceanSODA_temp_extreme_grid <-
    full_join(
      OceanSODA_temp_regression_augmented,
      OceanSODA_temp_regression_glanced %>%
        select(lon:month, sigma)
    )
}
# results in 925 056 rows 

# identify observations in anomaly classes
OceanSODA_temp_extreme_grid <- OceanSODA_temp_extreme_grid %>%
  mutate(
    temp_extreme = case_when(
      .resid < -sigma*2 ~ 'L',
      .resid > sigma*2 ~ 'H',
      TRUE ~ 'N'
    )
  ) 

OceanSODA_temp_extreme_grid <- OceanSODA_temp_extreme_grid %>%
  mutate(temp_extreme = fct_relevel(temp_extreme, "H", "N", "L"))


# combine with regression coefficients

OceanSODA_temp_extreme_grid <-
  full_join(OceanSODA_temp_extreme_grid,
            OceanSODA_temp_regression_tidied) 

OceanSODA_temp_extreme_grid <- OceanSODA_temp_extreme_grid %>%
  mutate(year = year(date),
         month = month(date),
         .after = decimal_year)

# 925 056 rows, in line with expectations for 40 lat x 360 lon x 12 months x 8 years (1 382 400 obs minus NA values)
```

### Write anomalies to file 

```{r OceanSODA_SST_anomalies_to_file}

# Restrict to SO by inner join to nm_biomes
OceanSODA_temp_SO_extreme_grid <- inner_join(OceanSODA_temp_extreme_grid, nm_biomes %>% 
                                        select(-n)) 

if (opt_extreme_determination == 1){
  OceanSODA_temp_SO_extreme_grid %>%
    write_rds(file = paste0(
      path_argo_preprocessed,
      "/OceanSODA_SST_anomaly_field_01.rds"
    ))
  OceanSODA_temp_extreme_grid %>%
    write_rds(file = paste0(
      path_argo_preprocessed,
      "/OceanSODA_global_SST_anomaly_field_01.rds"
    ))
} else if (opt_extreme_determination == 2){
  OceanSODA_temp_SO_extreme_grid %>%
    write_rds(file = paste0(
      path_argo_preprocessed,
      "/OceanSODA_SST_anomaly_field_02.rds"
    ))
  OceanSODA_temp_extreme_grid %>%
    write_rds(file = paste0(
      path_argo_preprocessed,
      "/OceanSODA_global_SST_anomaly_field_02.rds"
    ))
}

```

```{r temp_anomaly_test_plot_grid, fig.asp=0.4}

if (opt_extreme_determination == 1){
  OceanSODA_temp_SO_extreme_grid %>%
    group_split(lon, lat) %>%
    head(6) %>%
    map(
      ~ ggplot(data = .x) +
        geom_point(aes(
          x = year,
          y = clim_diff,
          col = temp_extreme
        )) +
        geom_abline(data = .x, aes(slope = slope,
                                   intercept = intercept)) +
        geom_abline(
          data = .x,
          aes(slope = slope,
              intercept = intercept + 2 * sigma),
          linetype = 2
        ) +
        geom_abline(
          data = .x,
          aes(slope = slope,
              intercept = intercept - 2 * sigma),
          linetype = 2
        ) +
        labs(title = paste(
          fititle = paste("lon:", unique(.x$lon),
                          "| lat:", unique(.x$lat))
        )) +
        scale_color_manual(values = HNL_colors)
    )
} else if (opt_extreme_determination == 2){
  OceanSODA_temp_SO_extreme_grid %>%
    group_split(lon, lat, month) %>%
    head(6) %>%
    map(
      ~ ggplot(data = .x) +
        geom_point(aes(
          x = year,
          y = clim_diff,
          col = temp_extreme
        )) +
        geom_abline(data = .x, aes(slope = slope,
                                   intercept = intercept)) +
        geom_abline(
          data = .x,
          aes(slope = slope,
              intercept = intercept + 2 * sigma),
          linetype = 2
        ) +
        geom_abline(
          data = .x,
          aes(slope = slope,
              intercept = intercept - 2 * sigma),
          linetype = 2
        ) +
        labs(title = paste(fititle = paste(
          "lon:", unique(.x$lon),
          "| lat:", unique(.x$lat),
          "| month:", unique(.x$month)
        ))) +
        scale_color_manual(values = HNL_colors)
    )
}

```

## Global anomaly identification

```{r global_OceanSODA_temp, eval=FALSE}

# Check valid temperature
OceanSODA_temp <- OceanSODA_temp %>% 
   filter(!is.na(temperature))

# create a decimal_year column to use are the parameter to the regression function
OceanSODA_temp <- OceanSODA_temp %>%
  mutate(decimal_year = decimal_date(date), .after = year)

# fit a linear regression of OceanSODA temp against time (temporal trend)
# in each lat/lon/month grid, month is used depending on opt_extreme_determination
if (opt_extreme_determination == 1){
  OceanSODA_temp_regression <- OceanSODA_temp %>%
    nest(data = -c(lon, lat)) %>%
    mutate(
      fit = map(
        .x = data,
        .f = ~ lm(clim_diff ~ decimal_year, data = .x)
      ),
      tidied = map(.x = fit, .f = tidy),
      glanced = map(.x = fit, .f = glance),
      augmented = map(.x = fit, .f = augment)
    )
} else if (opt_extreme_determination == 2){
  OceanSODA_temp_regression <- OceanSODA_temp %>%
    nest(data = -c(lon, lat, month)) %>%
    mutate(
      fit = map(
        .x = data,
        .f = ~ lm(clim_diff ~ decimal_year, data = .x)
      ),
      tidied = map(.x = fit, .f = tidy),
      glanced = map(.x = fit, .f = glance),
      augmented = map(.x = fit, .f = augment)
    )
}

OceanSODA_temp_regression_tidied <- OceanSODA_temp_regression %>%
  select(-c(data, fit, augmented, glanced)) %>%
  unnest(tidied) 

OceanSODA_temp_regression_tidied <- OceanSODA_temp_regression_tidied %>% 
  select(lon:estimate) %>% 
  pivot_wider(names_from = term,
              values_from = estimate) %>% 
  rename(intercept = `(Intercept)`,
         slope = decimal_year)

OceanSODA_temp_regression_augmented <- OceanSODA_temp_regression %>%
  select(-c(fit, tidied, glanced, data)) %>%
  unnest(augmented) %>% 
  select(lon:decimal_year, .resid) 

OceanSODA_temp_regression_data <- OceanSODA_temp_regression %>% 
  select(-c(fit, tidied, glanced, augmented)) %>% 
  unnest(data) 

OceanSODA_temp_regression_augmented <- bind_cols(
  OceanSODA_temp_regression_augmented,
  OceanSODA_temp_regression_data %>% 
    select(date,
           temperature, clim_temp, 
           lat_raw, lon_raw))

OceanSODA_temp_regression_glanced <- OceanSODA_temp_regression %>%
  select(-c(data, fit, tidied, augmented)) %>%
  unnest(glanced) 

# Anomally identification

# when the in-situ OceanSODA temperature is lower than the 5th percentile (predicted - 2*residual.st.dev), assign 'L' for low extreme
# when the in-situ OceanSODA temperature exceeds the 95th percentile (predicted + 2*residual.st.dev), assign 'H' for high extreme
# when the in-situ OceanSODA temperature is within 95% of the range, then assign 'N' for normal pH

# combine observations and regression statistics
if (opt_extreme_determination == 1){
  OceanSODA_temp_extreme_grid <-
    full_join(
      OceanSODA_temp_regression_augmented,
      OceanSODA_temp_regression_glanced %>%
        select(lon:lat, sigma)
    )
} else if (opt_extreme_determination == 2){
  OceanSODA_temp_extreme_grid <-
    full_join(
      OceanSODA_temp_regression_augmented,
      OceanSODA_temp_regression_glanced %>%
        select(lon:month, sigma)
    )
}

# identify observations in anomaly classes
OceanSODA_temp_extreme_grid <- OceanSODA_temp_extreme_grid %>%
  mutate(
    temp_extreme = case_when(
      .resid < -sigma*2 ~ 'L',
      .resid > sigma*2 ~ 'H',
      TRUE ~ 'N'
    )
  ) 

OceanSODA_temp_extreme_grid <- OceanSODA_temp_extreme_grid %>%
  mutate(temp_extreme = fct_relevel(temp_extreme, "H", "N", "L"))

# combine with regression coefficients
OceanSODA_temp_extreme_grid <-
  full_join(OceanSODA_temp_extreme_grid,
            OceanSODA_temp_regression_tidied) 

OceanSODA_temp_extreme_grid <- OceanSODA_temp_extreme_grid %>%
  mutate(year = year(date),
         month = month(date),
         .after = decimal_year)


# Write anomalies to file
if (opt_extreme_determination == 1){
  OceanSODA_temp_extreme_grid %>%
    write_rds(file = paste0(
      path_argo_preprocessed,
      "/OceanSODA_global_SST_anomaly_field_01.rds"
    ))
} else if (opt_extreme_determination == 2){
  OceanSODA_temp_extreme_grid %>%
    write_rds(file = paste0(
      path_argo_preprocessed,
      "/OceanSODA_global_SST_anomaly_field_02.rds"
    ))
}

```

## Anomaly maps

```{r map_temp_extremes_1x1_plot, fig.asp=1.5}
# anomaly maps on a 1x1 grid 

OceanSODA_temp_extreme_grid %>% 
  filter(year >= 2013) %>% 
  group_split(month) %>% 
  #head(1) %>% 
  map(
    ~map +
      geom_tile(data = .x,
                aes(x = lon_raw,
                    y = lat_raw,
                    fill = temp_extreme),
                width = 1,
                height = 1)+
      scale_fill_manual(values = HNL_colors_map)+
      facet_wrap(~year, ncol = 2)+
      labs(title = paste('month:', unique(.x$month)),
           fill = 'temperature')
  )
```

## Anomaly timeseries

```{r extreme_temp_timeseries_grid}
# calculate a regional mean temperature for each biome, basin, and temp extreme (H/L/N) and plot a timeseries 

OceanSODA_temp_SO_extreme_grid %>% 
  group_by(year, biome_name, basin_AIP, temp_extreme) %>% 
  summarise(temp_regional = mean(temperature, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = temp_regional, col = temp_extreme))+
  geom_point(size = 0.3)+
  geom_line()+
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP~biome_name)+
  theme(legend.position = 'bottom')

```

## Anomaly histogram

```{r extreme_temp_histogram_grid}

# histograms for each extreme level 

OceanSODA_temp_SO_extreme_grid %>%
  ggplot(aes(temperature, col = temp_extreme)) +
  geom_density() +
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP ~ biome_name) +
  coord_cartesian(xlim = c(-2, 28)) +
  labs(x = 'value',
       y = 'density',
       col = 'temp anomaly') +
  theme(legend.position = 'bottom')
```

# Argo (BGC-temperature)

## Grid reduction

```{r grid_reduction_to_2x2_argo}

# Note: While reducing lon x lat grid,
# we keep the original number of observations

# full_argo_2x2 <- full_argo %>%
#   mutate(
#     lat_raw = lat,
#     lon_raw = lon,
#     lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
#     lat = as.numeric(as.character(lat)),
#     lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
#     lon = as.numeric(as.character(lon)))  # re-grid to 2x2

full_argo <- full_argo %>%
  mutate(
    lat_raw = lat,
    lon_raw = lon)

```

## Apply region masks

```{r apply_region_masks_argo, eval=FALSE}

# add in new Mayot biome information
full_argo_2x2_SO <- inner_join(full_argo_2x2, nm_biomes_2x2)

# add in basin separations
full_argo_2x2_SO <- inner_join(full_argo_2x2_SO, basinmask_2x2)

```

# Join OceanSODA

```{r combine_extreme_temp_OceanSODA_to_Argo}

# revert OceanSODA to regular 1x1 grid
OceanSODA_temp_SO_extreme_grid <- OceanSODA_temp_SO_extreme_grid %>%
  select(-c(lon, lat)) %>%
  rename(OceanSODA_temp = temperature,
         lon = lon_raw,
         lat = lat_raw) %>% 
  filter(year >=2013)
# 925 056 obs 

# combine the argo profile data to the surface extreme data
profile_temp_extreme <- inner_join(
  full_argo %>%
    select(
      file_id, 
      year, 
      month, 
      date, 
      lon, 
      lat, 
      depth, 
      temp
      ),
  OceanSODA_temp_SO_extreme_grid %>% 
    select(c(year, month, date, lon, lat,
           OceanSODA_temp, temp_extreme,
           clim_temp, clim_diff,
           basin_AIP, biome_name)))

# profile_temp_extreme <- profile_temp_extreme %>% 
#   unite('platform_cycle', platform_number:cycle_number, sep = '_', remove = FALSE)
  

```

# Location of BGC-temperature profiles

```{r map_location_argo_profiles, fig.asp=2}

OceanSODA_temp_SO_extreme_grid %>%
  group_split(month) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(
        data = .x,
        aes(x = lon,
            y = lat,
            fill = temp_extreme),
        alpha = 0.5
      ) +
      scale_fill_manual(values = HNL_colors_map) +
      new_scale_fill() +
      geom_tile(
        data = profile_temp_extreme %>%
          distinct(lon, lat, file_id, year, month),
        aes(
          x = lon,
          y = lat,
          fill = 'argo\nprofiles',
          height = 1,
          width = 1
        ),
        alpha = 0.5
      ) +
      scale_fill_manual(values = "springgreen4",
                        name = "") +
      facet_wrap(~ year, ncol = 1) +
      lims(y = c(-85, -30)) +
      labs(title = paste('month:', unique(.x$month))
      )
  )

```


# Plot profiles

Argo profiles plotted according to the surface OceanSODA temperature

L profiles correspond to a low surface temperature event, as recorded in OceanSODA

H profiles correspond to an event of high surface temperature, as recorded in OceanSODA

N profiles correspond to normal surface OceanSODA temperature

## Raw

### By Mayot biomes

```{r temp_profiles_raw_Mayot_biomes}

profile_temp_extreme %>%
  group_split(biome_name, basin_AIP, year) %>% 
  head(6) %>%
  map(
    ~ ggplot() +
      geom_path(data = .x %>% filter(temp_extreme == 'N'),
                aes(x = temp, 
                    y = depth,
                    group = file_id,
                    col = temp_extreme),
                linewidth = 0.3) +
      geom_path(data = .x %>% filter(temp_extreme == 'H' | temp_extreme == 'L'),
                aes(x = temp,
                    y = depth,
                    group = file_id,
                    col = temp_extreme),
                linewidth = 0.5)+
      scale_y_reverse() +
      scale_color_manual(values = HNL_colors) +
      facet_wrap(~ month, ncol = 6) +
      labs(
        x = 'Argo temperature (ºC)',
        y = 'depth (m)',
        title = paste(
          unique(.x$basin_AIP),
          "|",
          unique(.x$year),
          "| biome:",
          unique(.x$biome_name)
        ),
        col = 'OceanSODA temp \nanomaly'
      )
  )

```

### Atl, STSS biome, Oct17

```{r select_specific_temp_profiles_2017}

# Temperature extreme: 
# Atlantic biome 1, 2018, months 2 and 3 

OceanSODA_temp_SO_extreme_grid_2017 <- OceanSODA_temp_SO_extreme_grid %>% 
  filter(date == '2017-10-15')  

map+
  geom_tile(data = OceanSODA_temp_SO_extreme_grid_2017,
            aes(x = lon,
                y = lat,
                fill = temp_extreme))+
  scale_fill_manual(values = HNL_colors_map)+
  lims(y = c(-85, -30)) +
  labs(title = 'October 2017',
       fill = 'OceanSODA SST \nextreme')
  
profile_temp_Atl_2017 <- profile_temp_extreme %>% 
  filter(date == '2017-10-15',
         basin_AIP == 'Atlantic',
         biome_name == 'STSS') 

profile_temp_Atl_2017 %>% 
  ggplot(aes(x = temp,
             y = depth,
             group = file_id,
             col = temp_extreme))+
  geom_path(data = profile_temp_Atl_2017 %>% filter(temp_extreme == 'N'),
            aes(x = temp,
                y = depth,
                group = file_id,
                col = temp_extreme),
            linewidth = 0.3)+
  geom_path(data = profile_temp_Atl_2017 %>% filter(temp_extreme == 'H'| temp_extreme == 'L'),
            aes(x = temp,
                y = depth,
                group = file_id,
                col = temp_extreme),
            linewidth = 0.5)+
  scale_y_reverse()+
  scale_color_manual(values = HNL_colors)+
  labs(title = 'Atlantic, STSS biome, October 2017',
       col = 'OceanSODA SST\nextreme',
       x = 'Argo temperature (ºC)')

rm(profile_temp_Atl_2017, OceanSODA_temp_SO_extreme_grid_2017)

```

### Atl, SPSS biome, Jul16

```{r select_specific_temp_profiles_2015, eval=FALSE}

# Atlantic biome 2, 2016 month 7 

OceanSODA_temp_SO_extreme_grid_2016 <- OceanSODA_temp_SO_extreme_grid %>% 
  filter(date == '2016-07-15')  

map+
  geom_tile(data = OceanSODA_temp_SO_extreme_grid_2016,
            aes(x = lon,
                y = lat,
                fill = temp_extreme))+
  scale_fill_manual(values = HNL_colors_map)+
  lims(y = c(-85, -30)) +
  labs(title = 'July 2016',
       fill = 'OceanSODA SST \nextreme')

profile_temp_Atl_2016 <- profile_temp_extreme %>% 
  filter(date == '2016-07-15',
         basin_AIP == 'Atlantic',
         biome_name == 'SPSS') 

profile_temp_Atl_2016 %>% 
  ggplot(aes(x = temp,
             y = depth,
             group = file_id,
             col = temp_extreme))+
  geom_path(data = profile_temp_Atl_2016 %>% filter(temp_extreme == 'N'),
            aes(x = temp,
                y = depth, 
                group = file_id,
                col = temp_extreme),
            linewidth = 0.3)+
  geom_path(data = profile_temp_Atl_2016 %>% filter(temp_extreme == 'H'|temp_extreme == 'L'),
            aes(x = temp,
                y = depth, 
                group = file_id,
                col = temp_extreme),
            linewidth = 0.5)+
  scale_y_reverse()+
  scale_color_manual(values = HNL_colors)+
  labs(title = 'Atlantic, SPSS biome, July 2016',
       col = 'OceanSODA SST\nextreme',
       x = 'Argo temperature (ºC)')

rm(profile_temp_Atl_2016, OceanSODA_temp_SO_extreme_grid_2016)

```

## Averaged profiles

```{r calculate_mean_temp_profiles}
 
# cut depth levels at 10, 20, .... etc m
# add seasons 
# Dec, Jan, Feb <- summer 
# Mar, Apr, May <- autumn 
# Jun, Jul, Aug <- winter 
# Sep, Oct, Nov <- spring 

profile_temp_extreme <- profile_temp_extreme %>%
  # mutate(
  #   depth = Hmisc::cut2(
  #     depth,
  #     cuts = c(10, 20, 30, 50, 70, 100, 300, 500, 800, 1000, 1500, 2000, 2500),
  #     levels.mean = TRUE,
  #     digits = 3
  #   ),
  #   depth = as.numeric(as.character(depth))
  # ) %>%
  mutate(
    season = case_when(
      between(month, 3, 5) ~ 'autumn',
      between(month, 6, 8) ~ 'winter',
      between(month, 9, 11) ~ 'spring',
      month == 12 | 1 | 2 ~ 'summer'
    ),
    season_order = case_when(
      between(month, 3, 5) ~ 2,
      between(month, 6, 8) ~ 3,
      between(month, 9, 11) ~ 4,
      month == 12 | 1 | 2 ~ 1
    ),
    .after = date
  )

```

### Overall mean

```{r mean_temp_profiles, fig.asp=1}

profile_temp_extreme_mean <- profile_temp_extreme %>%
  group_by(temp_extreme, depth) %>%
  summarise(temp_mean = mean(temp, na.rm = TRUE),
            temp_std = sd(temp, na.rm = TRUE)) %>%
  ungroup()

profile_temp_extreme_mean %>%
  arrange(depth) %>%
  ggplot(aes(y = depth)) +
  geom_ribbon(aes(xmin = temp_mean - temp_std,
                  xmax = temp_mean + temp_std,
                  fill = temp_extreme), 
              alpha = 0.2)+
  geom_path(aes(x = temp_mean,
                col = temp_extreme))+
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = "Overall mean",
       col = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'mean Argo temperature (ºC)') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))

rm(profile_temp_extreme_mean)

```

Number of profiles

```{r mean_temp_profile_count, fig.asp=1}

profile_temp_count_mean <- profile_temp_extreme %>% 
  distinct(temp_extreme, file_id) %>% 
  count(temp_extreme)

profile_temp_count_mean %>% 
  ggplot(aes(x = temp_extreme, y = n, fill = temp_extreme))+
  geom_col(width = 0.5)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles')

# rm(profile_temp_count_mean)
```

Surface Argo temperature vs surface OceanSODA temperature (20 m)

```{r argo_vs_OceanSODA_temp_mean, fig.asp=1}

# calculate surface-mean argo SST, for each profile 
surface_temp_mean <- profile_temp_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(temp_extreme, file_id) %>% 
  summarise(argo_surf_temp = mean(temp, na.rm = TRUE),
            OceanSODA_surf_temp = mean(OceanSODA_temp, na.rm = TRUE))

surface_temp_mean %>% 
  group_by(temp_extreme) %>%
  group_split() %>% 
  # head(1) %>%
  map(
  ~ggplot(data = .x, aes(x = OceanSODA_surf_temp, 
             y = argo_surf_temp))+
  geom_bin2d(data = .x, aes(x = OceanSODA_surf_temp, 
                 y = argo_surf_temp), size = 0.3, bins = 60) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1,
              xlim = c(-3, 28),
              ylim = c(-3, 28))+
    labs(title = paste('temp extreme:', unique(.x$temp_extreme)),
         x = 'OceanSODA temp',
         y = 'Argo temp')
  )

rm(surface_temp_mean)

```

### January overall mean profiles

```{r jan_overall_mean_temp_profiles, fig.asp=1, eval=FALSE}

profile_temp_extreme_mean_jan <- profile_temp_extreme %>%
  filter(month == 1) %>% 
  group_by(temp_extreme, depth) %>%
  summarise(temp_mean = mean(temp, na.rm = TRUE),
            temp_std = sd(temp, na.rm = TRUE)) %>%
  ungroup()

profile_temp_extreme_mean_jan %>%
  arrange(depth) %>%
  ggplot(aes(y = depth)) +
  geom_ribbon(aes(xmin = temp_mean - temp_std,
                  xmax = temp_mean + temp_std,
                  fill = temp_extreme), 
              alpha = 0.2)+
  geom_path(aes(x = temp_mean,
                col = temp_extreme))+
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = "January mean",
       col = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'mean Argo temperature (ºC)') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))

rm(profile_temp_extreme_mean_jan)


```

### Season x Mayot biome

```{r mean_temp_profiles_season_new_biomes, fig.asp=1}

profile_temp_extreme_biome <- profile_temp_extreme %>% 
  group_by(season_order, season, biome_name, temp_extreme, depth) %>% 
  summarise(temp_biome = mean(temp, na.rm = TRUE),
            temp_std_biome = sd(temp, na.rm = TRUE)) %>% 
  ungroup()
  
facet_label <- as_labeller(c("1"="summer", 
                             "2"="autumn", 
                             "3"="winter", 
                             "4"="spring", 
                             "ICE" = "ICE", 
                             "SPSS" = "SPSS",
                             "STSS" = "STSS",
                             "Atlantic" = "Atlantic",
                             "Indian" = "Indian",
                             "Pacific" = "Pacific"
                             ))

profile_temp_extreme_biome %>%
  ggplot(aes(
    x = temp_biome,
    y = depth,
    group = temp_extreme,
    col = temp_extreme
  )) +
  geom_ribbon(aes(xmax = temp_biome + temp_std_biome,
                  xmin = temp_biome - temp_std_biome,
                  group = temp_extreme,
                  fill = temp_extreme),
              col = NA, 
              alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(col = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'biome mean Argo temperature (ºC)') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
  lims(x = c(-3, 18))+
  facet_grid(season_order ~ biome_name, labeller = facet_label)

rm(profile_temp_extreme_biome)

```

Number of profiles per season per Mayot biome

```{r count_temp_profiles_season_new_biome, fig.asp=1}

profile_temp_count_biome <- profile_temp_extreme %>% 
  distinct(season_order, season, biome_name, temp_extreme, file_id) %>%
  group_by(season_order, season, biome_name, temp_extreme) %>% 
  count(temp_extreme)

profile_temp_count_biome %>% 
  ggplot(aes(x = temp_extreme, y = n, fill = temp_extreme))+
  geom_col(width = 0.5)+
  facet_grid(season_order ~ biome_name, labeller = facet_label)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles season x Mayot biome')

# rm(profile_temp_count_biome)

```

Surface Argo temp vs surface OceanSODA temp season x Mayot biome (20 m)

```{r argo_vs_OceanSODA_temp_new_biome, fig.asp=1}

surface_temp_biome <- profile_temp_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season_order, season, biome_name, temp_extreme, file_id) %>% 
  summarise(argo_surf_temp = mean(temp, na.rm=TRUE),
            OceanSODA_surf_temp = mean(OceanSODA_temp, na.rm = TRUE))

surface_temp_biome %>% 
  group_by(temp_extreme) %>% 
  group_split(temp_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = OceanSODA_surf_temp, 
             y = argo_surf_temp))+
  geom_bin2d(data = .x, aes(x = OceanSODA_surf_temp, 
                 y = argo_surf_temp)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(-3, 25),
              ylim = c(-3, 25))+
  facet_grid(season_order~biome_name, labeller = facet_label) +
    labs(title = paste( 'Temp extreme:', unique(.x$temp_extreme)),
         x = 'OceanSODA temp',
         y = 'Argo temp')
  )

rm(surface_temp_biome)

```

### Season x basin

```{r mean_basin_temp_profiles, fig.asp=1}

profile_temp_extreme_basin <- profile_temp_extreme %>% 
  group_by(season_order, season, basin_AIP, temp_extreme, depth) %>% 
  summarise(temp_basin = mean(temp, na.rm = TRUE),
            temp_basin_std = sd(temp, na.rm = TRUE)) %>% 
  ungroup()

profile_temp_extreme_basin %>% 
  ggplot(aes(x = temp_basin, 
             y = depth, 
             group = temp_extreme, 
             col = temp_extreme))+
  geom_ribbon(aes(xmin = temp_basin - temp_basin_std,
                  xmax = temp_basin + temp_basin_std,
                  group = temp_extreme, 
                  fill = temp_extreme),
              col = NA, 
              alpha = 0.2)+
  geom_path()+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  labs(col = 'OceanSODA\ntemp anomaly\n(mean ± st dev)',
       fill = 'OceanSODA\ntemp anomaly\n(mean ± st dev)',
       y = 'depth (m)',
       x = 'basin-mean Argo temperature (ªC)')+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
  facet_grid(season_order~basin_AIP, labeller = facet_label)

rm(profile_temp_extreme_basin)
```

Number of profiles season x basin

```{r count_basin_temp_profiles, fig.asp=1}

profile_temp_count_basin <- profile_temp_extreme %>% 
  distinct(season_order, season, basin_AIP, temp_extreme, file_id) %>% 
  group_by(season_order, season, basin_AIP, temp_extreme) %>% 
  count(temp_extreme)

profile_temp_count_basin %>% 
  ggplot(aes(x = temp_extreme, y = n, fill = temp_extreme))+
  geom_col(width = 0.5)+
  facet_grid(season_order~basin_AIP, labeller = facet_label)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles season x basin')

# rm(profile_temp_count_basin)

```

Surface Argo temperature vs surface OceanSODA temperature (20 m) season x basin

```{r argo_vs_OceanSODA_temp_basin, fig.asp=1}
# calculate surface-mean argo temp to compare against OceanSODA surface temp (one value)
surface_temp_basin <- profile_temp_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season_order, season, basin_AIP, temp_extreme, file_id) %>% 
  summarise(surf_argo_temp = mean(temp, na.rm=TRUE),
            surf_OceanSODA_temp = mean(OceanSODA_temp, na.rm = TRUE)) 

surface_temp_basin %>% 
  group_by(temp_extreme) %>% 
  group_split(temp_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = surf_OceanSODA_temp, 
             y = surf_argo_temp))+
  geom_bin2d(data = .x, aes(x = surf_OceanSODA_temp, 
                 y = surf_argo_temp)) +
    scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(-3, 25),
              ylim = c(-3, 25))+
  facet_grid(season_order~basin_AIP, labeller = facet_label) +
    labs(title = paste('Temp extreme:', unique(.x$temp_extreme)),
         x = 'OceanSODA temp',
         y = 'Argo temp')
  )

rm(surface_temp_basin)

```

### Season x Mayot biome x Basin

```{r temp_profiles_new_biomes_basin, fig.asp=1}

profile_temp_extreme_season <- profile_temp_extreme %>%
  group_by(season_order, season, biome_name, basin_AIP, temp_extreme, depth) %>%
  summarise(temp_mean = mean(temp, na.rm = TRUE),
            temp_std = sd(temp, na.rm = TRUE)) %>%
  ungroup()

profile_temp_extreme_season %>%
  arrange(depth) %>%
  group_split(season_order) %>%
  # head(1) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(x = temp_mean,
          y = depth,
          group = temp_extreme,
          col = temp_extreme)) +
      geom_ribbon(aes(xmax = temp_mean + temp_std,
                      xmin = temp_mean - temp_std,
                      group = temp_extreme,
                      fill = temp_extreme),
                  col = NA,
                  alpha = 0.2)+
      geom_path() +
      scale_color_manual(values = HNL_colors) +
      scale_fill_manual(values = HNL_colors) +
      labs(title = paste("season:", unique(.x$season)),
           col = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
           fill = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
           y = 'depth (m)',
           x = 'mean Argo temperature (ºC)') +
      scale_y_continuous(
        trans = trans_reverser("sqrt"),
        breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))
      ) +
      facet_grid(basin_AIP ~ biome_name)
  )

```

Number of profiles season x Mayot biome x basin

```{r count_number_of_profiles_season_new_biomes, fig.asp=1}

profile_temp_count_season <- profile_temp_extreme %>% 
  distinct(season_order, season, biome_name, basin_AIP,
           temp_extreme, file_id) %>% 
  group_by(season_order, season, biome_name, basin_AIP, temp_extreme) %>% 
  count(temp_extreme)


profile_temp_count_season %>% 
  group_by(season_order) %>% 
  group_split(season_order) %>% 
  map(
    ~ggplot()+
      geom_col(data =.x, 
               aes(x = temp_extreme,
                   y = n,
                   fill = temp_extreme),
               width = 0.5)+
      facet_grid(basin_AIP ~ biome_name)+
      scale_y_continuous(trans = 'log10')+
      labs(y = 'log(number of profiles)',
           title = paste('season:', unique(.x$season)))
  )

# rm(profile_temp_count_season)


```

Surface Argo temperature vs surface OceanSODA temperature (20m) in each season, Mayot biome, basin

```{r argo_vs_OceanSODA_temp_season_new_biomes, fig.asp=1}

# calculate surface-mean argo temp, for each season x biome x basin x temp extreme 
surface_temp_season <- profile_temp_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season_order, 
           season, 
           basin_AIP, 
           biome_name, 
           temp_extreme,  
           file_id) %>%  
  summarise(surf_argo_temp = mean(temp, na.rm=TRUE),
            surf_OceanSODA_temp = mean(OceanSODA_temp, na.rm = TRUE)) 

surface_temp_season %>% 
  group_by(season_order, temp_extreme) %>% 
  group_split(season_order, temp_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = surf_OceanSODA_temp, 
             y = surf_argo_temp))+
  geom_bin2d(data = .x, aes(x = surf_OceanSODA_temp, 
                 y = surf_argo_temp)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(-3, 25),
              ylim = c(-3, 25))+
  facet_grid(basin_AIP ~ biome_name) +
    labs(title = paste('season:', unique(.x$season), 
                        '| temp extreme:', unique(.x$temp_extreme)),
         x = 'OceanSODA temp',
         y = 'Argo temp')
  )

rm(surface_temp_season)
```

#### Atlantic, SPSS biome, winter

```{r temp_profile_season_biome_Atlantic, fig.asp=1}

profile_temp_extreme_season %>%
  filter(basin_AIP == 'Atlantic',
         biome_name == 'SPSS',
         season == 'winter') %>% 
  arrange(depth) %>%
  ggplot(aes(x = temp_mean,
             y = depth,
             group = temp_extreme,
             col = temp_extreme)) +
  geom_ribbon(aes(xmax = temp_mean + temp_std,
                  xmin = temp_mean - temp_std,
                  group = temp_extreme,
                  fill = temp_extreme),
              col = NA,
              alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors) +
  labs(title = 'Atlantic basin, SPSS biome, winter',
       col = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'mean Argo temperature (ºC)') +
  scale_y_continuous(
  trans = trans_reverser("sqrt"),
  breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) 
```

#### Atlantic, STSS biome, spring

```{r Atlantic_biome_1_spring_mean_profiles, fig.asp=1}

profile_temp_extreme_season %>%
  filter(basin_AIP == 'Atlantic',
         biome_name == 'STSS',
         season == 'spring') %>% 
  arrange(depth) %>%
  ggplot(aes(x = temp_mean,
             y = depth,
             group = temp_extreme,
             col = temp_extreme)) +
  geom_ribbon(aes(xmax = temp_mean + temp_std,
                  xmin = temp_mean - temp_std,
                  group = temp_extreme,
                  fill = temp_extreme),
              col = NA,
              alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors) +
  labs(title = 'Atlantic basin, STSS biome, spring',
       col = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'mean Argo temperature (ºC)') +
  scale_y_continuous(
  trans = trans_reverser("sqrt"),
  breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) 

rm(profile_temp_extreme_season)

```

### Mayot biome - basin January mean profiles

```{r new_biome_basin_january_mean_profiles, fig.asp=1, eval=FALSE}

profile_temp_extreme_biome_basin_jan <- profile_temp_extreme %>%
  filter(month == 1) %>% 
  group_by(biome_name, basin_AIP, temp_extreme, depth) %>%
  summarise(temp_mean = mean(temp, na.rm = TRUE),
            temp_std = sd(temp, na.rm = TRUE)) %>%
  ungroup()

profile_temp_extreme_biome_basin_jan %>%
  arrange(depth) %>%
  ggplot(aes(x = temp_mean,
             y = depth)) +
  geom_ribbon(aes(xmin = temp_mean - temp_std,
                  xmax = temp_mean + temp_std,
                  fill = temp_extreme), 
              alpha = 0.2)+
  geom_path(aes(x = temp_mean,
                col = temp_extreme))+
  facet_grid(basin_AIP~biome_name)+
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = "Basin-Mayot biome-mean January profiles",
       col = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\ntemp anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'mean Argo temperature (ºC)') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))


```

# Remove climatology

Plot the H/L/N profiles as anomalies relative to the CSIO-MNR Argo temperature climatology

## Argo profiles

```{r average_depth_levels}

# profile_temp_extreme_binned <- profile_temp_extreme %>%
#   group_by(lon, lat, year, month, file_id,
#            biome_name, basin_AIP, temp_extreme,
#            depth) %>%
#   summarize(temp_adjusted_binned = mean(temp_adjusted, na.rm = TRUE)) %>%
#   ungroup()

```

## ARGO climatology

```{r load_jan_temp_climatology}

# boa_temp_clim <- read_rds(file = paste0(path_argo_preprocessed, '/boa_temp_clim.rds'))
# 
# # compatibility with profile_temp_extreme_jan
# boa_temp_clim_SO <- boa_temp_clim %>% 
#   filter(lat <= -30) %>% 
#   mutate(depth_boa = depth)
# 
# # grid average climatological temp into the argo depth bins 
# boa_temp_clim_SO <- boa_temp_clim_SO %>%
#   mutate(
#     depth = cut(
#       depth_boa,
#       breaks = c(0, 10, 20, 30, 50, 70, 100, 300, 500, 800, 1000, 1500, 2000),
#       include.lowest = TRUE,
#       labels = as.factor(unique(profile_temp_extreme$depth))[1:12]
#     ),
#     depth = as.numeric(as.character(depth))
#   )


# calculate mean climatological pH per depth bin
# boa_temp_clim_SO_binned <- boa_temp_clim_SO %>% 
#   group_by(lon, lat, depth, month) %>% 
#   summarise(clim_temp_binned = mean(clim_temp, na.rm = TRUE)) %>%
#   ungroup()
# 
# 
# # join climatology and ARGO profiles
# 
# remove_clim <- inner_join(profile_temp_extreme_binned,
#                               boa_temp_clim_SO_binned)

remove_clim <-
  read_rds(file = paste0(path_argo_preprocessed, "/temp_anomaly_va.rds")) %>%
  filter(profile_range >= opt_min_profile_range) %>%
  mutate(date = ymd(format(date, "%Y-%m-15")))

remove_clim <- inner_join(
  remove_clim %>%
    select(
      file_id, 
      year, 
      month, 
      date, 
      lon, 
      lat, 
      depth, 
      temp,
      clim_temp,
      anomaly
      ),
  OceanSODA_temp_SO_extreme_grid %>%
    select(
      year,
      month,
      date,
      lon,
      lat,
      OceanSODA_temp,
      temp_extreme,
      biome_name,
      basin_AIP
    )
)

remove_clim <- remove_clim %>%
  mutate(
    season = case_when(
      between(month, 3, 5) ~ 'autumn',
      between(month, 6, 8) ~ 'winter',
      between(month, 9, 11) ~ 'spring',
      month == 12 | 1 | 2 ~ 'summer'
    ),
    season_order = case_when(
      between(month, 3, 5) ~ 2,
      between(month, 6, 8) ~ 3,
      between(month, 9, 11) ~ 4,
      month == 12 | 1 | 2 ~ 1
    ),
    .after = date
  ) 

```

## Profiles

Points are the climatological temperature, lines are the depth-binned Argo profiles colored by H/N/L classification

### Absolute

```{r plot_raw_profiles_with_clim}

remove_clim %>%
  group_split(biome_name, basin_AIP, year) %>%
  head(6) %>%
  map(
    ~ ggplot() +
      geom_path(
        data = .x %>%
          filter(temp_extreme == 'N'),
        aes(
          x = temp,
          y = depth,
          group = file_id,
          col = temp_extreme
        ),
        size = 0.3
      ) +
      geom_path(
        data = .x %>%
          filter(temp_extreme == 'H' | temp_extreme == 'L'),
        aes(
          x = temp,
          y = depth,
          group = file_id,
          col = temp_extreme
        ),
        size = 0.5
      ) +
      geom_point(
        data = .x,
        aes(x = clim_temp,
            y = depth,
            col = temp_extreme),
        size = 0.5
      ) +
      scale_y_reverse() +
      scale_color_manual(values = HNL_colors) +
      labs(
        x = 'Argo temperature (ºC)',
        y = 'depth (m)',
        title = paste(
          "Biome:",
          unique(.x$biome_name),
          "| basin:",
          unique(.x$basin_AIP),
          " | ",
          unique(.x$year)
        ),
        col = 'OceanSODA temp \nanomaly'
      )
  )

```

```{r remove_climatology_from_profiles}

# calculate the difference between the binned climatological argo and in-situ argo for each depth level and grid cell 

# remove_clim <- remove_clim %>% 
#   mutate(argo_temp_anomaly = temp_adjusted_binned - clim_temp_binned,
#           season = case_when(
#                 between(month, 3, 5) ~ 'autumn',
#                 between(month, 6, 8) ~ 'winter',
#                 between(month, 9, 11) ~ 'spring',
#                 month == 12 | 1 | 2 ~ 'summer'),
#           season_order = case_when(
#                 between(month, 3, 5) ~ 2,
#                 between(month, 6, 8) ~ 3,
#                 between(month, 9, 11) ~ 4,
#                 month == 12 | 1 | 2 ~ 1
#           )
#          )

```

### Anomaly

```{r plot_anomaly_profiles, fig.asp=1}

remove_clim %>% 
  group_split(month) %>% 
  #head(6) %>% 
  map(
    ~ggplot()+
      geom_path(data = .x %>% filter(temp_extreme == 'N'),
                aes(x = anomaly,
                    y = depth,
                    group = file_id,
                    col = temp_extreme),
                size = 0.2)+
      geom_path(data = .x %>% filter(temp_extreme == 'H'| temp_extreme == 'L'),
                 aes(x = anomaly,
                     y = depth,
                     group = file_id,
                     col = temp_extreme),
                 size = 0.3)+
      geom_vline(xintercept = 0)+
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
      scale_color_manual(values = HNL_colors)+
      scale_fill_manual(values = HNL_colors)+
      facet_grid(basin_AIP~biome_name)+
      labs(title = paste0('month: ', unique(.x$month)))
  )

```

### Overall mean anomaly

```{r plot_overall_mean_clim_removed_profiles, fig.asp=1}

remove_clim_overall_mean <- remove_clim %>% 
  group_by(temp_extreme, depth) %>% 
  summarise(temp_anomaly_mean = mean(anomaly, na.rm = TRUE),
            temp_anomaly_sd = sd(anomaly, na.rm = TRUE))

remove_clim_overall_mean %>% 
  ggplot()+
  geom_path(aes(x = temp_anomaly_mean,
                y = depth,
                group = temp_extreme,
                col = temp_extreme))+
  geom_ribbon(aes(xmax = temp_anomaly_mean + temp_anomaly_sd,
                  xmin = temp_anomaly_mean - temp_anomaly_sd,
                  y = depth,
                  group = temp_extreme,
                  fill = temp_extreme),
              col = NA,
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  geom_text(data = profile_temp_count_mean[2,],
          aes(x = -4.0, 
              y = 1200, 
              label = paste0(n), 
              col = temp_extreme),
          size = 6)+
  geom_text(data = profile_temp_count_mean[1,],
          aes(x = -4.0, 
              y = 1400, 
              label = paste0(n), 
              col = temp_extreme),
          size = 6)+
  geom_text(data = profile_temp_count_mean[3,],
          aes(x = -4.0, 
              y = 1600, 
              label = paste0(n), 
              col = temp_extreme),
          size = 6)+
  coord_cartesian(xlim = c(-4.5, 4.5))+
  scale_x_continuous(breaks = c(-4, -2, 0, 2, 4))+
  labs(title = 'Overall mean anomaly profiles')

rm(remove_clim_overall_mean, profile_temp_count_mean)

```

### Biome x season mean anomaly

```{r plot_biome_mean_clim_removed_profiles, fig.asp=1}

remove_clim_biome_mean <- remove_clim %>% 
  group_by(temp_extreme, depth, season_order, season, biome_name) %>% 
  summarise(temp_anomaly_mean = mean(anomaly, na.rm = TRUE),
            temp_anomaly_sd = sd(anomaly, na.rm = TRUE))

remove_clim_biome_mean %>% 
  ggplot(aes(x = temp_anomaly_mean,
                y = depth,
                group = temp_extreme,
                col = temp_extreme))+
  geom_path()+
  geom_ribbon(aes(xmax = temp_anomaly_mean + temp_anomaly_sd,
                  xmin = temp_anomaly_mean - temp_anomaly_sd,
                  group = temp_extreme,
                  fill = temp_extreme),
              col = NA,
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  scale_fill_manual(values = HNL_colors)+
  scale_color_manual(values = HNL_colors)+
  labs(title = 'Biome-mean anomaly profiles')+
  geom_text(data = profile_temp_count_biome %>% filter (temp_extreme == 'N'),
                  aes(x = -4,
                      y = 800,
                      label = paste0(n),
                      col = temp_extreme),
                  size = 4)+
  geom_text(data = profile_temp_count_biome %>% filter (temp_extreme == 'H'),
                  aes(x = -4,
                      y = 1200,
                      label = paste0(n),
                      col = temp_extreme),
                  size = 4)+
  geom_text(data = profile_temp_count_biome %>% filter (temp_extreme == 'L'),
                  aes(x = -4,
                      y = 1600,
                      label = paste0(n),
                      col = temp_extreme),
                  size = 4)+
  coord_cartesian(xlim = c(-4.5, 4.5))+
  scale_x_continuous(breaks = c(-4, -2, 0, 2, 4))+
  facet_grid(season_order~biome_name, labeller = facet_label)

rm(remove_clim_biome_mean, profile_temp_count_biome)

```

### Basin x season mean anomaly

```{r plot_basin_mean_anomaly_profiles, fig.asp=1}

remove_clim_basin_mean <- remove_clim %>% 
  group_by(basin_AIP, temp_extreme, depth, season_order, season) %>% 
  summarise(temp_anomaly_mean = mean(anomaly, na.rm = TRUE),
            temp_anomaly_sd = sd(anomaly, na.rm = TRUE))

remove_clim_basin_mean %>% 
  ggplot(aes(x = temp_anomaly_mean,
             y = depth, 
             group = temp_extreme,
             col = temp_extreme))+
  geom_path()+
  geom_ribbon(aes(xmax = temp_anomaly_mean + temp_anomaly_sd,
                  xmin = temp_anomaly_mean - temp_anomaly_sd,
                  group = temp_extreme,
                  fill = temp_extreme),
              col = NA,
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  facet_grid(season~basin_AIP)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  # geom_text_repel(data = profile_temp_count_basin,
  #                 aes(x = 2,
  #                     y = 1500,
  #                     label = paste0(n),
  #                     col = temp_extreme),
  #                 size = 4,
  #                 segment.color = 'transparent')+
  geom_text(data = profile_temp_count_basin %>% filter (temp_extreme == 'N'),
                  aes(x = -4,
                      y = 800,
                      label = paste0(n),
                      col = temp_extreme),
                  size = 4)+
  geom_text(data = profile_temp_count_basin %>% filter (temp_extreme == 'H'),
                  aes(x = -4,
                      y = 1200,
                      label = paste0(n),
                      col = temp_extreme),
                  size = 4)+
  geom_text(data = profile_temp_count_basin %>% filter (temp_extreme == 'L'),
                  aes(x = -4,
                      y = 1600,
                      label = paste0(n),
                      col = temp_extreme),
                  size = 4)+
  coord_cartesian(xlim = c(-4.5, 4.5))+
  scale_x_continuous(breaks = c(-4, -2, 0, 2, 4))+
  labs(title = 'Basin-mean anomaly profiles')

rm(remove_clim_basin_mean, profile_temp_count_basin)

```

### Basin x biome x season mean anomaly

```{r plot_basin_biome_mean_anomaly_profiles, fig.asp=1}

remove_clim_basin_biome_mean <- remove_clim %>% 
  group_by(basin_AIP, biome_name, temp_extreme, season_order, season, depth) %>% 
  summarise(temp_anomaly_mean = mean(anomaly, na.rm = TRUE),
            temp_anomaly_sd = sd(anomaly, na.rm = TRUE))

remove_clim_basin_biome_mean %>% 
  group_by(season_order) %>% 
  group_split(season_order) %>% 
  map(
    ~ggplot(data = .x, 
            aes(x = temp_anomaly_mean,
                y = depth,
                group = temp_extreme,
                col = temp_extreme))+
      geom_path()+
      geom_ribbon(data = .x,
                  aes(xmax = temp_anomaly_mean + temp_anomaly_sd,
                  xmin = temp_anomaly_mean - temp_anomaly_sd,
                  group = temp_extreme,
                  fill = temp_extreme),
              col = NA,
              alpha = 0.2)+
      geom_vline(xintercept = 0)+
      facet_grid(basin_AIP~biome_name)+
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
      scale_color_manual(values = HNL_colors)+
      scale_fill_manual(values = HNL_colors)+
      # geom_text_repel(data = profile_temp_count_season,
      #                 aes(x = 1,
      #                     y = 1400,
      #                     label = paste0(n),
      #                     col = temp_extreme,
      #                     group = temp_extreme),
      #                 size = 4,
      #                 segment.color = 'transparent')+
      geom_text(data = profile_temp_count_season %>% filter (temp_extreme == 'N' & season == unique(.x$season)),
                      aes(x = -4,
                          y = 800,
                          label = paste0(n),
                          col = temp_extreme),
                      size = 4)+
      geom_text(data = profile_temp_count_season %>% filter (temp_extreme == 'H' & season == unique(.x$season)),
                      aes(x = -4,
                          y = 1200,
                          label = paste0(n),
                          col = temp_extreme),
                      size = 4)+
      geom_text(data = profile_temp_count_season %>% filter (temp_extreme == 'L' & season == unique(.x$season)),
                      aes(x = -4,
                          y = 1600,
                          label = paste0(n),
                          col = temp_extreme),
                      size = 4)+
      coord_cartesian(xlim = c(-4.5, 4.5))+
      scale_x_continuous(breaks = c(-4, -2, 0, 2, 4))+
      labs(title = paste0('biome-basin mean anomaly profiles ', unique(.x$season)))
    )

rm(remove_clim_basin_biome_mean, profile_temp_count_season)

```

# Argo (BGC-temperature irrespective of pH)

```{r temperature_without_ph, eval=FALSE}

all_profile_temp_extreme <- inner_join(
  argo_temp %>% 
    select(c(year, month, date, lon, lat, depth,
           temp_adjusted,
           file_id)),                 # 567 327 obs 
  OceanSODA_temp_SO_extreme_grid %>% 
    select(c(year, month, date, lon, lat,
           OceanSODA_temp, temp_extreme,
           clim_temp, clim_diff,
           basin_AIP, biome_name)))

all_profile_temp_extreme <- profile_temp_extreme %>% 
  unite('platform_cycle', platform_number:cycle_number, sep = '_', remove = FALSE)

```

# Location of all BGC-temp profiles (regardless of pH)

```{r map_all_temp_profiles, fig.asp=2, eval=FALSE}

OceanSODA_temp_SO_extreme_grid %>%
  group_split(month) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(
        data = .x,
        aes(x = lon,
            y = lat,
            fill = temp_extreme),
        alpha = 0.5
      ) +
      scale_fill_manual(values = HNL_colors_map) +
      new_scale_fill() +
      geom_tile(
        data = all_profile_temp_extreme %>%
          distinct(lon, lat, platform_cycle, year, month),
        aes(
          x = lon,
          y = lat,
          fill = 'argo\nprofiles',
          height = 1,
          width = 1
        ),
        alpha = 0.5
      ) +
      scale_fill_manual(values = "springgreen4",
                        name = "") +
      facet_wrap(~ year, ncol = 1) +
      lims(y = c(-85, -30)) +
      labs(title = paste('month:', unique(.x$month))
      )
  )

```
