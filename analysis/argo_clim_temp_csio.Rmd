---
title: "CSIO-MNR Argo Temperature Climatology"
author: "Pasqualina Vonlanthen & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Task

CSIO-MNR Argo temperature climatology of Li et al. (2017)

Li, H., F. Xu, W. Zhou, D. Wang, J. S. Wright, Z. Liu, and Y. Lin (2017), Development of a global gridded Argo data set with Barnes successive corrections, J. Geophys. Res.Oceans, 122, doi: 10.1002/2016JC012285.6

User Manual: Shaolei Lu，Zenghong Liu，Hong Li，Zhaoqin Li，Xiaofen Wu，Chaohui Sun，Jianping Xu.(2020). Manual of Global Ocean Argo gridded data set (BOA_Argo) (Version 2019), 14 pp <https://argo.ucsd.edu/wp-content/uploads/sites/361/2020/07/User_Manual_BOA_Argo-2020.pdf>

```{r load_libraries}
library(tidyverse)
# library(ggOceanMaps)
library(oce)
```

# Load data

```{r set_paths}
path_updata <- "/nfs/kryo/work/updata"
path_argo_clim_temp <- paste0(path_updata, "/argo_climatology/temperature")
path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"
path_argo <- '/nfs/kryo/work/updata/bgc_argo_r_argodata'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

theme_set(theme_bw())

map <-
  read_rds(paste(path_emlr_utilities,
                 "map_landmask_WOA18.rds",
                 sep = ""))
```

```{r load_in_regions_basins}

# RECCAP2-ocean region mask

region_masks_all_1x1 <- read_rds(file = paste0(path_argo_preprocessed,
                                              "/region_masks_all_1x1.rds"))

region_masks_all_1x1 <- region_masks_all_1x1 %>%
  rename(biome = value) %>% 
  mutate(coast = as.character(coast))

# WOA 18 basin mask

basinmask <-
  read_csv(
    paste(path_emlr_utilities,
          "basin_mask_WOA18.csv",
          sep = ""),
    col_types = cols("MLR_basins" = col_character())
  )

basinmask <- basinmask %>%
  filter(MLR_basins == unique(basinmask$MLR_basins)[1]) %>% 
  select(-c(MLR_basins, basin))

```


# CSIO-MNR climatology

```{r load_argo_temp_climatology}

boa_clim_argo_temp_jan <- tidync::hyper_tibble(paste0(path_argo_clim_temp, "/BOA_Argo_monthly_01.nc"))
# 1 896 093 obs of 6 variables (2004-2019):
# temp (range between -3.9180 and 30.1866º)
# salt
# lon (range between 0.5 and 359.5)
# lat (range between -72.5 and 79.5)
# pres (range between 0 and 1975)
# time (15 days since 0000-01-01)
# range(boa_clim_argo_temp_jan$temp)
# -3.9180 to 30.1866 
# range(boa_clim_argo_temp_jan$lon)
# 0.5 to 359.5 by 1
# range(boa_clim_argo_temp_jan$lat)
# -72.5 to 79.5 by 1
# range(boa_clim_argo_temp_jan$pres)
# 0 to 1975 (58 pressure levels)
# table(boa_clim_argo_temp_jan$pres)
# pressure levels: 0, 5, 10-170 by 10, 180-460 by 20, 500-1300 by 50, 1400-1900 by 100, 1975 dbar 
# range(boa_clim_argo_temp_jan$time)
# days since 0000-01-01

# keep only data south of 30ºS
boa_clim_temp_jan_SO <- boa_clim_argo_temp_jan %>% 
  filter(lat <= -30) %>% 
  select(-salt)
# 766 434 obs of 5 variables 

# range(boa_clim_temp_jan_SO$temp)
# range(boa_clim_temp_jan_SO$lat)
# range(boa_clim_temp_jan_SO$lon)

boa_clim_temp_jan_SO <- boa_clim_temp_jan_SO %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon),
         depth = swDepth(pressure = pres, latitude = lat)) %>% 
  rename(clim_temp_jan = temp) %>% 
  mutate(month = rep(1, length(time)))

# range(boa_clim_temp_jan_SO$depth)
```

```{r map_location_of_observations}

map+
  geom_point(data = boa_clim_temp_jan_SO %>% filter(depth < 20),
             aes(x = lon,
                 y = lat),
             size = 0.2,
             pch = 2,
             alpha = 0.2)

```

```{r map_surface_climatological_january_temperature}

boa_clim_sst_jan_SO <- boa_clim_temp_jan_SO %>% 
  filter(depth <= 20) %>% 
  group_by(lon, lat) %>% 
  summarise(clim_sst = mean(clim_temp_jan, na.rm = TRUE)) %>% 
  ungroup()

map+
  geom_tile(data = boa_clim_sst_jan_SO,
            aes(x = lon,
                y = lat,
                fill = clim_sst))+
  scale_fill_viridis_c()+
  lims(y = c(-80, -25))+
  labs(title = 'Li et al. CSIO January climatological argo SST')
```


```{r add_in_basins_and_biomes}

boa_clim_temp_jan_SO <- inner_join(boa_clim_temp_jan_SO, region_masks_all_1x1)

boa_clim_temp_jan_SO <- inner_join(boa_clim_temp_jan_SO,
                                    basinmask)

```

```{r plot_basin_biome_climatological_profiles}

boa_clim_temp_jan_SO %>% 
  ggplot(aes(x = clim_temp_jan,
             y = depth))+
  geom_point(size = 0.2, pch = 1, fill = NA)+
  scale_y_reverse()+
  facet_grid(basin_AIP~biome)

```

# UCSD climatology 

Roemmich and Gilson UCSD argo temperature climatology 
```{r sio_temp_climatology}

# clim_argo_temp_jan_2022 <- tidync::hyper_tibble(paste0(path_argo_clim_temp, "/RG_ArgoClim_202201_2019.nc"))
# 
# range(clim_argo_temp_jan_2022$LONGITUDE)
# # range between 20.5 and 379.5 
# range(clim_argo_temp_jan_2022$LATITUDE)
# # range between -64.5 and 79.5 
# range(clim_argo_temp_jan_2022$TIME)
# table(clim_argo_temp_jan_2022$TIME)
# # time = 216.5 in the whole dataset (216.5 months since January 1 2004, corresponds to 15-01-2022)
# 
# clim_argo_temp_2004_2018 <- tidync::hyper_tibble(paste0(path_argo_clim_temp, "/RG_ArgoClim_Temperature_2019.nc"))
# range(clim_argo_temp$LONGITUDE)
# # 20.5 to 379.5
# table(clim_argo_temp$LONGITUDE)
# # 1 degree intervals
# range(clim_argo_temp$LATITUDE)
# # -64.5 to 79.5
# range(clim_argo_temp$TIME)
# # 0.5 to 179.5 
# # -> 01-01-2014 to 31-12-2018, centered on the 15th of each month
# range(clim_argo_temp$ARGO_TEMPERATURE_ANOMALY)
# # -12.543 to 13.413 
# range(clim_argo_temp$PRESSURE)
# # 2.5 to 1975.0 
# 
clim_argo_temp_year_mean <- tidync::hyper_tibble(paste0(path_argo_clim_temp, "/RG_ArgoClim_33pfit_2019_mean.nc"))
# yearly mean temperature values in each 1/6 lat/lon grid (1 value for the year) 

# # 2004-2018
# # 66 030 591 obs of 6 variables, with columns: 
# # ARGO_TEMPERATURE_MEAN
# # ARGO_SALINITY_MEAN
# # BATHYMETRY_MASK
# # LONGITUDE between 20.083 and 379.917º (1/6 degree intervals)
# # LATITUDE between -64.5 and 79.5º 
# # PRESSURE between 2.5 and 1975.0 dbar 
# range(clim_argo_temp$LONGITUDE)
# # 20.083 to 379.917
# range(clim_argo_temp$LATITUDE)
# # -64.5 to 79.5
# range(clim_argo_temp$ARGO_TEMPERATURE_MEAN)
# # -1.880 to 30.516 
# range(clim_argo_temp$PRESSURE)
# # 2.5 to 1975.0 
# table(clim_argo_temp$PRESSURE)
# # pressure levels: 2.5 dbar, 10-170 dbar by 10, 182.5, 200-440 dbar by 20, 462.5, 500-1350 dbar by 50, 12412.5, 1500-1900 dbar by 100, 1975 dbar
# 
clim_argo_temp_monthly_anomaly <- tidync::hyper_tibble(paste0(path_argo_clim_temp, "/RG_ArgoClim_33pfit_2019_annual.nc"))
# monthly temperature anomaly from the annual mean, from January (time = 0.5) to December (time = 11.5), in each 1/2 lon/lat grid

# # 88 035 468 obs of 6 variables, with columns:
# # ARGO_TEMPERATURE_ANNUAL_ANOMALY range between -9.270 and 10.982, with some values of 9.9692e+36 
# # ARGO_SALINITY_ANNUAL_ANOMALY
# # LONGITUDE range between 20.25 and 379.75º, in 0.5º intervals
# # LATITUDE range between -64.75 and 79.75º, in 0.5º intervals
# # PRESSURE range between 2.5 and 1975 dbar 
# # TIME ranging from 0.5 to 11.5 (15 January to 15 December)
# range(clim_argo_temp$TIME)
# # 0.5 to 11.5 -> 15-January to 15-December 
# range(clim_argo_temp$ARGO_TEMPERATURE_ANNUAL_ANOMALY)
# table(round(clim_argo_temp$ARGO_TEMPERATURE_ANNUAL_ANOMALY, digits = 0))
# clim_argo_temp_filtered <- clim_argo_temp %>% 
#   filter(ARGO_TEMPERATURE_ANNUAL_ANOMALY < 10^35)
# range(clim_argo_temp_filtered$ARGO_TEMPERATURE_ANNUAL_ANOMALY)
# # -9.270 to 10.982 
# range(clim_argo_temp$LONGITUDE)
# # 20.25 to 379.75 (every 0.5 degrees)
# range(clim_argo_temp$LATITUDE)
# # -64.75 to 79.75 (every 0.5 degrees)
# range(clim_argo_temp$PRESSURE)
# # 2.5 to 1975.0 dbar


# put both dataframes onto 1/1 lon/lat grid and calculate mean temperature / mean anomaly in each grid 

clim_argo_temp_monthly_anomaly <- clim_argo_temp_monthly_anomaly %>% 
  select(-ARGO_SALINITY_ANNUAL_ANOMALY) %>% 
  rename(lon = LONGITUDE,
         lat = LATITUDE,
         pressure = PRESSURE,
         temp_annual_anomaly = ARGO_TEMPERATURE_ANNUAL_ANOMALY,
         time = TIME) %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon)) %>% 
  mutate(lat = cut(lat, seq(-90, 90, 1), seq(-89.5, 89.5, 1)),
         lat = as.numeric(as.character(lat)),
         lon = cut(lon, seq(20, 380, 1), seq(20.5, 379.5, 1)),
         lon = as.numeric(as.character(lon))) %>% 
  mutate(depth = swDepth(pressure = pressure, latitude = lat),
         .after = pressure) %>% 
  filter(lat < -30)

clim_argo_temp_monthly_anomaly <- clim_argo_temp_monthly_anomaly %>% 
  group_by(lon, lat, depth, time) %>% 
  summarise(temp_monthly_anomaly = mean(temp_annual_anomaly, na.rm = TRUE)) %>% 
  ungroup()


clim_argo_temp_year_mean <- clim_argo_temp_year_mean %>% 
  select(-ARGO_SALINITY_MEAN) %>% 
  rename(lon = LONGITUDE,
         lat = LATITUDE,
         temp_annual_mean = ARGO_TEMPERATURE_MEAN,
         pressure = PRESSURE) %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon)) %>% 
  mutate(lat = cut(lat, seq(-90, 90, 1), seq(-89.5, 89.5, 1)),
         lat = as.numeric(as.character(lat)),
         lon = cut(lon, seq(20, 380, 1), seq(20.5, 379.5, 1)),
         lon = as.numeric(as.character(lon))) %>% 
  mutate(depth = swDepth(pressure = pressure, latitude = lat),
         .after = pressure) %>% 
  filter(lat < -30)

clim_argo_temp_year_mean <- clim_argo_temp_year_mean %>% 
  group_by(lon, lat, depth) %>% 
  summarise(temp_annual_clim = mean(temp_annual_mean, na.rm = TRUE)) %>% 
  ungroup()

# 
clim_argo_temp_ucsd <- left_join(clim_argo_temp_monthly_anomaly,
                                 clim_argo_temp_year_mean)

clim_argo_temp_ucsd <- clim_argo_temp_ucsd %>% 
  mutate(temp_clim_month = temp_annual_clim + temp_monthly_anomaly,
         depth = round(depth, digits = 0))

```

```{r map_location_of_ucsd_clim_observations}
map+
  geom_point(data = clim_argo_temp_ucsd %>% 
              filter(depth < 5),
            aes(x = lon,
                y = lat),
            size = 0.2)+
  facet_wrap(~time, ncol = 2)+
  lims(y = c(-80, -30))

```

```{r january_clim_sst_ucsd}

clim_jan_sst_ucsd <- clim_argo_temp_ucsd %>% 
  filter(time == 0.5,
         depth <= 20) %>% 
  group_by(lon, lat) %>% 
  summarise(clim_sst_jan = mean(temp_clim_month, na.rm = TRUE)) %>% 
  ungroup()

map+
  geom_tile(data = clim_jan_sst_ucsd,
            aes(x = lon,
                y = lat, 
                fill = clim_sst_jan))+
  scale_fill_viridis_c()+
  lims(y = c(-80, -30))+
  labs(title = 'Roemmich & Gilson UCSD January Climatological Argo SST')
```

```{r january_clim_depth_levels}

map+
  geom_tile(data = clim_argo_temp_ucsd %>% 
              filter(time == 0.5),
            aes(x = lon, 
                y = lat, 
                fill = temp_clim_month))+
  scale_fill_viridis_c()+
  facet_wrap(~depth)+
  lims(y = c(-80, -30))

```

