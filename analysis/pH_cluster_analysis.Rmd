---
title: "pH cluster analysis"
author: "David Stappard & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```

# Tasks

This markdown file carries out cluster analysis on previously created pH anomaly profiles.

The cluster_analysis_determine_k chunk is used to give an indication of an appropriate number of clusters and this can then set the option opt_num_clusters. Chunk cluster_analysis_cluster_details carried out the cluster analysis and the results are used in subsequent figures.

```{r loading_libraries, include=FALSE}

library(tidyverse)
library(argodata)
library(lubridate)
library(gridExtra)
library(gsw)
library(ggforce)
library(ggpmisc)
library(tidymodels)

```

## Set directories

location of pre-prepared data

```{r set_updata_root_directory, include=FALSE}

path_argo <- '/nfs/kryo/work/datasets/ungridded/3d/ocean/floats/bgc_argo'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"

```

## Set options

Define options that are used to determine what analysis is done

```{r set_options}

# Options

# opt_analysis_type
# opt_analysis_type = 1 determine number of clusters to use
# opt_analysis_type = 2 do analysis based on identified number of clusters
opt_analysis_type <- 2

# opt_num_clusters
# How many clusters are used in the cluster analysis
opt_num_clusters_min <- c(8, 8, 4)
opt_num_clusters_max <- c(8, 8, 5)
# What is the max depth of each profile_range
opt_max_depth <- c(614, 1225, 1600)
# Which profile range is used
opt_profile_range <- 3

# opt_measure
# opt_measure = 1 analysis is done using pH
# opt_measure = 2 analysis is done using h_plus
# opt_measure_label, opt_xlim and opt_xbreaks are associated formatting
opt_measure <- 2
if (opt_measure == 1){
  opt_measure_label <- "pH anomaly"
  opt_measure_label_adjusted <- "adjusted pH anomaly"
  opt_xlim <- c(-0.08, 0.08)
  opt_xbreaks <- c(-0.08, -0.04, 0, 0.04, 0.08)
} else {
  opt_measure_label <- expression("[H]"^"+" ~ "anomaly")
  opt_measure_label_adjusted <- expression("adjusted [H]"^"+" ~ "anomaly")
  opt_xlim <- c(-2e-9, 2e-9)
  opt_xbreaks <- c(-2e-9, -1e-9, 0, 1e-9, 2e-9)
}

# adjusted to be in scale -1 to 1
opt_measure_label_adjusted <- expression("adjusted [H]"^"+" ~ "anomaly")
opt_xlim_adjusted <- c(-1, 1)
opt_xbreaks_adjusted <- c(-1.0, -0.5, 0, 0.5, 1.0)

# Chl-a formatting
opt_chla_measure_label <- expression("chlorophyll a ( mg m"^"-3"~")")
opt_chla_xlim <- c(-0.5, 2.0)
opt_chla_xbreaks <- c(-0.5, 0, 0.5, 1.0, 1.5, 2.0)

# oxygen formatting
opt_doxy_measure_label <- expression("dissolved oxygen ( µmol kg"^"-1"~")")
opt_doxy_xlim <- c(50, 350)
opt_doxy_xbreaks <- c(50, 100, 150, 200, 250, 300, 350)

# options relating to cluster analysis
opt_n_start <- 25
opt_max_iterations <- 500
opt_n_clusters <- 14 # Max number of clusters to try when determining optimal number of clusters

# opt_extreme_determination
# 1 - based on the trend of de-seasonal data - we believe this results in more summer extremes where variation tend to be greater.
# 2 - based on the trend of de-seasonal data by month. grouping is by lat, lon and month.
opt_extreme_determination <- 2

# Options associated with profiles under surface extreme conditions
# Carried out for 1500m profiles
opt_profile_range = 3
extreme_type <- c('L', 'N', 'H')
opt_num_clusters_ext_min <- c(4, 4, 4)
opt_num_clusters_ext_max <- c(5, 5, 5)

# Option related to normalising the anomaly profiles.
# TRUE - anomaly profiles are normalised by the surface anomaly. Every depth anomaly is divided by the surface anomaly.
#      - The is only carried out for profiles where the abs(surface pH) > 1.
#      - This analysis is carried out in addition to the analysis on base anomaly profiles.  
# FALSE - The normalisation process is not carried out. 
opt_norm_anomaly <- TRUE

```


```{r set_global_theme, include=TRUE}

theme_set(theme_bw())

map <-
  read_rds(paste(path_emlr_utilities,
                 "map_landmask_WOA18.rds",
                 sep = ""))

```

## Preperation

Prepare data for cluster analysis

```{r cluster_analysis_prep}

# read data
pH_anomaly_va <- read_rds(file = paste0(path_argo_preprocessed, "/pH_anomaly_va.rds"))

# select profile based on profile_range and he appropriate max depth
pH_anomaly_va <- pH_anomaly_va %>% 
  filter(profile_range == opt_profile_range & depth <= opt_max_depth[opt_profile_range])

# Select target variable
if (opt_measure == 1) {
  pH_anomaly_va_id <- pH_anomaly_va %>% 
    rename(
      anomaly = anomaly_pH
    )
} else {
  pH_anomaly_va_id <- pH_anomaly_va %>% 
    rename(
      anomaly = anomaly_h_plus
    )
}

pH_anomaly_va_id <- pH_anomaly_va_id %>% 
  select(
    file_id, depth, anomaly,
    year, month, lat, lon
  )

# wide table with each depth becoming a column
pH_anomaly_va_wide <- pH_anomaly_va_id %>%
  select(file_id, depth, anomaly) %>%
  pivot_wider(names_from = depth, values_from = anomaly)


# Drop any rows with missing values N/A caused by gaps in climatology data
pH_anomaly_va_wide <- pH_anomaly_va_wide %>% 
  drop_na()

# profile_id <- pH_anomaly_va_wide %>% select(file_id)

# Table for cluster analysis
# points <- pH_anomaly_va_wide %>%
#   select(-c(file_id))

points <- pH_anomaly_va_wide %>%
  column_to_rownames(var = "file_id")

# normalisation?
if (opt_norm_anomaly) {
  
  surf_anomaly <- abs(pH_anomaly_va_id %>% 
    filter (depth == 5) %>%
    select (file_id, abs_sa = anomaly))
  
  # Get the maximum anomaly for each profile - the normalisation will then fit max to 1
  surf_anomaly <- pH_anomaly_va_id %>%
    group_by(file_id) %>%
    summarise(abs_sa = max(abs(anomaly))) %>%
    ungroup() %>%
    select (file_id, abs_sa)

  pH_anomaly_va_id_normalised <- left_join(pH_anomaly_va_id, surf_anomaly)
  
  #pH_anomaly_va_id_normalised <- pH_anomaly_va_id_normalised %>%
  #  mutate(anomaly = if_else(abs_sa > 1.0, anomaly/abs_sa, anomaly))
  pH_anomaly_va_id_normalised <- pH_anomaly_va_id_normalised %>%
    mutate(anomaly = anomaly/abs_sa)
    
  # wide table with each depth becoming a column
  pH_anomaly_va_wide <- pH_anomaly_va_id_normalised %>%
    select(file_id, depth, anomaly) %>%
    pivot_wider(names_from = depth, values_from = anomaly)
  
  # Drop any rows with missing values N/A caused by gaps in climatology data
  pH_anomaly_va_wide <- pH_anomaly_va_wide %>% 
    drop_na()
  
  # Table for cluster analysis
  points_normalised <- pH_anomaly_va_wide %>%
    column_to_rownames(var = "file_id")

}


```

## Number of clusters

```{r cluster_analysis_determine_k}

if (opt_analysis_type == 1) {

  # cluster analysis - What k? try between 1 and opt_n_clusters clusters
  kclusts <- 
  tibble(k = 1:opt_n_clusters) %>%
  mutate(
    kclust = map(k, ~kmeans(points, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
    tidied = map(kclust, tidy),
    glanced = map(kclust, glance),
    augmented = map(kclust, augment, points)
  )
  

  # cluster analysis data
  clusters <-
    kclusts %>%
    unnest(cols = c(tidied))
  
  assignments <-
    kclusts %>%
    unnest(cols = c(augmented))
  
  clusterings <-
    kclusts %>%
    unnest(cols = c(glanced))
  
  # What cluster works best?
  clusterings %>%
  ggplot(aes(k, tot.withinss)) +
    geom_line() +
    geom_point() +
    scale_x_continuous(breaks = c(2, 4, 6, 8, 10, 12, 14))

}

```

## Cluster analysis

### Cluster means

```{r cluster_analysis_cluster_details}

if (opt_analysis_type == 2) {
  
  for (iType in 1:2) {
    for (inum_clusters in opt_num_clusters_min[opt_profile_range]:opt_num_clusters_max[opt_profile_range]) {
      if (iType == 1) {

        set.seed(1)
        kclusts <-
          tibble(k = inum_clusters) %>%
          mutate(kclust = map(k, ~ kmeans(points, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
            tidied = map(kclust, tidy),
            glanced = map(kclust, glance),
            augmented = map(kclust, augment, points)
          )
        
        profile_id <-
          kclusts %>%
          unnest(cols = c(augmented)) %>%
          select(file_id = .rownames,
                 cluster = .cluster) %>%
          mutate(file_id = as.numeric(file_id),
                 cluster = as.character(cluster))
        
        # Add cluster to pH_anomaly_va
        pH_anomaly_cluster <-
          full_join(pH_anomaly_va_id, profile_id)
        
        # Add profile_type field
        pH_anomaly_cluster <- pH_anomaly_cluster %>%
          mutate(profile_type = 'base')
        
        # Check null clusters
        pH_anomaly_cluster <- pH_anomaly_cluster %>%
          filter(!is.na(cluster))
        
        # Create table to be used for later analysis and Set the number of clusters field
        if (!exists('pH_anomaly_cluster_all')) {
          pH_anomaly_cluster_all <- pH_anomaly_cluster %>%
            mutate(num_clusters = inum_clusters)
        } else {
          pH_anomaly_cluster_all <-
            rbind(
              pH_anomaly_cluster_all,
              pH_anomaly_cluster %>%
                mutate(num_clusters = inum_clusters)
            )
        }
        
      } else if (iType == 2 & opt_norm_anomaly) {

        set.seed(1)
        kclusts <-
          tibble(k = inum_clusters) %>%
          mutate(kclust = map(k, ~ kmeans(points_normalised, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
            tidied = map(kclust, tidy),
            glanced = map(kclust, glance),
            augmented = map(kclust, augment, points)
          )
        
        profile_id <-
          kclusts %>%
          unnest(cols = c(augmented)) %>%
          select(file_id = .rownames,
                 cluster = .cluster) %>%
          mutate(file_id = as.numeric(file_id),
                 cluster = as.character(cluster))
        
        # Add cluster to pH_anomaly_va
        pH_anomaly_cluster_norm <-
          full_join(pH_anomaly_va_id_normalised %>% select(-c(abs_sa)) ,
                    profile_id)
        
        # Add profile_type field
        pH_anomaly_cluster_norm <- pH_anomaly_cluster_norm %>%
          mutate(profile_type = 'adjusted')
        
        # Check null clusters
        pH_anomaly_cluster_norm <- pH_anomaly_cluster_norm %>%
          filter(!is.na(cluster))
        
        # Create table to be used for later analysis and Set the number of clusters field
        if (!exists('pH_anomaly_cluster_all')) {
          pH_anomaly_cluster_all <- pH_anomaly_cluster_norm %>%
            mutate(num_clusters = inum_clusters)
        } else {
          pH_anomaly_cluster_all <-
            rbind(
              pH_anomaly_cluster_all,
              pH_anomaly_cluster_norm %>%
                mutate(num_clusters = inum_clusters)
            )
        }
        
      }
      
    }
  }
  
  # Plot cluster mean
  anomaly_cluster_mean <- pH_anomaly_cluster_all %>%
    group_by(profile_type, num_clusters, cluster, depth) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_cluster_mean_year <- pH_anomaly_cluster_all %>%
    group_by(profile_type, num_clusters, cluster, depth, year) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_year_mean <- pH_anomaly_cluster_all %>%
    group_by(profile_type, num_clusters, cluster, year) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_year_mean <- anomaly_year_mean %>%
    group_by(profile_type, num_clusters, year) %>%
    summarise(anomaly_mean = mean(anomaly_mean, na.rm = TRUE)) %>%
    ungroup ()

  # Determine profile count by cluster and year
  # Count the measurements
  cluster_by_year <- pH_anomaly_cluster_all %>% 
    count(profile_type, num_clusters, file_id, cluster, year,
          name = "count_cluster")

  # Convert to profiles
  cluster_by_year <- cluster_by_year %>% 
    count(profile_type, num_clusters, cluster, year,
          name = "count_cluster")
  
  # total of each type of cluster
  cluster_count <- cluster_by_year %>%
    group_by(profile_type, num_clusters, cluster) %>% 
    summarise(count_profiles = sum(count_cluster)) %>%
    ungroup()
  
  anomaly_cluster_mean <- left_join(anomaly_cluster_mean, cluster_count)
  
  # create figure of cluster mean profiles
  anomaly_cluster_mean %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x,) +
        geom_path(aes(x = anomaly_mean,
                      y = depth)) +
        geom_ribbon(
          aes(
            xmax = anomaly_mean + anomaly_sd,
            xmin = anomaly_mean - anomaly_sd,
            y = depth
          ),
          alpha = 0.2
        ) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
        coord_cartesian(xlim = opt_xlim) +
        scale_x_continuous(breaks = opt_xbreaks) +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = opt_measure_label,
          y = 'depth (m)'
        )
    )
  
}

```

Adjusted profiles

```{r cluster_analysis_cluster_details_adj}

if (opt_norm_anomaly) {
  
  # Repeat for adjusted profiles
  anomaly_cluster_mean %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x,) +
        geom_path(aes(x = anomaly_mean,
                      y = depth)) +
        geom_ribbon(
          aes(
            xmax = anomaly_mean + anomaly_sd,
            xmin = anomaly_mean - anomaly_sd,
            y = depth
          ),
          alpha = 0.2
        ) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )
}


```

### Cluster mean by year

```{r cluster_mean_year}

if (opt_analysis_type == 2) {

  # cluster means by year
  anomaly_cluster_mean_year %>%
    filter (profile_type == "base") %>%
    mutate(year = as.factor(year)) %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x, ) +
        geom_path(aes(
          x = anomaly_mean,
          y = depth,
          col = year
        )) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ cluster) +
        coord_cartesian(xlim = opt_xlim) +
        scale_x_continuous(breaks = opt_xbreaks) +
        scale_color_viridis_d() +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = opt_measure_label,
          y = 'depth (m)'
        )
    )
}

```

Adjusted profiles

```{r cluster_mean_year_adj}

if (opt_norm_anomaly) {
  
  # Repeat for adjusted profiles
  anomaly_cluster_mean_year %>%
    filter (profile_type == "adjusted") %>%
    mutate(year = as.factor(year)) %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x, ) +
        geom_path(aes(
          x = anomaly_mean,
          y = depth,
          col = year
        )) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ cluster) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        scale_color_viridis_d() +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )

}

```

Cluster climatology

```{r cluster_climatology_shift, eval=FALSE}

# A nice short alternative, uses the package ggpmisc
anomaly_year_mean %>%
  ggplot(aes(x = year,
             y = anomaly_mean)) +
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2","P", "n"))) +
  geom_point()
  
```


### Cluster by year

count of each cluster by year

```{r cluster_by_year}

if (opt_analysis_type == 2) {

  year_min <- min(cluster_by_year$year)
  year_max <- max(cluster_by_year$year)
  
  # create figure
  cluster_by_year %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x, aes(
          x = year,
          y = count_cluster,
          col = cluster,
          group = cluster
        )) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'Count of profiles by year and cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = 'year',
          y = 'number of profiles',
          col = 'cluster'
        )
    )
}

```

Adjusted profiles

```{r cluster_by_year_adj}

if (opt_norm_anomaly) {
  
  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(data = .x, aes(
          x = year,
          y = count_cluster,
          col = cluster,
          group = cluster
        )) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'Count of profiles by year and cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = 'year',
          y = 'number of profiles',
          col = 'cluster'
        )
    )

}

```

### Cluster by month

count of each cluster by month of year

```{r cluster_by_month}

if (opt_analysis_type == 2) {

  # Determine profile count by cluster and year
  # Count the measurements
  cluster_by_year <- pH_anomaly_cluster_all %>% 
    count(profile_type, num_clusters, file_id, cluster, month,
          name = "count_cluster")

  # Convert to profiles
  cluster_by_year <- cluster_by_year %>% 
    count(profile_type, num_clusters, cluster, month,
          name = "count_cluster")

  # create figure
  cluster_by_year %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(
        data = .x,
        aes(
          x = month,
          y = count_cluster,
          col = cluster,
          group = cluster
        )
      ) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(1, 12, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'Count of profiles by month and cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = 'month',
          y = 'number of profiles',
          col = 'cluster'
        )
    )
  
}

```

Adjusted profiles

```{r cluster_by_month_adj}

if (opt_norm_anomaly) {

  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ ggplot(
        data = .x,
        aes(
          x = month,
          y = count_cluster,
          col = cluster,
          group = cluster
        )
      ) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(1, 12, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'Count of profiles by month and cluster \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
          x = 'month',
          y = 'number of profiles',
          col = 'cluster'
        )
    )
  
}

```

### Cluster spatial

location of each cluster on map, spatial analysis

```{r spatial_cluster_01}

if (opt_analysis_type == 2) {

  # create figure
  pH_anomaly_cluster_all %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ map +
        geom_tile(data = .x,
                  aes(
                    x = lon,
                    y = lat,
                    fill = cluster
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
        )
    )
  
}

```

Adjusted profiles

```{r spatial_cluster_01_adj}

if (opt_norm_anomaly) {

  # create figure
  pH_anomaly_cluster_all %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ map +
        geom_tile(data = .x,
                  aes(
                    x = lon,
                    y = lat,
                    fill = cluster
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          ),
        )
    )
  
}

```

location of each cluster on separate maps, spatial analysis

```{r spatial_cluster_02, eval=FALSE}

if (opt_analysis_type == 2) {

  # create figure
map +
  geom_tile(data = pH_anomaly_cluster,
            aes(x = lon,
                y = lat,
                fill = cluster)) +
  lims(y = c(-85, -30)) +
  scale_fill_brewer(palette = 'Dark2') +
  facet_wrap( ~ cluster, ncol = 2) +
  labs(title = 'cluster spatial distribution')

}
```

### Cluster spatial counts

count of measurements for each cluster on separate maps, spatial analysis

```{r spatial_cluster_03}

if (opt_analysis_type == 2) {

  # Count profiles    
  cluster_by_location <- pH_anomaly_cluster_all %>%
    count(profile_type, num_clusters, file_id, lat, lon, cluster,
          name = "count_cluster")
  
  # create figure
  cluster_by_location %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ map +
        geom_tile(data = .x %>%
                    count(lat, lon, cluster),
                  aes(
                    x = lon,
                    y = lat,
                    fill = n
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_gradient(low = "blue",
                            high = "red",
                            trans = "log10") +
        facet_wrap(~ cluster, ncol = 2) +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          )
        )
    )

}

```

Adjusted profiles

```{r spatial_cluster_03_adj}

if (opt_norm_anomaly) {

  # create figure
  cluster_by_location %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters) %>%
    map(
      ~ map +
        geom_tile(data = .x %>%
                    count(lat, lon, cluster),
                  aes(
                    x = lon,
                    y = lat,
                    fill = n
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_gradient(low = "blue",
                            high = "red",
                            trans = "log10") +
        facet_wrap(~ cluster, ncol = 2) +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'type = ', unique(.x$profile_type), ', ', 
            'num clusters = ', unique(.x$num_clusters)
          )
        )
    )
  
}
```

Cluster spatial year

location of each cluster on map, spatial analysis by year

```{r spatial_cluster_year, eval=FALSE}

if (opt_analysis_type == 2) {

  # create figure
  pH_anomaly_cluster %>%
    group_split(year) %>%
    map(
      ~ map +
        geom_tile(data = .x,
                  aes(
                    x = lon,
                    y = lat,
                    fill = cluster
                  )) +
        #lims(y = c(-85, -30))+
        scale_fill_brewer(palette = 'Dark2') +
        facet_wrap( ~ cluster, ncol = 2) +
        labs(title = paste0(
          'cluster spatial distribution ', unique(.x$year)
        ))
    )

}

```

### pH and Chl-a

for each cluster identified by pH cluster analysis show  alongside chl-a

```{r ph_with_chla}
if (opt_analysis_type == 2) {
  
  # Read chl-a data and link to cluster ID
  chla_bgc_va <- read_rds(file = paste0(path_argo_preprocessed, "/chla_bgc_va.rds"))
  chla_cluster <- right_join(chla_bgc_va, profile_id)

  # summarise by cluster
  chla_cluster_mean <- chla_cluster %>% 
      group_by(cluster, depth) %>% 
      summarise(chla_mean = mean(chla, na.rm = TRUE),
                chla_sd = sd(chla, na.rm = TRUE)) %>%
      ungroup()

  # join pH anomaly with chl-a
  cluster_ph_chla <- full_join(anomaly_cluster_mean, chla_cluster_mean)
  
  # create figures
  cluster_ph_chla %>% 
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,)+
      geom_path(aes(x = anomaly_mean,
                    y = depth))+
      geom_ribbon(aes(xmax = anomaly_mean + anomaly_sd,
                      xmin = anomaly_mean - anomaly_sd,
                      y = depth),
                  alpha = 0.2)+
      geom_vline(xintercept = 0)+
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
      facet_wrap(~cluster)+
      coord_cartesian(xlim = opt_xlim)+
      scale_x_continuous(breaks = opt_xbreaks)+
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      )
    )
    
  cluster_ph_chla %>% 
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,)+
      geom_path(aes(x = chla_mean,
                    y = depth))+
      geom_ribbon(aes(xmax = chla_mean + chla_sd,
                      xmin = chla_mean - chla_sd,
                      y = depth),
                  alpha = 0.2)+
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
      facet_wrap(~cluster)+
      coord_cartesian(xlim = opt_chla_xlim)+
      scale_x_continuous(breaks = opt_chla_xbreaks)+
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_chla_measure_label,
        y = 'depth (m)'
      )
    )


  if (opt_measure == 1){
    chla_to_ph_factor <- 25
    chla_to_ph_offset <- 1
  } else {
    chla_to_ph_factor <- 1e9
    chla_to_ph_offset <- 1
  }
  chla_color <- "#69b3a2"
  
  cluster_ph_chla %>% 
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(aes(
        xmax = anomaly_mean + anomaly_sd,
        xmin = anomaly_mean - anomaly_sd,
        y = depth
      ),
      alpha = 0.2) +
      geom_path(aes(
        x = (chla_mean - chla_to_ph_offset) / chla_to_ph_factor,
        y = depth
      ), color = chla_color) +
      geom_ribbon(
        aes(
          xmax = (chla_mean + chla_sd - chla_to_ph_offset) / chla_to_ph_factor,
          xmin = (chla_mean - chla_sd - chla_to_ph_offset) / chla_to_ph_factor,
          y = depth
        ),
        fill = chla_color,
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
      facet_wrap( ~ cluster,
                  strip.position = "right") +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(
        # First axis
        name = opt_measure_label,
        breaks = opt_xbreaks,
        # Second axis
        sec.axis = sec_axis(
          trans =  ~ . * chla_to_ph_factor + chla_to_ph_offset,
          name = opt_chla_measure_label
        )
      ) +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      ) +
      theme(axis.title.x.top = element_text(color = chla_color),
            axis.text.x.top = element_text(color = chla_color))
    )

}

```

### pH and oxygen

for each cluster identified by pH cluster analysis show  alongside oxygen

```{r ph_with_oxygen}
if (opt_analysis_type == 2) {
  
  # Read chl-a data and link to cluster ID
  doxy_bgc_va <- read_rds(file = paste0(path_argo_preprocessed, "/doxy_bgc_va.rds"))
  doxy_cluster <- right_join(doxy_bgc_va, profile_id)

  # summarise by cluster
  doxy_cluster_mean <- doxy_cluster %>% 
      group_by(cluster, depth) %>% 
      summarise(doxy_mean = mean(doxy, na.rm = TRUE),
                doxy_sd = sd(doxy, na.rm = TRUE)) %>%
      ungroup()

  # join pH anomaly with chl-a
  cluster_ph_doxy <- full_join(anomaly_cluster_mean, doxy_cluster_mean)
  
  # create figure
  cluster_ph_doxy %>% 
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,)+
      geom_path(aes(x = anomaly_mean,
                    y = depth))+
      geom_ribbon(aes(xmax = anomaly_mean + anomaly_sd,
                      xmin = anomaly_mean - anomaly_sd,
                      y = depth),
                  alpha = 0.2)+
      geom_vline(xintercept = 0)+
      scale_y_reverse()+
      facet_wrap(~cluster)+
      coord_cartesian(xlim = opt_xlim)+
      scale_x_continuous(breaks = opt_xbreaks)+
      labs(        
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label, 
        y = 'depth (m)')
    )
    
  cluster_ph_doxy %>% 
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,)+
      geom_path(aes(x = doxy_mean,
                    y = depth))+
      geom_ribbon(aes(xmax = doxy_mean + doxy_sd,
                      xmin = doxy_mean - doxy_sd,
                      y = depth),
                  alpha = 0.2)+
      scale_y_reverse()+
      facet_wrap(~cluster)+
      coord_cartesian(xlim = opt_doxy_xlim)+
      scale_x_continuous(breaks = opt_doxy_xbreaks)+
      labs(        
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_doxy_measure_label, 
        y = 'depth (m)')
    )


  if (opt_measure == 1){
    doxy_to_ph_factor <- 1875
    doxy_to_ph_offset <- 200
  } else {
    doxy_to_ph_factor <- 75e9
    doxy_to_ph_offset <- 200
  }
  doxy_color <- "#5B9BD5"
  
  cluster_ph_doxy %>%
    filter (profile_type == "base") %>%
    group_split(profile_type, num_clusters) %>%
    map(
    ~ ggplot(data = .x,) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(aes(
        xmax = anomaly_mean + anomaly_sd,
        xmin = anomaly_mean - anomaly_sd,
        y = depth
      ),
      alpha = 0.2) +
      geom_path(aes(
        x = (doxy_mean - doxy_to_ph_offset)  / doxy_to_ph_factor,
        y = depth
      ), color = doxy_color) +
      geom_ribbon(
        aes(
          xmax = (doxy_mean + doxy_sd - doxy_to_ph_offset) / doxy_to_ph_factor,
          xmin = (doxy_mean - doxy_sd - doxy_to_ph_offset) / doxy_to_ph_factor,
          y = depth
        ),
        fill = doxy_color,
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap( ~ cluster,
                  strip.position = "right") +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(
        # First axis
        name = opt_measure_label,
        breaks = opt_xbreaks,
        # First axis
        sec.axis = sec_axis(
          trans =  ~ . * doxy_to_ph_factor + doxy_to_ph_offset,
          name = opt_doxy_measure_label
        )
      ) +
      labs(        
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'type = ', unique(.x$profile_type), ', ', 
          'num clusters = ', unique(.x$num_clusters)
        ),
        x = opt_measure_label, 
        y = 'depth (m)'
        ) +
      theme(axis.title.x.top = element_text(color = doxy_color),
            axis.text.x.top = element_text(color = doxy_color))
    )
  
}

```

## Cluster by surface Extreme

```{r cluster_analysis_prep_ext}

# ---------------------------------------------------------------------------------------------
# read data
# ---------------------------------------------------------------------------------------------
# load previously created OceanSODA extreme data. date, position and nature of extreme
if (opt_extreme_determination == 1){
  pH_extreme <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_pH_anomaly_field_01.rds")) %>%
    select(lon, lat, date, ph_extreme)
} else if (opt_extreme_determination == 2){
  pH_extreme <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_pH_anomaly_field_02.rds")) %>%
    select(lon, lat, date, ph_extreme)
}

# -------------------------------------------------------------------------------------------------------------
# pH - review incidences of extremes based on method.
# -------------------------------------------------------------------------------------------------------------
# 
#   pH_extreme_info_01 <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_SST_anomaly_field_01.rds")) %>%
#     select(lon, lat, date, pH_extreme)
# 
# pH_extreme_info_01 <- pH_extreme_info_01 %>%
#   group_by(pH_extreme, date) %>%
#   summarise(n = n()) %>%
#   ungroup()
# 
# pH_extreme_info_01 %>%
#   filter (pH_extreme %in% c('H', 'L') & date >= '2013-01-01') %>%
#   ggplot(aes(
#            x = date,
#            y = n,
#            col = pH_extreme
#          )) +
#   geom_point() +
#   geom_line() +
#   lims(y = c(0,3200)) +
#   labs(
#     x = 'date',
#     y = 'number of extreme pixels',
#     col = 'extreme type',
#     title = paste0(
#       'Count of extreme pixels - single trend'
#     )
#   )
# 
# 
# pH_extreme_info_02 <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_SST_anomaly_field_02.rds")) %>%
#     select(lon, lat, date, pH_extreme)
# 
# pH_extreme_info_02 <- pH_extreme_info_02 %>%
#   group_by(pH_extreme, date) %>%
#   summarise(n = n()) %>%
#   ungroup()
# 
# pH_extreme_info_02 %>%
#   filter (pH_extreme %in% c('H', 'L') & date >= '2013-01-01') %>%
#   ggplot(aes(
#            x = date,
#            y = n,
#            col = pH_extreme
#          )) +
#   geom_point() +
#   geom_line() +
#   lims(y = c(0,3200)) +
#   labs(
#     x = 'date',
#     y = 'number of extreme pixels',
#     col = 'extreme type',
#     title = paste0(
#       'Count of extreme pixels - monthly trends'
#     )
#   )
#   
# -------------------------------------------------------------------------------------------------------------
  
# read data
pH_anomaly_va <- read_rds(file = paste0(path_argo_preprocessed, "/pH_anomaly_va.rds")) %>%
  mutate(date = ymd(format(date, "%Y-%m-15")))

# Add the OceanSODA extreme condition
pH_anomaly_va <- left_join(pH_anomaly_va, pH_extreme)

# If pH_extreme is NA set it to N
pH_anomaly_va <- pH_anomaly_va %>% replace_na(list(ph_extreme = 'N'))
pH_anomaly_va <- pH_anomaly_va %>% mutate (profile_type = 'base')

if (opt_measure == 1){
  pH_anomaly_va <- pH_anomaly_va %>%
    mutate(anomaly = anomaly_pH)
} else {
  pH_anomaly_va <- pH_anomaly_va %>%
    mutate(anomaly = anomaly_h_plus)
}

# Create a replica data set with profile_type = adjusted 
if (opt_norm_anomaly){
  # mark as adjusted
  pH_anomaly_va_norm <- pH_anomaly_va %>% mutate (profile_type = 'adjusted')

  # Determine surface anomaly for each profile
  # surf_anomaly <- abs(pH_anomaly_va_norm %>% 
  #   filter (depth == 5) %>%
  #   select (file_id, abs_sa = anomaly))

  # Get the maximum anomaly for each profile - the normalisation will then fit max to 1
  surf_anomaly <- pH_anomaly_va %>%
    group_by(file_id) %>%
    summarise(abs_sa = max(abs(anomaly))) %>%
    ungroup() %>%
    select (file_id, abs_sa)
  
  pH_anomaly_va_norm <- left_join(pH_anomaly_va_norm, surf_anomaly)
    
  # Carry out the adjustment
  #pH_anomaly_va_norm <- pH_anomaly_va_norm %>%
  #  mutate(anomaly = if_else(abs_sa > 1.0, anomaly/abs_sa, anomaly))
  if (opt_measure == 1){
    pH_anomaly_va_norm <- pH_anomaly_va_norm %>%
      mutate(anomaly = anomaly_pH/abs_sa)
  } else {
    pH_anomaly_va_norm <- pH_anomaly_va_norm %>%
      mutate(anomaly = anomaly_h_plus/abs_sa)
  }
  
  #remove the surface anomaly field
  pH_anomaly_va_norm <- pH_anomaly_va_norm %>% select(-c(abs_sa))
  
  # Append to base profiles
  pH_anomaly_va <- rbind(pH_anomaly_va, pH_anomaly_va_norm)
  
}

profile_types <- c('adjusted', 'base')

# loop through profile_type
for (iprofile_type in 1:2) {

  sel_profile_type = profile_types[iprofile_type]
    
  # loop through surface condition
  for (i in 1:3) {
  
    # ---------------------------------------------------------------------------------------------
    # Preparation
    # ---------------------------------------------------------------------------------------------
    # select profile based on profile_range and he appropriate max depth
    pH_anomaly_va_id <- pH_anomaly_va %>% 
      filter(profile_range == opt_profile_range & depth <= opt_max_depth[opt_profile_range] & ph_extreme == extreme_type[i] & profile_type == sel_profile_type)
    
    # Simplified table ready to pivot
    pH_anomaly_va_id <- pH_anomaly_va_id %>%
      select(file_id,
             depth,
             anomaly,
             year, 
             month, 
             lat, 
             lon)
    
    # wide table with each depth becoming a column
    pH_anomaly_va_wide <- pH_anomaly_va_id %>%
      select(file_id, depth, anomaly) %>%
      pivot_wider(names_from = depth, values_from = anomaly)
    
    # Drop any rows with missing values N/A caused by gaps in climatology data
    pH_anomaly_va_wide <- pH_anomaly_va_wide %>% 
      drop_na()
    
    # Table for cluster analysis
    points <- pH_anomaly_va_wide %>%
      column_to_rownames(var = "file_id")
    
    # ---------------------------------------------------------------------------------------------
    # cluster analysis
    # ---------------------------------------------------------------------------------------------
    # loop through number of clusters
    for (inum_clusters in opt_num_clusters_ext_min[i]:opt_num_clusters_ext_max[i]) {    
  
      set.seed(1)
      kclusts <-
        tibble(k = inum_clusters) %>%
        mutate(
          kclust = map(k, ~ kmeans(points, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
          tidied = map(kclust, tidy),
          glanced = map(kclust, glance),
          augmented = map(kclust, augment, points)
        )
      
      profile_id <-
        kclusts %>%
        unnest(cols = c(augmented)) %>%
        select(file_id = .rownames,
               cluster = .cluster) %>% 
        mutate(file_id = as.numeric(file_id),
               cluster = as.character(cluster))
      
      # Add cluster to pH_anomaly_va
      pH_anomaly_cluster <- full_join(pH_anomaly_va_id, profile_id)
      
      # Plot cluster mean
      pH_anomaly_cluster <- pH_anomaly_cluster %>% 
        filter(!is.na(cluster))
      
      # cluster mean
      anomaly_cluster_mean <- pH_anomaly_cluster %>%
        group_by(cluster, depth) %>%
        summarise(
          count_cluster = n(),
          anomaly_mean = mean(anomaly, na.rm = TRUE),
          anomaly_sd = sd(anomaly, na.rm = TRUE)
        ) %>%
        ungroup()
      
      anomaly_cluster_mean_year <- pH_anomaly_cluster %>%
        group_by(cluster, depth, year) %>%
        summarise(
          count_cluster = n(),
          anomaly_mean = mean(anomaly, na.rm = TRUE),
          anomaly_sd = sd(anomaly, na.rm = TRUE)
        ) %>%
        ungroup()
      
      anomaly_year_mean <- pH_anomaly_cluster %>%
        group_by(cluster, year) %>%
        summarise(
          count_cluster = n(),
          anomaly_mean = mean(anomaly, na.rm = TRUE),
          anomaly_sd = sd(anomaly, na.rm = TRUE)
        ) %>%
        ungroup()
      
      anomaly_year_mean <- anomaly_year_mean %>%
        group_by(year) %>%
        summarise(anomaly_mean = mean(anomaly_mean, na.rm = TRUE)) %>%
        ungroup ()
      
      if (!exists('anomaly_cluster_mean_ext')) {
        anomaly_cluster_mean_ext <-
          anomaly_cluster_mean %>% mutate(
            pH_extreme_order = i,
            pH_extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
        anomaly_cluster_mean_year_ext <-
          anomaly_cluster_mean_year %>% mutate(
            pH_extreme_order = i,
            pH_extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
        anomaly_year_mean_ext <-
          anomaly_year_mean %>% mutate(
            pH_extreme_order = i,
            pH_extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
        pH_anomaly_cluster_ext <-
          pH_anomaly_cluster %>% mutate(
            pH_extreme_order = i,
            pH_extreme = extreme_type[i],
            num_clusters = inum_clusters,
            profile_type = sel_profile_type
          )
      } else {
        anomaly_cluster_mean_ext <-
          rbind(
            anomaly_cluster_mean_ext,
            anomaly_cluster_mean %>% mutate(
              pH_extreme_order = i,
              pH_extreme = extreme_type[i],
              num_clusters = inum_clusters,
              profile_type = sel_profile_type
            )
          )
        anomaly_cluster_mean_year_ext <-
          rbind(
            anomaly_cluster_mean_year_ext,
            anomaly_cluster_mean_year %>% mutate(
              pH_extreme_order = i,
              pH_extreme = extreme_type[i],
              num_clusters = inum_clusters,
              profile_type = sel_profile_type
            )
          )
        anomaly_year_mean_ext <-
          rbind(
            anomaly_year_mean_ext,
            anomaly_year_mean %>% mutate(
              pH_extreme_order = i,
              pH_extreme = extreme_type[i],
              num_clusters = inum_clusters,
              profile_type = sel_profile_type
            )
          )
        pH_anomaly_cluster_ext <-
          rbind(
            pH_anomaly_cluster_ext,
            pH_anomaly_cluster_ext <-
              pH_anomaly_cluster %>% mutate(
                pH_extreme_order = i,
                pH_extreme = extreme_type[i],
                num_clusters = inum_clusters,
                profile_type = sel_profile_type
              )
          )
      }
  
    }
    
  }
  
}
```

### Cluster means

```{r cluster_mean_ext}

# Determine profile count by cluster and year
# Count the measurements
cluster_by_year <- pH_anomaly_cluster_ext %>% 
  count(profile_type, num_clusters, pH_extreme, pH_extreme_order, file_id, cluster, year,
        name = "count_cluster")

#cluster_by_year %>% filter (num_clusters == 5 & pH_extreme == 'N')

# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(profile_type, num_clusters, pH_extreme, pH_extreme_order, cluster, year,
        name = "count_cluster")

# total of each type of cluster
cluster_count <- cluster_by_year %>%
  group_by(profile_type, num_clusters, pH_extreme, pH_extreme_order, cluster) %>% 
  summarise(count_profiles = sum(count_cluster)) %>%
  ungroup()

anomaly_cluster_mean_ext <- left_join(anomaly_cluster_mean_ext, cluster_count)
  
# create figure of cluster mean profiles
anomaly_cluster_mean_ext %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, pH_extreme_order) %>%
  map(
    ~  ggplot(data = .x, ) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(
        aes(
          xmax = anomaly_mean + anomaly_sd,
          xmin = anomaly_mean - anomaly_sd,
          y = depth
        ),
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      #facet_wrap(~ cluster) +
      facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(breaks = opt_xbreaks) +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$pH_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      )
  )

```

Adjusted profiles

```{r cluster_mean_ext_adj}

if (opt_norm_anomaly) {

  # create figure of cluster mean profiles
  anomaly_cluster_mean_ext %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, pH_extreme_order) %>%
    map(
      ~  ggplot(data = .x, ) +
        geom_path(aes(x = anomaly_mean,
                      y = depth)) +
        geom_ribbon(
          aes(
            xmax = anomaly_mean + anomaly_sd,
            xmin = anomaly_mean - anomaly_sd,
            y = depth
          ),
          alpha = 0.2
        ) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        #facet_wrap(~ cluster) +
        facet_wrap(~ paste0(cluster, " (", formatC(count_profiles, big.mark=",") , ")")) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$pH_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )

}

```

### Clusters mean by year

```{r cluster_mean_year_ext}

# cluster means by year
anomaly_cluster_mean_year_ext %>%
  filter (profile_type == "base") %>%
  mutate(year = as.factor(year)) %>%
  group_split(profile_type, num_clusters, pH_extreme_order) %>%
  map(
    ~  ggplot(data = .x,) +
      geom_path(aes(
        x = anomaly_mean,
        y = depth,
        col = year
      )) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap(~ cluster) +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(breaks = opt_xbreaks) +
      scale_color_viridis_d() +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster by year \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$pH_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      )
  )

```

Adjusted profiles

```{r cluster_mean_year_ext_adj}

if (opt_norm_anomaly) {

  # cluster means by year
  anomaly_cluster_mean_year_ext %>%
    filter (profile_type == "adjusted") %>%
    mutate(year = as.factor(year)) %>%
    group_split(profile_type, num_clusters, pH_extreme_order) %>%
    map(
      ~  ggplot(data = .x,) +
        geom_path(aes(
          x = anomaly_mean,
          y = depth,
          col = year
        )) +
        geom_vline(xintercept = 0) +
        scale_y_reverse() +
        facet_wrap(~ cluster) +
        coord_cartesian(xlim = opt_xlim_adjusted) +
        scale_x_continuous(breaks = opt_xbreaks_adjusted) +
        scale_color_viridis_d() +
        labs(
          title = paste0(
            'Overall mean anomaly profiles by cluster by year \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$pH_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          ),
          x = opt_measure_label_adjusted,
          y = 'depth (m)'
        )
    )

}
```

### Cluster by year

count of each cluster by year

```{r cluster_by_year_ext}

# Determine profile count by extreme and cluster and year
# Count the measurements
cluster_by_year <- pH_anomaly_cluster_ext %>% 
  count(file_id, profile_type, num_clusters, pH_extreme_order, pH_extreme, cluster, year,
        name = "count_cluster")
# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(profile_type, num_clusters, pH_extreme_order, pH_extreme, cluster, year,
        name = "count_cluster")

year_min <- min(cluster_by_year$year)
year_max <- max(cluster_by_year$year)

# create figure
cluster_by_year %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, pH_extreme_order) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = year,
        y = count_cluster,
        col = cluster,
        group = cluster
      )
    ) +
      geom_point() +
      geom_line() +
      scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
      scale_color_brewer(palette = 'Dark2') +
      labs(
        x = 'year',
        y = 'number of profiles',
        col = 'cluster',
        title = paste0(
          'Count of profiles by year and cluster \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$pH_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )

```

Adjusted profiles

```{r cluster_by_year_ext_adj}

if (opt_norm_anomaly) {

  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, pH_extreme_order) %>%
    map(
      ~ ggplot(
        data = .x,
        aes(
          x = year,
          y = count_cluster,
          col = cluster,
          group = cluster
        )
      ) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          x = 'year',
          y = 'number of profiles',
          col = 'cluster',
          title = paste0(
            'Count of profiles by year and cluster \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$pH_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )
    
}

```

### Cluster by month

count of each cluster by month of year

```{r cluster_by_month_ext}

# Determine profile count by cluster and year
# Count the measurements
cluster_by_year <- pH_anomaly_cluster_ext %>% 
  count(file_id, profile_type, num_clusters, pH_extreme_order, pH_extreme, cluster, month,
        name = "count_cluster")
# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(profile_type, num_clusters, pH_extreme_order, pH_extreme, cluster, month,
        name = "count_cluster")

# create figure
cluster_by_year %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, pH_extreme_order) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = month,
        y = count_cluster,
        col = cluster,
        group = cluster
      )
    ) +
      geom_point() +
      geom_line() +
      scale_x_continuous(breaks = seq(1, 12, 2)) +
      scale_color_brewer(palette = 'Dark2') +
      labs(
        x = 'month',
        y = 'number of profiles',
        col = 'cluster',
        title = paste0(
          'Count of profiles by month and cluster \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$pH_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )

```

Adjusted profiles

```{r cluster_by_month_ext_adj}

if (opt_norm_anomaly) {

  # create figure
  cluster_by_year %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, pH_extreme_order) %>%
    map(
      ~ ggplot(
        data = .x,
        aes(
          x = month,
          y = count_cluster,
          col = cluster,
          group = cluster
        )
      ) +
        geom_point() +
        geom_line() +
        scale_x_continuous(breaks = seq(1, 12, 2)) +
        scale_color_brewer(palette = 'Dark2') +
        labs(
          x = 'month',
          y = 'number of profiles',
          col = 'cluster',
          title = paste0(
            'Count of profiles by month and cluster \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$pH_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )
  
}

```

### Cluster spatial

location of each cluster on map, spatial analysis

```{r spatial_cluster_combined_ext}

# create figure combined
pH_anomaly_cluster_ext %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, pH_extreme_order) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(
                  x = lon,
                  y = lat,
                  fill = cluster
                )) +
      lims(y = c(-85,-30)) +
      scale_fill_brewer(palette = 'Dark2') +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$pH_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )

```

Adjusted profiles

```{r spatial_cluster_combined_ext_adj}

if (opt_norm_anomaly) {

  # create figure combined
  pH_anomaly_cluster_ext %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, pH_extreme_order) %>%
    map(
      ~ map +
        geom_tile(data = .x,
                  aes(
                    x = lon,
                    y = lat,
                    fill = cluster
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_brewer(palette = 'Dark2') +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$pH_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )

}

```

Spatial by cluster
location of each cluster on map, spatial analysis

```{r spatial_cluster_ext, eval=FALSE}

# create figure by cluster
pH_anomaly_cluster_ext %>%
  group_split(profile_type, num_clusters, pH_extreme_order) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(
                  x = lon,
                  y = lat,
                  fill = cluster
                )) +
      lims(y = c(-85,-30)) +
      scale_fill_brewer(palette = 'Dark2') +
      facet_wrap( ~ cluster, ncol = 2) +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$pH_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )

```

### Cluster spatial counts

location of each cluster on map, spatial analysis

```{r spatial_cluster_count_ext}

# Count profiles    
cluster_by_location <- pH_anomaly_cluster_ext %>%
  count(profile_type, num_clusters, pH_extreme_order, pH_extreme, file_id, lat, lon, cluster,
        name = "count_cluster")


# create figure
cluster_by_location %>%
  filter (profile_type == "base") %>%
  group_split(profile_type, num_clusters, pH_extreme_order) %>%
  map(
    ~ map +
      geom_tile(data = .x %>%
                  count(lat, lon, cluster),
                aes(
                  x = lon,
                  y = lat,
                  fill = n
                )) +
      lims(y = c(-85,-30)) +
      scale_fill_gradient(low = "blue",
                          high = "red",
                          trans = "log10") +
      facet_wrap(~ cluster, ncol = 2) +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'profile type: ', unique(.x$profile_type), ', ', 
          'surface extreme: ', unique(.x$pH_extreme), ', ', 
          'number clusters: ', unique(.x$num_clusters)
        )
      )
  )

```

Adjusted profiles

```{r spatial_cluster_count_ext_adj}

if (opt_norm_anomaly) {

  cluster_by_location %>%
    filter (profile_type == "adjusted") %>%
    group_split(profile_type, num_clusters, pH_extreme_order) %>%
    map(
      ~ map +
        geom_tile(data = .x %>%
                    count(lat, lon, cluster),
                  aes(
                    x = lon,
                    y = lat,
                    fill = n
                  )) +
        lims(y = c(-85,-30)) +
        scale_fill_gradient(low = "blue",
                            high = "red",
                            trans = "log10") +
        facet_wrap(~ cluster, ncol = 2) +
        labs(
          title = paste0(
            'cluster spatial distribution \n',
            'profile type: ', unique(.x$profile_type), ', ', 
            'surface extreme: ', unique(.x$pH_extreme), ', ', 
            'number clusters: ', unique(.x$num_clusters)
          )
        )
    )
    
}    
    
```
