---
title: "pH cluster analysis"
author: "David Stappard & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```

# Tasks

This markdown file carries out cluster analysis on previously created pH anomaly profiles.

The cluster_analysis_determine_k chunk is used to give an indication of an appropriate number of clusters and this can then set the option opt_num_clusters. Chunk cluster_analysis_cluster_details carried out the cluster analysis and the results are used in subsequent figures.

```{r loading_libraries, include=FALSE}

library(tidyverse)
library(argodata)
library(lubridate)
library(gridExtra)
library(gsw)
library(ggforce)
library(ggpmisc)
library(tidymodels)

```

## Set directories

location of pre-prepared data

```{r set_updata_root_directory, include=FALSE}

path_argo <- '/nfs/kryo/work/datasets/ungridded/3d/ocean/floats/bgc_argo'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"

```

## Set options

Define options that are used to determine what analysis is done

```{r set_options}

# Options

# opt_analysis_type
# opt_analysis_type = 1 determine number of clusters to use
# opt_analysis_type = 2 do analysis based on identified number of clusters
opt_analysis_type <- 2

# opt_num_clusters
# How many clusters are used in the cluster analysis
opt_num_clusters <- c(7, 7, 7)
# What is the max depth of each profile_range
opt_max_depth <- c(614, 1225, 1600)
# Which profile range is used
opt_profile_range <- 3

# opt_measure
# opt_measure = 1 analysis is done using pH
# opt_measure = 2 analysis is done using h_plus
# opt_measure_label, opt_xlim and opt_xbreaks are associated formatting
opt_measure <- 2
if (opt_measure == 1){
  opt_measure_label <- "pH anomaly"
  opt_xlim <- c(-0.08, 0.08)
  opt_xbreaks <- c(-0.08, -0.04, 0, 0.04, 0.08)
} else {
  opt_measure_label <- expression("[H]"^"+" ~ "anomaly")
  opt_xlim <- c(-2e-9, 2e-9)
  opt_xbreaks <- c(-2e-9, -1e-9, 0, 1e-9, 2e-9)
}
# Chl-a formatting
opt_chla_measure_label <- expression("chlorophyll a ( mg m"^"-3"~")")
opt_chla_xlim <- c(-0.5, 2.0)
opt_chla_xbreaks <- c(-0.5, 0, 0.5, 1.0, 1.5, 2.0)

# oxygen formatting
opt_doxy_measure_label <- expression("dissolved oxygen ( µmol kg"^"-1"~")")
opt_doxy_xlim <- c(50, 350)
opt_doxy_xbreaks <- c(50, 100, 150, 200, 250, 300, 350)

# options relating to cluster analysis
opt_n_start <- 25
opt_max_iterations <- 500
opt_n_clusters <- 14 # Max number of clusters to try when determining optimal number of clusters

```


```{r set_global_theme, include=TRUE}

theme_set(theme_bw())

map <-
  read_rds(paste(path_emlr_utilities,
                 "map_landmask_WOA18.rds",
                 sep = ""))

```

## Cluster analysis

### Preperation

Prepare data for cluster analysis

```{r cluster_analysis_prep}

# read data
pH_anomaly_va <- read_rds(file = paste0(path_argo_preprocessed, "/pH_anomaly_va.rds"))

# select profile based on profile_range and he appropriate max depth
pH_anomaly_va <- pH_anomaly_va %>% 
  filter(profile_range == opt_profile_range & depth <= opt_max_depth[opt_profile_range])

# Select target variable
if (opt_measure == 1) {
  pH_anomaly_va_id <- pH_anomaly_va %>% 
    rename(
      anomaly = anomaly_pH
    )
} else {
  pH_anomaly_va_id <- pH_anomaly_va %>% 
    rename(
      anomaly = anomaly_h_plus
    )
}

pH_anomaly_va_id <- pH_anomaly_va_id %>% 
  select(
    file_id, depth, anomaly,
    year, month, lat, lon
  )

# wide table with each depth becoming a column
pH_anomaly_va_wide <- pH_anomaly_va_id %>%
  select(file_id, depth, anomaly) %>%
  pivot_wider(names_from = depth, values_from = anomaly)


# Drop any rows with missing values N/A caused by gaps in climatology data
pH_anomaly_va_wide <- pH_anomaly_va_wide %>% 
  drop_na()

# profile_id <- pH_anomaly_va_wide %>% select(file_id)

# Table for cluster analysis
# points <- pH_anomaly_va_wide %>%
#   select(-c(file_id))

points <- pH_anomaly_va_wide %>%
  column_to_rownames(var = "file_id")

```

### Number of clusters

```{r cluster_analysis_determine_k}

if (opt_analysis_type == 1) {

  # cluster analysis - What k? try between 1 and opt_n_clusters clusters
  kclusts <- 
  tibble(k = 1:opt_n_clusters) %>%
  mutate(
    kclust = map(k, ~kmeans(points, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
    tidied = map(kclust, tidy),
    glanced = map(kclust, glance),
    augmented = map(kclust, augment, points)
  )
  

  # cluster analysis data
  clusters <-
    kclusts %>%
    unnest(cols = c(tidied))
  
  assignments <-
    kclusts %>%
    unnest(cols = c(augmented))
  
  clusterings <-
    kclusts %>%
    unnest(cols = c(glanced))
  
  # What cluster works best?
  clusterings %>%
  ggplot(aes(k, tot.withinss)) +
    geom_line() +
    geom_point() +
    scale_x_continuous(breaks = c(2, 4, 6, 8, 10, 12, 14))

}

```

### Cluster analysis

```{r cluster_analysis_cluster_details}

if (opt_analysis_type == 2) {

  # caution: set.seed works only for one execution of the clustering
  # How sensitive are our results to the acutal seed?
  set.seed(1)

  kclusts <-
    tibble(k = opt_num_clusters[opt_profile_range]) %>%
    mutate(
      kclust = map(k, ~ kmeans(points, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
      tidied = map(kclust, tidy),
      glanced = map(kclust, glance),
      augmented = map(kclust, augment, points)
    )
  
  profile_id <-
    kclusts %>%
    unnest(cols = c(augmented)) %>%
    select(file_id = .rownames,
           cluster = .cluster) %>% 
    mutate(file_id = as.numeric(file_id),
           cluster = as.character(cluster))
  
  # Add cluster to pH_anomaly_va
  pH_anomaly_cluster <- full_join(pH_anomaly_va_id, profile_id)
  
  # Note the null cluster results relate to the profiles that were removed
  # from pH_anomaly_va_wide by the dron_na() function above.
  pH_anomaly_cluster <- pH_anomaly_cluster %>% 
    filter(!is.na(cluster))
  
  # Plot cluster mean
  anomaly_cluster_mean <- pH_anomaly_cluster %>%
    group_by(cluster, depth) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_cluster_mean_year <- pH_anomaly_cluster %>%
    group_by(cluster, depth, year) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_year_mean <- pH_anomaly_cluster %>%
    group_by(cluster, year) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_year_mean <- anomaly_year_mean %>%
    group_by(year) %>%
    summarise(anomaly_mean = mean(anomaly_mean, na.rm = TRUE)) %>%
    ungroup ()
  
  # create figure
  anomaly_cluster_mean %>%
    ggplot() +
    geom_path(aes(x = anomaly_mean,
                  y = depth)) +
    geom_ribbon(aes(
      xmax = anomaly_mean + anomaly_sd,
      xmin = anomaly_mean - anomaly_sd,
      y = depth
    ),
    alpha = 0.2) +
    geom_vline(xintercept = 0) +
    scale_y_reverse() +
    facet_wrap( ~ cluster) +
    coord_cartesian(xlim = opt_xlim) +
    scale_x_continuous(breaks = opt_xbreaks) +
    labs(
      title = paste0('Overall mean anomaly profiles by cluster'),
      x = opt_measure_label,
      y = 'depth (m)'
    )
}
```
### Cluster mean by year

```{r cluster_mean_year}

if (opt_analysis_type == 2) {

  anomaly_cluster_mean_year %>%
    mutate(year = as.factor(year)) %>%
    ggplot() +
    geom_path(aes(x = anomaly_mean,
                  y = depth,
                  col = year)) +
    geom_vline(xintercept = 0) +
    scale_y_reverse() +
    facet_wrap( ~ cluster) +
    coord_cartesian(xlim = opt_xlim) +
    scale_x_continuous(breaks = opt_xbreaks) +
    scale_color_viridis_d() +
    labs(
      title = paste0('Overall mean anomaly profiles by cluster'),
      x = opt_measure_label,
      y = 'depth (m)'
    )

}

```

### Cluster climatology

```{r cluster_climatology_shift}

# A nice short alternative, uses the package ggpmisc
anomaly_year_mean %>%
  ggplot(aes(x = year,
             y = anomaly_mean)) +
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2","P", "n"))) +
  geom_point()
  
```


### Cluster by year

count of each cluster by year

```{r cluster_by_year}

if (opt_analysis_type == 2) {

  # Determine profile count by cluster and year
  cluster_by_year <- pH_anomaly_cluster %>% 
    count(cluster, year,
          name = "count_cluster")

  year_min <- min(cluster_by_year$year)
  year_max <- max(cluster_by_year$year)
  
  # create figure
  cluster_by_year %>% 
    ggplot(aes(x = year, y = count_cluster, col = cluster, group=cluster))+
    geom_point() +
    geom_line() +
    scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
    scale_color_brewer(palette = 'Dark2')+
    labs(x = 'year', 
         y = 'number of profiles', 
         col = 'cluster',
         title = 'Count of profiles by year and cluster')

}

```

### Cluster by month

count of each cluster by month of year

```{r cluster_by_month}

if (opt_analysis_type == 2) {

  # Determine profile count by cluster and year
  cluster_by_year <- pH_anomaly_cluster %>% 
    count(cluster, month,
          name = "count_cluster")

  # create figure
  cluster_by_year %>% 
    ggplot(aes(x = month, y = count_cluster, col = cluster, group=cluster))+
    geom_point() +
    geom_line() +
    scale_x_continuous(breaks = seq(1, 12, 2)) +
    scale_color_brewer(palette = 'Dark2')+
    labs(x = 'month', 
         y = 'number of profiles', 
         col = 'cluster',
         title = 'Count of profiles by month and cluster')

}

```

### Cluster spatial

location of each cluster on map, spatial analysis

```{r spatial_cluster_01}

if (opt_analysis_type == 2) {

  # create figure
map +
  geom_tile(data = pH_anomaly_cluster, 
            aes(x = lon, 
                y = lat, 
                fill = cluster))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')+
  labs(title = 'cluster spatial distribution')

}
```

location of each cluster on separate maps, spatial analysis

```{r spatial_cluster_02}

if (opt_analysis_type == 2) {

  # create figure
map +
  geom_tile(data = pH_anomaly_cluster,
            aes(x = lon,
                y = lat,
                fill = cluster)) +
  lims(y = c(-85, -30)) +
  scale_fill_brewer(palette = 'Dark2') +
  facet_wrap( ~ cluster, ncol = 2) +
  labs(title = 'cluster spatial distribution')

}
```

count of measurements for each cluster on separate maps, spatial analysis

```{r spatial_cluster_03}

if (opt_analysis_type == 2) {

  # create figure
map +
  geom_tile(data = pH_anomaly_cluster %>% 
              count(lat, lon, cluster),
            aes(x = lon,
                y = lat,
                fill = n)) +
  lims(y = c(-85, -30)) +
  scale_fill_viridis_c(option = "cividis", direction = -1, trans = "log10") +
  facet_wrap( ~ cluster, ncol = 2) +
  labs(title = 'cluster spatial distribution')

}

```

### Cluster spatial year

location of each cluster on map, spatial analysis by year

```{r spatial_cluster_year}

if (opt_analysis_type == 2) {

  # create figure
  pH_anomaly_cluster %>%
    group_split(year) %>%
    map(
      ~ map +
        geom_tile(data = .x,
                  aes(
                    x = lon,
                    y = lat,
                    fill = cluster
                  )) +
        #lims(y = c(-85, -30))+
        scale_fill_brewer(palette = 'Dark2') +
        facet_wrap( ~ cluster, ncol = 2) +
        labs(title = paste0(
          'cluster spatial distribution ', unique(.x$year)
        ))
    )

}

```

### pH and Chl-a

for each cluster identified by pH cluster analysis show  alongside chl-a

```{r ph_with_chla}
if (opt_analysis_type == 2) {
  
  # Read chl-a data and link to cluster ID
  chla_bgc_va <- read_rds(file = paste0(path_argo_preprocessed, "/chla_bgc_va.rds"))
  chla_cluster <- right_join(chla_bgc_va, profile_id)

  # summarise by cluster
  chla_cluster_mean <- chla_cluster %>% 
      group_by(cluster, depth) %>% 
      summarise(chla_mean = mean(chla, na.rm = TRUE),
                chla_sd = sd(chla, na.rm = TRUE)) %>%
      ungroup()

  # join pH anomaly with chl-a
  cluster_ph_chla <- full_join(anomaly_cluster_mean, chla_cluster_mean)
  
  # create figures
  cluster_ph_chla %>% 
    ggplot()+
    geom_path(aes(x = anomaly_mean,
                  y = depth))+
    geom_ribbon(aes(xmax = anomaly_mean + anomaly_sd,
                    xmin = anomaly_mean - anomaly_sd,
                    y = depth),
                alpha = 0.2)+
    geom_vline(xintercept = 0)+
    scale_y_continuous(trans = trans_reverser("sqrt"),
                       breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
    facet_wrap(~cluster)+
    coord_cartesian(xlim = opt_xlim)+
    scale_x_continuous(breaks = opt_xbreaks)+
    labs(title = paste0('Overall mean anomaly profiles by cluster'), x = opt_measure_label, y = 'depth (m)')
    
  cluster_ph_chla %>% 
    ggplot()+
    geom_path(aes(x = chla_mean,
                  y = depth))+
    geom_ribbon(aes(xmax = chla_mean + chla_sd,
                    xmin = chla_mean - chla_sd,
                    y = depth),
                alpha = 0.2)+
    scale_y_continuous(trans = trans_reverser("sqrt"),
                       breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
    facet_wrap(~cluster)+
    coord_cartesian(xlim = opt_chla_xlim)+
    scale_x_continuous(breaks = opt_chla_xbreaks)+
    labs(title = paste0('Overall mean profiles by cluster'), x = opt_chla_measure_label, y = 'depth (m)')


  if (opt_measure == 1){
    chla_to_ph_factor <- 25
    chla_to_ph_offset <- 1
  } else {
    chla_to_ph_factor <- 1e9
    chla_to_ph_offset <- 1
  }
  chla_color <- "#69b3a2"
  
  cluster_ph_chla %>%
    ggplot() +
    geom_path(aes(x = anomaly_mean,
                  y = depth)) +
    geom_ribbon(aes(
      xmax = anomaly_mean + anomaly_sd,
      xmin = anomaly_mean - anomaly_sd,
      y = depth
    ),
    alpha = 0.2) +
    geom_path(aes(
      x = (chla_mean - chla_to_ph_offset) / chla_to_ph_factor,
      y = depth
    ), color = chla_color) +
    geom_ribbon(
      aes(
        xmax = (chla_mean + chla_sd - chla_to_ph_offset) / chla_to_ph_factor,
        xmin = (chla_mean - chla_sd - chla_to_ph_offset) / chla_to_ph_factor,
        y = depth
      ),
      fill = chla_color,
      alpha = 0.2
    ) +
    geom_vline(xintercept = 0) +
    scale_y_continuous(trans = trans_reverser("sqrt"),
                       breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
    facet_wrap( ~ cluster,
                strip.position = "right") +
    coord_cartesian(xlim = opt_xlim) +
    scale_x_continuous(
      # First axis
      name = opt_measure_label,
      breaks = opt_xbreaks,
      # Second axis
      sec.axis = sec_axis(
        trans =  ~ . * chla_to_ph_factor + chla_to_ph_offset,
        name = opt_chla_measure_label
      )
    ) +
    labs(
      title = paste0('Overall mean profiles by cluster'),
      x = opt_measure_label,
      y = 'depth (m)'
    ) +
    theme(axis.title.x.top = element_text(color = chla_color),
          axis.text.x.top = element_text(color = chla_color))

}

```

### pH and oxygen

for each cluster identified by pH cluster analysis show  alongside oxygen

```{r ph_with_oxygen}
if (opt_analysis_type == 2) {
  
  # Read chl-a data and link to cluster ID
  doxy_bgc_va <- read_rds(file = paste0(path_argo_preprocessed, "/doxy_bgc_va.rds"))
  doxy_cluster <- right_join(doxy_bgc_va, profile_id)

  # summarise by cluster
  doxy_cluster_mean <- doxy_cluster %>% 
      group_by(cluster, depth) %>% 
      summarise(doxy_mean = mean(doxy, na.rm = TRUE),
                doxy_sd = sd(doxy, na.rm = TRUE)) %>%
      ungroup()

  # join pH anomaly with chl-a
  cluster_ph_doxy <- full_join(anomaly_cluster_mean, doxy_cluster_mean)
  
  # create figure
  cluster_ph_doxy %>% 
    ggplot()+
    geom_path(aes(x = anomaly_mean,
                  y = depth))+
    geom_ribbon(aes(xmax = anomaly_mean + anomaly_sd,
                    xmin = anomaly_mean - anomaly_sd,
                    y = depth),
                alpha = 0.2)+
    geom_vline(xintercept = 0)+
    scale_y_reverse()+
    facet_wrap(~cluster)+
    coord_cartesian(xlim = opt_xlim)+
    scale_x_continuous(breaks = opt_xbreaks)+
    labs(title = paste0('Overall mean anomaly profiles by cluster'), x = opt_measure_label, y = 'depth (m)')
    
  cluster_ph_doxy %>% 
    ggplot()+
    geom_path(aes(x = doxy_mean,
                  y = depth))+
    geom_ribbon(aes(xmax = doxy_mean + doxy_sd,
                    xmin = doxy_mean - doxy_sd,
                    y = depth),
                alpha = 0.2)+
    scale_y_reverse()+
    facet_wrap(~cluster)+
    coord_cartesian(xlim = opt_doxy_xlim)+
    scale_x_continuous(breaks = opt_doxy_xbreaks)+
    labs(title = paste0('Overall mean profiles by cluster'), x = opt_doxy_measure_label, y = 'depth (m)')


  if (opt_measure == 1){
    doxy_to_ph_factor <- 1875
    doxy_to_ph_offset <- 200
  } else {
    doxy_to_ph_factor <- 75e9
    doxy_to_ph_offset <- 200
  }
  doxy_color <- "#5B9BD5"
  
  cluster_ph_doxy %>%
    ggplot() +
    geom_path(aes(x = anomaly_mean,
                  y = depth)) +
    geom_ribbon(aes(
      xmax = anomaly_mean + anomaly_sd,
      xmin = anomaly_mean - anomaly_sd,
      y = depth
    ),
    alpha = 0.2) +
    geom_path(aes(
      x = (doxy_mean - doxy_to_ph_offset)  / doxy_to_ph_factor,
      y = depth
    ), color = doxy_color) +
    geom_ribbon(
      aes(
        xmax = (doxy_mean + doxy_sd - doxy_to_ph_offset) / doxy_to_ph_factor,
        xmin = (doxy_mean - doxy_sd - doxy_to_ph_offset) / doxy_to_ph_factor,
        y = depth
      ),
      fill = doxy_color,
      alpha = 0.2
    ) +
    geom_vline(xintercept = 0) +
    scale_y_reverse() +
    facet_wrap( ~ cluster,
                strip.position = "right") +
    coord_cartesian(xlim = opt_xlim) +
    scale_x_continuous(
      # First axis
      name = opt_measure_label,
      breaks = opt_xbreaks,
      # First axis
      sec.axis = sec_axis(
        trans =  ~ . * doxy_to_ph_factor + doxy_to_ph_offset,
        name = opt_doxy_measure_label
      )
    ) +
    labs(
      title = paste0('Overall mean profiles by cluster'),
      x = opt_measure_label,
      y = 'depth (m)'
    ) +
    theme(axis.title.x.top = element_text(color = doxy_color),
          axis.text.x.top = element_text(color = doxy_color))
  
}

```

## Cluster by surface Extreme

```{r cluster_analysis_prep_ext}

# Carried out for 1600m profiles
opt_profile_range = 3
extreme_type <- c('L', 'N', 'H')
num_clusters <- c(5, 6, 5)

# ---------------------------------------------------------------------------------------------
# read data
# ---------------------------------------------------------------------------------------------
# load previously created OceanSODA extreme data. date, position and nature of extreme
pH_extreme <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA_pH_anomaly_field.rds")) %>%
  select(lon, lat, date, ph_extreme)

# read data
pH_anomaly_va <- read_rds(file = paste0(path_argo_preprocessed, "/pH_anomaly_va.rds")) %>%
  mutate(date = ymd(format(date, "%Y-%m-15")))

# Add the OceanSODA extreme condition
pH_anomaly_va <- left_join(pH_anomaly_va, pH_extreme)

# Select target variable
if (opt_measure == 1) {
  pH_anomaly_va <- pH_anomaly_va %>% 
    rename(
      anomaly = anomaly_pH
    )
} else {
  pH_anomaly_va <- pH_anomaly_va %>% 
    rename(
      anomaly = anomaly_h_plus
    )
}

for (i in 1:3) {

  # ---------------------------------------------------------------------------------------------
  # Preparation
  # ---------------------------------------------------------------------------------------------
  # select profile based on profile_range and he appropriate max depth
  pH_anomaly_va_id <- pH_anomaly_va %>% 
    filter(profile_range == opt_profile_range & depth <= opt_max_depth[opt_profile_range] & ph_extreme == extreme_type[i])

  # Simplified table ready to pivot
  pH_anomaly_va_id <- pH_anomaly_va_id %>%
    select(file_id,
           depth,
           anomaly,
           year, 
           month, 
           lat, 
           lon)
  
  # wide table with each depth becoming a column
  pH_anomaly_va_wide <- pH_anomaly_va_id %>%
    select(file_id, depth, anomaly) %>%
    pivot_wider(names_from = depth, values_from = anomaly)
  
  # Drop any rows with missing values N/A caused by gaps in climatology data
  pH_anomaly_va_wide <- pH_anomaly_va_wide %>% 
    drop_na()
  
  # Table for cluster analysis
  points <- pH_anomaly_va_wide %>%
    column_to_rownames(var = "file_id")
  
  # ---------------------------------------------------------------------------------------------
  # cluster analysis
  # ---------------------------------------------------------------------------------------------
  set.seed(1)
  kclusts <-
    tibble(k = num_clusters[i]) %>%
    mutate(
      kclust = map(k, ~ kmeans(points, .x, iter.max = opt_max_iterations, nstart = opt_n_start)),
      tidied = map(kclust, tidy),
      glanced = map(kclust, glance),
      augmented = map(kclust, augment, points)
    )
  
  profile_id <-
    kclusts %>%
    unnest(cols = c(augmented)) %>%
    select(file_id = .rownames,
           cluster = .cluster) %>% 
    mutate(file_id = as.numeric(file_id),
           cluster = as.character(cluster))
  
  # Add cluster to pH_anomaly_va
  pH_anomaly_cluster <- full_join(pH_anomaly_va, profile_id)
  
  # Plot cluster mean
  pH_anomaly_cluster <- pH_anomaly_cluster %>% 
    filter(!is.na(cluster))
  
  # Plot cluster mean
  anomaly_cluster_mean <- pH_anomaly_cluster %>%
    group_by(cluster, depth) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_cluster_mean_year <- pH_anomaly_cluster %>%
    group_by(cluster, depth, year) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_year_mean <- pH_anomaly_cluster %>%
    group_by(cluster, year) %>%
    summarise(
      count_cluster = n(),
      anomaly_mean = mean(anomaly, na.rm = TRUE),
      anomaly_sd = sd(anomaly, na.rm = TRUE)
    ) %>%
    ungroup()
  
  anomaly_year_mean <- anomaly_year_mean %>%
    group_by(year) %>%
    summarise(anomaly_mean = mean(anomaly_mean, na.rm = TRUE)) %>%
    ungroup ()
  
  if (i == 1) {
    anomaly_cluster_mean_ext <- anomaly_cluster_mean %>% mutate(pH_extreme_order = i, pH_extreme = extreme_type[i])
    anomaly_cluster_mean_year_ext <- anomaly_cluster_mean_year %>% mutate(pH_extreme_order = i, pH_extreme = extreme_type[i])
    anomaly_year_mean_ext <- anomaly_year_mean %>% mutate(pH_extreme_order = i, pH_extreme = extreme_type[i])
    pH_anomaly_cluster_ext <- pH_anomaly_cluster %>% mutate(pH_extreme_order = i, pH_extreme = extreme_type[i])
  } else {
    anomaly_cluster_mean_ext <- rbind(anomaly_cluster_mean_ext, anomaly_cluster_mean %>% mutate(pH_extreme_order = i, pH_extreme = extreme_type[i]))
    anomaly_cluster_mean_year_ext <- rbind(anomaly_cluster_mean_year_ext, anomaly_cluster_mean_year %>% mutate(pH_extreme_order = i, pH_extreme = extreme_type[i]))
    anomaly_year_mean_ext <- rbind(anomaly_year_mean_ext, anomaly_year_mean %>% mutate(pH_extreme_order = i, pH_extreme = extreme_type[i]))
    pH_anomaly_cluster_ext <- rbind(pH_anomaly_cluster_ext, pH_anomaly_cluster_ext <- pH_anomaly_cluster %>% mutate(pH_extreme_order = i, pH_extreme = extreme_type[i]))
  }

}

```

### Cluster mean

```{r cluster_mean_extreme}

# create figure of mean clusters
anomaly_cluster_mean_ext %>%
  group_split(pH_extreme_order) %>%
  map(
    ~  ggplot(data = .x, ) +
      geom_path(aes(x = anomaly_mean,
                    y = depth)) +
      geom_ribbon(
        aes(
          xmax = anomaly_mean + anomaly_sd,
          xmin = anomaly_mean - anomaly_sd,
          y = depth
        ),
        alpha = 0.2
      ) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap(~ cluster) +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(breaks = opt_xbreaks) +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster \n',
          'Surface extreme: ',
          unique(.x$pH_extreme),
          ' pH'
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      )
  )


```

### Clusters mean by year

```{r cluster_mean_extreme_year}

# cluster means by year
anomaly_cluster_mean_year_ext %>%
  mutate(year = as.factor(year)) %>%
  group_split(pH_extreme_order) %>%
  map(
    ~  ggplot(data = .x,) +
      geom_path(aes(
        x = anomaly_mean,
        y = depth,
        col = year
      )) +
      geom_vline(xintercept = 0) +
      scale_y_reverse() +
      facet_wrap(~ cluster) +
      coord_cartesian(xlim = opt_xlim) +
      scale_x_continuous(breaks = opt_xbreaks) +
      scale_color_viridis_d() +
      labs(
        title = paste0(
          'Overall mean anomaly profiles by cluster by year \n',
          'Surface extreme: ',
          unique(.x$pH_extreme),
          ' pH'
        ),
        x = opt_measure_label,
        y = 'depth (m)'
      )
  )

```

### Cluster by year

count of each cluster by year

```{r cluster_ext_by_year}

# Determine profile count by extreme and cluster and year
# Count the measurements
cluster_by_year <- pH_anomaly_cluster_ext %>% 
  count(file_id, pH_extreme_order, pH_extreme, cluster, year,
        name = "count_cluster")
# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(pH_extreme_order, pH_extreme, cluster, year,
        name = "count_cluster")

year_min <- min(cluster_by_year$year)
year_max <- max(cluster_by_year$year)

# create figure
cluster_by_year %>%
  group_split(pH_extreme_order) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = year,
        y = count_cluster,
        col = cluster,
        group = cluster
      )
    ) +
      geom_point() +
      geom_line() +
      scale_x_continuous(breaks = seq(year_min, year_max, 2)) +
      scale_color_brewer(palette = 'Dark2') +
      labs(
        x = 'year',
        y = 'number of profiles',
        col = 'cluster',
        title = paste0(
          'Count of profiles by year and cluster \n',
          'Surface extreme: ',
          unique(.x$pH_extreme),
          ' pH'
        )
      )
  )

```

### Cluster by month

count of each cluster by month of year

```{r cluster_ext_by_month}

# Determine profile count by cluster and year
# Count the measurements
cluster_by_year <- pH_anomaly_cluster_ext %>% 
  count(file_id, pH_extreme_order, pH_extreme, cluster, month,
        name = "count_cluster")
# Convert to profiles
cluster_by_year <- cluster_by_year %>% 
  count(pH_extreme_order, pH_extreme, cluster, month,
        name = "count_cluster")

# create figure
cluster_by_year %>%
  group_split(pH_extreme_order) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = month,
        y = count_cluster,
        col = cluster,
        group = cluster
      )
    ) +
      geom_point() +
      geom_line() +
      scale_x_continuous(breaks = seq(1, 12, 2)) +
      scale_color_brewer(palette = 'Dark2') +
      labs(
        x = 'month',
        y = 'number of profiles',
        col = 'cluster',
        title = paste0(
          'Count of profiles by month and cluster \n',
          'Surface extreme: ',
          unique(.x$pH_extreme),
          ' pH'
        )
      )
  )


```

### Cluster spatial

location of each cluster on map, spatial analysis

```{r spatial_cluster_combined}

# create figure combined
pH_anomaly_cluster_ext %>%
  group_split(pH_extreme_order) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(
                  x = lon,
                  y = lat,
                  fill = cluster
                )) +
      lims(y = c(-85,-30)) +
      scale_fill_brewer(palette = 'Dark2') +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'Surface extreme: ',
          unique(.x$pH_extreme),
          ' pH'
        )
      )
  )

```

### Spatial by cluster

location of each cluster on map, spatial analysis

```{r spatial_cluster_ext_01}

# create figure by cluster
pH_anomaly_cluster_ext %>%
  group_split(pH_extreme_order) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(
                  x = lon,
                  y = lat,
                  fill = cluster
                )) +
      lims(y = c(-85,-30)) +
      scale_fill_brewer(palette = 'Dark2') +
      facet_wrap( ~ cluster, ncol = 2) +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'Surface extreme: ',
          unique(.x$pH_extreme),
          ' pH'
        )
      )
  )

```

### Spatial count

location of each cluster on map, spatial analysis

```{r spatial_cluster_ext_02}

# create figure
pH_anomaly_cluster_ext %>%
  group_split(pH_extreme_order) %>%
  map(
    ~ map +
      geom_tile(data = .x %>%
                  count(lat, lon, cluster),
                aes(
                  x = lon,
                  y = lat,
                  fill = n
                )) +
      lims(y = c(-85,-30)) +
      scale_fill_viridis_c(
        option = "cividis",
        direction = -1,
        trans = "log10"
      ) +
      facet_wrap(~ cluster, ncol = 2) +
      labs(
        title = paste0(
          'cluster spatial distribution \n',
          'Surface extreme: ',
          unique(.x$pH_extreme),
          ' pH'
        )
      )
  )

```

