---
title: "Extreme pH Profiles"
author: "Pasqualina Vonlanthen & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Task

Compare depth profiles of normal pH and of extreme pH, as identified in the surface OceanSODA pH data product

```{r load_libraries, include=FALSE}
library(tidyverse)
library(lubridate)
library(ggOceanMaps)
```

```{r set_global_theme}

theme_set(theme_bw())
HNL_colors <- c("H" = "#b2182b",
                "N" = "#636363",
                "L" = "#2166ac")

```

# Load data

```{r set_root_directories}
path_argo <- '/nfs/kryo/work/updata/bgc_argo_r_argodata'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")
path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"
```

```{r load_data}

# RECCAP2-ocean region mask
region_masks_all_1x1 <- read_rds(file = paste0(path_argo_preprocessed,
                                               "/region_masks_all_1x1.rds"))

region_masks_all_1x1 <- region_masks_all_1x1 %>%
  rename(biome = value) %>% 
  filter(region == 'southern',
         biome != 0) %>% 
  select(-region) %>% 
  mutate(coast = as.character(coast))

# WOA 18 basin mask

basinmask <-
  read_csv(
    paste(path_emlr_utilities,
          "basin_mask_WOA18.csv",
          sep = ""),
    col_types = cols("MLR_basins" = col_character())
  )

basinmask <- basinmask %>%
  filter(MLR_basins == unique(basinmask$MLR_basins)[1]) %>%
  select(lon, lat, basin_AIP)


# OceanSODA
OceanSODA <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA.rds"))

OceanSODA <- OceanSODA %>%
  mutate(month = month(date))

# load in the full argo data
full_argo <- read_rds(file = paste0(path_argo_preprocessed, "/bgc_merge_pH_qc_1.rds"))

# change the date format for compatibility with OceanSODA pH data
full_argo <- full_argo %>%
  mutate(year = year(date),
         month = month(date)) %>%
  mutate(date = ymd(format(date, "%Y-%m-15")))

```

# Regions

## Biomes

```{r biomes_map}

basemap(limits = -32) +
  geom_spatial_tile(
    data = region_masks_all_1x1,
    aes(x = lon,
        y = lat,
        fill = biome),
    col = 'transparent'
  ) +
  scale_fill_brewer(palette = "Dark2")

```

## Coast

```{r coast_map}

basemap(limits = -32) +
  geom_spatial_tile(
    data = region_masks_all_1x1,
    aes(x = lon,
        y = lat,
        fill = coast),
    col = 'transparent'
  ) +
  scale_fill_brewer(palette = "Dark2")


```

## Apply region masks

```{r remove_coastal_regions}

region_masks_all_1x1 <- region_masks_all_1x1 %>% 
  filter(coast == "0")

```


```{r apply_region_masks}

# keep only Southern Ocean data
OceanSODA_SO <- inner_join(region_masks_all_1x1, OceanSODA)

# add in basin separations
OceanSODA_SO <- inner_join(OceanSODA_SO, basinmask)

# keep only Southern Ocean argo data
full_argo_SO <- inner_join(full_argo, region_masks_all_1x1)

# add in basin separations
full_argo_SO <- inner_join(full_argo_SO, basinmask)

```


# OceanSODA pH anomalies

## Grid level

### Climatological thresholds

Climatological monthly OceanSODA pH and the 5th and 95th percentiles, calculated for 2013-2021, with the full spatial OceanSODA data

```{r calculate_clim_OceanSODA_pH_grid}

# calculate climatological average OceanSODA pH
# and the 95th percentile of the monthly OceanSODA pH

OceanSODA_SO_clim_grid <- OceanSODA_SO %>%
  group_by(lon, lat, month) %>%
  summarise(
    ph_N = mean(ph_total, na.rm = TRUE),
    ph_H = quantile(ph_total, 0.95, na.rm = TRUE),
    ph_L = quantile(ph_total, 0.05, na.rm = TRUE)
  ) %>%
  ungroup()

OceanSODA_SO_extreme_grid <- inner_join(OceanSODA_SO, OceanSODA_SO_clim_grid)

```

### Anomaly identification

Calculate OceanSODA pH anomalies:
L for abnormally low,
H for abnormally high,
N for normal pH

```{r calculate_extreme_OceanSODA_pH_grid}

# when the in-situ OceanSODA pH is lower than the 5th percentile, assign 'L' for low extreme
# when the in-situ OceanSODA pH exceeds the 95th percentile, assign 'H' for high extreme
# when the in-situ OceanSODA pH is within 95% of the range, then assign 'N' for normal pH
OceanSODA_SO_extreme_grid <- OceanSODA_SO_extreme_grid %>%
  mutate(
    ph_extreme = case_when(
      ph_total < ph_L ~ 'L',
      ph_total > ph_H ~ 'H',
      TRUE ~ 'N'
    )
  ) %>%
  drop_na()

OceanSODA_SO_extreme_grid <- OceanSODA_SO_extreme_grid %>%
  mutate(ph_extreme = fct_relevel(ph_extreme, "H", "N", "L"))

```

```{r anomaly_test_plot_grid, fig.asp=0.5}

OceanSODA_SO_extreme_grid %>%
  group_split(lon, lat, month) %>%
  head(6) %>%
  map(~ ggplot(data = .x) +
        geom_hline(aes(yintercept = ph_H), linetype = 2) +
        geom_hline(aes(yintercept = ph_L), linetype = 2) +
        geom_hline(aes(yintercept = ph_N)) +
        geom_point(
          aes(x = year, y = ph_total, col = ph_extreme)) +
        labs(title = paste(
          "lon:", unique(.x$lon),
          "| lat:", unique(.x$lat),
          "| month:", unique(.x$month)
          )) +
        scale_color_manual(values = HNL_colors))

```

### Anomaly maps

Location of OceanSODA pH extremes

```{r map_OceanSODA_ph_extremes_grid, fig.asp=2}

OceanSODA_SO_extreme_grid %>% 
  group_split(year) %>% 
  # head(1) %>%
  map(
    ~ basemap(limits = -32, data = .x)+
      geom_spatial_tile(data = .x,
                        aes(x = lon,
                            y = lat,
                            fill = ph_extreme),
                        linejoin = 'mitre',
                        col = 'transparent',
                        detail = 60
                        ) +
      scale_fill_manual(values = HNL_colors) +
      facet_wrap(~month, ncol = 2)+
      labs(title = paste("Year:", unique(.x$year)),
           fill = 'pH')
  )

```

### Anomaly time series

```{r extreme_pH_timeseries_grid}
# calculate a regional mean pH for each biome, basin, and ph extreme (H/L/N) and plot a timeseries 

OceanSODA_SO_extreme_grid %>% 
  group_by(date, biome, basin_AIP, ph_extreme) %>% 
  summarise(ph_regional = mean(ph_total, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = date, y = ph_regional, col = ph_extreme))+
  geom_point(size = 0.3)+
  geom_line()+
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP~biome)+
  labs(x = 'date',
       y = 'regional mean pH',
       col = 'pH anomaly') +
  theme(legend.position = 'bottom')

```

### Anomaly histogram

```{r extreme_pH_histogram_grid}

OceanSODA_SO_extreme_grid %>%
  ggplot(aes(ph_total, col = ph_extreme)) +
  geom_density() +
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP ~ biome) +
  coord_cartesian(xlim = c(8, 8.2)) +
  labs(x = 'date',
       y = 'regional mean pH',
       col = 'pH anomaly') +
  theme(legend.position = 'bottom')

```

### Threshold histogram

```{r threshold_pH_histogram_grid}

OceanSODA_SO_clim_grid %>%
  pivot_longer(starts_with("ph_"),
               names_to = "level",
               values_to = "value",
               names_prefix = "ph_") %>% 
  ggplot(aes(value, col = level)) +
  geom_density() +
  scale_color_manual(values = HNL_colors, name = "threshold") +
  coord_cartesian(xlim = c(8, 8.2)) +
  theme(legend.position = 'bottom')

```

## Biome level

### Climatological thresholds

Climatological monthly OceanSODA pH and the 5th and 95th percentiles, calculated for 2013-2021, with the full spatial OceanSODA data

```{r calculate_clim_OceanSODA_pH_biome}

# calculate climatological average OceanSODA pH
# and the 95th percentile of the monthly OceanSODA pH

OceanSODA_SO_clim_biome <- OceanSODA_SO %>%
  group_by(biome, basin_AIP, month) %>%
  summarise(
    ph_N = mean(ph_total, na.rm = TRUE),
    ph_H = quantile(ph_total, 0.95, na.rm = TRUE),
    ph_L = quantile(ph_total, 0.05, na.rm = TRUE)
  ) %>%
  ungroup()

OceanSODA_SO_extreme_biome <- inner_join(OceanSODA_SO, OceanSODA_SO_clim_biome)

```

### Anomaly identification

Calculate OceanSODA pH anomalies:
L for abnormally low,
H for abnormally high,
N for normal pH

```{r calculate_extreme_OceanSODA_pH_biome}

# when the in-situ OceanSODA pH is lower than the 5th percentile, assign 'L' for low extreme
# when the in-situ OceanSODA pH exceeds the 95th percentile, assign 'H' for high extreme
# when the in-situ OceanSODA pH is within 95% of the range, then assign 'N' for normal pH
OceanSODA_SO_extreme_biome <- OceanSODA_SO_extreme_biome %>%
  mutate(
    ph_extreme = case_when(
      ph_total < ph_L ~ 'L',
      ph_total > ph_H ~ 'H',
      TRUE ~ 'N'
    )
  ) %>%
  drop_na()

OceanSODA_SO_extreme_biome <- OceanSODA_SO_extreme_biome %>%
  mutate(ph_extreme = fct_relevel(ph_extreme, "H", "N", "L"))

```

```{r anomaly_test_plot_biome, fig.asp=0.5}

OceanSODA_SO_extreme_biome %>%
  group_split(biome, basin_AIP, month) %>%
  head(6) %>%
  map(~ ggplot(data = .x) +
        geom_hline(aes(yintercept = ph_H), linetype = 2) +
        geom_hline(aes(yintercept = ph_L), linetype = 2) +
        geom_hline(aes(yintercept = ph_N)) +
        geom_point(
          aes(x = year, y = ph_total, col = ph_extreme)) +
        labs(title = paste(
          "lon:", unique(.x$biome),
          "| lat:", unique(.x$basin_AIP),
          "| month:", unique(.x$month)
          )) +
        scale_color_manual(values = HNL_colors))

```

### Anomaly maps

Location of OceanSODA pH extremes

```{r map_OceanSODA_ph_extremes_biome, fig.asp=2}

OceanSODA_SO_extreme_biome %>% 
  group_split(year) %>% 
  # head(1) %>%
  map(
    ~ basemap(limits = -32, data = .x)+
      geom_spatial_tile(data = .x,
                        aes(x = lon,
                            y = lat,
                            fill = ph_extreme),
                        linejoin = 'mitre',
                        col = 'transparent',
                        detail = 60
                        ) +
      scale_fill_manual(values = HNL_colors) +
      facet_wrap(~month, ncol = 2)+
      labs(title = paste("Year:", unique(.x$year)),
           fill = 'pH')
  )

```

### Anomaly time series

```{r extreme_pH_timeseries_biome}
# calculate a regional mean pH for each biome, basin, and ph extreme (H/L/N) and plot a timeseries 

OceanSODA_SO_extreme_biome %>% 
  group_by(date, biome, basin_AIP, ph_extreme) %>% 
  summarise(ph_regional = mean(ph_total, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = date, y = ph_regional, col = ph_extreme))+
  geom_point(size = 0.3)+
  geom_line()+
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP~biome)+
  labs(x = 'date',
       y = 'regional mean pH',
       col = 'pH anomaly') +
  theme(legend.position = 'bottom')

```

### Anomaly histogram

```{r extreme_pH_histogram_biome}

OceanSODA_SO_extreme_biome %>%
  ggplot(aes(ph_total, col = ph_extreme)) +
  geom_density() +
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP ~ biome) +
  coord_cartesian(xlim = c(8, 8.2)) +
  labs(x = 'date',
       y = 'regional mean pH',
       col = 'pH anomaly') +
  theme(legend.position = 'bottom')

```

### Threshold histogram

```{r threshold_pH_histogram_biome}

OceanSODA_SO_clim_biome %>%
  pivot_longer(starts_with("ph_"),
               names_to = "level",
               values_to = "value",
               names_prefix = "ph_") %>% 
  ggplot(aes(value, col = level)) +
  geom_density() +
  scale_color_manual(values = HNL_colors, name = "threshold") +
  coord_cartesian(xlim = c(8, 8.2)) +
  theme(legend.position = 'bottom')

```

# Argo

## Join OceanSODA

```{r combine_extreme_OceanSODA_to_Argo}

# rename OceanSODA columns
OceanSODA_SO_extreme <- OceanSODA_SO_extreme_biome %>%
  rename(OceanSODA_ph_uncert = ph_total_uncert,
         OceanSODA_ph = ph_total)

# combine the argo profile data to the surface extreme data
profile_extreme <- inner_join(full_argo_SO, OceanSODA_SO_extreme)

```

# Plot profiles

Argo profiles plotted according to the surface OceanSODA pH

L profiles correspond to a surface acidification event (low pH), as recorded in OceanSODA

H profiles correspond to an event of high surface pH, as recorded in OceanSODA

N profiles correspond to normal surface OceanSODA pH

## pH

```{r pH_profiles}

profile_extreme %>%
  group_split(biome, basin_AIP, year) %>%
  # head(1) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = ph_in_situ_total_adjusted,
        y = depth,
        group = ph_extreme,
        col = ph_extreme
      )
    ) +
      geom_point(pch = 19, size = 0.5) +
      scale_y_reverse() +
      scale_color_manual(values = HNL_colors) +
      facet_wrap( ~ month, ncol = 6) +
      labs(
        x = 'Argo pH (total scale)',
        y = 'depth (m)',
        title = paste(
          unique(.x$basin_AIP),
          "|",
          unique(.x$year),
          "| biome:",
          unique(.x$biome)
        ),
        col = 'OceanSODA pH \nanomaly'
      )
  )

```

## Temperature

```{r temp_profiles}

# plot temperature profiles for the Atlantic
profile_extreme %>%
  group_split(biome, basin_AIP, year) %>%
  # head(1) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = temp_adjusted,
        y = depth,
        group = ph_extreme,
        col = ph_extreme
      )
    ) +
      geom_point(pch = 19, size = 0.5) +
      scale_y_reverse() +
      scale_color_manual(values = HNL_colors) +
      facet_wrap( ~ month, ncol = 6) +
      labs(
        x = 'Argo temperature (°C)',
        y = 'depth (m)',
        title = paste(
          unique(.x$basin_AIP),
          "|",
          unique(.x$year),
          "| biome:",
          unique(.x$biome)
        ),
        col = 'OceanSODA\npH\nanomaly'
      )
  )
```

# Plot monthly profiles

```{r calculate_mean_profiles}
# calculate mean profiles in each basin and biome, for each month between 2014 and 2021 

profile_extreme_monthly <- profile_extreme %>% 
  mutate(depth = cut(depth, seq(0,2000,10), seq(5,2000,10)),
         depth = as.numeric(as.character(depth))) %>%
  group_by(month, biome, basin_AIP, ph_extreme, depth) %>% 
  summarise(ph_mean = mean(ph_in_situ_total_adjusted, na.rm = TRUE),
            temp_mean = mean(temp_adjusted, na.rm = TRUE)) %>% 
  ungroup()

```

## pH

```{r mean_monthly_profiles_pH, fig.asp=1}

profile_extreme_monthly %>%
  arrange(depth) %>% 
  group_split(month) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(
               x = ph_mean,
               y = depth,
               group = ph_extreme,
               col = ph_extreme
             )) +
      geom_path() +
      scale_color_manual(values = HNL_colors) +
      labs(title = paste("month:", unique(.x$month)),
           col = 'OceanSODA\npH\nanomaly') +
      scale_y_reverse() +
      facet_grid(basin_AIP ~ biome)
  )


```
