---
title: "Extreme pH Profiles"
author: "Pasqualina Vonlanthen, David Stappard & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Task

Compare depth profiles of normal pH and of extreme pH, as identified in the surface OceanSODA pH data product.
BGC pH profiles have already been validate for coverage and aligned to climatology depths.

```{r load_libraries, include=FALSE}
library(tidyverse)
library(lubridate)
library(broom)
library(ggOceanMaps)
library(scico)
library(metR)
library(ggforce)
library(ggrepel)
library(ggnewscale)
```

```{r set_global_theme}

theme_set(theme_bw())
HNL_colors <- c("H" = "#b2182b",
                "N" = "#636363",
                "L" = "#2166ac")

HNL_colors_map <- c('H' = 'red3',
                    'N' = 'transparent',
                    'L' = 'blue3')

# opt_min_profile_range
# profiles with profile_range >= opt_min_profile_range will be selected 1 = profiles of at least 614m, 2 = profiles of at least 1225m, 3 = profiles of at least 1600m
opt_min_profile_range = 3

# opt_extreme_determination
# 1 - based on the trend of de-seasonal data - we believe this results in more summer extremes where variation tend to be greater.
# 2 - based on the trend of de-seasonal data by month. grouping is by lat, lon and month.
opt_extreme_determination <- 2

```

# Load data

```{r set_root_directories}
path_argo <- '/nfs/kryo/work/updata/bgc_argo_r_argodata'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")
path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"

path_argo <- '/nfs/kryo/work/datasets/ungridded/3d/ocean/floats/bgc_argo'
# /nfs/kryo/work/datasets/ungridded/3d/ocean/floats/bgc_argo/preprocessed_bgc_data
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")

```

```{r load_data}

# load in new Mayot biomes 

nm_biomes <- read_rds(file = paste0(path_argo_preprocessed, "/nm_biomes.rds"))

# WOA 18 basin mask

basinmask <-
  read_csv(
    paste(path_emlr_utilities,
          "basin_mask_WOA18.csv",
          sep = ""),
    col_types = cols("MLR_basins" = col_character())
  )

basinmask <- basinmask %>%
  filter(MLR_basins == unique(basinmask$MLR_basins)[1]) %>% 
  select(-c(MLR_basins, basin))

# OceanSODA
OceanSODA <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA.rds"))

OceanSODA <- OceanSODA %>%
  mutate(year = year(date),
         month = month(date))

# load validated and vertically aligned pH profiles, 
full_argo <-
  read_rds(file = paste0(path_argo_preprocessed, "/pH_bgc_va.rds")) %>%
  filter(profile_range >= opt_min_profile_range) %>%
  mutate(date = ymd(format(date, "%Y-%m-15")))

# map data
map <-
  read_rds(paste(path_emlr_utilities,
                 "map_landmask_WOA18.rds",
                 sep = ""))
```

# Regions

## Biome grid reduction

```{r biomes_flat_map_pre_grid_reduction, fig.asp=0.4}

map +
  geom_tile(data = nm_biomes, 
            aes(x = lon, 
                y = lat, 
                fill = biome_name))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')+
  labs(title = 'Mayot biomes pre-grid reduction')

```

```{r grid_reduction_to_true_2x2_region_mask}

# Commented
# nm_biomes_2x2 <- nm_biomes %>% 
#   mutate(lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
#          lon = as.numeric(as.character(lon)),
#          lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
#          lat = as.numeric(as.character(lat)))
# 
# nm_biomes_2x2 <- nm_biomes_2x2 %>% 
#   count(lon, lat, biome_name) %>% 
#   group_by(lon, lat) %>% 
#   slice_max(n, with_ties = FALSE) %>% 
#   ungroup()

# New
nm_biomes <- nm_biomes %>% 
  count(lon, lat, biome_name) %>% 
  group_by(lon, lat) %>% 
  slice_max(n, with_ties = FALSE) %>% 
  ungroup()

# Commented
#rm(nm_biomes)

```

```{r biomes_flat_map_post_grid_reduction, fig.asp=0.4}

# map+
#   geom_tile(data = nm_biomes_2x2,
#             aes(x = lon,
#                 y = lat,
#                 fill = biome_name))+
#   lims(y = c(-85, -30))+
#   scale_fill_brewer(palette = 'Dark2')+
#   labs(title = 'Mayot biomes post-grid reduction')

```

## Basin grid reduction

```{r filter_southern_ocean_basins}

# basinmask <- basinmask %>%
#  filter(lat < -30)

```

```{r basin_flat_map_pre_grid_reduction, fig.asp=1}
map +
  geom_tile(data = basinmask, 
            aes(x = lon, 
                y = lat, 
                fill = basin_AIP))+
  scale_fill_brewer(palette = 'Dark2')

```

```{r grid_reduction_to_true_2x2_basinmask}

# Commented
# basinmask_2x2 <- basinmask %>%
#   mutate(
#     lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
#     lat = as.numeric(as.character(lat)),
#     lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
#     lon = as.numeric(as.character(lon))
#    )
# 
# # assign basins from each pixel to to each 2 Lon x Lat pixel, based on the majority of basins in each 2x2 grid
# 
# basinmask_2x2 <- basinmask_2x2 %>%
#   count(lon, lat, basin_AIP) %>%
#   group_by(lon, lat) %>%
#   slice_max(n, with_ties = FALSE) %>%
#   ungroup() %>%
#   select(-n)

# Added
basinmask <- basinmask %>%
  count(lon, lat, basin_AIP) %>%
  group_by(lon, lat) %>%
  slice_max(n, with_ties = FALSE) %>%
  ungroup() %>%
  select(-n)

# commented
#rm(basinmask)

```

```{r basin_flat_map_post_grid_reduction, fig.asp=0.4}

# map+
#   geom_tile(data = basinmask_2x2 %>% filter(lat < -30),
#             aes(x = lon,
#                 y = lat,
#                 fill = basin_AIP))+
#   lims(y = c(-85, -30))+
#   scale_fill_brewer(palette = 'Dark2')


```

# OceanSODA

## Monthly clim surface pH

```{r calculate_monthly_clim_surface_pH_OceanSODA}

OceanSODA <- OceanSODA %>% 
  group_by(lon, lat, month) %>% 
  mutate(clim_ph = mean(ph_total, na.rm = TRUE),
         clim_diff = ph_total - clim_ph,
         .after = ph_total) %>% 
  ungroup()
```

## Grid reduction

```{r grid_reduction_to_2x2_OceanSODA}

# Note: While reducing lon x lat grid,
# we keep the original number of observations

# OceanSODA_2x2 <- OceanSODA %>%
#   mutate(
#     lat_raw = lat,
#     lon_raw = lon,
#     lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
#     lat = as.numeric(as.character(lat)),
#     lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
#     lon = as.numeric(as.character(lon))) # regrid into 2x2º grid

OceanSODA <- OceanSODA %>%
  mutate(
    lat_raw = lat,
    lon_raw = lon)

# rm(OceanSODA)

```

## Apply region masks

```{r apply_region_masks_OceanSODA}

# # keep only Southern Ocean data
# OceanSODA_2x2_SO <- inner_join(OceanSODA_2x2, nm_biomes_2x2)
# 
# # add in basin separations
# OceanSODA_2x2_SO <- inner_join(OceanSODA_2x2_SO, basinmask_2x2)
# # expected number of rows from -30 to -70º latitude, 360º longitude, for 12 months, 8 years:
# # 40 lat x 360 lon x 12 months x 8 years = 1 382 400 rows 
# # actual number of rows: 919 768
# 
# OceanSODA_2x2_SO <- OceanSODA_2x2_SO %>% 
#   filter(!is.na(ph_total))

## keep only Southern Ocean data
# OceanSODA_SO <- inner_join(OceanSODA, nm_biomes %>% 
#                                       select(-n)) 

# add in basin separations
OceanSODA <- inner_join(OceanSODA, basinmask)

OceanSODA <- OceanSODA %>% 
   filter(!is.na(ph_total))


```

## Maps

```{r map_OceanSODA_ph_clim_diff, fig.asp=1.5}

OceanSODA %>% 
  filter(year == 2020) %>% 
  ggplot(aes(lon_raw, lat_raw, fill = clim_ph)) +
  geom_tile() +
  scale_fill_viridis_c() +
  facet_wrap(~ month, ncol = 2) +
  coord_quickmap(expand = 0)


```

```{r map_OceanSODA_pH_clim, fig.asp=0.4}

# map of climatological OceanSODA pH 
OceanSODA %>% 
  group_split(month) %>% 
  #head(1) %>% 
  map(
    ~map+
      geom_tile(data = .x,
                aes(x = lon_raw,
                    y = lat_raw,
                    fill = clim_ph))+
      scale_fill_viridis_c()+
      labs(title = paste('climatological OceanSODA pH (1995-2020) month:', unique(.x$month)))
  )


```

```{r map_of_OceanSODA_pH_anomalies, fig.asp=1}

# map of monthly anomaly relative to climatology

OceanSODA %>%
  group_split(month) %>%
  #head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(
                  x = lon_raw,
                  y = lat_raw,
                  fill = clim_diff
                )) +
      scale_fill_divergent(mid = 'grey80') +
      facet_wrap( ~ year, ncol = 2) +
      labs(
        title = paste(
          'in-situ OceanSODA pH - clim OceanSODA pH, month:',
          unique(.x$month)
        )
      ) +
      theme(legend.position = 'right')
  )

```

# OceanSODA pH anomalies

## Grid level

### Climatological thresholds

### Fit lm models

```{r fit_linear_regression}

OceanSODA <- OceanSODA %>%
  mutate(decimal_year = decimal_date(date), .after = year)

# fit a linear regression of OceanSODA pH against time (temporal trend)
# in each lat/lon/month grid
# in each lat/lon/month grid, month is used depending on opt_extreme_determination
if (opt_extreme_determination == 1){
  OceanSODA_regression <- OceanSODA %>%
    nest(data = -c(lon, lat)) %>%
    mutate(
      fit = map(
        .x = data,
        .f = ~ lm(clim_diff ~ decimal_year, data = .x)
      ),
      tidied = map(.x = fit, .f = tidy),
      glanced = map(.x = fit, .f = glance),
      augmented = map(.x = fit, .f = augment)
    )
} else if (opt_extreme_determination == 2){
  OceanSODA_regression <- OceanSODA %>%
    nest(data = -c(lon, lat, month)) %>%
    mutate(
      fit = map(
        .x = data,
        .f = ~ lm(clim_diff ~ decimal_year, data = .x)
      ),
      tidied = map(.x = fit, .f = tidy),
      glanced = map(.x = fit, .f = glance),
      augmented = map(.x = fit, .f = augment)
    )
}

OceanSODA_regression_tidied <- OceanSODA_regression %>%
  select(-c(data, fit, augmented, glanced)) %>%
  unnest(tidied)

OceanSODA_regression_tidied <- OceanSODA_regression_tidied %>% 
  select(lat:estimate) %>% 
  pivot_wider(names_from = term,
              values_from = estimate) %>% 
  rename(intercept = `(Intercept)`,
         slope = decimal_year)

OceanSODA_regression_data <- OceanSODA_regression %>% 
  select(-c(fit, tidied, glanced, augmented)) %>% 
  unnest(data)

OceanSODA_regression_augmented <- OceanSODA_regression %>%
  select(-c(fit, tidied, glanced, data)) %>%
  unnest(augmented) %>% 
  select(lat:decimal_year, .resid)

OceanSODA_regression_augmented <- bind_cols(
  OceanSODA_regression_augmented,
  OceanSODA_regression_data %>% select(
    date, basin_AIP,   
    clim_ph, ph_total,
    lon_raw, lat_raw))

OceanSODA_regression_glanced <- OceanSODA_regression %>%
  select(-c(data, fit, tidied, augmented)) %>%
  unnest(glanced)

```

### Fit mean

```{r fit_pH_mean, eval=FALSE}

# identify the mean value
# in each lat/lon/month grid

OceanSODA_regression_tidied <- OceanSODA_SO %>% 
  # filter(basin_AIP == "Indian",
  #        biome_name == "SPSS",
  #        lon < 40) %>%
  group_by(lon, lat, month) %>%
  summarise(slope = 0,
            intercept = mean(clim_diff, na.rm = TRUE)) %>% 
  ungroup()

OceanSODA_regression_glanced <- OceanSODA_SO %>% 
  # filter(basin_AIP == "Indian",
  #        biome_name == "SPSS",
  #        lon < 40) %>%
  group_by(lon, lat, month) %>%
  summarise(sigma = sd(clim_diff, na.rm = TRUE)) %>% 
  ungroup()

OceanSODA_regression_augmented <- OceanSODA_SO %>% 
  # filter(basin_AIP == "Indian",
  #        biome_name == "SPSS",
  #        lon < 40) %>%
  mutate(.resid = clim_diff)

```

### Slope maps

```{r map_regression_slopes_flat, fig.asp=1}

if (opt_extreme_determination == 1){
  map +
    geom_tile(data = OceanSODA_regression_tidied,
              aes(x = lon,
                  y = lat,
                  fill = slope)) +
    scale_fill_scico(palette = 'vik', midpoint = 0)
} else if (opt_extreme_determination == 2){
  map +
    geom_tile(data = OceanSODA_regression_tidied,
              aes(x = lon,
                  y = lat,
                  fill = slope)) +
    scale_fill_scico(palette = 'vik', midpoint = 0) +
    facet_wrap( ~ month, ncol = 2)
}

```

### Sigma maps

```{r flat_map_sigma, fig.asp=1}

if (opt_extreme_determination == 1){
  map +
    geom_tile(data = OceanSODA_regression_glanced,
              aes(x = lon,
                  y = lat,
                  fill = sigma)) +
    scale_fill_viridis_c() +
    labs(fill = '1 residual \nst. dev.')
} else if (opt_extreme_determination == 2){
  map +
    geom_tile(data = OceanSODA_regression_glanced,
              aes(x = lon,
                  y = lat,
                  fill = sigma)) +
    scale_fill_viridis_c() +
    labs(fill = '1 residual \nst. dev.') +
    facet_wrap(~month, ncol = 2)
}

```

### Anomaly identification

Calculate OceanSODA pH anomalies: L for abnormally low, H for abnormally high, N for normal pH

```{r calculate_extreme_OceanSODA_pH_grid}

# when the in-situ OceanSODA pH is lower than the 5th percentile (predicted - 2*residual.st.dev), assign 'L' for low extreme
# when the in-situ OceanSODA pH exceeds the 95th percentile (predicted + 2*residual.st.dev), assign 'H' for high extreme
# when the in-situ OceanSODA pH is within 95% of the range, then assign 'N' for normal pH

# combine observations and regression statistics

if (opt_extreme_determination == 1){
  OceanSODA_extreme_grid <-
    full_join(
      OceanSODA_regression_augmented,
      OceanSODA_regression_glanced %>%
        select(lat:lon, sigma)
    )
} else if (opt_extreme_determination == 2){
  OceanSODA_extreme_grid <-
    full_join(
      OceanSODA_regression_augmented,
      OceanSODA_regression_glanced %>%
        select(lat:month, sigma)
    )
}

# identify observations in anomaly classes

OceanSODA_extreme_grid <- OceanSODA_extreme_grid %>%
  mutate(
    ph_extreme = case_when(
      .resid < -sigma*2 ~ 'L',
      .resid > sigma*2 ~ 'H',
      TRUE ~ 'N'
    )
  ) 

OceanSODA_extreme_grid <- OceanSODA_extreme_grid %>%
  mutate(ph_extreme = fct_relevel(ph_extreme, "H", "N", "L"))


# combine with regression coefficients

OceanSODA_extreme_grid <-
  full_join(OceanSODA_extreme_grid,
            OceanSODA_regression_tidied)

OceanSODA_extreme_grid <- OceanSODA_extreme_grid %>%
  mutate(year = year(date),
         month = month(date),
         .after = decimal_year)

```

#### Write anomalies to file

```{r write_OceanSODA_pH_anomalies_to_file}

# Restrict to SO by inner join to nm_biomes
OceanSODA_SO_extreme_grid <- inner_join(OceanSODA_extreme_grid, nm_biomes %>% 
                                        select(-n)) 



if (opt_extreme_determination == 1){
  OceanSODA_SO_extreme_grid %>%
    write_rds(file = paste0(path = path_argo_preprocessed, "/OceanSODA_pH_anomaly_field_01.rds"))
  OceanSODA_extreme_grid %>%
    write_rds(file = paste0(path = path_argo_preprocessed, "/OceanSODA_global_pH_anomaly_field_01.rds"))
} else if (opt_extreme_determination == 2){
  OceanSODA_SO_extreme_grid %>%
    write_rds(file = paste0(path = path_argo_preprocessed, "/OceanSODA_pH_anomaly_field_02.rds"))
  OceanSODA_extreme_grid %>%
    write_rds(file = paste0(path = path_argo_preprocessed, "/OceanSODA_global_pH_anomaly_field_02.rds"))
}
  
```

```{r anomaly_test_plot_grid, fig.asp=0.4}

if (opt_extreme_determination == 1){
  OceanSODA_SO_extreme_grid %>%
    group_split(lon, lat) %>%
    head(8) %>%
    map(
      ~ ggplot(data = .x) +
        geom_point(aes(
          x = year,
          y = clim_diff,
          col = ph_extreme
        )) +
        geom_abline(data = .x, aes(slope = slope,
                                   intercept = intercept)) +
        geom_abline(
          data = .x,
          aes(slope = slope,
              intercept = intercept + 2 * sigma),
          linetype = 2
        ) +
        geom_abline(
          data = .x,
          aes(slope = slope,
              intercept = intercept - 2 * sigma),
          linetype = 2
        ) +
        labs(title = paste(
          fititle = paste("lon:", unique(.x$lon),
                          "| lat:", unique(.x$lat))
        )) +
        scale_color_manual(values = HNL_colors)
    )
} else if (opt_extreme_determination == 2){
  OceanSODA_SO_extreme_grid %>%
    group_split(lon, lat, month) %>%
    head(8) %>%
    map(
      ~ ggplot(data = .x) +
        geom_point(aes(
          x = year,
          y = clim_diff,
          col = ph_extreme
        )) +
        geom_abline(data = .x, aes(slope = slope,
                                   intercept = intercept)) +
        geom_abline(
          data = .x,
          aes(slope = slope,
              intercept = intercept + 2 * sigma),
          linetype = 2
        ) +
        geom_abline(
          data = .x,
          aes(slope = slope,
              intercept = intercept - 2 * sigma),
          linetype = 2
        ) +
        labs(title = paste(fititle = paste(
          "lon:", unique(.x$lon),
          "| lat:", unique(.x$lat),
          "| month:", unique(.x$month)
        ))) +
        scale_color_manual(values = HNL_colors)
    )
}

```

### Anomaly maps

```{r flat_map_OceanSODA_ph_extremes_1x1_plot, fig.asp=1.5}

#use the original lat/lon grid to plot the extreme on a 1x1
#(anomalies detected with 1995-2020 data but mapped only from 2013 to 2020)

OceanSODA_SO_extreme_grid %>%
  filter(year >= 2013) %>% 
  group_split(month) %>%
  #head(1) %>%
  map(
    ~map +
      geom_tile(data = .x,
                aes(x = lon_raw,
                    y = lat_raw,
                    fill = ph_extreme))+
      scale_fill_manual(values = HNL_colors_map)+
      facet_wrap(~year, ncol = 2)+
      lims(y = c(-85, -30))+
      labs(title = paste('month:', unique(.x$month)),
           fill = 'pH')
  )

```

### Anomaly time series

```{r extreme_pH_timeseries_grid}
# calculate a regional mean pH for each biome, basin, and ph extreme (H/L/N) and plot a timeseries 

OceanSODA_SO_extreme_grid %>% 
  group_by(year, biome_name, basin_AIP, ph_extreme) %>% 
  summarise(ph_regional = mean(ph_total, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = ph_regional, col = ph_extreme))+
  geom_point(size = 0.3)+
  geom_line()+
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP~biome_name)+
  theme(legend.position = 'bottom')

```

### Anomaly histogram

```{r extreme_pH_histogram_grid}

OceanSODA_SO_extreme_grid %>%
  ggplot(aes(ph_total, col = ph_extreme)) +
  geom_density() +
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP ~ biome_name) +
  coord_cartesian(xlim = c(8, 8.2)) +
  labs(x = 'value',
       y = 'density',
       col = 'pH anomaly') +
  theme(legend.position = 'bottom')

```

# Argo

## Grid reduction

```{r grid_reduction_to_2x2_argo}

# Note: While reducing lon x lat grid,
# we keep the original number of observations

# full_argo_2x2 <- full_argo %>%
#   mutate(
#     lat_raw = lat,
#     lon_raw = lon,
#     lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
#     lat = as.numeric(as.character(lat)),
#     lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
#     lon = as.numeric(as.character(lon)))  # re-grid to 2x2

full_argo <- full_argo %>%
  mutate(
    lat_raw = lat,
    lon_raw = lon)

```

## Apply region masks

```{r apply_region_masks_argo}

# keep only Southern Ocean argo data
full_argo_SO <- inner_join(full_argo, nm_biomes)

# add in basin separations
full_argo_SO <- inner_join(full_argo_SO, basinmask)

```

## Join OceanSODA

```{r combine_extreme_OceanSODA_to_Argo}

# rename OceanSODA columns
OceanSODA_SO_extreme_grid <- OceanSODA_SO_extreme_grid %>%
  select(-c(lon, lat)) %>%
  rename(OceanSODA_ph = ph_total,
         lon = lon_raw,
         lat = lat_raw) %>% 
  filter(year >= 2013)

# combine the argo profile data to the surface extreme data
profile_extreme <- inner_join(
  full_argo %>%
    select(
      file_id, 
      year, 
      month, 
      date, 
      lon, 
      lat, 
      depth, 
      pH
      ),
  OceanSODA_SO_extreme_grid %>%
    select(
      year,
      month,
      date,
      lon,
      lat,
      OceanSODA_ph,
      ph_extreme,
      clim_ph,
      clim_diff,
      biome_name,
      basin_AIP
    )
)

# profile_extreme <- profile_extreme %>% 
#   unite('platform_cycle', platform_number:cycle_number, sep = '_', remove = FALSE)

```

# Location of Argo profiles

```{r map_location_argo_profiles, fig.asp=2}


OceanSODA_SO_extreme_grid %>%
  group_split(month) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(
        data = .x,
        aes(x = lon,
            y = lat,
            fill = ph_extreme),
        alpha = 0.5
      ) +
      scale_fill_manual(values = HNL_colors_map) +
      new_scale_fill() +
      geom_tile(
        data = profile_extreme %>%
          distinct(lon, lat, file_id, year, month),
        aes(
          x = lon,
          y = lat,
          fill = 'argo\nprofiles',
          height = 1,
          width = 1
        ),
        alpha = 0.5
      ) +
      scale_fill_manual(values = "springgreen4",
                        name = "") +
      facet_wrap( ~ year, ncol = 1) +
      lims(y = c(-85, -30)) +
      labs(title = paste('month:', unique(.x$month)))
  )

```

# Plot profiles

Argo profiles plotted according to the surface OceanSODA pH

L profiles correspond to a surface acidification event (low pH), as recorded in OceanSODA

H profiles correspond to an event of high surface pH, as recorded in OceanSODA

N profiles correspond to normal surface OceanSODA pH

## Raw

```{r profiles_raw}

profile_extreme %>%
  group_split(biome_name, basin_AIP, year) %>% 
  head(6) %>% 
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = pH,
        y = depth,
        group = file_id,
        col = ph_extreme
      )
    ) +
      geom_path(data = .x %>% filter(ph_extreme == 'N'),
                aes(x = pH,
                    y = depth,
                    group = file_id,
                    col = ph_extreme),
                size = 0.3) +
      geom_path(data = .x %>% filter(ph_extreme == 'H' | ph_extreme == 'L'),
                aes(x = pH,
                    y = depth,
                    group = file_id,
                    col = ph_extreme),
                size = 0.5)+
      scale_y_reverse() +
      scale_color_manual(values = HNL_colors) +
      facet_wrap(~ month, ncol = 6) +
      labs(
        x = 'Argo pH (total scale)',
        y = 'depth (m)',
        title = paste(
          unique(.x$basin_AIP),
          "|",
          unique(.x$year),
          "| biome:",
          unique(.x$biome_name)
        ),
        col = 'OceanSODA pH \nanomaly'
      )
  )

```

### Atl, STSS biome, Aug 2017

```{r select_specific_pH_profiles_2017, eval=FALSE}

# plot profiles for the Atlantic basin, biome 1, month 08, 2017 

OceanSODA_SO_extreme_grid_2017 <-  
  OceanSODA_SO_extreme_grid %>% 
  filter(date == '2017-08-15')

map+
  geom_tile(data = OceanSODA_SO_extreme_grid_2017,
            aes(x = lon,
                y = lat,
                fill = ph_extreme))+
  scale_fill_manual(values = HNL_colors_map)+
  lims(y = c(-85, -30))+
  labs(title = 'August 2017',
       fill = 'OceanSODA pH \nextreme')

profile_extreme_Atl_2017 <- profile_extreme %>% 
  filter(date == '2017-08-15',
         basin_AIP == 'Atlantic',
         biome_name == 'STSS')

profile_extreme_Atl_2017 %>% 
  ggplot(aes(y = depth, 
             x = pH,
             group = file_id,
             col = ph_extreme))+
  geom_path(data = profile_extreme_Atl_2017 %>% filter(ph_extreme == 'N'),
            aes(x = pH,
                y = depth, 
                group = file_id,
                col = ph_extreme),
            size = 0.3)+
  geom_path(data = profile_extreme_Atl_2017 %>% filter(ph_extreme == 'H'| ph_extreme == 'L'),
            aes(x = pH,
                y = depth,
                group = file_id,
                col = ph_extreme),
            size = 0.5)+
  scale_y_reverse()+
  scale_color_manual(values = HNL_colors)+
  labs(title = 'Atlantic basin, STSS biome, August 2017',
       col = 'OceanSODA\npH anomaly',
       x = 'Argo pH')

rm(OceanSODA_SO_extreme_grid_2017, profile_extreme_Atl_2017)
```

### Atl, STSS biome, Dec 2017

```{r select_specific_profiles_2017, eval=FALSE}

# Plot profiles for the Pacific basin, biome 3, months 12, 2017

OceanSODA_SO_extreme_grid_2017 <-   
  OceanSODA_SO_extreme_grid %>% 
  filter(date == '2017-12-15')

map+
  geom_tile(data = OceanSODA_SO_extreme_grid_2017,
            aes(x = lon,
                y = lat,
                fill = ph_extreme))+
  scale_fill_manual(values = HNL_colors_map)+
  lims(y = c(-85, -30))+
  labs(title = 'December 2017',
       fill = 'OceanSODA pH \nextreme')

profile_extreme_Atl_2017 <- profile_extreme %>% 
  filter(date == '2017-12-15',
         basin_AIP == 'Atlantic',
         biome_name == 'STSS')

profile_extreme_Atl_2017 %>% 
  ggplot(aes(y = depth, 
             x = pH,
             group = file_id,
             col = ph_extreme))+
  geom_path(data = profile_extreme_Atl_2017 %>% filter(ph_extreme == 'N'),
            aes(x = pH,
                y = depth,
                group = file_id,
                col = ph_extreme),
            size = 0.3)+
  geom_path(data = profile_extreme_Atl_2017 %>% filter(ph_extreme == 'H' | ph_extreme == 'L'),
            aes(x = pH,
                y = depth,
                group = file_id,
                col = ph_extreme),
            size = 0.5)+
  scale_y_reverse()+
  scale_color_manual(values = HNL_colors)+
  labs(title = 'Atlantic basin, STSS biome, December 2017',
       col = 'OceanSODA\npH anomaly',
       x = 'Argo pH')

rm(OceanSODA_SO_extreme_grid_2017, profile_extreme_Atl_2017)
```

### Atl, STSS biome, Jan 2018

```{r select_specific_profiles_2018, eval=FALSE}

OceanSODA_SO_extreme_grid_2018 <-   
  OceanSODA_SO_extreme_grid %>% 
  filter(date == '2018-01-15')

map+
  geom_tile(data = OceanSODA_SO_extreme_grid_2018,
            aes(x = lon,
                y = lat,
                fill = ph_extreme))+
  scale_fill_manual(values = HNL_colors_map)+
  lims(y = c(-85, -30))+
  labs(title = 'January 2018',
       fill = 'OceanSODA pH \nextreme')

profile_extreme_Atl_2018 <- profile_extreme %>% 
  filter(date == '2018-01-15',
         basin_AIP == 'Atlantic',
         biome_name == 'STSS')

profile_extreme_Atl_2018 %>% 
  ggplot(aes(y = depth, 
             x = pH,
             group = file_id,
             col = ph_extreme))+
  geom_path(data = profile_extreme_Atl_2018 %>% filter(ph_extreme == 'N'),
            aes(x = pH,
                y = depth,
                group = file_id,
                col = ph_extreme),
            size = 0.3)+
  geom_path(data = profile_extreme_Atl_2018 %>% filter(ph_extreme == 'H' | ph_extreme == 'L'),
            aes(x = pH,
                y = depth,
                group = file_id,
                col = ph_extreme),
            size = 0.5)+
  scale_y_reverse()+
  scale_color_manual(values = HNL_colors)+
  labs(title = 'Atlantic basin, STSS biome, January 2018',
       col = 'OceanSODA\npH anomaly',
       x = 'Argo pH')

rm(OceanSODA_SO_extreme_grid_2018, profile_extreme_Atl_2018)
```

## Averaged profiles

```{r calculate_mean_profiles}
# calculate mean profiles in each basin and biome, for each month between 2014 and 2021 
# cut depth levels at 10, 20, .... etc m
# add seasons 
# Dec, Jan, Feb <- summer 
# Mar, Apr, May <- autumn 
# Jun, Jul, Aug <- winter 
# Sep, Oct, Nov <- spring 

profile_extreme <- profile_extreme %>%
  mutate(
    season = case_when(
      between(month, 3, 5) ~ 'autumn',
      between(month, 6, 8) ~ 'winter',
      between(month, 9, 11) ~ 'spring',
      month == 12 | 1 | 2 ~ 'summer'
    ),
    season_order = case_when(
      between(month, 3, 5) ~ 2,
      between(month, 6, 8) ~ 3,
      between(month, 9, 11) ~ 4,
      month == 12 | 1 | 2 ~ 1
    ),
    .after = date
  ) 

```

### Overall mean

```{r mean_profiles, fig.asp=1}

profile_extreme_mean <- profile_extreme %>%
  group_by(ph_extreme, depth) %>%
  summarise(ph_mean = mean(pH, na.rm = TRUE),
            ph_std = sd(pH, na.rm = TRUE)) %>%
  ungroup()

profile_extreme_mean %>%
  arrange(depth) %>%
  ggplot(aes(
    x = ph_mean,
    y = depth,
    group = ph_extreme,
    col = ph_extreme
  )) +
  geom_ribbon(aes(xmin = ph_mean - ph_std,
                  xmax = ph_mean + ph_std,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = "Overall mean",
       col = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'Argo mean pH') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))

rm(profile_extreme_mean)
```

Number of profiles

```{r mean_profile_count, fig.asp=1}

profile_count_mean <- profile_extreme %>% 
  distinct(ph_extreme, file_id) %>% 
  count(ph_extreme)

profile_count_mean %>% 
  ggplot(aes(x = ph_extreme, y = n, fill = ph_extreme))+
  geom_col(width = 0.5)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles')

# rm(profile_count_mean)
```

Surface Argo pH vs surface OceanSODA pH (20 m)

```{r argo_vs_OceanSODA_ph_mean, fig.asp=1}

# calculate surface-mean argo pH, for each profile 
surface_ph_mean <- profile_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(ph_extreme, file_id) %>% 
  summarise(argo_surf_ph = mean(pH, na.rm = TRUE),
            OceanSODA_surf_ph = mean(OceanSODA_ph, na.rm = TRUE)) %>%
  ungroup()



surface_ph_mean %>% 
  group_by(ph_extreme) %>% 
  group_split(ph_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = OceanSODA_surf_ph, 
             y = argo_surf_ph))+
  geom_bin2d(data = .x, aes(x = OceanSODA_surf_ph, 
                 y = argo_surf_ph)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(7.9, 8.21),
              ylim = c(7.9, 8.21))+
  # facet_grid(basin_AIP ~ biome) +
    labs(title = paste('pH extreme:', unique(.x$ph_extreme)),
         x = 'OceanSODA pH',
         y = 'Argo pH')
  )

rm(surface_ph_mean)
```

### January Overall Mean Profiles

```{r overall_mean_january_ph_profiles, fig.asp=1}

profile_extreme_mean_jan <- profile_extreme %>%
  filter(month == 1) %>% 
  group_by(ph_extreme, depth) %>%
  summarise(ph_mean = mean(pH, na.rm = TRUE),
            ph_std = sd(pH, na.rm = TRUE)) %>%
  ungroup()

profile_extreme_mean_jan %>%
  arrange(depth) %>%
  ggplot(aes(
    x = ph_mean,
    y = depth,
    group = ph_extreme,
    col = ph_extreme
  )) +
  geom_ribbon(aes(xmin = ph_mean - ph_std,
                  xmax = ph_mean + ph_std,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = "Overall mean January profiles",
       col = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'Argo mean pH') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))

rm(profile_extreme_mean_jan)

```

### Season x Mayot biome

```{r mean_profiles_season_biome, fig.asp=1}

profile_extreme_biome <- profile_extreme %>% 
  group_by(season_order, season, biome_name, ph_extreme, depth) %>% 
  summarise(ph_biome = mean(pH, na.rm = TRUE),
            ph_biome_std = sd(pH, na.rm = TRUE)) %>% 
  ungroup()

facet_label <- as_labeller(c("1"="summer", 
                             "2"="autumn", 
                             "3"="winter", 
                             "4"="spring", 
                             "ICE" = "ICE", 
                             "SPSS" = "SPSS",
                             "STSS" = "STSS",
                             "Atlantic" = "Atlantic",
                             "Indian" = "Indian",
                             "Pacific" = "Pacific"
                             ))

profile_extreme_biome %>%
  ggplot(aes(
    x = ph_biome,
    y = depth,
    group = ph_extreme,
    col = ph_extreme
  )) +
  geom_ribbon(aes(xmin = ph_biome - ph_biome_std,
                  xmax = ph_biome + ph_biome_std,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA, 
              alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(col = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'Biome mean Argo pH',
       title = 'Biome-mean Argo profiles') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
  facet_grid(season_order ~ biome_name, labeller = facet_label)

rm(profile_extreme_biome)
```

Number of profiles season x biome

```{r count_profiles_season_biome, fig.asp=1}

profile_count_biome <- profile_extreme %>% 
  distinct(season_order, season, biome_name, ph_extreme, file_id) %>% 
  group_by(season_order, season, biome_name, ph_extreme) %>% 
  count(ph_extreme)

profile_count_biome %>% 
  ggplot(aes(x = ph_extreme, y = n, fill = ph_extreme))+
  geom_col(width = 0.5)+
  facet_grid(season_order ~ biome_name, labeller = facet_label)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles season x biome')

# rm(profile_count_biome)
```

Surface Argo vs surface OceanSODA pH (20 m) season x biome

```{r argo_vs_OceanSODA_biome, fig.asp=1}

surface_ph_biome <- profile_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season_order, season, biome_name, ph_extreme, file_id) %>% 
  summarise(argo_surf_ph = mean(pH, na.rm=TRUE),
            OceanSODA_surf_ph = mean(OceanSODA_ph, na.rm = TRUE))

surface_ph_biome %>% 
  group_by(ph_extreme) %>% 
  group_split(ph_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = OceanSODA_surf_ph, 
             y = argo_surf_ph))+
  geom_bin2d(data = .x, aes(x = OceanSODA_surf_ph, 
                 y = argo_surf_ph)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(7.94, 8.21),
              ylim = c(7.94, 8.21))+
  facet_grid(season_order~biome_name, labeller = facet_label) +
    labs(title = paste( 'pH extreme:', unique(.x$ph_extreme)),
         x = 'OceanSODA pH',
         y = 'Argo pH')
  )

rm(surface_ph_biome)
```

### Season x basin

```{r mean_basin_profiles, fig.asp=1}

profile_extreme_basin <- profile_extreme %>% 
  group_by(season_order, season, basin_AIP, ph_extreme, depth) %>% 
  summarise(ph_basin = mean(pH, na.rm = TRUE),
            ph_basin_std = sd(pH, na.rm = TRUE)) %>% 
  ungroup()

profile_extreme_basin %>% 
  ggplot(aes(x = ph_basin, 
             y = depth, 
             group = ph_extreme, 
             col = ph_extreme))+
  geom_ribbon(aes(xmax = ph_basin + ph_basin_std,
                  xmin = ph_basin - ph_basin_std,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.3)+
  geom_path()+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  labs(col = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       y = 'depth (m)',
       x = 'Basin mean Argo pH',
       title = 'Basin-mean Argo profiles')+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
  facet_grid(season_order~basin_AIP, labeller = facet_label)

rm(profile_extreme_basin)
```

Number of profiles season x basin

```{r count_basin_profiles, fig.asp=1}

profile_count_basin <- profile_extreme %>% 
  distinct(season_order, season, basin_AIP, ph_extreme, file_id) %>% 
  group_by(season_order, season, basin_AIP, ph_extreme) %>% 
  count(ph_extreme)

profile_count_basin %>% 
  ggplot(aes(x = ph_extreme, y = n, fill = ph_extreme))+
  geom_col(width = 0.5)+
  facet_grid(season_order~basin_AIP, labeller = facet_label)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles season x basin')

# rm(profile_count_basin)
```

Surface Argo vs surface OceanSODA pH (20 m) season x basin

```{r argo_vs_OceanSODA_pH_basin, fig.asp=1}

# calculate surface-mean argo pH to compare against OceanSODA surface pH (one value)
surface_ph_basin <- profile_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season_order, season, basin_AIP, ph_extreme, file_id) %>% 
  summarise(surf_argo_ph = mean(pH, na.rm=TRUE),
            surf_OceanSODA_ph = mean(OceanSODA_ph, na.rm = TRUE)) 

surface_ph_basin %>% 
  group_by(ph_extreme) %>% 
  group_split(ph_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = surf_OceanSODA_ph, 
             y = surf_argo_ph))+
  geom_bin2d(data = .x, aes(x = surf_OceanSODA_ph, 
                 y = surf_argo_ph)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(7.94, 8.21),
              ylim = c(7.94, 8.21))+
  facet_grid(season_order~basin_AIP, labeller = facet_label) +
    labs(title = paste('pH extreme:', unique(.x$ph_extreme)),
         x = 'OceanSODA pH',
         y = 'Argo pH')
  )

rm(surface_ph_basin)
```

### Biome-basin January mean

```{r january_biome_basin_profiles, fig.asp=1}

profile_extreme_biome_basin_jan <- profile_extreme %>%
  filter(month == 1) %>% 
  group_by(biome_name, basin_AIP, ph_extreme, depth) %>%
  summarise(ph_mean = mean(pH, na.rm = TRUE),
            ph_std = sd(pH, na.rm = TRUE)) %>%
  ungroup()

profile_extreme_biome_basin_jan %>%
  arrange(depth) %>%
  ggplot(aes(x = ph_mean,
             y = depth)) +
  geom_ribbon(aes(xmin = ph_mean - ph_std,
                  xmax = ph_mean + ph_std,
                  fill = ph_extreme), 
              alpha = 0.2)+
  geom_path(aes(x = ph_mean,
                col = ph_extreme))+
  facet_grid(basin_AIP~biome_name)+
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = "Basin-biome-mean January profiles",
       col = 'OceanSODA\nph anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\nph anomaly \n(mean ± st dev)',
       y = 'sqrt(depth)',
       x = 'mean Argo pH)') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))

rm(profile_extreme_biome_basin_jan)
```

### Season x biome x basin

```{r mean_profiles_season_biome_basin, fig.asp=1}

profile_extreme_season <- profile_extreme %>%
  group_by(season_order, season, biome_name, basin_AIP, ph_extreme, depth) %>%
  summarise(ph_mean = mean(pH, na.rm = TRUE),
            ph_std = sd(pH, na.rm = TRUE)) %>%
  ungroup()

profile_extreme_season %>%
  arrange(depth) %>%
  group_split(season_order) %>%
  # head(1) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = ph_mean,
        y = depth,
        group = ph_extreme,
        col = ph_extreme
      )
    ) +
      geom_ribbon(aes(xmax = ph_mean + ph_std,
                      xmin = ph_mean - ph_std,
                      group = ph_extreme,
                      fill = ph_extreme),
                  col = NA,
                  alpha = 0.2)+
      geom_path() +
      scale_color_manual(values = HNL_colors) +
      scale_fill_manual(values = HNL_colors)+
      labs(title = paste("season:", unique(.x$season)),
           col = 'OceanSODA\npH anomaly\n(mean ± st dev)',
           fill = 'OceanSODA\npH anomaly\n(mean ± st dev)',
           y = 'sqrt(depth)',
           x = 'Argo pH') +
      scale_y_continuous(
        trans = trans_reverser("sqrt"),
        breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))
      ) +
      facet_grid(basin_AIP ~ biome_name)
  )

```

Number of profiles per season x biome x basin x pH extreme

```{r count_number_season_biome_basin_profiles, fig.asp=1}

profile_count_season <- profile_extreme %>% 
  distinct(season_order, season, biome_name, basin_AIP,
           ph_extreme, file_id) %>% 
  group_by(season_order, season, biome_name, basin_AIP, ph_extreme) %>% 
  count(ph_extreme)


profile_count_season %>% 
  group_by(season_order) %>% 
  group_split(season_order) %>% 
  map(
    ~ggplot()+
      geom_col(data =.x, 
               aes(x = ph_extreme,
                   y = n,
                   fill = ph_extreme),
               width = 0.5)+
      facet_grid(basin_AIP ~ biome_name)+
      scale_y_continuous(trans = 'log10')+
      labs(y = 'log(number of profiles)',
           title = paste('season:', unique(.x$season)))
  )

# rm(profile_count_season)
```

Surface OceanSODA pH vs surface Argo pH (20 m)

```{r surface_OceanSODA_vs_argo_ph, fig.asp=1}

# calculate surface-mean argo pH, for each season x biome x basin x ph extreme 
surface_ph_season <- profile_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season_order,
           season, 
           basin_AIP, 
           biome_name, 
           ph_extreme, 
           file_id) %>% 
  summarise(surf_argo_ph = mean(pH, na.rm=TRUE),
            surf_OceanSODA_ph = mean(OceanSODA_ph, na.rm = TRUE)) 

surface_ph_season %>% 
  group_by(season_order, ph_extreme) %>% 
  group_split(season_order, ph_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = surf_OceanSODA_ph, 
             y = surf_argo_ph))+
  geom_bin2d(data = .x, aes(x = surf_OceanSODA_ph, 
                 y = surf_argo_ph)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(7.94, 8.21),
              ylim = c(7.94, 8.21))+
  facet_grid(basin_AIP ~ biome_name) +
    labs(title = paste('season:', unique(.x$season), 
                        '| pH extreme:', unique(.x$ph_extreme)),
         x = 'OceanSODA pH',
         y = 'Argo pH')
  )

rm(surface_ph_season)
```

##### Atl, SPSS biome, winter

```{r season_biome_1_Atlantic_profile_winter, fig.asp=1}

profile_extreme_season %>%
  filter(basin_AIP == 'Atlantic',
         season == 'winter',
         biome_name == 'SPSS') %>% 
  arrange(depth) %>%
  ggplot(aes(x = ph_mean,
             y = depth,
             group = ph_extreme,
             col = ph_extreme)) +
  geom_ribbon(aes(xmax = ph_mean + ph_std,
                  xmin = ph_mean - ph_std,
                  group = ph_extreme,
                  fill = ph_extreme),
                col = NA,
                alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = 'Atlantic basin, SPSS biome, winter',
       col = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       y = 'sqrt(depth)',
       x = 'Argo pH') +
  scale_y_continuous(
        trans = trans_reverser("sqrt"),
        breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))
```

##### Atl, STSS biome, summer

```{r Atlantic_biome_1_profile_season_summer, fig.asp=1}

profile_extreme_season %>%
  filter(basin_AIP == 'Atlantic',
         season == 'summer',
         biome_name == 'STSS') %>% 
  arrange(depth) %>%
  ggplot(aes(x = ph_mean,
             y = depth,
             group = ph_extreme,
             col = ph_extreme)) +
  geom_ribbon(aes(xmax = ph_mean + ph_std,
                  xmin = ph_mean - ph_std,
                  group = ph_extreme,
                  fill = ph_extreme),
                col = NA,
                alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = 'Atlantic basin, STSS biome, summer',
       col = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       y = 'sqrt(depth)',
       x = 'Argo pH') +
  scale_y_continuous(
        trans = trans_reverser("sqrt"),
        breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))
```

# Anomaly profiles

## Read anomalies

```{r average_ph_argo_depth_levels}

# profile_extreme_binned <- profile_extreme %>%
#   group_by(lon, lat, year, month, file_id,
#            biome_name, basin_AIP, ph_extreme,
#            depth, season, season_order) %>%
#   summarise(ph_adjusted_binned = mean(pH, na.rm = TRUE)) %>%
#   ungroup()

```

```{r load_broullon_clim}

# broullon_clim <- read_rds(file = paste0(path_argo_preprocessed, 
#                                         '/broullon_TA_DIC_clim_SO_pH.rds'))
# 
# # compatibility with profile_extreme
# broullon_clim <- broullon_clim %>% 
#   mutate(depth_broullon = depth)
# 
# # grid average climatological temp into the argo depth bins 
# broullon_clim <- broullon_clim %>%
#   mutate(
#     depth = cut(
#       depth_broullon,
#       breaks = c(0, 10, 20, 30, 50, 70, 100, 300, 500, 800, 1000, 1500, 2000),
#       include.lowest = TRUE,
#       labels = as.factor(unique(profile_extreme$depth))[1:12]
#     ),
#     depth = as.numeric(as.character(depth))
#   )
# 
# 
# # calculate mean climatological pH per depth bin
# broullon_clim_binned <- broullon_clim %>% 
#   group_by(lon, lat, depth, month, basin_AIP, biome_name) %>% 
#   summarise(clim_ph_binned = mean(pH, na.rm = TRUE)) %>%
#   ungroup()
# 
# 
# # join climatology and ARGO profiles
# remove_clim <- inner_join(profile_extreme_binned, 
#                               broullon_clim_binned)


remove_clim <-
  read_rds(file = paste0(path_argo_preprocessed, "/pH_anomaly_va.rds")) %>%
  filter(profile_range >= opt_min_profile_range) %>%
  mutate(date = ymd(format(date, "%Y-%m-15")))

remove_clim <- inner_join(
  remove_clim %>%
    select(
      file_id, 
      year, 
      month, 
      date, 
      lon, 
      lat, 
      depth, 
      pH,
      clim_pH,
      anomaly_pH
      ),
  OceanSODA_SO_extreme_grid %>%
    select(
      year,
      month,
      date,
      lon,
      lat,
      OceanSODA_ph,
      ph_extreme,
      biome_name,
      basin_AIP
    )
)

remove_clim <- remove_clim %>%
  mutate(
    season = case_when(
      between(month, 3, 5) ~ 'autumn',
      between(month, 6, 8) ~ 'winter',
      between(month, 9, 11) ~ 'spring',
      month == 12 | 1 | 2 ~ 'summer'
    ),
    season_order = case_when(
      between(month, 3, 5) ~ 2,
      between(month, 6, 8) ~ 3,
      between(month, 9, 11) ~ 4,
      month == 12 | 1 | 2 ~ 1
    ),
    .after = date
  ) 


```

### Profiles - Absolute

```{r plot_raw_profiles_with_broullon_clim}

remove_clim %>%
  group_split(biome_name, basin_AIP, year) %>%
  head(6) %>%
  map(
    ~ ggplot() +
      geom_path(
        data = .x %>%
          filter(ph_extreme == 'N'),
        aes(
          x = pH,
          y = depth,
          group = file_id,
          col = ph_extreme
        ),
        size = 0.3
      ) +
      geom_path(
        data = .x %>%
          filter(ph_extreme == 'H' | ph_extreme == 'L'),
        aes(
          x = pH,
          y = depth,
          group = file_id,
          col = ph_extreme
        ),
        size = 0.5
      ) +
      geom_point(
        data = .x,
        aes(x = clim_pH,
            y = depth,
            col = ph_extreme),
        size = 0.5
      ) +
      scale_y_reverse() +
      scale_color_manual(values = HNL_colors) +
      labs(
        x = 'Argo pH',
        y = 'depth (m)',
        title = paste(
          "Biome:",
          unique(.x$biome_name),
          "| basin:",
          unique(.x$basin_AIP),
          " | ",
          unique(.x$year)
        ),
        col = 'OceanSODA pH \nanomaly'
      )
  )

```

### Profiles - Anomaly

```{r plot_anomaly_profiles_broullon_clim, fig.asp=1}

remove_clim %>% 
  group_split(month) %>% 
  #head(1) %>% 
  map(
    ~ggplot()+
      geom_path(data = .x %>% filter(ph_extreme == 'N'),
                aes(x = anomaly_pH,
                    y = depth,
                    group = file_id,
                    col = ph_extreme),
                size = 0.2)+
      geom_path(data = .x %>% filter(ph_extreme == 'H'| ph_extreme == 'L'),
                 aes(x = anomaly_pH,
                     y = depth,
                     group = file_id,
                     col = ph_extreme),
                 size = 0.3)+
      geom_vline(xintercept = 0)+
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
      scale_color_manual(values = HNL_colors)+
      scale_fill_manual(values = HNL_colors)+
      facet_grid(basin_AIP~biome_name)+
      labs(title = paste('month:', unique(.x$month)))
  )

```

### Overall mean anomaly profiles

```{r overall_mean_anomaly_profiles_broullon, fig.asp=1}

remove_clim_overall_mean <- remove_clim %>% 
  group_by(ph_extreme, depth) %>% 
  summarise(ph_anomaly_mean = mean(anomaly_pH, na.rm = TRUE),
            ph_anomaly_sd = sd(anomaly_pH, na.rm = TRUE)) %>%
  ungroup()

remove_clim_overall_mean %>% 
  ggplot()+
  geom_path(aes(x = ph_anomaly_mean,
                y = depth,
                group = ph_extreme,
                col = ph_extreme))+
  geom_ribbon(aes(xmax = ph_anomaly_mean + ph_anomaly_sd,
                  xmin = ph_anomaly_mean - ph_anomaly_sd,
                  y = depth,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  # geom_text_repel(data = profile_count_mean,
  #                 aes(x = -0.075,
  #                     y = 1500,
  #                     label = paste0(n),
  #                     col = ph_extreme),
  #                 size = 7,
  #                 segment.color = 'transparent')+
  geom_text(data = profile_count_mean[2,],
          aes(x = -0.07,
              y = 1200,
              label = paste0(n),
              col = ph_extreme),
          size = 6)+
  geom_text(data = profile_count_mean[1,],
          aes(x = -0.07,
              y = 1400,
              label = paste0(n),
              col = ph_extreme),
          size = 6)+
  geom_text(data = profile_count_mean[3,],
          aes(x = -0.07,
              y = 1600,
              label = paste0(n),
              col = ph_extreme),
          size = 6)+
  coord_cartesian(xlim = c(-0.08, 0.08))+
  scale_x_continuous(breaks = c(-0.08, -0.04, 0, 0.04, 0.08))+
  labs(title = 'Overall Mean Anomaly Profiles')



rm(remove_clim_overall_mean, profile_count_mean)


```

### Biome-mean anomaly profiles

```{r biome_mean_broullon_anomaly, fig.asp=1}

remove_clim_biome <- remove_clim %>% 
  group_by(depth, ph_extreme, biome_name, season_order, season) %>% 
  summarise(ph_anomaly_mean = mean(anomaly_pH, na.rm = TRUE),
            ph_anomaly_sd = sd(anomaly_pH, na.rm = TRUE))

remove_clim_biome %>% 
  ggplot()+
  geom_path(aes(x = ph_anomaly_mean,
                y = depth,
                group = ph_extreme,
                col = ph_extreme))+
  geom_ribbon(aes(xmax = ph_anomaly_mean + ph_anomaly_sd,
                  xmin = ph_anomaly_mean - ph_anomaly_sd,
                  y = depth, 
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser('sqrt'),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  facet_grid(season_order~biome_name, labeller = facet_label)+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  # geom_text_repel(data = profile_count_biome,
  #                 aes(x = -0.085,
  #                     y = 1500,
  #                     label = paste0(n),
  #                     col = ph_extreme),
  #                 size = 4,
  #                 segment.color = 'transparent')+
  geom_text(data = profile_count_biome %>% filter (ph_extreme == 'N'),
          aes(x = -0.07,
              y = 800,
              label = paste0(n),
              col = ph_extreme),
          size = 4)+
  geom_text(data = profile_count_biome %>% filter (ph_extreme == 'H'),
          aes(x = -0.07,
              y = 1200,
              label = paste0(n),
              col = ph_extreme),
          size = 4)+
  geom_text(data = profile_count_biome %>% filter (ph_extreme == 'L'),
          aes(x = -0.07,
              y = 1600,
              label = paste0(n),
              col = ph_extreme),
          size = 4)+
  coord_cartesian(xlim = c(-0.08, 0.08))+
  scale_x_continuous(breaks = c(-0.08, -0.04, 0, 0.04, 0.08))+
  labs(title = 'Biome-mean anomaly profiles')

rm(remove_clim_biome, profile_count_biome)
```

### Basin-mean anomaly profiles

```{r basin_mean_anomaly_profiles_broullon, fig.asp=1}

remove_clim_basin <-  remove_clim %>% 
  group_by(depth, ph_extreme, basin_AIP, season_order, season) %>% 
  summarise(ph_anomaly_mean = mean(anomaly_pH, na.rm = TRUE),
            ph_anomaly_sd = sd(anomaly_pH, na.rm = TRUE))

remove_clim_basin %>% 
  ggplot()+
  geom_path(aes(x = ph_anomaly_mean,
                y = depth,
                group = ph_extreme,
                col = ph_extreme))+
  geom_ribbon(aes(xmax = ph_anomaly_mean + ph_anomaly_sd,
                  xmin = ph_anomaly_mean - ph_anomaly_sd,
                  y = depth,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  scale_y_continuous(trans = trans_reverser('sqrt'),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  geom_vline(xintercept = 0)+
  facet_grid(season_order~basin_AIP, labeller = facet_label)+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  # geom_text_repel(data = profile_count_basin,
  #                 aes(x = -0.1,
  #                     y = 1500,
  #                     label = paste0(n),
  #                     col = ph_extreme),
  #                 size = 4,
  #                 segment.color = 'transparent')+
  geom_text(data = profile_count_basin %>% filter (ph_extreme == 'N'),
          aes(x = -0.07,
              y = 800,
              label = paste0(n),
              col = ph_extreme),
          size = 4)+
  geom_text(data = profile_count_basin %>% filter (ph_extreme == 'H'),
          aes(x = -0.07,
              y = 1200,
              label = paste0(n),
              col = ph_extreme),
          size = 4)+
  geom_text(data = profile_count_basin %>% filter (ph_extreme == 'L'),
          aes(x = -0.07,
              y = 1600,
              label = paste0(n),
              col = ph_extreme),
          size = 4)+
  coord_cartesian(xlim = c(-0.08, 0.08))+
  scale_x_continuous(breaks = c(-0.08, -0.04, 0, 0.04, 0.08))+
  labs(title = 'Basin-mean anomaly profiles')

rm(remove_clim_basin, profile_count_basin)
```

### Basin-biome-mean anomaly profiles

```{r basin_biome_mean_broullon, fig.asp=1}

remove_clim_basin_biome <- remove_clim %>% 
  group_by(depth, ph_extreme, season_order, season, basin_AIP, biome_name) %>% 
  summarise(ph_anomaly_mean = mean(anomaly_pH, na.rm=TRUE),
            ph_anomaly_sd = sd(anomaly_pH, na.rm = TRUE))

remove_clim_basin_biome %>% 
  group_by(season_order) %>% 
  group_split(season_order) %>% 
  map(
    ~ggplot()+
      geom_path(data = .x,
            aes(x = ph_anomaly_mean,
                y = depth,
                group = ph_extreme,
                col = ph_extreme))+
      geom_ribbon(data = .x,
              aes(xmax = ph_anomaly_mean+ph_anomaly_sd,
                  xmin = ph_anomaly_mean-ph_anomaly_sd,
                  y = depth,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
      geom_vline(xintercept = 0)+
      scale_y_continuous(trans = trans_reverser('sqrt'),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
      facet_grid(basin_AIP~biome_name)+
      scale_color_manual(values = HNL_colors)+
      scale_fill_manual(values = HNL_colors)+
      geom_text(data = profile_count_season %>% filter (ph_extreme == 'N' & season == unique(.x$season)),
              aes(x = -0.07,
                  y = 800,
                  label = paste0(n),
                  col = ph_extreme),
              size = 4)+
      geom_text(data = profile_count_season %>% filter (ph_extreme == 'H' & season == unique(.x$season)),
              aes(x = -0.07,
                  y = 1200,
                  label = paste0(n),
                  col = ph_extreme),
              size = 4)+
      geom_text(data = profile_count_season %>% filter (ph_extreme == 'L' & season == unique(.x$season)),
              aes(x = -0.07,
                  y = 1600,
                  label = paste0(n),
                  col = ph_extreme),
              size = 4)+
      coord_cartesian(xlim = c(-0.08, 0.08))+
      scale_x_continuous(breaks = c(-0.08, -0.04, 0, 0.04, 0.08))+
      labs(title = paste0('basin-biome-mean profiles ', unique(.x$season)))
  )

rm(remove_clim_basin_biome)
```
