---
title: "Extreme pH Profiles"
author: "Pasqualina Vonlanthen & Jens Daniel Müller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r set_options_global, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Task

Compare depth profiles of normal pH and of extreme pH, as identified in the surface OceanSODA pH data product

```{r load_libraries, include=FALSE}
library(tidyverse)
library(lubridate)
library(broom)
library(ggOceanMaps)
library(scico)
library(metR)
library(ggforce)
```

```{r set_global_theme}

theme_set(theme_bw())
HNL_colors <- c("H" = "#b2182b",
                "N" = "#636363",
                "L" = "#2166ac")

HNL_colors_map <- c('H' = 'red3',
                    'N' = 'gray90',
                    'L' = 'blue3')

```

# Load data

```{r set_root_directories}
path_argo <- '/nfs/kryo/work/updata/bgc_argo_r_argodata'
path_argo_preprocessed <- paste0(path_argo, "/preprocessed_bgc_data")
path_emlr_utilities <- "/nfs/kryo/work/jenmueller/emlr_cant/utilities/files/"
```

```{r load_data}

# RECCAP2-ocean region mask

# region_masks_all_2x2 <- read_rds(file = paste0(path_argo_preprocessed,
#                                               "/region_masks_all_2x2.rds"))
# 
# region_masks_all_2x2 <- region_masks_all_2x2 %>%
#   rename(biome = value) %>% 
#   mutate(coast = as.character(coast))

# load in new Mayot biomes 

nm_biomes <- read_rds(file = paste0(path_argo_preprocessed, "/nm_biomes.rds"))

# WOA 18 basin mask

basinmask <-
  read_csv(
    paste(path_emlr_utilities,
          "basin_mask_WOA18.csv",
          sep = ""),
    col_types = cols("MLR_basins" = col_character())
  )

basinmask <- basinmask %>%
  filter(MLR_basins == unique(basinmask$MLR_basins)[1]) %>% 
  select(-c(MLR_basins, basin))

# OceanSODA
OceanSODA <- read_rds(file = paste0(path_argo_preprocessed, "/OceanSODA.rds"))

OceanSODA <- OceanSODA %>%
  mutate(year = year(date),
         month = month(date))

# argo pH data (flag A only)
full_argo <- read_rds(file = paste0(path_argo_preprocessed, "/bgc_merge_flag_A.rds")) %>%
  select(-c(temp_adjusted:temp_adjusted_error,
            profile_temp_qc))


# change the date format for compatibility with OceanSODA pH data
full_argo <- full_argo %>%
  mutate(year = year(date),
         month = month(date)) %>%
  mutate(date = ymd(format(date, "%Y-%m-15")))

map <-
  read_rds(paste(path_emlr_utilities,
                 "map_landmask_WOA18.rds",
                 sep = ""))
```

# Regions

## Biome grid reduction

```{r biomes_flat_map_pre_grid_reduction, fig.asp=0.4}

map +
  geom_tile(data = nm_biomes, 
            aes(x = lon, 
                y = lat, 
                fill = biome_name))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')+
  labs(title = 'Mayot biomes pre-grid reduction')

```

```{r grid_reduction_to_true_2x2_region_mask}

nm_biomes_2x2 <- nm_biomes %>% 
  mutate(lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
         lon = as.numeric(as.character(lon)),
         lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
         lat = as.numeric(as.character(lat)))

nm_biomes_2x2 <- nm_biomes_2x2 %>%
   count(lon, lat, biome_name) %>%
   group_by(lon, lat) %>%
   slice_max(n, with_ties = FALSE) %>%
   ungroup()
 
rm(nm_biomes)
```

```{r biomes_flat_map_post_grid_reduction, fig.asp=0.4}

map+
  geom_tile(data = nm_biomes_2x2,
            aes(x = lon,
                y = lat,
                fill = biome_name))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')+
  labs(title = 'Mayot biomes post-grid reduction')

```

## Basin grid reduction

```{r filter_southern_ocean_basins}

basinmask <- basinmask %>%
  filter(lat < -30)

```

```{r basin_flat_map_pre_grid_reduction, fig.asp=1}
map +
  geom_tile(data = basinmask, 
            aes(x = lon, 
                y = lat, 
                fill = basin_AIP))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')

```

```{r grid_reduction_to_true_2x2_basinmask}

basinmask_2x2 <- basinmask %>%
  mutate(
    lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
    lat = as.numeric(as.character(lat)),
    lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
    lon = as.numeric(as.character(lon))
   ) # regrid into 2x2º grid
# 
# # assign basins from each pixel to to each 2 Lon x Lat pixel, based on the majority of basins in each 2x2 grid  
# 
basinmask_2x2 <- basinmask_2x2 %>%
  count(lon, lat, basin_AIP) %>%
  group_by(lon, lat) %>%
  slice_max(n, with_ties = FALSE) %>%
  ungroup() %>%
  select(-n)
# 
rm(basinmask)

```

```{r basin_flat_map_post_grid_reduction, fig.asp=0.4}

map+
  geom_tile(data = basinmask_2x2 %>% filter(lat < -30),
            aes(x = lon,
                y = lat,
                fill = basin_AIP))+
  lims(y = c(-85, -30))+
  scale_fill_brewer(palette = 'Dark2')


```

# OceanSODA

## Monthly clim surface pH

```{r calculate_monthly_clim_surface_pH_OceanSODA}

OceanSODA <- OceanSODA %>% 
  group_by(lon, lat, month) %>% 
  mutate(clim_ph = mean(ph_total, na.rm = TRUE),
         clim_diff = ph_total - clim_ph,
         .after = ph_total) %>% 
  ungroup()
```

## Grid reduction

```{r grid_reduction_to_2x2_OceanSODA}

# Note: While reducing lon x lat grid,
# we keep the original number of observations

OceanSODA_2x2 <- OceanSODA %>%
  mutate(
    lat_raw = lat,
    lon_raw = lon,
    lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
    lat = as.numeric(as.character(lat)),
    lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
    lon = as.numeric(as.character(lon))) # regrid into 2x2º grid

rm(OceanSODA)
```

## Apply region masks

```{r apply_region_masks_OceanSODA}

# keep only Southern Ocean data
OceanSODA_2x2_SO <- inner_join(OceanSODA_2x2, nm_biomes_2x2)

# add in basin separations
OceanSODA_2x2_SO <- inner_join(OceanSODA_2x2_SO, basinmask_2x2)
# expected number of rows from -30 to -70º latitude, 360º longitude, for 12 months, 8 years:
# 40 lat x 360 lon x 12 months x 8 years = 1 382 400 rows 
# actual number of rows: 919 768

OceanSODA_2x2_SO <- OceanSODA_2x2_SO %>% 
  filter(!is.na(ph_total))

```

## Maps

```{r map_OceanSODA_pH_clim, fig.asp=0.5}

# map of climatological OceanSODA pH 
OceanSODA_2x2_SO %>% 
  group_split(month) %>% 
  #head(1) %>% 
  map(
    ~map+
      geom_tile(data = .x,
                aes(x = lon_raw,
                    y = lat_raw,
                    fill = clim_ph))+
      scale_fill_viridis_c()+
      lims(y = c(-80, -30))+
      labs(title = paste('climatological OceanSODA pH (1995-2020) month:', unique(.x$month)))
  )


```

```{r map_of_OceanSODA_pH_anomalies, fig.asp=1.5}

# map of monthly anomaly relative to climatology

OceanSODA_2x2_SO %>% 
  filter(year >= 2013) %>% 
  group_split(month) %>% 
  #head(1) %>% 
  map(
    ~map+
      geom_tile(data = .x,
                aes(x = lon_raw,
                    y = lat_raw,
                    fill = clim_diff))+
      scale_fill_divergent(mid = 'grey80')+
      lims(y = c(-80, -30))+
      facet_wrap(~year, ncol = 2)+
      labs(title = paste('in-situ OceanSODA pH - clim OceanSODA pH, month:', unique(.x$month)))+
      theme(legend.position = 'right')
  )

```

# OceanSODA pH anomalies

## Grid level

### Climatological thresholds

### Fit lm models

```{r fit_linear_regression}

# fit a linear regression of OceanSODA pH against time (temporal trend)
# in each lat/lon/month grid

OceanSODA_regression <- OceanSODA_2x2_SO %>% 
  # filter(basin_AIP == "Indian",
  #        biome_name == "SPSS",
  #        lon < 40) %>%
  nest(data = -c(lon, lat, month)) %>%
  mutate(fit = map(.x = data,
                   .f = ~ lm(clim_diff ~ year, data = .x)),
         tidied = map(.x = fit, .f = tidy),
         glanced = map(.x = fit, .f = glance),
         augmented = map(.x = fit, .f = augment))


OceanSODA_regression_tidied <- OceanSODA_regression %>%
  select(-c(data, fit, augmented, glanced)) %>%
  unnest(tidied)

OceanSODA_regression_tidied <- OceanSODA_regression_tidied %>% 
  select(lat:estimate) %>% 
  pivot_wider(names_from = term,
              values_from = estimate) %>% 
  rename(intercept = `(Intercept)`,
         slope = year)

OceanSODA_regression_data <- OceanSODA_regression %>% 
  select(-c(fit, tidied, glanced, augmented)) %>% 
  unnest(data)

OceanSODA_regression_augmented <- OceanSODA_regression %>%
  select(-c(fit, tidied, glanced, data)) %>%
  unnest(augmented) %>% 
  select(lat:year, .resid)

OceanSODA_regression_augmented <- bind_cols(
  OceanSODA_regression_augmented,
  OceanSODA_regression_data %>% select(
    date, basin_AIP, biome_name,  
    clim_ph, ph_total,
    lon_raw, lat_raw))

OceanSODA_regression_glanced <- OceanSODA_regression %>%
  select(-c(data, fit, tidied, augmented)) %>%
  unnest(glanced)

```

### Fit mean

```{r fit_pH_mean, eval=FALSE}

# identify the mean value
# in each lat/lon/month grid

OceanSODA_regression_tidied <- OceanSODA_2x2_SO %>% 
  # filter(basin_AIP == "Indian",
  #        biome_name == "SPSS",
  #        lon < 40) %>%
  group_by(lon, lat, month) %>%
  summarise(slope = 0,
            intercept = mean(clim_diff, na.rm = TRUE)) %>% 
  ungroup()

OceanSODA_regression_glanced <- OceanSODA_2x2_SO %>% 
  # filter(basin_AIP == "Indian",
  #        biome_name == "SPSS",
  #        lon < 40) %>%
  group_by(lon, lat, month) %>%
  summarise(sigma = sd(clim_diff, na.rm = TRUE)) %>% 
  ungroup()

OceanSODA_regression_augmented <- OceanSODA_2x2_SO %>% 
  # filter(basin_AIP == "Indian",
  #        biome_name == "SPSS",
  #        lon < 40) %>%
  mutate(.resid = clim_diff)

```

### Slope maps

```{r map_regression_slopes_flat, fig.asp=1}

map+
  geom_tile(data = OceanSODA_regression_tidied,
            aes(x = lon,
                y = lat, 
                fill = slope))+
  scale_fill_scico(palette = 'vik', midpoint = 0)+
  lims(y = c(-85, -30))+
  facet_wrap(~month, ncol = 2)

```

### Sigma maps

```{r flat_map_sigma, fig.asp=1}

map+
  geom_tile(data = OceanSODA_regression_glanced,
            aes(x = lon,
                y = lat, 
                fill = sigma))+
  scale_fill_viridis_c()+
  lims(y = c(-85, -30))+
  facet_wrap(~month, ncol = 2)+
  labs(fill = '1 residual \nst. dev.')

```

### Anomaly identification

Calculate OceanSODA pH anomalies: L for abnormally low, H for abnormally high, N for normal pH

```{r calculate_extreme_OceanSODA_pH_grid}

# when the in-situ OceanSODA pH is lower than the 5th percentile (predicted - 2*residual.st.dev), assign 'L' for low extreme
# when the in-situ OceanSODA pH exceeds the 95th percentile (predicted + 2*residual.st.dev), assign 'H' for high extreme
# when the in-situ OceanSODA pH is within 95% of the range, then assign 'N' for normal pH

# combine observations and regression statistics

OceanSODA_2x2_SO_extreme_grid <-
  full_join(
    OceanSODA_regression_augmented,
    OceanSODA_regression_glanced %>%
      select(lat:month, sigma)
  )

# identify observations in anomaly classes

OceanSODA_2x2_SO_extreme_grid <- OceanSODA_2x2_SO_extreme_grid %>%
  mutate(
    ph_extreme = case_when(
      .resid < -sigma*2 ~ 'L',
      .resid > sigma*2 ~ 'H',
      TRUE ~ 'N'
    )
  ) 

OceanSODA_2x2_SO_extreme_grid <- OceanSODA_2x2_SO_extreme_grid %>%
  mutate(ph_extreme = fct_relevel(ph_extreme, "H", "N", "L"))


# combine with regression coefficients

OceanSODA_2x2_SO_extreme_grid <-
  full_join(OceanSODA_2x2_SO_extreme_grid,
            OceanSODA_regression_tidied)


```

#### Write anomalies to file

```{r write_OceanSODA_pH_anomalies_to_file}

OceanSODA_2x2_SO_extreme_grid %>% 
  write_rds(file = paste0(path = path_argo_preprocessed, "/OceanSODA_pH_anomaly_field.rds"))

```

```{r anomaly_test_plot_grid, fig.asp=0.4}

OceanSODA_2x2_SO_extreme_grid %>%
  group_split(lon, lat, month) %>%
  head(8) %>%
  map(~ ggplot(data = .x) +
        geom_point(aes(x = year,
                       y = clim_diff,
                       col = ph_extreme)) +
        geom_abline(data = .x, aes(slope = slope,
                    intercept = intercept)) +
        geom_abline(data = .x, aes(slope = slope,
                    intercept = intercept + 2*sigma),
                    linetype = 2) +
        geom_abline(data = .x, aes(slope = slope,
                    intercept = intercept - 2*sigma),
                    linetype = 2) +
        labs(title = paste(fititle = paste(
          "lon:", unique(.x$lon),
          "| lat:", unique(.x$lat),
          "| month:", unique(.x$month)
          ))) +
        scale_color_manual(values = HNL_colors))

```

### Anomaly maps

```{r flat_map_OceanSODA_ph_extremes_1x1_plot, fig.asp=1.5}

#use the original lat/lon grid to plot the extreme on a 1x1
#(anomalies detected with 1995-2020 data but mapped only from 2013 to 2020)

OceanSODA_2x2_SO_extreme_grid %>%
  filter(year >= 2013) %>% 
  group_split(month) %>%
  #head(1) %>%
  map(
    ~map +
      geom_tile(data = .x,
                aes(x = lon_raw,
                    y = lat_raw,
                    fill = ph_extreme))+
      scale_fill_manual(values = HNL_colors_map)+
      facet_wrap(~year, ncol = 2)+
      lims(y = c(-85, -30))+
      labs(title = paste('month:', unique(.x$month)),
           fill = 'pH')
  )

# map the anomalies on the original 1x1 grid 
```

### Anomaly time series

```{r extreme_pH_timeseries_grid}
# calculate a regional mean pH for each biome, basin, and ph extreme (H/L/N) and plot a timeseries 

OceanSODA_2x2_SO_extreme_grid %>% 
  group_by(year, biome_name, basin_AIP, ph_extreme) %>% 
  summarise(ph_regional = mean(ph_total, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = ph_regional, col = ph_extreme))+
  geom_point(size = 0.3)+
  geom_line()+
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP~biome_name)+
  theme(legend.position = 'bottom')

```

### Anomaly histogram

```{r extreme_pH_histogram_grid}

OceanSODA_2x2_SO_extreme_grid %>%
  ggplot(aes(ph_total, col = ph_extreme)) +
  geom_density() +
  scale_color_manual(values = HNL_colors) +
  facet_grid(basin_AIP ~ biome_name) +
  coord_cartesian(xlim = c(8, 8.2)) +
  labs(x = 'value',
       y = 'density',
       col = 'pH anomaly') +
  theme(legend.position = 'bottom')

```

# Argo

## Grid reduction

```{r grid_reduction_to_2x2_argo}

# Note: While reducing lon x lat grid,
# we keep the original number of observations

full_argo_2x2 <- full_argo %>%
  mutate(
    lat_raw = lat,
    lon_raw = lon,
    lat = cut(lat, seq(-90, 90, 2), seq(-89, 89, 2)),
    lat = as.numeric(as.character(lat)),
    lon = cut(lon, seq(20, 380, 2), seq(21, 379, 2)),
    lon = as.numeric(as.character(lon)))  # re-grid to 2x2

```

## Apply region masks

```{r apply_region_masks_argo}

# keep only Southern Ocean argo data
full_argo_2x2_SO <- inner_join(full_argo_2x2, nm_biomes_2x2)

# add in basin separations
full_argo_2x2_SO <- inner_join(full_argo_2x2_SO, basinmask_2x2)

```

## Join OceanSODA

```{r combine_extreme_OceanSODA_to_Argo}

# rename OceanSODA columns
OceanSODA_2x2_SO_extreme_grid <- OceanSODA_2x2_SO_extreme_grid %>%
  select(-c(lon, lat)) %>%
  rename(OceanSODA_ph = ph_total,
         lon = lon_raw,
         lat = lat_raw) %>% 
  filter(year >= 2013)

# combine the argo profile data to the surface extreme data
profile_extreme <- inner_join(
  full_argo %>% 
    select(year, month, date, lon, lat, depth,
           ph_in_situ_total_adjusted,
           platform_number,
           cycle_number),
  OceanSODA_2x2_SO_extreme_grid %>% 
    select(year, month, date, lon, lat,
           OceanSODA_ph, ph_extreme,
           clim_ph, clim_diff,
           biome_name, basin_AIP))
  
profile_extreme <- profile_extreme %>% 
  unite('platform_cycle', platform_number:cycle_number, sep = '_', remove = FALSE)

```

# Location of Argo profiles

```{r map_location_argo_profiles, fig.asp=1.5}

OceanSODA_2x2_SO_extreme_grid %>% 
  group_split(month) %>%
  head(1) %>%
  map(
    ~map +
      geom_tile(data = .x,
                aes(x = lon,
                    y = lat,
                    fill = ph_extreme))+
      geom_point(data = profile_extreme %>% 
                   filter(between(depth, 0, 50)),
                 aes(x = lon, 
                     y = lat),
                 shape = 21,
                 size = 0.5,
                 alpha = 0.2,
                 col = 'black',
                 fill = NA)+
      scale_fill_manual(values = HNL_colors_map)+
      facet_wrap(~year, ncol = 2)+
      lims(y = c(-85, -30))+
      labs(title = paste('month:', unique(.x$month)),
           fill = 'pH')
  )

```

# Plot profiles

Argo profiles plotted according to the surface OceanSODA pH

L profiles correspond to a surface acidification event (low pH), as recorded in OceanSODA

H profiles correspond to an event of high surface pH, as recorded in OceanSODA

N profiles correspond to normal surface OceanSODA pH

## Raw

```{r profiles_raw}

profile_extreme %>%
  group_split(biome_name, basin_AIP, year) %>% 
  head(6) %>% 
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = ph_in_situ_total_adjusted,
        y = depth,
        group = platform_cycle,
        col = ph_extreme
      )
    ) +
      geom_path(data = .x %>% filter(ph_extreme == 'N'),
                aes(x = ph_in_situ_total_adjusted,
                    y = depth,
                    group = platform_cycle,
                    col = ph_extreme),
                size = 0.3) +
      geom_path(data = .x %>% filter(ph_extreme == 'H' | ph_extreme == 'L'),
                aes(x = ph_in_situ_total_adjusted,
                    y = depth,
                    group = platform_cycle,
                    col = ph_extreme),
                size = 0.5)+
      scale_y_reverse() +
      scale_color_manual(values = HNL_colors) +
      facet_wrap(~ month, ncol = 6) +
      labs(
        x = 'Argo pH (total scale)',
        y = 'depth (m)',
        title = paste(
          unique(.x$basin_AIP),
          "|",
          unique(.x$year),
          "| biome:",
          unique(.x$biome_name)
        ),
        col = 'OceanSODA pH \nanomaly'
      )
  )

```

### Atl, STSS biome, Aug 2017

```{r select_specific_pH_profiles_2017, eval=FALSE}

# plot profiles for the Atlantic basin, biome 1, month 08, 2017 

OceanSODA_SO_extreme_grid_2017 <-  
  OceanSODA_2x2_SO_extreme_grid %>% 
  filter(date == '2017-08-15')

map+
  geom_tile(data = OceanSODA_SO_extreme_grid_2017,
            aes(x = lon,
                y = lat,
                fill = ph_extreme))+
  scale_fill_manual(values = HNL_colors_map)+
  lims(y = c(-85, -30))+
  labs(title = 'August 2017',
       fill = 'OceanSODA pH \nextreme')

profile_extreme_Atl_2017 <- profile_extreme %>% 
  filter(date == '2017-08-15',
         basin_AIP == 'Atlantic',
         biome_name == 'STSS')

profile_extreme_Atl_2017 %>% 
  ggplot(aes(y = depth, 
             x = ph_in_situ_total_adjusted,
             group = platform_cycle,
             col = ph_extreme))+
  geom_path(data = profile_extreme_Atl_2017 %>% filter(ph_extreme == 'N'),
            aes(x = ph_in_situ_total_adjusted,
                y = depth, 
                group = platform_cycle,
                col = ph_extreme),
            size = 0.3)+
  geom_path(data = profile_extreme_Atl_2017 %>% filter(ph_extreme == 'H'| ph_extreme == 'L'),
            aes(x = ph_in_situ_total_adjusted,
                y = depth,
                group = platform_cycle,
                col = ph_extreme),
            size = 0.5)+
  scale_y_reverse()+
  scale_color_manual(values = HNL_colors)+
  labs(title = 'Atlantic basin, STSS biome, August 2017',
       col = 'OceanSODA\npH anomaly',
       x = 'Argo pH')

rm(OceanSODA_SO_extreme_grid_2017, profile_extreme_Atl_2017)
```

### Atl, STSS biome, Dec 2017

```{r select_specific_profiles_2017, eval=FALSE}

# Plot profiles for the Pacific basin, biome 3, months 12, 2017

OceanSODA_SO_extreme_grid_2017 <-   
  OceanSODA_2x2_SO_extreme_grid %>% 
  filter(date == '2017-12-15')

map+
  geom_tile(data = OceanSODA_SO_extreme_grid_2017,
            aes(x = lon,
                y = lat,
                fill = ph_extreme))+
  scale_fill_manual(values = HNL_colors_map)+
  lims(y = c(-85, -30))+
  labs(title = 'December 2017',
       fill = 'OceanSODA pH \nextreme')

profile_extreme_Atl_2017 <- profile_extreme %>% 
  filter(date == '2017-12-15',
         basin_AIP == 'Atlantic',
         biome_name == 'STSS')

profile_extreme_Atl_2017 %>% 
  ggplot(aes(y = depth, 
             x = ph_in_situ_total_adjusted,
             group = platform_cycle,
             col = ph_extreme))+
  geom_path(data = profile_extreme_Atl_2017 %>% filter(ph_extreme == 'N'),
            aes(x = ph_in_situ_total_adjusted,
                y = depth,
                group = platform_cycle,
                col = ph_extreme),
            size = 0.3)+
  geom_path(data = profile_extreme_Atl_2017 %>% filter(ph_extreme == 'H' | ph_extreme == 'L'),
            aes(x = ph_in_situ_total_adjusted,
                y = depth,
                group = platform_cycle,
                col = ph_extreme),
            size = 0.5)+
  scale_y_reverse()+
  scale_color_manual(values = HNL_colors)+
  labs(title = 'Atlantic basin, STSS biome, December 2017',
       col = 'OceanSODA\npH anomaly',
       x = 'Argo pH')

rm(OceanSODA_SO_extreme_grid_2017, profile_extreme_Atl_2017)
```

### Atl, STSS biome, Jan 2018

```{r select_specific_profiles_2018, eval=FALSE}

OceanSODA_SO_extreme_grid_2018 <-   
  OceanSODA_2x2_SO_extreme_grid %>% 
  filter(date == '2018-01-15')

map+
  geom_tile(data = OceanSODA_SO_extreme_grid_2018,
            aes(x = lon,
                y = lat,
                fill = ph_extreme))+
  scale_fill_manual(values = HNL_colors_map)+
  lims(y = c(-85, -30))+
  labs(title = 'January 2018',
       fill = 'OceanSODA pH \nextreme')

profile_extreme_Atl_2018 <- profile_extreme %>% 
  filter(date == '2018-01-15',
         basin_AIP == 'Atlantic',
         biome_name == 'STSS')

profile_extreme_Atl_2018 %>% 
  ggplot(aes(y = depth, 
             x = ph_in_situ_total_adjusted,
             group = platform_cycle,
             col = ph_extreme))+
  geom_path(data = profile_extreme_Atl_2018 %>% filter(ph_extreme == 'N'),
            aes(x = ph_in_situ_total_adjusted,
                y = depth,
                group = platform_cycle,
                col = ph_extreme),
            size = 0.3)+
  geom_path(data = profile_extreme_Atl_2018 %>% filter(ph_extreme == 'H' | ph_extreme == 'L'),
            aes(x = ph_in_situ_total_adjusted,
                y = depth,
                group = platform_cycle,
                col = ph_extreme),
            size = 0.5)+
  scale_y_reverse()+
  scale_color_manual(values = HNL_colors)+
  labs(title = 'Atlantic basin, STSS biome, January 2018',
       col = 'OceanSODA\npH anomaly',
       x = 'Argo pH')

rm(OceanSODA_SO_extreme_grid_2018, profile_extreme_Atl_2018)
```

## Averaged profiles

```{r calculate_mean_profiles}
# calculate mean profiles in each basin and biome, for each month between 2014 and 2021 
# cut depth levels at 10, 20, .... etc m
# add seasons 
# Dec, Jan, Feb <- summer 
# Mar, Apr, May <- autumn 
# Jun, Jul, Aug <- winter 
# Sep, Oct, Nov <- spring 

profile_extreme <- profile_extreme %>%
  mutate(
    depth = Hmisc::cut2(
      depth,
      cuts = c(10, 20, 30, 50, 70, 100, 300, 500, 800, 1000, 1500, 2000, 2500),
      m = 5,
      levels.mean = TRUE
    ),
    depth = as.numeric(as.character(depth))
  ) %>%
  mutate(
    season = case_when(
      between(month, 3, 5) ~ 'autumn',
      between(month, 6, 8) ~ 'winter',
      between(month, 9, 11) ~ 'spring',
      month == 12 | 1 | 2 ~ 'summer'
    ),
    .after = date
  ) 

```

### Overall mean

```{r mean_profiles, fig.asp=1}

profile_extreme_mean <- profile_extreme %>%
  group_by(ph_extreme, depth) %>%
  summarise(ph_mean = mean(ph_in_situ_total_adjusted, na.rm = TRUE),
            ph_std = sd(ph_in_situ_total_adjusted, na.rm = TRUE)) %>%
  ungroup()

profile_extreme_mean %>%
  arrange(depth) %>%
  ggplot(aes(
    x = ph_mean,
    y = depth,
    group = ph_extreme,
    col = ph_extreme
  )) +
  geom_ribbon(aes(xmin = ph_mean - ph_std,
                  xmax = ph_mean + ph_std,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = "Overall mean",
       col = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'Argo mean pH') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))

rm(profile_extreme_mean)
```

Number of profiles

```{r mean_profile_count, fig.asp=1}

profile_count_mean <- profile_extreme %>% 
  distinct(ph_extreme, platform_number, cycle_number) %>% 
  count(ph_extreme)

profile_count_mean %>% 
  ggplot(aes(x = ph_extreme, y = n, fill = ph_extreme))+
  geom_col(width = 0.5)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles')

rm(profile_count_mean)
```

Surface Argo pH vs surface OceanSODA pH (20 m)

```{r argo_vs_OceanSODA_ph_mean, fig.asp=1}

# calculate surface-mean argo pH, for each profile 
surface_ph_mean <- profile_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(ph_extreme, platform_number, cycle_number) %>% 
  summarise(argo_surf_ph = mean(ph_in_situ_total_adjusted, na.rm = TRUE),
            OceanSODA_surf_ph = mean(OceanSODA_ph, na.rm = TRUE))


surface_ph_mean %>% 
  group_by(ph_extreme) %>% 
  group_split(ph_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = OceanSODA_surf_ph, 
             y = argo_surf_ph))+
  geom_bin2d(data = .x, aes(x = OceanSODA_surf_ph, 
                 y = argo_surf_ph)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(7.9, 8.21),
              ylim = c(7.9, 8.21))+
  # facet_grid(basin_AIP ~ biome) +
    labs(title = paste('pH extreme:', unique(.x$ph_extreme)),
         x = 'OceanSODA pH',
         y = 'Argo pH')
  )

rm(surface_ph_mean)
```

### January Overall Mean Profiles

```{r overall_mean_january_ph_profiles, fig.asp=1}

profile_extreme_mean_jan <- profile_extreme %>%
  filter(month == 1) %>% 
  group_by(ph_extreme, depth) %>%
  summarise(ph_mean = mean(ph_in_situ_total_adjusted, na.rm = TRUE),
            ph_std = sd(ph_in_situ_total_adjusted, na.rm = TRUE)) %>%
  ungroup()

profile_extreme_mean_jan %>%
  arrange(depth) %>%
  ggplot(aes(
    x = ph_mean,
    y = depth,
    group = ph_extreme,
    col = ph_extreme
  )) +
  geom_ribbon(aes(xmin = ph_mean - ph_std,
                  xmax = ph_mean + ph_std,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = "Overall mean January profiles",
       col = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'Argo mean pH') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))

rm(profile_extreme_mean_jan)

```

### Season x Mayot biome

```{r mean_profiles_season_biome, fig.asp=1}

profile_extreme_biome <- profile_extreme %>% 
  group_by(season, biome_name, ph_extreme, depth) %>% 
  summarise(ph_biome = mean(ph_in_situ_total_adjusted, na.rm = TRUE),
            ph_biome_std = sd(ph_in_situ_total_adjusted, na.rm = TRUE)) %>% 
  ungroup()
  

profile_extreme_biome %>%
  ggplot(aes(
    x = ph_biome,
    y = depth,
    group = ph_extreme,
    col = ph_extreme
  )) +
  geom_ribbon(aes(xmin = ph_biome - ph_biome_std,
                  xmax = ph_biome + ph_biome_std,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA, 
              alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(col = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly \n(mean ± st dev)',
       y = 'depth (m)',
       x = 'Biome mean Argo pH',
       title = 'Biome-mean Argo profiles') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
  facet_grid(season ~ biome_name)

rm(profile_extreme_biome)
```

Number of profiles season x biome

```{r count_profiles_season_biome, fig.asp=1}

profile_count_biome <- profile_extreme %>% 
  distinct(season, biome_name, ph_extreme, platform_number, cycle_number) %>% 
  group_by(season, biome_name, ph_extreme) %>% 
  count(ph_extreme)

profile_count_biome %>% 
  ggplot(aes(x = ph_extreme, y = n, fill = ph_extreme))+
  geom_col(width = 0.5)+
  facet_grid(season ~ biome_name)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles season x biome')

rm(profile_count_biome)
```

Surface Argo vs surface OceanSODA pH (20 m) season x biome

```{r argo_vs_OceanSODA_biome, fig.asp=1}

surface_ph_biome <- profile_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season, biome_name, ph_extreme, platform_number, cycle_number) %>% 
  summarise(argo_surf_ph = mean(ph_in_situ_total_adjusted, na.rm=TRUE),
            OceanSODA_surf_ph = mean(OceanSODA_ph, na.rm = TRUE))

surface_ph_biome %>% 
  group_by(ph_extreme) %>% 
  group_split(ph_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = OceanSODA_surf_ph, 
             y = argo_surf_ph))+
  geom_bin2d(data = .x, aes(x = OceanSODA_surf_ph, 
                 y = argo_surf_ph)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(7.94, 8.21),
              ylim = c(7.94, 8.21))+
  facet_grid(season~biome_name) +
    labs(title = paste( 'pH extreme:', unique(.x$ph_extreme)),
         x = 'OceanSODA pH',
         y = 'Argo pH')
  )

rm(surface_ph_biome)
```

### Season x basin

```{r mean_basin_profiles, fig.asp=1}

profile_extreme_basin <- profile_extreme %>% 
  group_by(season, basin_AIP, ph_extreme, depth) %>% 
  summarise(ph_basin = mean(ph_in_situ_total_adjusted, na.rm = TRUE),
            ph_basin_std = sd(ph_in_situ_total_adjusted, na.rm = TRUE)) %>% 
  ungroup()

profile_extreme_basin %>% 
  ggplot(aes(x = ph_basin, 
             y = depth, 
             group = ph_extreme, 
             col = ph_extreme))+
  geom_ribbon(aes(xmax = ph_basin + ph_basin_std,
                  xmin = ph_basin - ph_basin_std,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.3)+
  geom_path()+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  labs(col = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       y = 'depth (m)',
       x = 'Basin mean Argo pH',
       title = 'Basin-mean Argo profiles')+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))) +
  facet_grid(season~basin_AIP)

rm(profile_extreme_basin)
```

Number of profiles season x basin

```{r count_basin_profiles, fig.asp=1}

profile_count_basin <- profile_extreme %>% 
  distinct(season, basin_AIP, ph_extreme, platform_number, cycle_number) %>% 
  group_by(season, basin_AIP, ph_extreme) %>% 
  count(ph_extreme)

profile_count_basin %>% 
  ggplot(aes(x = ph_extreme, y = n, fill = ph_extreme))+
  geom_col(width = 0.5)+
  facet_grid(season~basin_AIP)+
  scale_y_continuous(trans = 'log10')+
  labs(y = 'log(number of profiles)',
       title = 'Number of profiles season x basin')

rm(profile_count_basin)
```

Surface Argo vs surface OceanSODA pH (20 m) season x basin

```{r argo_vs_OceanSODA_pH_basin, fig.asp=1}

# calculate surface-mean argo pH to compare against OceanSODA surface pH (one value)
surface_ph_basin <- profile_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season, basin_AIP, ph_extreme, platform_number, cycle_number) %>% 
  summarise(surf_argo_ph = mean(ph_in_situ_total_adjusted, na.rm=TRUE),
            surf_OceanSODA_ph = mean(OceanSODA_ph, na.rm = TRUE)) 

surface_ph_basin %>% 
  group_by(ph_extreme) %>% 
  group_split(ph_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = surf_OceanSODA_ph, 
             y = surf_argo_ph))+
  geom_bin2d(data = .x, aes(x = surf_OceanSODA_ph, 
                 y = surf_argo_ph)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(7.94, 8.21),
              ylim = c(7.94, 8.21))+
  facet_grid(season~basin_AIP) +
    labs(title = paste('pH extreme:', unique(.x$ph_extreme)),
         x = 'OceanSODA pH',
         y = 'Argo pH')
  )

rm(surface_ph_basin)
```

### Biome-basin January mean

```{r january_biome_basin_profiles, fig.asp=1}

profile_extreme_biome_basin_jan <- profile_extreme %>%
  filter(month == 1) %>% 
  group_by(biome_name, basin_AIP, ph_extreme, depth) %>%
  summarise(ph_mean = mean(ph_in_situ_total_adjusted, na.rm = TRUE),
            ph_std = sd(ph_in_situ_total_adjusted, na.rm = TRUE)) %>%
  ungroup()

profile_extreme_biome_basin_jan %>%
  arrange(depth) %>%
  ggplot(aes(x = ph_mean,
             y = depth)) +
  geom_ribbon(aes(xmin = ph_mean - ph_std,
                  xmax = ph_mean + ph_std,
                  fill = ph_extreme), 
              alpha = 0.2)+
  geom_path(aes(x = ph_mean,
                col = ph_extreme))+
  facet_grid(basin_AIP~biome_name)+
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = "Basin-biome-mean January profiles",
       col = 'OceanSODA\nph anomaly \n(mean ± st dev)',
       fill = 'OceanSODA\nph anomaly \n(mean ± st dev)',
       y = 'sqrt(depth)',
       x = 'mean Argo pH)') +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))

rm(profile_extreme_biome_basin_jan)
```

### Season x biome x basin

```{r mean_profiles_season_biome_basin, fig.asp=1}

profile_extreme_season <- profile_extreme %>%
  group_by(season, biome_name, basin_AIP, ph_extreme, depth) %>%
  summarise(ph_mean = mean(ph_in_situ_total_adjusted, na.rm = TRUE),
            ph_std = sd(ph_in_situ_total_adjusted, na.rm = TRUE)) %>%
  ungroup()

profile_extreme_season %>%
  arrange(depth) %>%
  group_split(season) %>%
  # head(1) %>%
  map(
    ~ ggplot(
      data = .x,
      aes(
        x = ph_mean,
        y = depth,
        group = ph_extreme,
        col = ph_extreme
      )
    ) +
      geom_ribbon(aes(xmax = ph_mean + ph_std,
                      xmin = ph_mean - ph_std,
                      group = ph_extreme,
                      fill = ph_extreme),
                  col = NA,
                  alpha = 0.2)+
      geom_path() +
      scale_color_manual(values = HNL_colors) +
      scale_fill_manual(values = HNL_colors)+
      labs(title = paste("season:", unique(.x$season)),
           col = 'OceanSODA\npH anomaly\n(mean ± st dev)',
           fill = 'OceanSODA\npH anomaly\n(mean ± st dev)',
           y = 'sqrt(depth)',
           x = 'Argo pH') +
      scale_y_continuous(
        trans = trans_reverser("sqrt"),
        breaks = c(10, 100, 250, 500, seq(1000, 5000, 500))
      ) +
      facet_grid(basin_AIP ~ biome_name)
  )

```

Number of profiles per season x biome x basin x pH extreme

```{r count_number_season_biome_basin_profiles, fig.asp=1}

profile_count_season <- profile_extreme %>% 
  distinct(season, biome_name, basin_AIP,
           ph_extreme, platform_number, cycle_number) %>% 
  group_by(season, biome_name, basin_AIP, ph_extreme) %>% 
  count(ph_extreme)


profile_count_season %>% 
  group_by(season) %>% 
  group_split(season) %>% 
  map(
    ~ggplot()+
      geom_col(data =.x, 
               aes(x = ph_extreme,
                   y = n,
                   fill = ph_extreme),
               width = 0.5)+
      facet_grid(basin_AIP ~ biome_name)+
      scale_y_continuous(trans = 'log10')+
      labs(y = 'log(number of profiles)',
           title = paste('season:', unique(.x$season)))
  )

rm(profile_count_season)
```

Surface OceanSODA pH vs surface Argo pH (20 m)

```{r surface_OceanSODA_vs_argo_ph, fig.asp=1}

# calculate surface-mean argo pH, for each season x biome x basin x ph extreme 
surface_ph_season <- profile_extreme %>% 
  filter(depth <= 20) %>% 
  group_by(season, 
           basin_AIP, 
           biome_name, 
           ph_extreme, 
           platform_number, 
           cycle_number) %>% 
  summarise(surf_argo_ph = mean(ph_in_situ_total_adjusted, na.rm=TRUE),
            surf_OceanSODA_ph = mean(OceanSODA_ph, na.rm = TRUE)) 

surface_ph_season %>% 
  group_by(season, ph_extreme) %>% 
  group_split(season, ph_extreme) %>% 
  map(
  ~ggplot(data = .x, aes(x = surf_OceanSODA_ph, 
             y = surf_argo_ph))+
  geom_bin2d(data = .x, aes(x = surf_OceanSODA_ph, 
                 y = surf_argo_ph)) +
  scale_fill_viridis_c()+
  geom_abline(slope = 1, intercept = 0)+
  coord_fixed(ratio = 1, 
              xlim = c(7.94, 8.21),
              ylim = c(7.94, 8.21))+
  facet_grid(basin_AIP ~ biome_name) +
    labs(title = paste('season:', unique(.x$season), 
                        '| pH extreme:', unique(.x$ph_extreme)),
         x = 'OceanSODA pH',
         y = 'Argo pH')
  )

rm(surface_ph_season)
```

##### Atl, SPSS biome, winter

```{r season_biome_1_Atlantic_profile_winter, fig.asp=1}

profile_extreme_season %>%
  filter(basin_AIP == 'Atlantic',
         season == 'winter',
         biome_name == 'SPSS') %>% 
  arrange(depth) %>%
  ggplot(aes(x = ph_mean,
             y = depth,
             group = ph_extreme,
             col = ph_extreme)) +
  geom_ribbon(aes(xmax = ph_mean + ph_std,
                  xmin = ph_mean - ph_std,
                  group = ph_extreme,
                  fill = ph_extreme),
                col = NA,
                alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = 'Atlantic basin, SPSS biome, winter',
       col = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       y = 'sqrt(depth)',
       x = 'Argo pH') +
  scale_y_continuous(
        trans = trans_reverser("sqrt"),
        breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))
```

##### Atl, STSS biome, summer

```{r Atlantic_biome_1_profile_season_summer, fig.asp=1}

profile_extreme_season %>%
  filter(basin_AIP == 'Atlantic',
         season == 'summer',
         biome_name == 'STSS') %>% 
  arrange(depth) %>%
  ggplot(aes(x = ph_mean,
             y = depth,
             group = ph_extreme,
             col = ph_extreme)) +
  geom_ribbon(aes(xmax = ph_mean + ph_std,
                  xmin = ph_mean - ph_std,
                  group = ph_extreme,
                  fill = ph_extreme),
                col = NA,
                alpha = 0.2)+
  geom_path() +
  scale_color_manual(values = HNL_colors) +
  scale_fill_manual(values = HNL_colors)+
  labs(title = 'Atlantic basin, STSS biome, summer',
       col = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       fill = 'OceanSODA\npH anomaly\n(mean ± st dev)',
       y = 'sqrt(depth)',
       x = 'Argo pH') +
  scale_y_continuous(
        trans = trans_reverser("sqrt"),
        breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))
```

# Remove climatology

Plot the Argo H/N/L profiles as anomalies relative to the UCSD Argo pH climatology

```{r filter_january_profiles}

# # keep only january profiles 
profile_extreme_jan <- profile_extreme %>%
  filter(month == 1)

```

```{r average_depth_levels}

profile_extreme_jan_binned <- profile_extreme_jan %>%
  group_by(lon, lat, year, month, platform_cycle,
           biome_name, basin_AIP, ph_extreme,
           depth) %>%
  summarize(ph_adjusted_binned = mean(ph_in_situ_total_adjusted, na.rm = TRUE)) %>%
  ungroup()
```

## Argo UCSD pH climatology

```{r load_jan_pH_climatology}

ucsd_clim_argo_ph_jan <- read_rds(file = paste0(path_argo_preprocessed, "/ucsd_ph_clim_jan.rds"))

# compatibility with profile_temp_extreme_jan
ucsd_clim_argo_ph_jan_SO <- ucsd_clim_argo_ph_jan %>% 
  filter(lat < -30) %>% 
  mutate(depth_ucsd = depth)

# grid average climatological temp into the argo depth bins 
ucsd_clim_argo_ph_jan_SO <- ucsd_clim_argo_ph_jan_SO %>%
  mutate(
    depth = cut(
      depth_ucsd,
      breaks = c(0, 10, 20, 30, 50, 70, 100, 300, 500, 800, 1000, 1500, 2000),
      include.lowest = TRUE,
      labels = as.factor(unique(profile_extreme_jan$depth))
    ),
    depth = as.numeric(as.character(depth))
  )


# calculate mean climatological pH per depth bin
ucsd_clim_argo_ph_jan_SO_binned <- ucsd_clim_argo_ph_jan_SO %>% 
  group_by(lon, lat, depth, month) %>% 
  summarise(clim_ph_jan_binned = mean(clim_pH_jan, na.rm = TRUE)) %>%
  ungroup()


# join climatology and ARGO profiles

remove_clim_jan <- inner_join(profile_extreme_jan_binned, 
                              ucsd_clim_argo_ph_jan_SO_binned %>% 
                                mutate(lat = lat + 0.5))

```

## Profiles - Jan

Points are the January climatological pH, lines are the depth-binned Argo profiles colored by H/N/L classification

### Absolute

```{r plot_raw_ph_profiles_with_clim}

remove_clim_jan %>%
  group_split(biome_name, basin_AIP, year) %>%
  head(6) %>%
  map(
    ~ ggplot() +
      geom_path(
        data = .x %>%
          filter(ph_extreme == 'N'),
        aes(
          x = ph_adjusted_binned,
          y = depth,
          group = platform_cycle,
          col = ph_extreme
        ),
        size = 0.3
      ) +
      geom_path(
        data = .x %>%
          filter(ph_extreme == 'H' | ph_extreme == 'L'),
        aes(
          x = ph_adjusted_binned,
          y = depth,
          group = platform_cycle,
          col = ph_extreme
        ),
        size = 0.5
      ) +
      geom_point(
        data = .x,
        aes(x = clim_ph_jan_binned,
            y = depth,
            col = ph_extreme),
        size = 0.5
      ) +
      scale_y_reverse() +
      scale_color_manual(values = HNL_colors) +
      labs(
        x = 'Argo pH',
        y = 'depth (m)',
        title = paste(
          "Biome:",
          unique(.x$biome_name),
          "| basin:",
          unique(.x$basin_AIP),
          " | Jan",
          unique(.x$year)
        ),
        col = 'OceanSODA pH \nanomaly'
      )
  )

```

```{r remove_ph_climatology_from_profiles}

# calculate the difference between the binned climatological argo and in-situ argo for each depth level and grid cell 

remove_clim_jan <- remove_clim_jan %>% 
  mutate(argo_ph_anomaly = ph_adjusted_binned - clim_ph_jan_binned)
```

### Anomaly

```{r plot_january_anomaly_ph_profiles, fig.asp=1}

remove_clim_jan %>% 
  group_split(year) %>% 
  #head(1) %>% 
  map(
    ~ggplot()+
      geom_path(data = .x %>% filter(ph_extreme == 'N'),
                aes(x = argo_ph_anomaly,
                    y = depth,
                    group = platform_cycle,
                    col = ph_extreme),
                size = 0.2)+
      geom_path(data = .x %>% filter(ph_extreme == 'H'| ph_extreme == 'L'),
                 aes(x = argo_ph_anomaly,
                     y = depth,
                     group = platform_cycle,
                     col = ph_extreme),
                 size = 0.3)+
      geom_vline(xintercept = 0)+
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
      scale_color_manual(values = HNL_colors)+
      scale_fill_manual(values = HNL_colors)+
      facet_grid(basin_AIP~biome_name)+
      labs(title = paste('January', unique(.x$year)))
  )

```

### Overall mean anomaly

```{r plot_overall_mean_clim_removed_profiles_ph, fig.asp=1}

remove_clim_jan_overall_mean <- remove_clim_jan %>% 
  group_by(ph_extreme, depth) %>% 
  summarise(ph_anomaly_mean = mean(argo_ph_anomaly, na.rm = TRUE),
            ph_anomaly_sd = sd(argo_ph_anomaly, na.rm = TRUE))

remove_clim_jan_overall_mean %>% 
  ggplot()+
  geom_path(aes(x = ph_anomaly_mean,
                y = depth,
                group = ph_extreme,
                col = ph_extreme))+
  geom_ribbon(aes(xmax = ph_anomaly_mean + ph_anomaly_sd,
                  xmin = ph_anomaly_mean - ph_anomaly_sd,
                  y = depth,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  labs(title = 'January Overall Mean Anomaly Profiles')

rm(remove_clim_jan_overall_mean)

```

### Biome-mean anomaly

```{r plot_biome_mean_clim_removed_profiles, fig.asp=1}
# using the Mayot biomes 

remove_clim_jan_biome_mean <- remove_clim_jan %>% 
  group_by(ph_extreme, depth, biome_name) %>% 
  summarise(ph_anomaly_mean = mean(argo_ph_anomaly, na.rm = TRUE),
            ph_anomaly_sd = sd(argo_ph_anomaly, na.rm = TRUE))

remove_clim_jan_biome_mean %>% 
  ggplot(aes(x = ph_anomaly_mean,
                y = depth,
                group = ph_extreme,
                col = ph_extreme))+
  geom_path()+
  geom_ribbon(aes(xmax = ph_anomaly_mean + ph_anomaly_sd,
                  xmin = ph_anomaly_mean - ph_anomaly_sd,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  scale_fill_manual(values = HNL_colors)+
  scale_color_manual(values = HNL_colors)+
  labs(title = 'January Biome-mean anomaly profiles')+
  facet_wrap(~biome_name)

rm(remove_clim_jan_biome_mean)

```

### Basin-mean anomaly

```{r plot_basin_mean_anomaly_profiles, fig.asp=1}

remove_clim_jan_basin_mean <- remove_clim_jan %>% 
  group_by(basin_AIP, ph_extreme, depth) %>% 
  summarise(ph_anomaly_mean = mean(argo_ph_anomaly, na.rm = TRUE),
            ph_anomaly_sd = sd(argo_ph_anomaly, na.rm = TRUE))

remove_clim_jan_basin_mean %>% 
  ggplot(aes(x = ph_anomaly_mean,
             y = depth, 
             group = ph_extreme,
             col = ph_extreme))+
  geom_path()+
  geom_ribbon(aes(xmax = ph_anomaly_mean + ph_anomaly_sd,
                  xmin = ph_anomaly_mean - ph_anomaly_sd,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  facet_wrap(~basin_AIP)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  labs(title = 'January Basin-mean anomaly profiles')

rm(remove_clim_jan_basin_mean)
  
```

### Basin-biome-mean anomaly

```{r plot_basin_biome_mean_anomaly_profiles_ph, fig.asp=1}

remove_clim_jan_basin_biome_mean <- remove_clim_jan %>% 
  group_by(basin_AIP, biome_name, ph_extreme, depth) %>% 
  summarise(ph_anomaly_mean = mean(argo_ph_anomaly, na.rm = TRUE),
            ph_anomaly_sd = sd(argo_ph_anomaly, na.rm = TRUE))

remove_clim_jan_basin_biome_mean %>% 
  ggplot(aes(x = ph_anomaly_mean,
             y = depth, 
             group = ph_extreme,
             col = ph_extreme))+
  geom_path()+
  geom_ribbon(aes(xmax = ph_anomaly_mean + ph_anomaly_sd,
                  xmin = ph_anomaly_mean - ph_anomaly_sd,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  facet_grid(basin_AIP~biome_name)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  labs(title = 'January Basin-biome-mean anomaly profiles')

rm(remove_clim_jan_basin_biome_mean)

```

## Broullón TA-DIC pH climatology

```{r average_ph_argo_depth_levels}

profile_extreme_binned <- profile_extreme %>%
  group_by(lon, lat, year, month, platform_cycle,
           biome_name, basin_AIP, ph_extreme,
           depth, season) %>%
  summarise(ph_adjusted_binned = mean(ph_in_situ_total_adjusted, na.rm = TRUE)) %>%
  ungroup()

```

```{r load_broullon_clim}

broullon_clim <- read_rds(file = paste0(path_argo_preprocessed, 
                                        '/broullon_TA_DIC_clim_SO_pH.rds'))

# compatibility with profile_extreme
broullon_clim <- broullon_clim %>% 
  mutate(depth_broullon = depth)

# grid average climatological temp into the argo depth bins 
broullon_clim <- broullon_clim %>%
  mutate(
    depth = cut(
      depth_broullon,
      breaks = c(0, 10, 20, 30, 50, 70, 100, 300, 500, 800, 1000, 1500, 2000),
      include.lowest = TRUE,
      labels = as.factor(unique(profile_extreme$depth))
    ),
    depth = as.numeric(as.character(depth))
  )


# calculate mean climatological pH per depth bin
broullon_clim_binned <- broullon_clim %>% 
  group_by(lon, lat, depth, month, basin_AIP, biome_name) %>% 
  summarise(clim_ph_binned = mean(pH, na.rm = TRUE)) %>%
  ungroup()


# join climatology and ARGO profiles

remove_clim <- inner_join(profile_extreme_binned, 
                              broullon_clim_binned)

```

### Profiles - Absolute

```{r plot_raw_profiles_with_broullon_clim}

remove_clim %>%
  group_split(biome_name, basin_AIP, year) %>%
  head(6) %>%
  map(
    ~ ggplot() +
      geom_path(
        data = .x %>%
          filter(ph_extreme == 'N'),
        aes(
          x = ph_adjusted_binned,
          y = depth,
          group = platform_cycle,
          col = ph_extreme
        ),
        size = 0.3
      ) +
      geom_path(
        data = .x %>%
          filter(ph_extreme == 'H' | ph_extreme == 'L'),
        aes(
          x = ph_adjusted_binned,
          y = depth,
          group = platform_cycle,
          col = ph_extreme
        ),
        size = 0.5
      ) +
      geom_point(
        data = .x,
        aes(x = clim_ph_binned,
            y = depth,
            col = ph_extreme),
        size = 0.5
      ) +
      scale_y_reverse() +
      scale_color_manual(values = HNL_colors) +
      labs(
        x = 'Argo pH',
        y = 'depth (m)',
        title = paste(
          "Biome:",
          unique(.x$biome_name),
          "| basin:",
          unique(.x$basin_AIP),
          " | ",
          unique(.x$year)
        ),
        col = 'OceanSODA pH \nanomaly'
      )
  )

```

### Profiles - Anomaly

```{r remove_broullon_ph_clim}

remove_clim <- remove_clim %>% 
  mutate(argo_ph_anomaly = ph_adjusted_binned - clim_ph_binned)

```

```{r plot_anomaly_profiles_broullon_clim, fig.asp=1}

remove_clim %>% 
  group_split(month) %>% 
  #head(1) %>% 
  map(
    ~ggplot()+
      geom_path(data = .x %>% filter(ph_extreme == 'N'),
                aes(x = argo_ph_anomaly,
                    y = depth,
                    group = platform_cycle,
                    col = ph_extreme),
                size = 0.2)+
      geom_path(data = .x %>% filter(ph_extreme == 'H'| ph_extreme == 'L'),
                 aes(x = argo_ph_anomaly,
                     y = depth,
                     group = platform_cycle,
                     col = ph_extreme),
                 size = 0.3)+
      geom_vline(xintercept = 0)+
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
      scale_color_manual(values = HNL_colors)+
      scale_fill_manual(values = HNL_colors)+
      facet_grid(basin_AIP~biome_name)+
      labs(title = paste('month:', unique(.x$month)))
  )

```

### Overall mean anomaly profiles

```{r overall_mean_anomaly_profiles_broullon, fig.asp=1}

remove_clim_overall_mean <- remove_clim %>% 
  group_by(ph_extreme, depth) %>% 
  summarise(ph_anomaly_mean = mean(argo_ph_anomaly, na.rm = TRUE),
            ph_anomaly_sd = sd(argo_ph_anomaly, na.rm = TRUE))

remove_clim_overall_mean %>% 
  ggplot()+
  geom_path(aes(x = ph_anomaly_mean,
                y = depth,
                group = ph_extreme,
                col = ph_extreme))+
  geom_ribbon(aes(xmax = ph_anomaly_mean + ph_anomaly_sd,
                  xmin = ph_anomaly_mean - ph_anomaly_sd,
                  y = depth,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  labs(title = 'Overall Mean Anomaly Profiles')

rm(remove_clim_overall_mean)


```

### Biome-mean anomaly profiles

```{r biome_mean_broullon_anomaly, fig.asp=1}

remove_clim_biome <- remove_clim %>% 
  group_by(depth, ph_extreme, biome_name, season) %>% 
  summarise(ph_anomaly_mean = mean(argo_ph_anomaly, na.rm = TRUE),
            ph_anomaly_sd = sd(argo_ph_anomaly, na.rm = TRUE))

remove_clim_biome %>% 
  ggplot()+
  geom_path(aes(x = ph_anomaly_mean,
                y = depth,
                group = ph_extreme,
                col = ph_extreme))+
  geom_ribbon(aes(xmax = ph_anomaly_mean + ph_anomaly_sd,
                  xmin = ph_anomaly_mean - ph_anomaly_sd,
                  y = depth, 
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  geom_vline(xintercept = 0)+
  scale_y_continuous(trans = trans_reverser('sqrt'),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  facet_grid(season~biome_name)+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  labs(title = 'Biome-mean anomaly profiles')

rm(remove_clim_biome)
```

### Basin-mean anomaly profiles

```{r basin_mean_anomaly_profiles_broullon, fig.asp=1}

remove_clim_basin <-  remove_clim %>% 
  group_by(depth, ph_extreme, basin_AIP, season) %>% 
  summarise(ph_anomaly_mean = mean(argo_ph_anomaly, na.rm = TRUE),
            ph_anomaly_sd = sd(argo_ph_anomaly, na.rm = TRUE))

remove_clim_basin %>% 
  ggplot()+
  geom_path(aes(x = ph_anomaly_mean,
                y = depth,
                group = ph_extreme,
                col = ph_extreme))+
  geom_ribbon(aes(xmax = ph_anomaly_mean + ph_anomaly_sd,
                  xmin = ph_anomaly_mean - ph_anomaly_sd,
                  y = depth,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
  scale_y_continuous(trans = trans_reverser('sqrt'),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
  geom_vline(xintercept = 0)+
  facet_grid(season~basin_AIP)+
  scale_color_manual(values = HNL_colors)+
  scale_fill_manual(values = HNL_colors)+
  labs(title = 'Basin-mean anomaly profiles')

rm(remove_clim_basin)
```

### Basin-biome-mean anomaly profiles

```{r basin_biome_mean_broullon, fig.asp=1}

remove_clim_basin_biome <- remove_clim %>% 
  group_by(depth, ph_extreme, season, basin_AIP, biome_name) %>% 
  summarise(ph_anomaly_mean = mean(argo_ph_anomaly, na.rm=TRUE),
            ph_anomaly_sd = sd(argo_ph_anomaly, na.rm = TRUE))

remove_clim_basin_biome %>% 
  group_by(season) %>% 
  group_split(season) %>% 
  map(
    ~ggplot()+
      geom_path(data = .x,
            aes(x = ph_anomaly_mean,
                y = depth,
                group = ph_extreme,
                col = ph_extreme))+
      geom_ribbon(data = .x,
              aes(xmax = ph_anomaly_mean+ph_anomaly_sd,
                  xmin = ph_anomaly_mean-ph_anomaly_sd,
                  y = depth,
                  group = ph_extreme,
                  fill = ph_extreme),
              col = NA,
              alpha = 0.2)+
      geom_vline(xintercept = 0)+
      scale_y_continuous(trans = trans_reverser('sqrt'),
                     breaks = c(10, 100, 250, 500, seq(1000, 5000, 500)))+
      facet_grid(biome_name~basin_AIP)+
      scale_color_manual(values = HNL_colors)+
      scale_fill_manual(values = HNL_colors)+
      labs(title = paste0('basin-biome-mean profiles ', unique(.x$season)))
  )

rm(remove_clim_basin_biome)
```
